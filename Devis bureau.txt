' Fichier : Form7.vb - VERSION FINALE (AVEC POSITIONNEMENT ET STYLES DE L'EXEMPLE PDF)
' ********************************************************************************
Imports System.Data.SqlClient
Imports System.Windows.Forms
Imports iTextSharp.text
Imports iTextSharp.text.pdf
Imports System.IO
Imports System.Diagnostics
Imports System.Globalization ' Gard√© pour CultureInfo dans le formatage de date/nombre
Imports WinFont = System.Drawing.Font
Imports System.Text
Public Class Form7
    Private actionEnCours As Boolean = False
    Private dernierClicAction As DateTime = DateTime.MinValue
    Private toolTipForm7 As New ToolTip()
    Private dtDevisCompletAvecStats As DataTable ' Pour stocker tous les devis avec statistiques
    Private StatistiquesDevisActuelles As StatistiquesDevis
    Private WithEvents txtRechercheDevis As New TextBox()
    Private WithEvents txtRechercheAppelProjet As New TextBox()
    Private WithEvents cmbAppelProjetSelection As New ComboBox()
    Private dtDevisComplet As DataTable ' Pour stocker tous les devis
    Private dtAppelProjet As DataTable ' Pour stocker les appels/projets
    Private AfficherColonnesDepot As Boolean = False
    Private AfficherColonnesRetour As Boolean = False
    Private IsLoadingData As Boolean = False
    Private devisID As Integer = 0
    Private TableLignesDevis As New DataTable()
    Private sectionActuelle As Integer = 0
    Private nombreSections As Integer = 0
    Private lignesEnCours As New List(Of Integer)
    Private lblTotalFiltre As New Label()
    Public Property ProjetIDInitial As Integer = 0
    Public Property NumeroDevisInitial As String = ""
    ' üî• NOUVELLE VARIABLE (ajoutez juste √ßa)
    Private txtRechercheTest As TextBox
    Private lblCompteurTest As Label
    ' üî• CONSTRUCTEUR OBLIGATOIRE MANQUANT - AJOUTER CECI :
    Public Sub New()
        ' Cet appel est requis par le concepteur.
        InitializeComponent()

        ' Ajoutez une initialisation quelconque apr√®s l'appel InitializeComponent().
        Console.WriteLine("‚úÖ Form7 constructeur appel√©")
    End Sub
    ' Chemin vers le template PDF avec en-t√™te et pied de page

    Private Sub Form7_Load(sender As Object, e As EventArgs) Handles MyBase.Load

        Try
            IsLoadingData = True

            InitialiserTableLignesDevis()
            ChargerComboBoxes()
            ConfigurerLignesDevisDGV()
            InitialiserApparenceBoutons()

            ' üî• COMMENT√â CAR M√âTHODE MANQUANTE :
            ' AjouterIndicateurStatutsAutomatiques()
            ' AjouterControlesRecherche()
            VerifierDossiersNecessaires()
            DetecterColonnesAfficher()
            ChargerDevis()
            PreserverTextesOriginauxBoutons()
            DesactiverTousBoutons()

            ' üî• REMPLAC√â PAR VERSION CORRIG√âE :
            ChargerDonneesAppelProjetCorrect()

            ActiverDesactiverControles(False)
            ' üî• AJOUTEZ CES DEUX LIGNES √Ä LA FIN
            AjouterRechercheComplete()
            AjouterEnTeteDataGridView()
            ' ‚≠ê AJOUTER CETTE V√âRIFICATION
            VerifierEtSynchroniserStatutsCommandes()
            Console.WriteLine("‚úÖ Form7 charg√©")

        Catch ex As Exception
            MessageBox.Show("Erreur chargement : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            IsLoadingData = False
        End Try

        ' üî• INITIALISER LES SECTIONS
        sectionActuelle = 0
        nombreSections = 0
        lignesEnCours.Clear()
        txtNomSection.Clear()

        Console.WriteLine("‚úÖ Sections initialis√©es")
    End Sub

    ' #################################################################################
    ' # Les fonctions utilitaires (ConvertirMontantEnLettres, FormatTelephone, etc.)
    ' # DOIVENT √äTRE D√âPLAC√âES DANS LE MODULE "ModuleGlobalFunctions.vb" ET SUPPRIM√âES D'ICI.
    ' #################################################################################


    ' üî• AJOUTER UNE NOUVELLE COLONNE DANS InitialiserTableLignesDevis
    Private Sub InitialiserTableLignesDevis()
        Try
            TableLignesDevis = New DataTable()
            TableLignesDevis.Columns.Add("Designation", GetType(String))
            TableLignesDevis.Columns.Add("Unite", GetType(String))
            TableLignesDevis.Columns.Add("Quantite", GetType(Decimal))
            TableLignesDevis.Columns.Add("PrixUnitaire", GetType(Decimal))
            TableLignesDevis.Columns.Add("MontantLigne", GetType(Decimal))
            TableLignesDevis.Columns.Add("TacheID", GetType(Integer))
            TableLignesDevis.Columns.Add("LigneDevisID", GetType(Integer))
            TableLignesDevis.Columns.Add("SectionNom", GetType(String))
            TableLignesDevis.Columns.Add("TypeLigne", GetType(String))
            TableLignesDevis.Columns.Add("OrdreAffichage", GetType(Integer))

            ' üî• NOUVELLE COLONNE
            TableLignesDevis.Columns.Add("EstLibreDefinitif", GetType(Boolean))
            TableLignesDevis.Columns("EstLibreDefinitif").DefaultValue = False

        Catch ex As Exception
            MessageBox.Show("Erreur initialisation : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub ConfigurerLignesDevisDGV()
        Try
            dgvLignesDevis.AutoGenerateColumns = False
            dgvLignesDevis.Columns.Clear()

            ' ‚≠ê COLONNE D√âSIGNATION √âLARGIE
            dgvLignesDevis.Columns.Add("colDesignation", "D√âSIGNATION")
            dgvLignesDevis.Columns("colDesignation").Width = 300 ' ‚≠ê AUGMENT√â DE ~200 √Ä 300 PIXELS
            dgvLignesDevis.Columns("colDesignation").MinimumWidth = 250 ' ‚≠ê LARGEUR MINIMUM GARANTIE
            dgvLignesDevis.Columns("colDesignation").AutoSizeMode = DataGridViewAutoSizeColumnMode.None ' ‚≠ê LARGEUR FIXE

            ' ‚≠ê COLONNE UNIT√â
            dgvLignesDevis.Columns.Add("colUnite", "U")
            dgvLignesDevis.Columns("colUnite").Width = 50 ' Largeur optimale pour unit√©s

            ' ‚≠ê COLONNE QUANTIT√â
            dgvLignesDevis.Columns.Add("colQuantite", "QT√â")
            dgvLignesDevis.Columns("colQuantite").Width = 80 ' Largeur suffisante pour les quantit√©s
            dgvLignesDevis.Columns("colQuantite").DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight

            ' ‚≠ê COLONNE PRIX UNITAIRE
            dgvLignesDevis.Columns.Add("colPrixUnitaire", "P.U.")
            dgvLignesDevis.Columns("colPrixUnitaire").Width = 100 ' Largeur pour les prix
            dgvLignesDevis.Columns("colPrixUnitaire").DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight

            ' ‚≠ê COLONNE MONTANT TOTAL
            dgvLignesDevis.Columns.Add("colMontantLigne", "MONTANT TOTAL (FCFA)")
            dgvLignesDevis.Columns("colMontantLigne").Width = 150 ' Largeur pour les montants
            dgvLignesDevis.Columns("colMontantLigne").DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
            dgvLignesDevis.Columns("colMontantLigne").ReadOnly = True

            ' ‚≠ê COLONNE ID T√ÇCHE (MASQU√âE)
            dgvLignesDevis.Columns.Add("colTacheID", "ID T√¢che")
            dgvLignesDevis.Columns("colTacheID").Visible = False

            ' ‚≠ê FORMATAGE DES COLONNES NUM√âRIQUES
            dgvLignesDevis.Columns("colQuantite").DefaultCellStyle.Format = "N2"
            dgvLignesDevis.Columns("colPrixUnitaire").DefaultCellStyle.Format = "N2"
            dgvLignesDevis.Columns("colMontantLigne").DefaultCellStyle.Format = "N2"

            ' ‚≠ê STYLE DE LA COLONNE D√âSIGNATION POUR MEILLEURE LISIBILIT√â
            dgvLignesDevis.Columns("colDesignation").DefaultCellStyle.WrapMode = DataGridViewTriState.True
            dgvLignesDevis.Columns("colDesignation").DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleLeft


            ' ‚≠ê CONFIGURATION G√âN√âRALE DU DGV
            dgvLignesDevis.AutoSizeRowsMode = DataGridViewAutoSizeRowsMode.AllCells ' ‚≠ê AJUSTEMENT AUTOMATIQUE HAUTEUR LIGNES
            dgvLignesDevis.AllowUserToResizeColumns = True ' ‚≠ê PERMETTRE REDIMENSIONNEMENT MANUEL
            dgvLignesDevis.AllowUserToResizeRows = True ' ‚≠ê PERMETTRE REDIMENSIONNEMENT LIGNES

            ' ‚≠ê STYLE G√âN√âRAL
            dgvLignesDevis.ColumnHeadersDefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)
            dgvLignesDevis.ColumnHeadersDefaultCellStyle.BackColor = Color.FromArgb(240, 240, 240)
            dgvLignesDevis.DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Regular)
            dgvLignesDevis.DefaultCellStyle.SelectionBackColor = Color.FromArgb(102, 126, 234)

            ' ‚≠ê NE PAS UTILISER AutoResizeColumns POUR GARDER NOS LARGEURS PERSONNALIS√âES
            ' dgvLignesDevis.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells) ' ‚≠ê COMMENT√â

            Console.WriteLine("‚úÖ Configuration DGV lignes devis avec colonne D√©signation √©largie (300px)")

            ' üî• NOUVELLE COLONNE SECTION (masqu√©e)
            dgvLignesDevis.Columns.Add("colSectionNom", "Section")
            dgvLignesDevis.Columns("colSectionNom").Width = 100
            dgvLignesDevis.Columns("colSectionNom").Visible = False ' Masqu√©e par d√©faut

            Console.WriteLine("‚úÖ Configuration DGV avec colonnes sections")

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la configuration du DataGridView : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine("‚ùå Erreur configuration DGV : " & ex.Message)
        End Try
    End Sub

    Private Sub ChargerComboBoxes()
        Try
            Application.DoEvents()

            ' üî• SAUVEGARDER LA S√âLECTION ACTUELLE
            Dim projetSelectionneActuel As Integer = 0
            If cmbProjetDevis.SelectedValue IsNot Nothing AndAlso Not TypeOf cmbProjetDevis.SelectedValue Is DataRowView Then
                Integer.TryParse(cmbProjetDevis.SelectedValue.ToString(), projetSelectionneActuel)
            End If

            Dim queryProjets As String =
                "SELECT P.ProjetID, P.NomProjet, P.StatutProjet, P.TypeProjet " &
                "FROM Projets P " &
                "WHERE (P.StatutProjet = 'Termine' OR P.StatutProjet = 'Termin√©') " &
                "AND P.TypeProjet IN ('Urgence', 'GreaGre', 'AppelOffres') "

            ' üî• LOGIQUE CORRIG√âE : En mode modification, inclure TOUJOURS le projet du devis
            If devisID > 0 Then
                ' Mode modification : inclure le projet du devis en cours + projets disponibles
                queryProjets &= "AND (P.ProjetID NOT IN (SELECT DISTINCT ProjetID FROM Devis WHERE ProjetID IS NOT NULL AND DevisID != @DevisEnCours) " &
                               "OR P.ProjetID = (SELECT ProjetID FROM Devis WHERE DevisID = @DevisEnCours)) "
            Else
                ' Mode cr√©ation : exclure les projets avec devis
                queryProjets &= "AND P.ProjetID NOT IN (SELECT DISTINCT ProjetID FROM Devis WHERE ProjetID IS NOT NULL) "
            End If

            queryProjets &= "ORDER BY P.NomProjet"

            Dim parameters As New List(Of SqlParameter)
            If devisID > 0 Then
                parameters.Add(New SqlParameter("@DevisEnCours", devisID))
            End If

            Dim dtProjets As DataTable = DbHelper.GetData(queryProjets, parameters.ToArray())

            ' üî• D√âSACTIVER TEMPORAIREMENT L'√âV√âNEMENT
            RemoveHandler cmbProjetDevis.SelectedIndexChanged, AddressOf cmbProjetDevis_SelectedIndexChanged

            With cmbProjetDevis
                .DataSource = dtProjets
                .DisplayMember = "NomProjet"
                .ValueMember = "ProjetID"
                .SelectedIndex = -1

                ' üî• RESTAURER LA S√âLECTION SI ELLE EXISTE DANS LA NOUVELLE LISTE
                If projetSelectionneActuel > 0 Then
                    .SelectedValue = projetSelectionneActuel
                    Console.WriteLine($"‚úÖ Projet restaur√© : {projetSelectionneActuel}")
                End If
            End With

            ' üî• R√âACTIVER L'√âV√âNEMENT
            AddHandler cmbProjetDevis.SelectedIndexChanged, AddressOf cmbProjetDevis_SelectedIndexChanged

            ' Reste des ComboBox...
            Dim dtTaches As DataTable = DbHelper.GetData("SELECT TacheID, Designation, Unite, PrixUnitaire FROM TachesPredefinies ORDER BY Designation", New SqlParameter() {})
            With cmbDesignationLigneDevis
                .DataSource = dtTaches
                .DisplayMember = "Designation"
                .ValueMember = "TacheID"
                .SelectedIndex = -1
            End With

            With cmbStatutDevis
                .Items.Clear()
                .Items.AddRange({"Brouillon", "Envoy√©", "D√©pos√©", "Retourn√©", "Accept√©", "R√©vision", "Command√©", "Factur√©", "Refus√©", "Annul√©"})
                .SelectedIndex = 0
            End With

            Console.WriteLine($"‚úÖ ComboBoxes charg√©es - Projets: {dtProjets.Rows.Count}")

        Catch ex As Exception
            MessageBox.Show("Erreur chargement ComboBoxes : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    ' 2. AJOUTER UNE VALIDATION AVANT SAUVEGARDE - NOUVELLE M√âTHODE
    Private Function ValiderChangementStatutManuel(ancienStatut As String, nouveauStatut As String) As Boolean
        Try
            ' ‚≠ê STATUTS AUTOMATIQUES (NE PEUVENT PAS √äTRE CHOISIS MANUELLEMENT)
            Dim statutsAutomatiques() As String = {"D√©pos√©", "Retourn√©", "Accept√©", "R√©vision"}

            ' ‚≠ê STATUTS MANUELS AUTORIS√âS
            Dim statutsManuels() As String = {"Brouillon", "Envoy√©", "Annul√©"}

            ' üî• EXCEPTION : Si l'ancien statut ET le nouveau statut sont identiques, autoriser
            If ancienStatut.ToUpper() = nouveauStatut.ToUpper() Then
                Console.WriteLine($"‚úÖ Statut inchang√© '{nouveauStatut}' - Autorisation accord√©e")
                Return True
            End If

            ' üî• EXCEPTION : R√©vision peut redevenir Brouillon pour modification
            If ancienStatut.ToUpper().Contains("R√âVISION") AndAlso nouveauStatut.ToUpper() = "BROUILLON" Then
                Console.WriteLine($"‚úÖ Passage R√©vision ‚Üí Brouillon autoris√© pour modification")
                Return True
            End If

            ' 1. Emp√™cher la s√©lection manuelle de statuts automatiques
            If statutsAutomatiques.Contains(nouveauStatut) Then
                MessageBox.Show($"üö´ STATUT AUTOMATIQUE" & vbCrLf & vbCrLf &
                      $"Le statut '{nouveauStatut}' ne peut pas √™tre d√©fini manuellement." & vbCrLf & vbCrLf &
                      "Statuts automatiques (g√©r√©s par les boutons) :" & vbCrLf &
                      "‚Ä¢ 'D√©pos√©' ‚Üí Bouton 'D√©poser Devis' ‚Üí Form6" & vbCrLf &
                      "‚Ä¢ 'Retourn√©' ‚Üí Bouton 'Retour Devis' ‚Üí Form18" & vbCrLf &
                      "‚Ä¢ 'Accept√©' ‚Üí D√©cision client = Accept√© dans Form18" & vbCrLf &
                      "‚Ä¢ 'R√©vision' ‚Üí D√©cision client = R√©vision dans Form18" & vbCrLf & vbCrLf &
                      "Statuts manuels autoris√©s : Brouillon, Envoy√©, Annul√©",
                      "Modification Interdite", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return False
            End If

            ' Le reste de votre validation existante...
            Return True

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur validation statut: {ex.Message}")
            Return False
        End Try
    End Function

    Private Sub ChargerDevis()
        Try
            ' üî• REQU√äTE CORRIG√âE : Utiliser "Commentaire" au lieu de "Commentaires"
            Dim query As String = "SELECT D.DevisID, D.NumeroDevis, P.NomProjet, P.NumeroProjet, " &
                     "D.DateDevis, D.StatutDevis, D.MontantHT, D.ObjetDevis, " &
                     "CASE WHEN EXISTS(SELECT 1 FROM BonsDeCommande BC WHERE BC.DevisID = D.DevisID) " &
                     "     THEN 'Command√©' " &
                     "     ELSE D.StatutDevis " &
                     "END as StatutActuel, " &
                     "DD.MethodeDepot, DD.Commentaires as CommentaireDepot, DD.DateDepot, " &
                     "RD.DecisionClient, RD.Commentaire as CommentaireRetour, RD.DateRetour " &
                     "FROM Devis D " &
                     "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                     "LEFT JOIN (SELECT DevisID, MethodeDepot, Commentaires, DateDepot, " &
                     "           ROW_NUMBER() OVER (PARTITION BY DevisID ORDER BY DateDepot DESC) as rn " &
                     "           FROM DepotDevis) DD ON D.DevisID = DD.DevisID AND DD.rn = 1 " &
                     "LEFT JOIN (SELECT DevisID, DecisionClient, Commentaire, DateRetour, " &
                     "           ROW_NUMBER() OVER (PARTITION BY DevisID ORDER BY DateRetour DESC) as rn " &
                     "           FROM RetourDevis) RD ON D.DevisID = RD.DevisID AND RD.rn = 1 " &
                     "ORDER BY D.DevisID DESC"

            Dim dtDevis As DataTable = DbHelper.GetData(query, New SqlParameter() {})

            If dtDevis IsNot Nothing Then
                dtDevisComplet = dtDevis.Copy()
                dtDevisCompletAvecStats = dtDevis.Copy()
                dgvListeDevis.DataSource = dtDevis
                ConfigurerColonnesListeDevis()
                MettreAJourCompteur()
                Console.WriteLine($"‚úÖ {dtDevis.Rows.Count} devis charg√©s avec MontantHT uniquement")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur ChargerDevis: {ex.Message}")
            MessageBox.Show("Erreur lors du chargement des devis : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    ' ‚≠ê NOUVELLE M√âTHODE : Remplir les donn√©es d√©p√¥t/retour
    Private Sub RemplirDonneesD√©p√¥tRetour(row As DataRow, devisID As Integer)
        Try
            ' RETOUR : R√©cup√©rer les derni√®res infos
            Dim queryRetour As String = "SELECT TOP 1 DecisionClient, Commentaire FROM RetourDevis WHERE DevisID = @DevisID ORDER BY DateRetour DESC"
            Dim dtRetour As DataTable = DbHelper.GetData(queryRetour, {New SqlParameter("@DevisID", devisID)})

            If dtRetour.Rows.Count > 0 Then
                row("DecisionClient") = If(IsDBNull(dtRetour.Rows(0)("DecisionClient")), "", dtRetour.Rows(0)("DecisionClient").ToString())
                row("CommentaireRetour") = If(IsDBNull(dtRetour.Rows(0)("Commentaire")), "", dtRetour.Rows(0)("Commentaire").ToString())
            Else
                row("DecisionClient") = ""
                row("CommentaireRetour") = ""
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur remplissage devis {devisID}: {ex.Message}")
            row("DecisionClient") = ""
            row("CommentaireRetour") = ""
        End Try
    End Sub
    ' 8. NOUVELLE M√âTHODE : Effacer la recherche devis
    Private Sub btnEffacerRechercheDevis_Click(sender As Object, e As EventArgs)
        Try
            txtRechercheDevis.Text = ""
            txtRechercheDevis.ForeColor = Color.Black

            If dtDevisCompletAvecStats IsNot Nothing Then
                dgvListeDevis.DataSource = dtDevisCompletAvecStats
                ConfigurerColonnesListeDevis()
                ConfigurerColonnesListeDevis()
                MettreAJourStatistiques(dtDevisCompletAvecStats)
                MettreAJourCompteurDevis()
            End If

            Console.WriteLine("‚úÖ Recherche devis effac√©e")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur effacement recherche devis : {ex.Message}")
        End Try
    End Sub

    ' 9. NOUVELLE M√âTHODE : Afficher les statistiques d√©taill√©es des devis
    Private Sub btnStatistiquesDevis_Click(sender As Object, e As EventArgs)
        Try
            Dim stats As StatistiquesDevis = ObtenirStatistiquesDevis()

            ' Construire le message d√©taill√©
            Dim message As New Text.StringBuilder()
            message.AppendLine("üìä STATISTIQUES D√âTAILL√âES DES DEVIS")
            message.AppendLine("=" & New String("=", 45))
            message.AppendLine()
            message.AppendLine($"üìã Nombre total de devis : {stats.NombreTotal}")
            message.AppendLine()
            message.AppendLine("üìà R√âPARTITION PAR STATUT :")
            message.AppendLine($"‚Ä¢ üìù Brouillons : {stats.NombreBrouillons}")
            message.AppendLine($"‚Ä¢ üì§ Envoy√©s : {stats.NombreEnvoyes}")
            message.AppendLine($"‚Ä¢ üì¶ D√©pos√©s : {stats.NombreDeposes}")
            message.AppendLine($"‚Ä¢ üîÑ Retourn√©s : {stats.NombreRetournes}")
            message.AppendLine($"‚Ä¢ ‚úÖ Accept√©s : {stats.NombreAcceptes}")
            message.AppendLine($"‚Ä¢ ‚ùå Refus√©s : {stats.NombreRefuses}")
            message.AppendLine($"‚Ä¢ üö´ Annul√©s : {stats.NombreAnnules}")
            message.AppendLine()

            If stats.NombreTotal > 0 Then
                ' Calculs de pourcentages
                Dim tauxAcceptation As Double = (stats.NombreAcceptes / stats.NombreTotal) * 100
                Dim tauxRefus As Double = (stats.NombreRefuses / stats.NombreTotal) * 100

                message.AppendLine("üìä TAUX DE PERFORMANCE :")
                message.AppendLine($"‚Ä¢ Taux d'acceptation : {tauxAcceptation:F1}%")
                message.AppendLine($"‚Ä¢ Taux de refus : {tauxRefus:F1}%")
                message.AppendLine()
            End If

            message.AppendLine("üí∞ ANALYSE FINANCI√àRE :")
            message.AppendLine($"‚Ä¢ Montant total HT : {stats.MontantTotalHT:N0} FCFA")
            message.AppendLine($"‚Ä¢ Montant moyen HT : {stats.MontantMoyenHT:N0} FCFA")
            message.AppendLine()

            message.AppendLine("üìÖ P√âRIODE :")
            message.AppendLine($"‚Ä¢ Premier devis : {stats.DatePremier:dd/MM/yyyy}")
            message.AppendLine($"‚Ä¢ Dernier devis : {stats.DateDernier:dd/MM/yyyy}")
            message.AppendLine()
            message.AppendLine($"üéØ Projet le plus actif : {stats.ProjetLePlusActif}")

            ' Afficher dans une MessageBox format√©e
            MessageBox.Show(message.ToString(), "Statistiques des Devis", MessageBoxButtons.OK, MessageBoxIcon.Information)

        Catch ex As Exception
            MessageBox.Show("Erreur lors du calcul des statistiques : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' 10. NOUVELLE M√âTHODE : Filtrer par statut de devis
    Private Sub btnFiltrerStatutDevis_Click(sender As Object, e As EventArgs)
        Try
            ' Cr√©er un formulaire de choix de statut
            Dim choixForm As New Form()
            choixForm.Text = "Filtrer par Statut Devis"
            choixForm.Size = New Size(320, 350)
            choixForm.StartPosition = FormStartPosition.CenterParent
            choixForm.FormBorderStyle = FormBorderStyle.FixedDialog
            choixForm.MaximizeBox = False
            choixForm.MinimizeBox = False

            Dim yPos As Integer = 20

            ' Tous les devis
            Dim btnTous As New Button() With {
                .Text = "üìã Tous les devis",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.FromArgb(52, 73, 94),
                .ForeColor = Color.White
            }
            yPos += 35

            ' Brouillons
            Dim btnBrouillons As New Button() With {
                .Text = "üìù Brouillons",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.FromArgb(149, 165, 166),
                .ForeColor = Color.White
            }
            yPos += 35

            ' Envoy√©s
            Dim btnEnvoyes As New Button() With {
                .Text = "üì§ Envoy√©s",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.FromArgb(52, 152, 219),
                .ForeColor = Color.White
            }
            yPos += 35

            ' D√©pos√©s
            Dim btnDeposes As New Button() With {
                .Text = "üì¶ D√©pos√©s",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.Orange,
                .ForeColor = Color.White
            }
            yPos += 35

            ' Retourn√©s
            Dim btnRetournes As New Button() With {
                .Text = "üîÑ Retourn√©s",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.Purple,
                .ForeColor = Color.White
            }
            yPos += 35

            ' Accept√©s
            Dim btnAcceptes As New Button() With {
                .Text = "‚úÖ Accept√©s",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.FromArgb(46, 204, 113),
                .ForeColor = Color.White
            }
            yPos += 35

            ' Refus√©s
            Dim btnRefuses As New Button() With {
                .Text = "‚ùå Refus√©s",
                .Size = New Size(250, 30),
                .Location = New Point(35, yPos),
                .FlatStyle = FlatStyle.Flat,
                .BackColor = Color.FromArgb(231, 76, 60),
                .ForeColor = Color.White
            }

            ' Gestionnaires d'√©v√©nements
            AddHandler btnTous.Click, Sub()
                                          choixForm.Close()
                                          ChargerDevis()
                                      End Sub

            AddHandler btnBrouillons.Click, Sub()
                                                choixForm.Close()
                                                FiltrerDevisParStatut("Brouillon")
                                            End Sub

            AddHandler btnEnvoyes.Click, Sub()
                                             choixForm.Close()
                                             FiltrerDevisParStatut("Envoy√©")
                                         End Sub

            AddHandler btnDeposes.Click, Sub()
                                             choixForm.Close()
                                             FiltrerDevisParStatut("D√©pos√©")
                                         End Sub

            AddHandler btnRetournes.Click, Sub()
                                               choixForm.Close()
                                               FiltrerDevisParStatut("Retourn√©")
                                           End Sub

            AddHandler btnAcceptes.Click, Sub()
                                              choixForm.Close()
                                              FiltrerDevisParStatut("Accept√©")
                                          End Sub

            AddHandler btnRefuses.Click, Sub()
                                             choixForm.Close()
                                             FiltrerDevisParStatut("Refus√©")
                                         End Sub

            choixForm.Controls.AddRange({btnTous, btnBrouillons, btnEnvoyes, btnDeposes, btnRetournes, btnAcceptes, btnRefuses})
            choixForm.ShowDialog()
            choixForm.Dispose()

        Catch ex As Exception
            MessageBox.Show("Erreur lors du filtrage : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' 11. M√âTHODE MODIFI√âE : Filtrer les devis par statut (avec passage du DataTable)
    Private Sub FiltrerDevisParStatut(statut As String)
        Try
            If dtDevisCompletAvecStats Is Nothing Then
                ChargerDevis()
                Return
            End If

            ' Filtrer les donn√©es
            Dim dv As DataView = dtDevisCompletAvecStats.DefaultView
            dv.RowFilter = $"StatutDevis = '{statut}'"

            ' Cr√©er une table filtr√©e
            Dim dtFiltre As DataTable = dv.ToTable()
            dgvListeDevis.DataSource = dtFiltre

            ConfigurerColonnesListeDevis()

            ' Mettre √† jour les statistiques pour le filtre
            MettreAJourStatistiques(dtFiltre)

            ' üî• NOUVEAU : Passer le DataTable filtr√© pour calculer la somme
            MettreAJourCompteurFiltre(dtFiltre.Rows.Count, statut, dtFiltre)

            Console.WriteLine($"‚úÖ Filtrage par statut '{statut}' : {dtFiltre.Rows.Count} r√©sultats")

        Catch ex As Exception
            MessageBox.Show("Erreur lors du filtrage par statut : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    ' 12. M√âTHODE AM√âLIOR√âE : Mettre √† jour le compteur pour les filtres avec somme
    Private Sub MettreAJourCompteurFiltre(nombreResultats As Integer, statut As String, Optional dtFiltre As DataTable = Nothing)
        Try
            Dim lblCompteur As Label = TryCast(Me.Controls("lblCompteurDevisAvance"), Label)
            If lblCompteur Is Nothing Then
                ' Si le label n'existe pas, utiliser lblCompteurTest
                lblCompteur = lblCompteurTest
            End If

            If lblCompteur IsNot Nothing Then
                Dim sommeTotal As Decimal = 0

                ' Calculer la somme des montants filtr√©s
                If dtFiltre IsNot Nothing AndAlso dtFiltre.Rows.Count > 0 Then
                    For Each row As DataRow In dtFiltre.Rows
                        If Not IsDBNull(row("MontantHT")) Then
                            sommeTotal += Convert.ToDecimal(row("MontantHT"))
                        End If
                    Next
                End If

                ' Formater la somme avec des espaces pour les milliers
                Dim sommeFormatee As String = sommeTotal.ToString("N0").Replace(",", " ") & " FCFA"

                ' Afficher selon le nombre de r√©sultats
                If nombreResultats = 0 Then
                    lblCompteur.Text = $"üîΩ Filtre '{statut}' : Aucun devis | üí∞ Montant : 0 FCFA"
                    lblCompteur.ForeColor = Color.FromArgb(231, 76, 60)
                ElseIf nombreResultats = 1 Then
                    lblCompteur.Text = $"üîΩ Filtre '{statut}' : 1 devis | üí∞ Montant HT : {sommeFormatee}"
                    lblCompteur.ForeColor = Color.FromArgb(52, 152, 219)
                Else
                    lblCompteur.Text = $"üîΩ Filtre '{statut}' : {nombreResultats} devis | üí∞ Montant HT : {sommeFormatee}"
                    lblCompteur.ForeColor = Color.FromArgb(155, 89, 182)
                End If
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur compteur filtre : {ex.Message}")
        End Try
    End Sub
    ' 11. FONCTION DE RACCOURCI CLAVIER (OPTIONNEL)
    Private Sub Form7_KeyDown(sender As Object, e As KeyEventArgs) Handles MyBase.KeyDown
        Try
            ' Ctrl + F pour focus sur recherche devis
            If e.Control AndAlso e.KeyCode = Keys.F Then
                txtRechercheDevis.Focus()
                txtRechercheDevis.SelectAll()
                e.Handled = True
            End If

            ' Ctrl + G pour focus sur recherche appel/projet
            If e.Control AndAlso e.KeyCode = Keys.G Then
                txtRechercheAppelProjet.Focus()
                txtRechercheAppelProjet.SelectAll()
                e.Handled = True
            End If

            ' √âchap pour vider les recherches
            If e.KeyCode = Keys.Escape Then
                txtRechercheDevis.Clear()
                txtRechercheAppelProjet.Clear()
                cmbAppelProjetSelection.Visible = False
                e.Handled = True
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur raccourcis clavier: {ex.Message}")
        End Try
    End Sub

    ' 3. NOUVELLE M√âTHODE POUR CONFIGURER LES COLONNES DYNAMIQUEMENT
    Private Sub ConfigurerColonnesListeDevis()
        Try
            dgvListeDevis.Columns("DevisID").Visible = False

            ' Colonnes principales
            dgvListeDevis.Columns("NumeroDevis").HeaderText = "N¬∞ Devis"
            dgvListeDevis.Columns("NumeroDevis").Width = 180
            dgvListeDevis.Columns("NumeroDevis").MinimumWidth = 150

            dgvListeDevis.Columns("NomProjet").HeaderText = "Projet"
            dgvListeDevis.Columns("NomProjet").Width = 200

            If dgvListeDevis.Columns.Contains("NumeroProjet") Then
                dgvListeDevis.Columns("NumeroProjet").HeaderText = "N¬∞ Projet"
                dgvListeDevis.Columns("NumeroProjet").Width = 120
                dgvListeDevis.Columns("NumeroProjet").Visible = True
            End If

            dgvListeDevis.Columns("DateDevis").HeaderText = "Date"
            dgvListeDevis.Columns("DateDevis").Width = 100
            dgvListeDevis.Columns("DateDevis").DefaultCellStyle.Format = "dd/MM/yyyy"

            dgvListeDevis.Columns("StatutDevis").HeaderText = "Statut"
            dgvListeDevis.Columns("StatutDevis").Width = 100

            ' üî• SEULEMENT MONTANT HT (pas de TTC)
            dgvListeDevis.Columns("MontantHT").HeaderText = "Montant HT (FCFA)"
            dgvListeDevis.Columns("MontantHT").Width = 130
            dgvListeDevis.Columns("MontantHT").DefaultCellStyle.Format = "N0"
            dgvListeDevis.Columns("MontantHT").DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight

            If dgvListeDevis.Columns.Contains("ObjetDevis") Then
                dgvListeDevis.Columns("ObjetDevis").HeaderText = "Objet"
                dgvListeDevis.Columns("ObjetDevis").Width = 250
            End If

            ' Colonnes de workflow
            If dgvListeDevis.Columns.Contains("CommentaireRetour") Then
                dgvListeDevis.Columns("CommentaireRetour").HeaderText = "Commentaire Retour"
                dgvListeDevis.Columns("CommentaireRetour").Width = 200
                dgvListeDevis.Columns("CommentaireRetour").MinimumWidth = 150
                dgvListeDevis.Columns("CommentaireRetour").DefaultCellStyle.WrapMode = DataGridViewTriState.True
                dgvListeDevis.Columns("CommentaireRetour").Visible = True
            End If

            If dgvListeDevis.Columns.Contains("DecisionClient") Then
                dgvListeDevis.Columns("DecisionClient").HeaderText = "D√©cision Client"
                dgvListeDevis.Columns("DecisionClient").Width = 120
            End If

            ColoriserStatutsDevis()
            Console.WriteLine("‚úÖ Colonnes configur√©es avec MontantHT uniquement")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur configuration colonnes: {ex.Message}")
        End Try
    End Sub
    ' 3. AJOUTER ColoriserStatutsDevis() SI MANQUANTE :
    Private Sub ColoriserStatutsDevis()
        Try
            For Each row As DataGridViewRow In dgvListeDevis.Rows
                If Not row.IsNewRow AndAlso row.Cells("StatutDevis").Value IsNot Nothing Then
                    Dim statut As String = row.Cells("StatutDevis").Value.ToString().ToUpper()

                    Select Case statut
                        Case "BROUILLON"
                            row.Cells("StatutDevis").Style.BackColor = Color.LightGray
                            row.Cells("StatutDevis").Style.ForeColor = Color.Black
                        Case "ENVOY√â", "ENVOYE"
                            row.Cells("StatutDevis").Style.BackColor = Color.LightBlue
                            row.Cells("StatutDevis").Style.ForeColor = Color.DarkBlue
                        Case "D√âPOS√â", "DEPOSE"
                            row.Cells("StatutDevis").Style.BackColor = Color.Orange
                            row.Cells("StatutDevis").Style.ForeColor = Color.White
                        Case "RETOURN√â", "RETOURNE"
                            row.Cells("StatutDevis").Style.BackColor = Color.Purple
                            row.Cells("StatutDevis").Style.ForeColor = Color.White
                        Case "ACCEPT√â", "ACCEPTE"
                            row.Cells("StatutDevis").Style.BackColor = Color.LightGreen
                            row.Cells("StatutDevis").Style.ForeColor = Color.DarkGreen
                        Case "COMMAND√â", "COMMANDE" ' ‚≠ê STATUT COMMAND√â
                            row.Cells("StatutDevis").Style.BackColor = Color.FromArgb(34, 153, 84)
                            row.Cells("StatutDevis").Style.ForeColor = Color.White
                        Case "FACTUR√â", "FACTURE" ' ‚≠ê NOUVEAU : STATUT FACTUR√â
                            row.Cells("StatutDevis").Style.BackColor = Color.FromArgb(46, 204, 113)
                            row.Cells("StatutDevis").Style.ForeColor = Color.White
                            row.Cells("StatutDevis").Style.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)
                        Case "R√âVISION", "REVISIONS"
                            row.Cells("StatutDevis").Style.BackColor = Color.Orange
                            row.Cells("StatutDevis").Style.ForeColor = Color.White
                        Case "REFUS√â", "REFUSE"
                            row.Cells("StatutDevis").Style.BackColor = Color.FromArgb(231, 76, 60)
                            row.Cells("StatutDevis").Style.ForeColor = Color.White
                        Case "ANNUL√â", "ANNULE"
                            row.Cells("StatutDevis").Style.BackColor = Color.LightSalmon
                            row.Cells("StatutDevis").Style.ForeColor = Color.DarkOrange
                    End Select
                End If
            Next

            Console.WriteLine("‚úÖ Colorisation des statuts appliqu√©e")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur colorisation: {ex.Message}")
        End Try
    End Sub
    ' üî• 6. NOUVELLE M√âTHODE : V√©rifier si un devis est en r√©vision
    Private Function DevisEnRevision(statutDevis As String) As Boolean
        Return statutDevis.ToUpper().Contains("R√âVISION") OrElse statutDevis.ToUpper().Contains("REVISIONS")
    End Function
    ' 12. M√âTHODE POUR FILTRER PAR STATUT (BONUS)
    ' üî• NOUVEAU : Filtrer les devis par statut

    Private Function GenererNouveauNumeroDevis() As String
        Dim anneeActuelle As Integer = DateTime.Now.Year
        Dim anneeComplete As String = anneeActuelle.ToString()  ' üî• CHANG√â : "2025" au lieu de "25"
        Dim numeroSequence As Integer = 1

        Try
            ' Chercher tous les devis de l'ann√©e actuelle avec le nouveau format
            Dim query As String = "SELECT COUNT(*) FROM Devis WHERE NumeroDevis LIKE 'VERNET/KAV-N¬∞%/%' AND NumeroDevis LIKE '%/" & anneeComplete & "'"  ' üî• CHANG√â : / au lieu de -
            Dim dtCount As DataTable = DbHelper.GetData(query, New SqlParameter() {})

            If dtCount IsNot Nothing AndAlso dtCount.Rows.Count > 0 Then
                numeroSequence = CInt(dtCount.Rows(0)(0)) + 1
            End If

            Dim numeroGenere As String
            Dim tentatives As Integer = 0

            Do
                ' ‚≠ê NOUVEAU FORMAT: VERNET/KAV-N¬∞001/2025
                numeroGenere = "VERNET/KAV-N¬∞" & numeroSequence.ToString("000") & "/" & anneeComplete  ' üî• CHANG√â : / au lieu de -

                ' V√©rifier si ce num√©ro existe d√©j√†
                Dim queryVerif As String = "SELECT COUNT(*) FROM Devis WHERE NumeroDevis = @NumeroDevis"
                Dim parametersVerif As SqlParameter() = {New SqlParameter("@NumeroDevis", numeroGenere)}
                Dim dtVerif As DataTable = DbHelper.GetData(queryVerif, parametersVerif)

                If dtVerif IsNot Nothing AndAlso dtVerif.Rows.Count > 0 Then
                    Dim existe As Integer = Convert.ToInt32(dtVerif.Rows(0)(0))
                    If existe = 0 Then
                        Exit Do ' Le num√©ro n'existe pas, on peut l'utiliser
                    Else
                        numeroSequence += 1 ' Le num√©ro existe, essayer le suivant
                        tentatives += 1
                    End If
                Else
                    Exit Do ' Erreur de requ√™te, utiliser ce num√©ro
                End If

                ' S√©curit√© pour √©viter une boucle infinie
                If tentatives > 999 Then
                    MessageBox.Show("Limite de 999 devis par ann√©e atteinte pour l'ann√©e " & anneeActuelle.ToString() & " !", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                    Return "VERNET/KAV-N¬∞999/" & anneeComplete  ' üî• CHANG√â : / au lieu de -
                End If
            Loop

            Console.WriteLine($"‚úÖ Num√©ro de devis g√©n√©r√©: {numeroGenere}")
            Return numeroGenere

        Catch ex As Exception
            Console.WriteLine("‚ùå Erreur g√©n√©ration num√©ro devis : " & ex.Message)
            ' Fallback en cas d'erreur
            Return "VERNET/KAV-N¬∞001/" & anneeComplete  ' üî• CHANG√â : / au lieu de -
        End Try
    End Function

    ' ObtenirInformationsClient utilise d√©sormais FormatTelephone depuis ModuleGlobalFunctions
    Private Function ObtenirInformationsClient(devisID As Integer) As String()
        Dim infosClient(4) As String

        Try
            Dim dtClientInfo As DataTable = DbHelper.GetData(
                    "SELECT C.NomClient, C.Adresse, C.Telephone, C.Email, C.SirenSiret " &
                    "FROM Devis D " &
                    "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                    "JOIN Clients C ON P.ClientID = C.ClientID " &
                    "WHERE D.DevisID = @DevisID",
                    New SqlParameter() {New SqlParameter("@DevisID", devisID)})

            If dtClientInfo.Rows.Count > 0 Then
                Dim row As DataRow = dtClientInfo.Rows(0)

                infosClient(0) = If(IsDBNull(row("NomClient")), "CLIENT NON SP√âCIFI√â", row("NomClient").ToString())
                infosClient(1) = If(IsDBNull(row("Adresse")) OrElse String.IsNullOrWhiteSpace(row("Adresse").ToString()), "", row("Adresse").ToString())
                infosClient(2) = If(IsDBNull(row("Telephone")) OrElse String.IsNullOrWhiteSpace(row("Telephone").ToString()), "", row("Telephone").ToString())
                infosClient(3) = If(IsDBNull(row("Email")) OrElse String.IsNullOrWhiteSpace(row("Email").ToString()), "", row("Email").ToString())
                infosClient(4) = If(IsDBNull(row("SirenSiret")) OrElse String.IsNullOrWhiteSpace(row("SirenSiret").ToString()), "", row("SirenSiret").ToString())
            Else
                infosClient(0) = "CLIENT NON SP√âCIFI√â"
                infosClient(1) = ""
                infosClient(2) = ""
                infosClient(3) = ""
                infosClient(4) = ""
            End If

        Catch ex As Exception
            infosClient(0) = "ERREUR R√âCUP√âRATION CLIENT"
            infosClient(1) = ""
            infosClient(2) = ""
            infosClient(3) = ""
            infosClient(4) = ""
            MessageBox.Show("Erreur lors de la r√©cup√©ration des informations client : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Warning)
        End Try

        Return infosClient
    End Function

    Private Sub cmbDesignationLigneDevis_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbDesignationLigneDevis.SelectedIndexChanged
        Try
            If cmbDesignationLigneDevis.SelectedValue IsNot Nothing AndAlso
                    Not TypeOf cmbDesignationLigneDevis.SelectedValue Is DataRowView Then

                Dim tacheID As Integer
                If Integer.TryParse(cmbDesignationLigneDevis.SelectedValue.ToString(), tacheID) AndAlso tacheID > 0 Then

                    Dim dtTache As DataTable = DbHelper.GetData("SELECT Unite, PrixUnitaire FROM TachesPredefinies WHERE TacheID = @TacheID",
                                                                     New SqlParameter() {New SqlParameter("@TacheID", tacheID)})

                    If dtTache.Rows.Count > 0 Then
                        Dim row As DataRow = dtTache.Rows(0)
                        txtUniteLigne.Text = If(row("Unite") Is DBNull.Value, "", row("Unite").ToString())

                        If Not IsDBNull(row("PrixUnitaire")) Then
                            txtPrixUnitaireLigne.Text = CDec(row("PrixUnitaire")).ToString("N2")
                        Else
                            txtPrixUnitaireLigne.Clear()
                        End If
                    Else
                        txtUniteLigne.Clear()
                        txtPrixUnitaireLigne.Clear()
                    End If
                Else
                    txtUniteLigne.Clear()
                    txtPrixUnitaireLigne.Clear()
                End If
            Else
                txtUniteLigne.Clear()
                txtPrixUnitaireLigne.Clear()
            End If
        Catch ex As Exception
            MessageBox.Show("Erreur lors du chargement des d√©tails de la t√¢che : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            txtUniteLigne.Clear()
            txtPrixUnitaireLigne.Clear()
        End Try
    End Sub

    Private Sub btnAjouterLigne_Click(sender As Object, e As EventArgs) Handles btnAjouterLigne.Click
        Try
            If Not ValiderSaisieLigneDevis() Then Return

            Dim tacheID As Integer = CInt(cmbDesignationLigneDevis.SelectedValue)
            Dim designation As String = cmbDesignationLigneDevis.Text
            Dim unite As String = txtUniteLigne.Text.Trim()
            Dim quantite As Decimal = CDec(txtQuantiteLigne.Text)
            Dim prixUnitaire As Decimal = CDec(txtPrixUnitaireLigne.Text.Replace(" FCFA", "").Replace(" ", ""))
            Dim montantLigne As Decimal = quantite * prixUnitaire

            Dim newRow As DataRow = TableLignesDevis.NewRow()
            newRow("Designation") = designation
            newRow("Unite") = unite
            newRow("Quantite") = quantite
            newRow("PrixUnitaire") = prixUnitaire
            newRow("MontantLigne") = montantLigne
            newRow("TacheID") = tacheID
            newRow("LigneDevisID") = 0
            newRow("SectionNom") = ""
            newRow("TypeLigne") = "LIGNE"
            newRow("OrdreAffichage") = TableLignesDevis.Rows.Count + 1
            newRow("EstLibreDefinitif") = False

            TableLignesDevis.Rows.Add(newRow)

            RefreshDataGridViewLignes()
            CalculerTotauxDevis()
            ViderChampsLigneDevis()

            ' üî• CORRECTION CRITIQUE : Activer le bouton Cr√©er Section
            GererEtatBoutonsSections()

            'MessageBox.Show($"‚úÖ Ligne ajout√©e : {designation}" & vbCrLf & vbCrLf &
            '$"Montant : {montantLigne:N0} FCFA" & vbCrLf & vbCrLf &
            ' "üí° Vous pouvez maintenant cr√©er une section si vous le souhaitez.",
            ' "Ajout r√©ussi", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine("‚úÖ Ligne ajout√©e et boutons sections mis √† jour")

        Catch ex As Exception
            GererErreurLigneDevis(ex, cmbDesignationLigneDevis.Text)
        End Try
    End Sub

    Private Sub FusionnerAvecLigneExistante(tacheID As Integer, quantiteSupplementaire As Decimal, sectionsInfo As String)
        Try
            For Each row As DataRow In TableLignesDevis.Rows
                If Not IsDBNull(row("TacheID")) AndAlso CInt(row("TacheID")) = tacheID AndAlso row("TypeLigne").ToString() <> "SECTION" Then

                    Dim quantiteActuelle As Decimal = CDec(row("Quantite"))
                    Dim prixUnitaire As Decimal = CDec(row("PrixUnitaire"))
                    Dim nouvelleQuantite As Decimal = quantiteActuelle + quantiteSupplementaire
                    Dim nouveauMontant As Decimal = nouvelleQuantite * prixUnitaire

                    row("Quantite") = nouvelleQuantite
                    row("MontantLigne") = nouveauMontant

                    RefreshDataGridViewLignes()
                    CalculerTotauxDevis()

                    MessageBox.Show($"Fusion r√©ussie avec la ligne existante" & vbCrLf & vbCrLf &
                               $"Section : {If(String.IsNullOrEmpty(row("SectionNom").ToString()), "Hors section", row("SectionNom").ToString())}" & vbCrLf &
                               $"Ancienne quantit√© : {quantiteActuelle:N2}" & vbCrLf &
                               $"Quantit√© ajout√©e : {quantiteSupplementaire:N2}" & vbCrLf &
                               $"Nouvelle quantit√© : {nouvelleQuantite:N2}" & vbCrLf &
                               $"Nouveau montant : {nouveauMontant:N0} FCFA",
                               "Fusion r√©ussie", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    Return
                End If
            Next

        Catch ex As Exception
            MessageBox.Show($"Erreur lors de la fusion : {ex.Message}", "Erreur de fusion", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub


    ' VALIDATION DE LA SAISIE
    Private Function ValiderSaisieLigneDevis() As Boolean
        ' V√©rifier la d√©signation
        If cmbDesignationLigneDevis.SelectedValue Is Nothing OrElse
           TypeOf cmbDesignationLigneDevis.SelectedValue Is DataRowView Then
            MessageBox.Show("‚ö†Ô∏è D√âSIGNATION REQUISE" & vbCrLf & vbCrLf &
                           "Veuillez s√©lectionner une t√¢che dans la liste.",
                           "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            cmbDesignationLigneDevis.Focus()
            Return False
        End If

        ' V√©rifier la quantit√©
        Dim quantite As Decimal = 0
        If Not Decimal.TryParse(txtQuantiteLigne.Text, quantite) OrElse quantite <= 0 Then
            MessageBox.Show("‚ö†Ô∏è QUANTIT√â INVALIDE" & vbCrLf & vbCrLf &
                           "La quantit√© doit √™tre un nombre positif." & vbCrLf &
                           "Exemple : 1, 2.5, 10",
                           "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            txtQuantiteLigne.Focus()
            txtQuantiteLigne.SelectAll()
            Return False
        End If

        ' V√©rifier le prix unitaire
        Dim prixUnitaire As Decimal = 0
        If Not Decimal.TryParse(txtPrixUnitaireLigne.Text.Replace(" FCFA", "").Replace(" ", ""), prixUnitaire) OrElse prixUnitaire <= 0 Then
            MessageBox.Show("‚ö†Ô∏è PRIX UNITAIRE INVALIDE" & vbCrLf & vbCrLf &
                           "Le prix unitaire doit √™tre un nombre positif." & vbCrLf &
                           "Exemple : 1000, 25000, 500000",
                           "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            txtPrixUnitaireLigne.Focus()
            txtPrixUnitaireLigne.SelectAll()
            Return False
        End If

        Return True
    End Function

    ' V√âRIFIER DOUBLON DANS LE TABLEAU EN M√âMOIRE
    Private Function VerifierDoublonDansTableauAvecSections(tacheID As Integer) As String
        Try
            Dim sectionsExistantes As New List(Of String)

            For Each row As DataRow In TableLignesDevis.Rows
                If Not IsDBNull(row("TacheID")) AndAlso CInt(row("TacheID")) = tacheID AndAlso row("TypeLigne").ToString() <> "SECTION" Then
                    Dim sectionExistante As String = If(IsDBNull(row("SectionNom")) OrElse String.IsNullOrEmpty(row("SectionNom").ToString()), "SANS_SECTION", row("SectionNom").ToString())
                    If Not sectionsExistantes.Contains(sectionExistante) Then
                        sectionsExistantes.Add(sectionExistante)
                    End If
                End If
            Next

            If sectionsExistantes.Count > 0 Then
                Return String.Join(", ", sectionsExistantes.Select(Function(s) If(s = "SANS_SECTION", "Hors section", s)))
            End If

            Return ""
        Catch ex As Exception
            Console.WriteLine($"Erreur v√©rification doublon avec sections: {ex.Message}")
            Return ""
        End Try
    End Function

    ' FUSIONNER AVEC UNE LIGNE EXISTANTE DANS LE TABLEAU
    Private Sub FusionnerLigneExistanteDansTableau(tacheID As Integer, quantiteSupplementaire As Decimal)
        Try
            For Each row As DataRow In TableLignesDevis.Rows
                If Not IsDBNull(row("TacheID")) AndAlso CInt(row("TacheID")) = tacheID Then
                    ' R√©cup√©rer les valeurs actuelles
                    Dim quantiteActuelle As Decimal = CDec(row("Quantite"))
                    Dim prixUnitaire As Decimal = CDec(row("PrixUnitaire"))

                    ' Calculer les nouvelles valeurs
                    Dim nouvelleQuantite As Decimal = quantiteActuelle + quantiteSupplementaire
                    Dim nouveauMontant As Decimal = nouvelleQuantite * prixUnitaire

                    ' Mettre √† jour la ligne
                    row("Quantite") = nouvelleQuantite
                    row("MontantLigne") = nouveauMontant

                    ' Rafra√Æchir l'affichage
                    RefreshDataGridViewLignes()
                    CalculerTotauxDevis()

                    MessageBox.Show($"‚úÖ FUSION R√âUSSIE" & vbCrLf & vbCrLf &
                                   $"Quantit√© mise √† jour :" & vbCrLf &
                                   $"‚Ä¢ Quantit√© pr√©c√©dente : {quantiteActuelle:N2}" & vbCrLf &
                                   $"‚Ä¢ Quantit√© ajout√©e : {quantiteSupplementaire:N2}" & vbCrLf &
                                   $"‚Ä¢ Nouvelle quantit√© : {nouvelleQuantite:N2}" & vbCrLf &
                                   $"‚Ä¢ Nouveau montant : {nouveauMontant:N0} FCFA",
                                   "Fusion r√©ussie", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    Return
                End If
            Next
        Catch ex As Exception
            MessageBox.Show($"‚ùå ERREUR LORS DE LA FUSION" & vbCrLf & vbCrLf &
                           "La quantit√© n'a pas pu √™tre mise √† jour." & vbCrLf &
                           "Veuillez modifier manuellement la ligne existante." & vbCrLf & vbCrLf &
                           $"D√©tail : {ex.Message}",
                           "Erreur de fusion", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' AJOUTER UNE LIGNE NORMALE
    Private Sub AjouterLigneNormale(tacheID As Integer, designation As String, unite As String, quantite As Decimal, prixUnitaire As Decimal)
        Try
            Dim montantLigne As Decimal = quantite * prixUnitaire
            Dim ordreAffichage As Integer = TableLignesDevis.Rows.Count + 1

            Dim newRow As DataRow = TableLignesDevis.NewRow()
            newRow("Designation") = designation
            newRow("Unite") = unite
            newRow("Quantite") = quantite
            newRow("PrixUnitaire") = prixUnitaire
            newRow("MontantLigne") = montantLigne
            newRow("TacheID") = tacheID
            newRow("LigneDevisID") = 0

            ' üî• NOUVELLES DONN√âES SECTION
            newRow("SectionNom") = ""  ' Pas encore assign√© √† une section
            newRow("TypeLigne") = "LIGNE"
            newRow("OrdreAffichage") = ordreAffichage

            TableLignesDevis.Rows.Add(newRow)

            ' üî• AJOUTER √Ä LA LISTE DES LIGNES EN COURS
            lignesEnCours.Add(TableLignesDevis.Rows.Count - 1)

            RefreshDataGridViewLignes()
            CalculerTotauxDevis()
            ViderChampsLigneDevis()

            ' Message de confirmation
            MessageBox.Show($"‚úÖ LIGNE AJOUT√âE" & vbCrLf & vbCrLf &
                       $"‚Ä¢ T√¢che : {designation}" & vbCrLf &
                       $"‚Ä¢ Quantit√© : {quantite:N2} {unite}" & vbCrLf &
                       $"‚Ä¢ Montant : {montantLigne:N0} FCFA",
                       "Ajout r√©ussi", MessageBoxButtons.OK, MessageBoxIcon.Information)

        Catch ex As Exception
            Throw New Exception($"Erreur lors de l'ajout de la ligne : {ex.Message}")
        End Try
    End Sub


    ' GESTION DES ERREURS AVEC MESSAGES CLAIRS
    Private Sub GererErreurLigneDevis(ex As Exception, designation As String)
        Dim messageErreur As String = ex.Message.ToLower()

        If TypeOf ex Is SqlException Then
            Dim sqlEx As SqlException = CType(ex, SqlException)

            Select Case sqlEx.Number
                Case 2627 ' Violation de contrainte UNIQUE
                    MessageBox.Show("üö´ DOUBLON NON AUTORIS√â" & vbCrLf & vbCrLf &
                                   $"{designation}"" est d√©j√† pr√©sente dans ce devis." & vbCrLf & vbCrLf &
                                   "Solutions possibles :" & vbCrLf &
                                   "‚Ä¢ Modifiez la quantit√© de la ligne existante" & vbCrLf &
                                   "‚Ä¢ Ou supprimez l'ancienne ligne avant d'ajouter la nouvelle",
                                   "T√¢che d√©j√† pr√©sente", MessageBoxButtons.OK, MessageBoxIcon.Warning)

                Case 547 ' Violation de contrainte de cl√© √©trang√®re
                    If messageErreur.Contains("tacheid") Then
                        MessageBox.Show("‚ùå T√ÇCHE INVALIDE" & vbCrLf & vbCrLf &
                                       "La t√¢che s√©lectionn√©e n'existe pas." & vbCrLf & vbCrLf &
                                       "Veuillez :" & vbCrLf &
                                       "‚Ä¢ S√©lectionner une t√¢che valide dans la liste" & vbCrLf &
                                       "‚Ä¢ Ou cr√©er cette t√¢che d'abord",
                                       "T√¢che introuvable", MessageBoxButtons.OK, MessageBoxIcon.Error)
                    ElseIf messageErreur.Contains("devisid") Then
                        MessageBox.Show("‚ùå DEVIS INVALIDE" & vbCrLf & vbCrLf &
                                       "Le devis s√©lectionn√© n'existe pas ou a √©t√© supprim√©." & vbCrLf & vbCrLf &
                                       "Veuillez rafra√Æchir la liste des devis.",
                                       "Devis introuvable", MessageBoxButtons.OK, MessageBoxIcon.Error)
                    Else
                        MessageBox.Show("‚ùå R√âF√âRENCE INVALIDE" & vbCrLf & vbCrLf &
                                       "Une des r√©f√©rences (devis ou t√¢che) n'est pas valide." & vbCrLf & vbCrLf &
                                       "Veuillez v√©rifier vos s√©lections.",
                                       "Erreur de r√©f√©rence", MessageBoxButtons.OK, MessageBoxIcon.Error)
                    End If

                Case 8152 ' Donn√©es trop longues
                    MessageBox.Show("üìè DONN√âES TROP LONGUES" & vbCrLf & vbCrLf &
                                   "Une des valeurs saisies d√©passe la taille autoris√©e :" & vbCrLf & vbCrLf &
                                   "‚Ä¢ D√©signation : maximum 255 caract√®res" & vbCrLf &
                                   "‚Ä¢ Unit√© : maximum 50 caract√®res" & vbCrLf & vbCrLf &
                                   "Veuillez raccourcir le texte.",
                                   "Texte trop long", MessageBoxButtons.OK, MessageBoxIcon.Warning)

                Case 515 ' Valeur NULL non autoris√©e
                    MessageBox.Show("‚ö†Ô∏è CHAMP OBLIGATOIRE MANQUANT" & vbCrLf & vbCrLf &
                                   "Tous les champs obligatoires doivent √™tre remplis :" & vbCrLf & vbCrLf &
                                   "‚Ä¢ T√¢che √† s√©lectionner" & vbCrLf &
                                   "‚Ä¢ Quantit√© √† saisir" & vbCrLf &
                                   "‚Ä¢ Prix unitaire √† d√©finir",
                                   "Informations manquantes", MessageBoxButtons.OK, MessageBoxIcon.Warning)

                Case Else
                    ' Erreur SQL g√©n√©rique
                    MessageBox.Show("üíæ ERREUR DE BASE DE DONN√âES" & vbCrLf & vbCrLf &
                                   $"Une erreur technique s'est produite lors de l'ajout de la t√¢che ""{designation}""." & vbCrLf & vbCrLf &
                                   "D√©tails techniques :" & vbCrLf &
                                   $"Code erreur : {sqlEx.Number}" & vbCrLf &
                                   $"Message : {sqlEx.Message}" & vbCrLf & vbCrLf &
                                   "Contactez l'administrateur si le probl√®me persiste.",
                                   "Erreur technique", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End Select

        Else
            ' Erreur g√©n√©rale
            MessageBox.Show("‚ùå ERREUR INATTENDUE" & vbCrLf & vbCrLf &
                           $"Une erreur s'est produite lors de l'ajout de la t√¢che ""{designation}""." & vbCrLf & vbCrLf &
                           "Veuillez :" & vbCrLf &
                           "‚Ä¢ V√©rifier votre saisie" & vbCrLf &
                           "‚Ä¢ R√©essayer l'op√©ration" & vbCrLf &
                           "‚Ä¢ Contacter le support si n√©cessaire" & vbCrLf & vbCrLf &
                           $"Erreur technique : {ex.Message}",
                           "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End If
    End Sub

    ' VALIDATION LORS DE L'ENREGISTREMENT DU DEVIS
    Private Sub ValiderDoublonsAvantEnregistrement()
        Try
            ' Compter les doublons dans le tableau
            Dim doublonsDetectes As New Dictionary(Of Integer, Integer)

            For Each row As DataRow In TableLignesDevis.Rows
                If Not IsDBNull(row("TacheID")) Then
                    Dim tacheID As Integer = CInt(row("TacheID"))
                    If doublonsDetectes.ContainsKey(tacheID) Then
                        doublonsDetectes(tacheID) += 1
                    Else
                        doublonsDetectes(tacheID) = 1
                    End If
                End If
            Next

            ' V√©rifier s'il y a des doublons
            Dim doublonsTrouves As Boolean = False
            Dim message As String = "Doublons d√©tect√©s dans les lignes de devis :" & vbCrLf & vbCrLf

            For Each kvp In doublonsDetectes
                If kvp.Value > 1 Then
                    doublonsTrouves = True
                    Dim nomTache As String = ObtenirNomTache(kvp.Key)
                    message &= $"‚Ä¢ {nomTache} : {kvp.Value} occurrences" & vbCrLf
                End If
            Next

            If doublonsTrouves Then
                message &= vbCrLf & "Voulez-vous fusionner automatiquement les doublons ?"

                Dim reponse As DialogResult = MessageBox.Show(message, "Doublons d√©tect√©s",
                                                             MessageBoxButtons.YesNo, MessageBoxIcon.Question)

                If reponse = DialogResult.Yes Then
                    FusionnerTousLesDoublons()
                End If
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur validation doublons: {ex.Message}")
        End Try
    End Sub

    Private Function ObtenirNomTache(tacheID As Integer) As String
        Try
            For Each row As DataRow In TableLignesDevis.Rows
                If Not IsDBNull(row("TacheID")) AndAlso CInt(row("TacheID")) = tacheID Then
                    Return row("Designation").ToString()
                End If
            Next
            Return $"T√¢che #{tacheID}"
        Catch
            Return $"T√¢che #{tacheID}"
        End Try
    End Function

    Private Sub FusionnerTousLesDoublons()
        Try
            ' Grouper par TacheID et fusionner
            Dim groupes As New Dictionary(Of Integer, List(Of DataRow))

            For Each row As DataRow In TableLignesDevis.Rows
                If Not IsDBNull(row("TacheID")) Then
                    Dim tacheID As Integer = CInt(row("TacheID"))
                    If Not groupes.ContainsKey(tacheID) Then
                        groupes(tacheID) = New List(Of DataRow)
                    End If
                    groupes(tacheID).Add(row)
                End If
            Next

            For Each kvp In groupes
                If kvp.Value.Count > 1 Then
                    ' Fusionner toutes les lignes de ce groupe
                    Dim premiereLigne As DataRow = kvp.Value(0)
                    Dim quantiteTotale As Decimal = 0
                    Dim prixMoyen As Decimal = 0

                    ' Calculer la somme des quantit√©s et prix moyen
                    For Each ligne In kvp.Value
                        quantiteTotale += CDec(ligne("Quantite"))
                        prixMoyen += CDec(ligne("PrixUnitaire"))
                    Next
                    prixMoyen = prixMoyen / kvp.Value.Count

                    ' Mettre √† jour la premi√®re ligne
                    premiereLigne("Quantite") = quantiteTotale
                    premiereLigne("PrixUnitaire") = prixMoyen
                    premiereLigne("MontantLigne") = quantiteTotale * prixMoyen

                    ' Supprimer les autres lignes
                    For i As Integer = kvp.Value.Count - 1 To 1 Step -1
                        TableLignesDevis.Rows.Remove(kvp.Value(i))
                    Next
                End If
            Next

            RefreshDataGridViewLignes()
            CalculerTotauxDevis()

            MessageBox.Show("‚úÖ Doublons fusionn√©s avec succ√®s !", "Fusion termin√©e",
                           MessageBoxButtons.OK, MessageBoxIcon.Information)

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur lors de la fusion : {ex.Message}", "Erreur",
                           MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' REMPLACER votre m√©thode existante par :
    Private Sub RefreshDataGridViewLignes()
        RefreshDataGridViewLignesAvecSections() ' Au lieu de RefreshDataGridViewLignesAvecSections()
    End Sub

    Private Sub btnSupprimerLigne_Click(sender As Object, e As EventArgs) Handles btnSupprimerLigne.Click
        Try
            If dgvLignesDevis.CurrentRow Is Nothing OrElse
                    dgvLignesDevis.CurrentRow.IsNewRow OrElse
                    dgvLignesDevis.CurrentRow.Index >= TableLignesDevis.Rows.Count Then
                MessageBox.Show("Veuillez s√©lectionner une ligne valide √† supprimer.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            If MessageBox.Show("√ätes-vous s√ªr de vouloir supprimer cette ligne de devis ?", "Confirmer Suppression", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
                Dim rowIndex As Integer = dgvLignesDevis.CurrentRow.Index
                If rowIndex < TableLignesDevis.Rows.Count Then
                    TableLignesDevis.Rows.RemoveAt(rowIndex)
                    RefreshDataGridViewLignes()
                    CalculerTotauxDevis()
                End If
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la suppression : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub ViderChampsLigneDevis()
        cmbDesignationLigneDevis.SelectedIndex = -1
        txtUniteLigne.Clear()
        txtQuantiteLigne.Clear()
        txtPrixUnitaireLigne.Clear()
    End Sub

    Private Sub CalculerTotauxDevis()
        Try
            Dim totalHT As Decimal = 0

            For Each row As DataRow In TableLignesDevis.Rows
                Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())

                ' ‚ùå IGNORER TITRE et SECTION
                If typeLigne = "TITRE" OrElse typeLigne = "SECTION" Then
                    Continue For
                End If

                ' ‚úÖ COMPTER lignes normales uniquement
                If typeLigne = "LIGNE" Then
                    totalHT += CDec(row("MontantLigne"))
                End If
            Next

            txtMontantHT.Text = totalHT.ToString("N0") & " FCFA"
            txtMontantEnLettres.Text = ConvertirMontantEnLettres(totalHT)

            Console.WriteLine($"‚úÖ Total HT : {totalHT:N0} FCFA")

        Catch ex As Exception
            MessageBox.Show("Erreur calcul totaux : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub btnNouveauDevis_Click(sender As Object, e As EventArgs) Handles btnNouveauDevis.Click
        Try
            ' V√©rifier qu'il y a des projets disponibles
            Dim queryProjetsTermines As String = "SELECT COUNT(*) FROM Projets WHERE StatutProjet = 'Termine' OR StatutProjet = 'Termin√©'"
            Dim dtCount As DataTable = DbHelper.GetData(queryProjetsTermines, New SqlParameter() {})

            If dtCount.Rows.Count > 0 AndAlso CInt(dtCount.Rows(0)(0)) = 0 Then
                MessageBox.Show("üö´ AUCUN PROJET DISPONIBLE" & vbCrLf & vbCrLf &
                  "Aucun projet termin√© n'est disponible." & vbCrLf & vbCrLf &
                  "Pour cr√©er un devis, un projet doit √™tre termin√©." & vbCrLf &
                  "Veuillez d'abord terminer au moins un projet.",
                  "Projets Requis", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' Vider tous les champs
            ViderChamps()
            devisID = 0

            ' NE PLUS G√âN√âRER AUTOMATIQUEMENT - Laisser vide pour saisie obligatoire
            txtNumeroDevis.Clear()
            txtNumeroChrono.Clear()

            ' Activer les contr√¥les
            ActiverDesactiverControles(True)

            ' Focus sur le num√©ro chrono
            txtNumeroChrono.Focus()

            Console.WriteLine("‚úÖ Mode NOUVEAU DEVIS activ√© - En attente de s√©lection projet")

            MessageBox.Show("‚úÖ NOUVEAU DEVIS" & vbCrLf & vbCrLf &
              "1. Saisissez le num√©ro chronologique du devis" & vbCrLf &
              "2. S√©lectionnez un projet (pr√©-remplissage automatique)" & vbCrLf &
              "3. Ajoutez les lignes du devis",
              "Mode Cr√©ation", MessageBoxButtons.OK, MessageBoxIcon.Information)

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la cr√©ation d'un nouveau devis : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub txtNumeroChrono_TextChanged(sender As Object, e As EventArgs) Handles txtNumeroChrono.TextChanged
        Try
            Dim numeroChrono As String = txtNumeroChrono.Text.Trim()

            If String.IsNullOrWhiteSpace(numeroChrono) Then
                txtNumeroDevis.Clear()
                Return
            End If

            ' üî• G√âN√âRER LE NUM√âRO COMPLET EN TEMPS R√âEL
            Dim numeroComplet As String = GenererNumeroAvecChrono(numeroChrono)
            txtNumeroDevis.Text = numeroComplet

            ' üî• VALIDATION EN TEMPS R√âEL (optionnel - indicateur visuel)
            If VerifierUniciteNumero(numeroComplet) Then
                txtNumeroChrono.BackColor = Color.White
                txtNumeroDevis.BackColor = Color.LightGreen
            Else
                txtNumeroChrono.BackColor = Color.LightCoral
                txtNumeroDevis.BackColor = Color.LightCoral
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur txtNumeroChrono_TextChanged: {ex.Message}")
        End Try
    End Sub

    Private Sub ExtraireNumeroChrono(numeroDevis As String)
        Try
            ' üî• EXTRAIRE LE CHRONO DU NUM√âRO COMPLET
            ' Format: VERNET/KAV/N¬∞045-25 ‚Üí Extraire 045

            If numeroDevis.Contains("VERNET/KAV-N¬∞") AndAlso numeroDevis.Contains("-") Then
                Dim debut As Integer = numeroDevis.IndexOf("N¬∞") + 2
                Dim fin As Integer = numeroDevis.LastIndexOf("-")

                If fin > debut Then
                    Dim chrono As String = numeroDevis.Substring(debut, fin - debut)
                    txtNumeroChrono.Text = chrono
                    Console.WriteLine($"‚úÖ Chrono extrait: '{chrono}' depuis '{numeroDevis}'")
                End If
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur extraction chrono: {ex.Message}")
            txtNumeroChrono.Clear()
        End Try
    End Sub
    Private Function GenererNumeroAvecChrono(numeroChrono As String) As String
        Try
            Dim anneeActuelle As Integer = DateTime.Now.Year
            Dim anneeComplete As String = anneeActuelle.ToString()  ' üî• CHANG√â : "2025" au lieu de "25"

            ' üî• FORMATER LE NUM√âRO CHRONO (assurer 3 chiffres)
            Dim chronoFormate As String = numeroChrono.PadLeft(3, "0"c)

            ' üî• G√âN√âRER LE NUM√âRO FINAL avec le nouveau format
            Dim numeroComplet As String = $"VERNET/KAV-N¬∞{chronoFormate}/{anneeComplete}"  ' üî• CHANG√â : / au lieu de -

            Console.WriteLine($"‚úÖ Num√©ro g√©n√©r√© avec chrono: {numeroComplet}")
            Return numeroComplet

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur g√©n√©ration num√©ro chrono: {ex.Message}")
            Return $"VERNET/KAV-N¬∞{numeroChrono}/{DateTime.Now.Year}"  ' üî• CHANG√â : / et ann√©e compl√®te
        End Try
    End Function


    Private Function VerifierUniciteNumero(numeroDevis As String) As Boolean
        Try
            If String.IsNullOrWhiteSpace(numeroDevis) Then Return False

            Dim query As String = "SELECT COUNT(*) FROM Devis WHERE NumeroDevis = @NumeroDevis"

            ' üî• EN MODE MODIFICATION - Exclure le devis actuel
            If devisID > 0 Then
                query += " AND DevisID != @DevisID"
            End If

            Dim parameters As New List(Of SqlParameter)
            parameters.Add(New SqlParameter("@NumeroDevis", numeroDevis))
            If devisID > 0 Then
                parameters.Add(New SqlParameter("@DevisID", devisID))
            End If

            Dim dtVerif As DataTable = DbHelper.GetData(query, parameters.ToArray())

            If dtVerif IsNot Nothing AndAlso dtVerif.Rows.Count > 0 Then
                Return CInt(dtVerif.Rows(0)(0)) = 0
            End If

            Return True

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification unicit√©: {ex.Message}")
            Return False
        End Try
    End Function

    Private Sub btnModifierDevis_Click(sender As Object, e As EventArgs) Handles btnModifierDevis.Click
        If dgvListeDevis.CurrentRow Is Nothing Then
            MessageBox.Show("Veuillez s√©lectionner un devis √† modifier.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return
        End If

        Try
            devisID = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)

            Console.WriteLine($"üîß Modification devis {devisID}")

            ' R√©cup√©rer les donn√©es du devis
            Dim dtDevis As DataTable = DbHelper.GetData("SELECT * FROM Devis WHERE DevisID = @ID",
                                                     New SqlParameter() {New SqlParameter("@ID", devisID)})

            If dtDevis.Rows.Count > 0 Then
                Dim row As DataRow = dtDevis.Rows(0)
                Dim projetIDDevis As Integer = CInt(row("ProjetID"))

                Console.WriteLine($"üìã Projet du devis : {projetIDDevis}")

                ' Recharger la ComboBox en mode modification
                ChargerComboBoxes()

                ' Forcer la s√©lection du projet
                Application.DoEvents()
                cmbProjetDevis.SelectedValue = projetIDDevis

                If cmbProjetDevis.SelectedValue Is Nothing OrElse CInt(cmbProjetDevis.SelectedValue) <> projetIDDevis Then
                    Console.WriteLine($"‚ùå ERREUR: Projet {projetIDDevis} non trouv√© dans ComboBox")

                    ' Solution de secours : Ajouter manuellement le projet manquant
                    Dim queryProjetManquant As String = "SELECT ProjetID, NomProjet FROM Projets WHERE ProjetID = @ProjetID"
                    Dim dtProjetManquant As DataTable = DbHelper.GetData(queryProjetManquant, {New SqlParameter("@ProjetID", projetIDDevis)})

                    If dtProjetManquant.Rows.Count > 0 Then
                        Dim dtSource As DataTable = CType(cmbProjetDevis.DataSource, DataTable)
                        Dim newRow As DataRow = dtSource.NewRow()
                        newRow("ProjetID") = projetIDDevis
                        newRow("NomProjet") = dtProjetManquant.Rows(0)("NomProjet").ToString() & " (Devis en cours)"
                        newRow("StatutProjet") = "Termin√©"
                        newRow("TypeProjet") = "Modifiable"
                        dtSource.Rows.Add(newRow)

                        cmbProjetDevis.SelectedValue = projetIDDevis
                        Console.WriteLine($"‚úÖ Projet {projetIDDevis} ajout√© manuellement")
                    End If
                Else
                    Console.WriteLine($"‚úÖ Projet {projetIDDevis} s√©lectionn√© correctement")
                End If

                ' üî• NOUVEAU : Charger directement depuis la base
                txtNumeroChrono.Text = If(IsDBNull(row("NumeroChrono")), "", row("NumeroChrono").ToString())

                ' Si le champ est vide (ancien devis avant migration), extraire du NumeroDevis
                If String.IsNullOrWhiteSpace(txtNumeroChrono.Text) Then
                    ExtraireNumeroChrono(txtNumeroDevis.Text)
                End If

                dtpDateDevis.Value = CDate(row("DateDevis"))

                ' üî• CORRECTION : Extraire et remplir le num√©ro chrono
                ExtraireNumeroChrono(txtNumeroDevis.Text)

                dtpDateDevis.Value = CDate(row("DateDevis"))
                cmbStatutDevis.SelectedItem = row("StatutDevis").ToString()
                If cmbStatutDevis.SelectedIndex = -1 Then
                    cmbStatutDevis.SelectedItem = "Brouillon"
                End If
                txtMontantHT.Text = CDec(row("MontantHT")).ToString("N2") & " FCFA"

                txtObjetDevis.Text = If(row("ObjetDevis") Is DBNull.Value, "", row("ObjetDevis").ToString())

                ' Charger les informations du projet
                RecupererEtMettreAJourInfosProjetForce(projetIDDevis)

                ChargerLignesDevisPourModification(devisID)
                ActiverDesactiverControles(True)

                Console.WriteLine($"‚úÖ Modification devis {devisID} pr√™te")
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la modification : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"‚ùå Erreur modification: {ex.Message}")
        End Try
    End Sub

    Private Sub ChargerLignesDevisPourModification(devisID As Integer)
        Try
            TableLignesDevis.Clear()
            lignesEnCours.Clear()

            ' REQU√äTE CORRIG√âE : R√©cup√©rer TypeLigne et SectionNom
            Dim dtLignesDevis As DataTable = DbHelper.GetData(
            "SELECT LigneDevisID, Designation, Unite, Quantite, PrixUnitaire, MontantLigne, " &
            "ISNULL(TypeLigne, 'LIGNE') as TypeLigne, " &
            "ISNULL(SectionNom, '') as SectionNom, " &
            "ISNULL(OrdreAffichage, 0) as OrdreAffichage " &
            "FROM LignesDevis WHERE DevisID = @DevisID ORDER BY OrdreAffichage, LigneDevisID",
            New SqlParameter() {New SqlParameter("@DevisID", devisID)})

            For Each ligneRow As DataRow In dtLignesDevis.Rows
                Dim newRow As DataRow = TableLignesDevis.NewRow()
                newRow("Designation") = ligneRow("Designation").ToString()
                newRow("Unite") = If(ligneRow("Unite") Is DBNull.Value, "", ligneRow("Unite").ToString())
                newRow("Quantite") = CDec(ligneRow("Quantite"))
                newRow("PrixUnitaire") = CDec(ligneRow("PrixUnitaire"))
                newRow("MontantLigne") = CDec(ligneRow("MontantLigne"))
                newRow("TacheID") = 0 ' Pas de t√¢che ID pour les sections
                newRow("LigneDevisID") = CInt(ligneRow("LigneDevisID"))

                ' CHARGER LES DONN√âES SECTIONS
                newRow("TypeLigne") = ligneRow("TypeLigne").ToString()
                newRow("SectionNom") = ligneRow("SectionNom").ToString()
                newRow("OrdreAffichage") = CInt(ligneRow("OrdreAffichage"))

                TableLignesDevis.Rows.Add(newRow)

                Console.WriteLine($"Charg√©: {ligneRow("TypeLigne")} - {ligneRow("Designation")} - Section: '{ligneRow("SectionNom")}'")
            Next

            RefreshDataGridViewLignes()
            CalculerTotauxDevis()

            Console.WriteLine($"Chargement termin√©: {TableLignesDevis.Rows.Count} lignes (articles + sections)")

        Catch ex As Exception
            Console.WriteLine("Erreur chargement lignes modification : " & ex.Message)
            MessageBox.Show("Erreur lors du chargement des lignes : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub



    Private Sub btnEnregistrerDevis_Click(sender As Object, e As EventArgs) Handles btnEnregistrerDevis.Click
        If actionEnCours Then
            Console.WriteLine("üîí Action enregistrement d√©j√† en cours")
            Return
        End If

        actionEnCours = True
        Try
            If Not ValiderDevis() Then Return

            ' üî• NOUVEAU : D√©tecter si on modifie un devis en r√©vision
            Dim devisEnRevision As Boolean = False
            If devisID > 0 Then
                Dim queryAncienStatut As String = "SELECT StatutDevis FROM Devis WHERE DevisID = @DevisID"
                Dim dtAncienStatut As DataTable = DbHelper.GetData(queryAncienStatut, {New SqlParameter("@DevisID", devisID)})

                If dtAncienStatut.Rows.Count > 0 Then
                    Dim ancienStatut As String = dtAncienStatut.Rows(0)("StatutDevis").ToString()

                    ' üî• FORCER LE PASSAGE EN BROUILLON SI ON √âTAIT EN R√âVISION
                    If ancienStatut.ToUpper().Contains("R√âVISION") Then
                        devisEnRevision = True
                        cmbStatutDevis.SelectedItem = "Brouillon"
                        Console.WriteLine("üîÑ Devis en r√©vision ‚Üí Passage automatique en Brouillon")

                        MessageBox.Show("Le devis a √©t√© modifi√© avec succ√®s.",
                 "R√©vision termin√©e",
                 MessageBoxButtons.OK,
                 MessageBoxIcon.Information)

                    Else
                        ' Validation normale pour les autres statuts
                        Dim nouveauStatut As String = cmbStatutDevis.SelectedItem.ToString()
                        If Not ValiderChangementStatutManuel(ancienStatut, nouveauStatut) Then
                            cmbStatutDevis.SelectedItem = ancienStatut
                            Return
                        End If
                    End If
                End If
            End If

            ' Continuer avec l'enregistrement normal
            Try
                Dim montantHT As Decimal = CDec(txtMontantHT.Text.Replace(" FCFA", "").Replace(" ", ""))

                ' üî• NOUVEAU (ajoutez le NumeroChrono)
                Dim parametersDevis As New List(Of SqlParameter) From {
    New SqlParameter("@ProjetID", CInt(cmbProjetDevis.SelectedValue)),
    New SqlParameter("@NumeroDevis", txtNumeroDevis.Text),
    New SqlParameter("@NumeroChrono", txtNumeroChrono.Text.Trim()), ' üî• NOUVEAU
    New SqlParameter("@DateDevis", dtpDateDevis.Value.Date),
    New SqlParameter("@StatutDevis", cmbStatutDevis.SelectedItem.ToString()),
    New SqlParameter("@MontantHT", montantHT),
    New SqlParameter("@ObjetDevis", If(String.IsNullOrWhiteSpace(txtObjetDevis.Text), DBNull.Value, txtObjetDevis.Text))
}

                Dim newDevisID As Integer = 0
                Dim modeCreation As Boolean = (devisID = 0)

                If modeCreation Then
                    ' Cr√©ation
                    Dim queryDevis As String = "INSERT INTO Devis (ProjetID, NumeroDevis, NumeroChrono, DateDevis, StatutDevis, MontantHT, ObjetDevis) " &
                      "VALUES (@ProjetID, @NumeroDevis, @NumeroChrono, @DateDevis, @StatutDevis, @MontantHT, @ObjetDevis); SELECT SCOPE_IDENTITY();"

                    Using conn As SqlConnection = DbHelper.GetConnection()
                        If conn Is Nothing Then Return
                        Using cmd As New SqlCommand(queryDevis, conn)
                            cmd.Parameters.AddRange(parametersDevis.ToArray())
                            newDevisID = CInt(cmd.ExecuteScalar())
                        End Using
                    End Using
                    devisID = newDevisID
                Else
                    ' üî• MODE MODIFICATION (nouveau code avec NumeroChrono)
                    Dim queryDevis As String = "UPDATE Devis SET ProjetID=@ProjetID, NumeroDevis=@NumeroDevis, NumeroChrono=@NumeroChrono, DateDevis=@DateDevis, " &
                      "StatutDevis=@StatutDevis, MontantHT=@MontantHT, ObjetDevis=@ObjetDevis WHERE DevisID=@DevisID"
                    parametersDevis.Add(New SqlParameter("@DevisID", devisID))

                    If DbHelper.ExecuteNonQuery(queryDevis, parametersDevis.ToArray()) <= 0 Then
                        MessageBox.Show("√âchec de la mise √† jour du devis.", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                        Return
                    End If
                End If

                EnregistrerLignesDevis()

                ' Message de succ√®s adapt√©
                If devisEnRevision Then
                    MessageBox.Show("‚úÖ R√©vision enregistr√©e avec succ√®s !" & vbCrLf &
                              "Statut : Brouillon (pr√™t pour finalisation)",
                              "R√©vision Termin√©e", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Else
                    MessageBox.Show("Devis enregistr√© avec succ√®s.", "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)
                End If

                ViderChamps()
                ActiverDesactiverControles(False)
                ChargerComboBoxes()
                ChargerDevis()
                ChargerDonneesAppelProjetCorrect()

                ' Rafra√Æchir les statistiques
                Try
                    MettreAJourCompteurDevis()
                    If txtRechercheTest IsNot Nothing AndAlso Not String.IsNullOrWhiteSpace(txtRechercheTest.Text) Then
                        RechercherDansDevis(txtRechercheTest.Text)
                    End If
                Catch ex As Exception
                    Console.WriteLine($"‚ùå Erreur rafra√Æchissement statistiques: {ex.Message}")
                End Try

            Catch ex As Exception
                MessageBox.Show("Erreur lors de l'enregistrement : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End Try
        Finally
            actionEnCours = False
        End Try
    End Sub
    ' 4. NOUVELLE M√âTHODE : Ajouter un indicateur visuel pour les statuts automatiques
    Private Sub AjouterIndicateurStatutsAutomatiques()
        Try
            ' Cr√©er un label d'information √† c√¥t√© de la ComboBox des statuts
            Dim lblInfoStatut As New Label()
            lblInfoStatut.Name = "lblInfoStatutAutomatique"
            lblInfoStatut.Text = "‚ÑπÔ∏è Statuts auto : D√©pos√©, Retourn√©, Accept√©, R√©vision"
            lblInfoStatut.Font = New System.Drawing.Font("Segoe UI", 8, FontStyle.Italic)
            lblInfoStatut.ForeColor = Color.FromArgb(100, 100, 100)
            lblInfoStatut.AutoSize = True

            ' Positionner sous la ComboBox des statuts
            If cmbStatutDevis IsNot Nothing Then
                lblInfoStatut.Location = New Point(cmbStatutDevis.Location.X, cmbStatutDevis.Location.Y + cmbStatutDevis.Height + 5)
            Else
                lblInfoStatut.Location = New Point(20, 200)
            End If

            ' Tooltip explicatif
            toolTipForm7.SetToolTip(lblInfoStatut,
                "Statuts g√©r√©s automatiquement par les boutons :" & vbCrLf &
                "‚Ä¢ D√©pos√© : Bouton 'D√©poser Devis'" & vbCrLf &
                "‚Ä¢ Retourn√© : Bouton 'Retour Devis'" & vbCrLf &
                "‚Ä¢ Accept√© : D√©cision client = Accept√©" & vbCrLf &
                "‚Ä¢ R√©vision : D√©cision client = R√©vision")

            Me.Controls.Add(lblInfoStatut)
            lblInfoStatut.BringToFront()

            Console.WriteLine("‚úÖ Indicateur statuts automatiques ajout√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur ajout indicateur: {ex.Message}")
        End Try
    End Sub

    ' 5. NOUVELLE M√âTHODE : G√©rer l'√©v√©nement de changement de statut pour validation en temps r√©el
    Private Sub cmbStatutDevis_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbStatutDevis.SelectedIndexChanged
        Try
            If IsLoadingData OrElse cmbStatutDevis.SelectedItem Is Nothing Then Return

            ' IGNORER si on est en mode lecture seule (pas en √©dition)
            If Not btnEnregistrerDevis.Enabled Then Return

            Dim nouveauStatut As String = cmbStatutDevis.SelectedItem.ToString()
            Dim statutsAutomatiques() As String = {"D√©pos√©", "Retourn√©", "Accept√©", "R√©vision"}

            If statutsAutomatiques.Contains(nouveauStatut) Then
                ' Restaurer l'ancien statut sans message d'erreur
                If dgvListeDevis.CurrentRow IsNot Nothing Then
                    Dim statutActuel As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString()
                    IsLoadingData = True
                    cmbStatutDevis.SelectedItem = statutActuel
                    IsLoadingData = False
                End If
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur changement statut: {ex.Message}")
        End Try
    End Sub
    Private Function ValiderDevis() As Boolean
        ' üî• VALIDATION NUM√âRO CHRONO OBLIGATOIRE
        If String.IsNullOrWhiteSpace(txtNumeroChrono.Text.Trim()) Then
            MessageBox.Show("‚ö†Ô∏è NUM√âRO CHRONOLOGIQUE OBLIGATOIRE" & vbCrLf & vbCrLf &
                  "Veuillez saisir un num√©ro chronologique pour ce devis." & vbCrLf &
                  "Exemple : 001, 045, 123",
                  "Num√©ro Manquant", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            txtNumeroChrono.Focus()
            Return False
        End If

        ' üî• VALIDATION UNICIT√â
        If Not VerifierUniciteNumero(txtNumeroDevis.Text) Then
            MessageBox.Show("üö´ NUM√âRO D√âJ√Ä UTILIS√â" & vbCrLf & vbCrLf &
                  $"Le num√©ro '{txtNumeroDevis.Text}' existe d√©j√†." & vbCrLf &
                  "Veuillez choisir un autre num√©ro chronologique.",
                  "Doublon D√©tect√©", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            txtNumeroChrono.Focus()
            txtNumeroChrono.SelectAll()
            Return False
        End If

        ' üî• V√âRIFICATION PROJET OBLIGATOIRE (votre code existant)
        If cmbProjetDevis.SelectedValue Is Nothing OrElse CInt(cmbProjetDevis.SelectedValue) <= 0 Then
            MessageBox.Show("‚ö†Ô∏è PROJET OBLIGATOIRE" & vbCrLf & vbCrLf &
                  "Veuillez s√©lectionner un projet pour ce devis." & vbCrLf &
                  "Le projet doit √™tre termin√© et sans devis existant.",
                  "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            cmbProjetDevis.Focus()
            Return False
        End If

        ' ... reste de votre validation existante ...

        If String.IsNullOrWhiteSpace(txtObjetDevis.Text) Then
            MessageBox.Show("L'objet du devis est obligatoire.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            txtObjetDevis.Focus()
            Return False
        End If

        If TableLignesDevis.Rows.Count = 0 Then
            MessageBox.Show("Au moins une ligne de devis est obligatoire.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return False
        End If

        Return True
    End Function

    Private Sub EnregistrerLignesDevis()
        Try
            ' Supprimer toutes les anciennes lignes
            DbHelper.ExecuteNonQuery("DELETE FROM LignesDevis WHERE DevisID = @DevisID",
                                 New SqlParameter() {New SqlParameter("@DevisID", devisID)})

            ' NOUVELLE REQU√äTE : Inclure TypeLigne et SectionNom
            Dim queryLigneDevis As String = "INSERT INTO LignesDevis " &
                                       "(DevisID, Designation, Unite, Quantite, PrixUnitaire, MontantLigne, TypeLigne, SectionNom, OrdreAffichage) " &
                                       "VALUES (@DevisID, @Designation, @Unite, @Quantite, @PrixUnitaire, @MontantLigne, @TypeLigne, @SectionNom, @OrdreAffichage)"

            Dim ordre As Integer = 1

            ' Sauvegarder TOUTES les lignes : articles ET sections
            For Each rowLigne As DataRow In TableLignesDevis.Rows
                Try
                    Dim typeLigne As String = If(IsDBNull(rowLigne("TypeLigne")), "LIGNE", rowLigne("TypeLigne").ToString())
                    Dim sectionNom As String = If(IsDBNull(rowLigne("SectionNom")), "", rowLigne("SectionNom").ToString())

                    Dim paramsLigne As SqlParameter() = {
                    New SqlParameter("@DevisID", devisID),
                    New SqlParameter("@Designation", rowLigne("Designation").ToString()),
                    New SqlParameter("@Unite", If(IsDBNull(rowLigne("Unite")), "", rowLigne("Unite").ToString())),
                    New SqlParameter("@Quantite", If(typeLigne = "SECTION", 0, CDec(rowLigne("Quantite")))),
                    New SqlParameter("@PrixUnitaire", If(typeLigne = "SECTION", 0, CDec(rowLigne("PrixUnitaire")))),
                    New SqlParameter("@MontantLigne", CDec(rowLigne("MontantLigne"))),
                    New SqlParameter("@TypeLigne", typeLigne),
                    New SqlParameter("@SectionNom", If(String.IsNullOrEmpty(sectionNom), DBNull.Value, sectionNom)),
                    New SqlParameter("@OrdreAffichage", ordre)
                }

                    DbHelper.ExecuteNonQuery(queryLigneDevis, paramsLigne)
                    ordre += 1

                    Console.WriteLine($"Sauvegard√©: {typeLigne} - {rowLigne("Designation")} - {CDec(rowLigne("MontantLigne")):N0}")

                Catch ex As Exception
                    Console.WriteLine($"Erreur sauvegarde ligne: {ex.Message}")
                    Continue For
                End Try
            Next

            Console.WriteLine($"Toutes les lignes sauvegard√©es avec sections (Ordre: {ordre - 1})")

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'enregistrement des lignes : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub btnSupprimerDevis_Click(sender As Object, e As EventArgs) Handles btnSupprimerDevis.Click
        If dgvListeDevis.CurrentRow Is Nothing Then
            MessageBox.Show("Veuillez s√©lectionner un devis √† supprimer.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return
        End If

        If MessageBox.Show("√ätes-vous s√ªr de vouloir supprimer ce devis et toutes ses lignes associ√©es ?", "Confirmer Suppression", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
            Try
                devisID = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)

                Dim query As String = "DELETE FROM Devis WHERE DevisID = @DevisID"
                If DbHelper.ExecuteNonQuery(query, New SqlParameter() {New SqlParameter("@DevisID", devisID)}) > 0 Then
                    MessageBox.Show("Devis supprim√© avec succ√®s.", "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    ViderChamps()
                    ActiverDesactiverControles(False)
                    ChargerDevis()
                End If
            Catch ex As Exception
                MessageBox.Show("Erreur lors de la suppression : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End Try
        End If
    End Sub

    Private Sub btnAnnulerDevis_Click(sender As Object, e As EventArgs) Handles btnAnnulerDevis.Click
        ViderChamps()
        ActiverDesactiverControles(False)
        devisID = 0
    End Sub

    Private Sub ViderChamps()
        txtNumeroChrono.Clear() ' üî• NOUVEAU
        txtNumeroDevis.Clear()
        cmbProjetDevis.SelectedIndex = -1
        dtpDateDevis.Value = Date.Today
        cmbStatutDevis.SelectedIndex = 0
        txtMontantHT.Clear()
        txtMontantEnLettres.Clear()
        txtObjetDevis.Clear()

        txtNumeroAppel.Clear()
        If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()

        TableLignesDevis.Clear()
        RefreshDataGridViewLignes()
        ViderChampsLigneDevis()
        devisID = 0

        ' üî• R√âINITIALISER LES COULEURS
        txtNumeroChrono.BackColor = Color.White
        txtNumeroDevis.BackColor = Color.White
    End Sub

    Private Sub ActiverDesactiverControles(enable As Boolean)
        ' Vos contr√¥les de saisie existants...
        txtNumeroDevis.Enabled = False
        cmbProjetDevis.Enabled = enable
        dtpDateDevis.Enabled = enable
        cmbStatutDevis.Enabled = enable
        txtObjetDevis.Enabled = enable

        txtMontantHT.Enabled = False

        txtMontantEnLettres.Enabled = False

        ' üî• NUM√âROS TOUJOURS EN LECTURE SEULE
        txtNumeroAppel.Enabled = False
        txtNumeroAppel.BackColor = SystemColors.Control

        If txtNumeroProjet IsNot Nothing Then ' üî• NOUVEAU
            txtNumeroProjet.Enabled = False
            txtNumeroProjet.BackColor = Color.LightGray
        End If

        cmbStatutDevis.Enabled = False  ' Toujours d√©sactiv√©, m√™me en mode √©dition

        ' Reste des contr√¥les...
        cmbDesignationLigneDevis.Enabled = enable
        txtUniteLigne.Enabled = enable
        txtQuantiteLigne.Enabled = enable
        txtPrixUnitaireLigne.Enabled = enable
        btnAjouterLigne.Enabled = enable
        btnSupprimerLigne.Enabled = enable
        dgvLignesDevis.Enabled = enable

        txtNumeroChrono.Enabled = enable
        btnEnregistrerDevis.Enabled = enable
        btnAnnulerDevis.Enabled = enable

        btnNouveauDevis.Enabled = Not enable
        btnModifierDevis.Enabled = Not enable
        btnSupprimerDevis.Enabled = False

        ' Gestion des boutons workflow (sans changement)
        If Not enable Then
            If dgvListeDevis.CurrentRow IsNot Nothing Then
                Dim statut As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString()
                GererAutresBoutons(statut)
                GererBoutonCreerFacture()
            Else
                DesactiverTousBoutons()
            End If
        Else
            DesactiverTousBoutons()
        End If

        ' Contr√¥les de recherche
        Dim btnEffacer As Button = TryCast(Me.Controls("btnEffacerRechercheDevis"), Button)
        Dim btnStats As Button = TryCast(Me.Controls("btnStatistiquesDevis"), Button)
        Dim btnFiltre As Button = TryCast(Me.Controls("btnFiltrerStatutDevis"), Button)

        If btnEffacer IsNot Nothing Then btnEffacer.Enabled = Not enable
        If btnStats IsNot Nothing Then btnStats.Enabled = Not enable
        If btnFiltre IsNot Nothing Then btnFiltre.Enabled = Not enable

        If txtRechercheDevis IsNot Nothing Then txtRechercheDevis.Enabled = Not enable
        If txtRechercheAppelProjet IsNot Nothing Then txtRechercheAppelProjet.Enabled = Not enable
        If cmbAppelProjetSelection IsNot Nothing Then cmbAppelProjetSelection.Enabled = Not enable
        GererControlesSection()
        GererEtatBoutonsSections()

    End Sub

    ' REMPLACER votre dgvListeDevis_SelectionChanged par ceci :
    Private Sub dgvListeDevis_SelectionChanged(sender As Object, e As EventArgs) Handles dgvListeDevis.SelectionChanged
        If dgvListeDevis.CurrentRow IsNot Nothing AndAlso Not dgvListeDevis.CurrentRow.IsNewRow AndAlso Not btnEnregistrerDevis.Enabled Then
            Try
                devisID = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)

                ' R√©cup√©rer les informations compl√®tes du devis
                Dim queryObjetActuel As String = "SELECT ObjetDevis FROM Devis WHERE DevisID = @DevisID"
                Dim dtObjet As DataTable = DbHelper.GetData(queryObjetActuel, {New SqlParameter("@DevisID", devisID)})

                Dim objetActuelDevis As String = ""
                If dtObjet.Rows.Count > 0 AndAlso Not IsDBNull(dtObjet.Rows(0)("ObjetDevis")) Then
                    objetActuelDevis = dtObjet.Rows(0)("ObjetDevis").ToString().Trim()
                End If

                ' Charger les autres donn√©es
                Dim dtDevis As DataTable = DbHelper.GetData("
                    SELECT D.*, P.NumeroProjet, AC.NumeroAppel 
                    FROM Devis D 
                    INNER JOIN Projets P ON D.ProjetID = P.ProjetID 
                    LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID 
                    WHERE D.DevisID = @ID",
                    New SqlParameter() {New SqlParameter("@ID", devisID)})

                If dtDevis.Rows.Count > 0 Then
                    Dim row As DataRow = dtDevis.Rows(0)

                    ' Remplir les champs d'affichage
                    txtNumeroDevis.Text = row("NumeroDevis").ToString()

                    ' üî• AFFICHER LE PROJET DANS LA COMBOBOX (LECTURE SEULE)
                    cmbProjetDevis.SelectedValue = CInt(row("ProjetID"))

                    dtpDateDevis.Value = CDate(row("DateDevis"))
                    cmbStatutDevis.SelectedItem = row("StatutDevis").ToString()
                    txtMontantHT.Text = CDec(row("MontantHT")).ToString("N2") & " FCFA"


                    ' Num√©ros
                    If Not IsDBNull(row("NumeroAppel")) Then
                        txtNumeroAppel.Text = row("NumeroAppel").ToString()
                    Else
                        txtNumeroAppel.Clear()
                    End If

                    If txtNumeroProjet IsNot Nothing AndAlso Not IsDBNull(row("NumeroProjet")) Then
                        txtNumeroProjet.Text = row("NumeroProjet").ToString()
                    End If

                    ' Objet depuis la base de donn√©es
                    txtObjetDevis.Text = objetActuelDevis
                    txtObjetDevis.Refresh()
                    Application.DoEvents()

                    Console.WriteLine($"‚úÖ Informations devis affich√©es: {txtNumeroDevis.Text}")

                    ChargerLignesDevisPourAffichage(devisID)

                    ' G√©rer les boutons selon le statut
                    Dim statutActuel As String = row("StatutDevis").ToString()
                    GererAutresBoutons(statutActuel)
                    GererBoutonCreerFacture()
                End If

            Catch ex As Exception
                Console.WriteLine("Erreur lors de la s√©lection : " & ex.Message)
            End Try
        Else
            DesactiverTousBoutons()
        End If
    End Sub
    Private Sub ChargerLignesDevisPourAffichage(devisID As Integer)
        Try
            TableLignesDevis.Clear()

            Dim dtLignesDevis As DataTable = DbHelper.GetData(
        "SELECT LigneDevisID, Designation, Unite, Quantite, PrixUnitaire, MontantLigne, " &
        "ISNULL(TypeLigne, 'LIGNE') as TypeLigne, SectionNom " &
        "FROM LignesDevis WHERE DevisID = @DevisID ORDER BY LigneDevisID",
        New SqlParameter() {New SqlParameter("@DevisID", devisID)})

            For Each ligneRow As DataRow In dtLignesDevis.Rows
                Dim newRow As DataRow = TableLignesDevis.NewRow()
                newRow("Designation") = ligneRow("Designation").ToString()
                newRow("Unite") = If(ligneRow("Unite") Is DBNull.Value, "", ligneRow("Unite").ToString())
                newRow("Quantite") = CDec(ligneRow("Quantite"))
                newRow("PrixUnitaire") = CDec(ligneRow("PrixUnitaire"))
                newRow("MontantLigne") = CDec(ligneRow("MontantLigne"))
                newRow("TacheID") = 0
                newRow("LigneDevisID") = CInt(ligneRow("LigneDevisID"))
                newRow("TypeLigne") = ligneRow("TypeLigne").ToString()
                newRow("SectionNom") = If(IsDBNull(ligneRow("SectionNom")), "", ligneRow("SectionNom").ToString())

                TableLignesDevis.Rows.Add(newRow)
            Next

            RefreshDataGridViewLignes()
            CalculerTotauxDevis()

            ' AJOUTER CES LIGNES POUR FORCER LE SCROLL EN MODE CONSULTATION
            dgvLignesDevis.ScrollBars = ScrollBars.Both
            dgvLignesDevis.AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.None
            dgvLignesDevis.Invalidate()
            dgvLignesDevis.Update()
            Application.DoEvents()

            Console.WriteLine("‚úÖ Barres de d√©filement restaur√©es pour devis en consultation")

        Catch ex As Exception
            Console.WriteLine("Erreur chargement lignes affichage : " & ex.Message)
        End Try
    End Sub
    Private Sub btnDeposerDevis_Click(sender As Object, e As EventArgs) Handles btnDeposerDevis.Click
        If actionEnCours Then Return
        actionEnCours = True

        Try
            If devisID = 0 Then
                MessageBox.Show("Veuillez s√©lectionner un devis √† d√©poser.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim statutActuel As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString().ToUpper()

            If Not (statutActuel = "BROUILLON" OrElse statutActuel.Contains("R√âVISION")) Then
                MessageBox.Show($"‚ùå D√âP√îT NON AUTORIS√â" & vbCrLf & vbCrLf &
                      $"Statut actuel : {statutActuel}" & vbCrLf & vbCrLf &
                      "Seuls les devis 'Brouillon' ou 'R√©vision' peuvent √™tre d√©pos√©s.",
                      "Statut Incorrect", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Using frmDepot As New Form6()
                frmDepot.DevisIDInitial = devisID
                frmDepot.NumeroDevisInitial = txtNumeroDevis.Text

                If frmDepot.ShowDialog() = DialogResult.OK Then
                    ' üî• ACTUALISATION AUTOMATIQUE IMM√âDIATE
                    ActualiserDonneesApresAction("DEPOT", devisID, "D√©pos√©")

                    Dim messageType As String = If(statutActuel.Contains("R√âVISION"), "red√©pos√© apr√®s r√©vision", "d√©pos√©")

                    MessageBox.Show($"‚úÖ Devis {messageType} avec succ√®s !" & vbCrLf &
                          "üìã Statut: D√©pos√©" & vbCrLf &
                          "‚ñ∂Ô∏è Prochaine √©tape: Enregistrer la D√©cision",
                          "Confirmation", MessageBoxButtons.OK, MessageBoxIcon.Information)
                End If
            End Using

        Catch ex As Exception
            MessageBox.Show("Erreur lors du d√©p√¥t : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            actionEnCours = False
        End Try
    End Sub

    Private Sub btnRetourDevis_Click(sender As Object, e As EventArgs) Handles btnRetourDevis.Click
        If actionEnCours Then Return
        actionEnCours = True

        Try
            If devisID = 0 Then
                MessageBox.Show("Veuillez s√©lectionner un devis.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim statutActuel As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString().ToUpper()

            If statutActuel <> "D√âPOS√â" And statutActuel <> "DEPOSE" Then
                MessageBox.Show($"‚ùå RETOUR NON AUTORIS√â" & vbCrLf & vbCrLf &
                      $"Statut actuel : {statutActuel}" & vbCrLf & vbCrLf &
                      "Seuls les devis en statut 'D√©pos√©' peuvent √™tre retourn√©s.",
                      "Statut Incorrect", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Using frmRetour As New Form18()
                frmRetour.DevisIDInitial = devisID
                frmRetour.NumeroDevisInitial = txtNumeroDevis.Text

                If frmRetour.ShowDialog() = DialogResult.OK Then
                    ' üî• R√âCUP√âRER LA D√âCISION CLIENT ET D√âTERMINER LE NOUVEAU STATUT
                    Dim decisionClient As String = ObtenirDecisionClientDepuisRetour(devisID)
                    Dim nouveauStatut As String = ""

                    Select Case decisionClient.ToUpper()
                        Case "ACCEPT√â", "ACCEPTE"
                            nouveauStatut = "Accept√©"
                        Case "R√âVISION", "REVISIONS"
                            nouveauStatut = "R√©vision"
                        Case Else
                            nouveauStatut = "Retourn√©"
                    End Select

                    ' üî• ACTUALISATION AUTOMATIQUE IMM√âDIATE
                    ActualiserDonneesApresAction("RETOUR", devisID, nouveauStatut)

                    ' Message personnalis√© selon la d√©cision
                    Dim messageClient As String = ""
                    Dim prochaineEtape As String = ""

                    Select Case nouveauStatut
                        Case "Accept√©"
                            messageClient = "Client a accept√© le devis"
                            prochaineEtape = "‚ñ∂Ô∏è Prochaine √©tape: Cr√©er la Commande"
                        Case "R√©vision"
                            messageClient = "Client demande des r√©visions"
                            prochaineEtape = "‚ñ∂Ô∏è Prochaine √©tape: Modifier le devis puis le red√©poser"
                        Case Else
                            messageClient = "Retour enregistr√©"
                            prochaineEtape = "‚è≥ En attente de traitement"
                    End Select

                    MessageBox.Show($"‚úÖ Retour enregistr√© avec succ√®s !" & vbCrLf &
                          $"üìã Statut: {nouveauStatut}" & vbCrLf &
                          $"üí¨ {messageClient}" & vbCrLf &
                          prochaineEtape,
                          "Retour Enregistr√©", MessageBoxButtons.OK, MessageBoxIcon.Information)
                End If
            End Using

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'enregistrement du retour : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            actionEnCours = False
        End Try
    End Sub
    Private Function ObtenirDecisionClientDepuisRetour(devisID As Integer) As String
        Try
            Dim query As String = "SELECT TOP 1 DecisionClient FROM RetourDevis WHERE DevisID = @DevisID ORDER BY DateRetour DESC"
            Dim dt As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dt.Rows.Count > 0 AndAlso Not IsDBNull(dt.Rows(0)("DecisionClient")) Then
                Return dt.Rows(0)("DecisionClient").ToString()
            End If

            Return "Retourn√©" ' Par d√©faut

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration d√©cision client: {ex.Message}")
            Return "Retourn√©"
        End Try
    End Function
    ' 7. NOUVELLE M√âTHODE POUR METTRE √Ä JOUR LE STATUT
    Private Sub MettreAJourStatutDevis(devisID As Integer, nouveauStatut As String)
        Try
            Console.WriteLine($"üîÑ Mise √† jour statut devis {devisID} vers '{nouveauStatut}'")

            Dim query As String = "UPDATE Devis SET StatutDevis = @Statut WHERE DevisID = @ID"
            Dim parameters() As SqlParameter = {
                New SqlParameter("@Statut", nouveauStatut),
                New SqlParameter("@ID", devisID)
            }

            Dim rowsAffected As Integer = DbHelper.ExecuteNonQuery(query, parameters)

            If rowsAffected > 0 Then
                Console.WriteLine($"‚úÖ Statut mis √† jour avec succ√®s: Devis {devisID} ‚Üí {nouveauStatut}")
            Else
                Console.WriteLine($"‚ö†Ô∏è Aucune ligne mise √† jour pour le devis {devisID}")
                Throw New Exception("Aucune ligne mise √† jour dans la base de donn√©es")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur mise √† jour statut: {ex.Message}")
            Throw New Exception($"Impossible de mettre √† jour le statut du devis: {ex.Message}")
        End Try
    End Sub

    ' 8. AJOUTER DES BOUTONS POUR BASCULER L'AFFICHAGE DES COLONNES (OPTIONNEL)
    Private Sub btnAfficherColonnesDepot_Click(sender As Object, e As EventArgs)
        AfficherColonnesDepot = Not AfficherColonnesDepot
        AfficherColonnesRetour = False
        ConfigurerColonnesListeDevis()

        Dim btnSender As Button = CType(sender, Button)
        btnSender.Text = If(AfficherColonnesDepot, "Masquer Colonnes D√©p√¥t", "Afficher Colonnes D√©p√¥t")

        Console.WriteLine($"üîÑ Colonnes d√©p√¥t: {If(AfficherColonnesDepot, "Affich√©es", "Masqu√©es")}")
    End Sub

    Private Sub btnAfficherColonnesRetour_Click(sender As Object, e As EventArgs)
        AfficherColonnesRetour = Not AfficherColonnesRetour
        AfficherColonnesDepot = False
        ConfigurerColonnesListeDevis()

        Dim btnSender As Button = CType(sender, Button)
        btnSender.Text = If(AfficherColonnesRetour, "Masquer Colonnes Retour", "Afficher Colonnes Retour")

        Console.WriteLine($"üîÑ Colonnes retour: {If(AfficherColonnesRetour, "Affich√©es", "Masqu√©es")}")
    End Sub

    ' 9. M√âTHODE POUR D√âTECTER AUTOMATIQUEMENT QUELLES COLONNES AFFICHER
    Private Sub DetecterColonnesAfficher()
        Try
            ' Compter les devis avec d√©p√¥t (avec vrais noms de colonnes)
            Dim queryDepot As String = "SELECT COUNT(*) FROM DepotDevis"
            Dim dtDepot As DataTable = DbHelper.GetData(queryDepot, New SqlParameter() {})
            Dim nbDepots As Integer = If(dtDepot.Rows.Count > 0, CInt(dtDepot.Rows(0)(0)), 0)

            ' Compter les devis avec retour
            Dim queryRetour As String = "SELECT COUNT(*) FROM RetourDevis"
            Dim dtRetour As DataTable = DbHelper.GetData(queryRetour, New SqlParameter() {})
            Dim nbRetours As Integer = If(dtRetour.Rows.Count > 0, CInt(dtRetour.Rows(0)(0)), 0)

            ' Afficher les colonnes s'il y a des donn√©es
            AfficherColonnesDepot = (nbDepots > 0)
            AfficherColonnesRetour = (nbRetours > 0)

            Console.WriteLine($"üìä D√©tection auto - D√©p√¥ts: {nbDepots} | Retours: {nbRetours}")
            Console.WriteLine($"üìä Affichage - Colonnes D√©p√¥t: {AfficherColonnesDepot} | Colonnes Retour: {AfficherColonnesRetour}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur d√©tection colonnes: {ex.Message}")
            ' Par d√©faut, ne pas afficher les colonnes en cas d'erreur
            AfficherColonnesDepot = False
            AfficherColonnesRetour = False
        End Try
    End Sub

    Private Sub btnImprimerDevisPDF_Click(sender As Object, e As EventArgs) Handles btnImprimerDevisPDF.Click
        If devisID = 0 Then
            MessageBox.Show("Veuillez s√©lectionner un devis √† imprimer.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            Return
        End If

        Try
            ' üî• UTILISATION DE PATHMANAGER POUR LE DOSSIER D'EXPORT
            Dim dossierExport As String = PathManager.GetExportPath()

            ' G√©n√©rer le nom de fichier
            Dim nomFichier As String = "Devis_" & txtNumeroDevis.Text.Replace("/", "_").Replace(" ", "_") & ".pdf"

            ' Cr√©er le dossier s'il n'existe pas
            If Not Directory.Exists(dossierExport) Then
                Directory.CreateDirectory(dossierExport)
            End If

            ' Dialogue de sauvegarde avec chemin par d√©faut
            Dim sfd As New SaveFileDialog()
            sfd.Filter = "Fichiers PDF (*.pdf)|*.pdf"
            sfd.FileName = nomFichier
            sfd.InitialDirectory = dossierExport ' üî• DOSSIER PAR D√âFAUT VIA PATHMANAGER


            If sfd.ShowDialog() = DialogResult.OK Then
                GenererDevisPDFAvecTemplate(sfd.FileName)
                MessageBox.Show("Le devis PDF a √©t√© g√©n√©r√© avec succ√®s !", "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)

                If MessageBox.Show("Voulez-vous ouvrir le fichier PDF g√©n√©r√© ?", "Ouvrir le fichier", MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
                    Process.Start(sfd.FileName)
                End If
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la g√©n√©ration du PDF : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    Private Sub GenererLignesDevisPDFEnSequence(ByRef cb As PdfContentByte, ByRef mainTable As PdfPTable)
        Try
            Console.WriteLine("G√©n√©ration PDF avec sections s√©quentielles...")

            ' PARCOURIR DANS L'ORDRE : TableLignesDevis contient d√©j√† l'ordre correct
            For Each ligneRow As DataRow In TableLignesDevis.Rows
                Dim typeLigne As String = If(IsDBNull(ligneRow("TypeLigne")), "LIGNE", ligneRow("TypeLigne").ToString())

                If typeLigne = "SECTION" Then
                    ' LIGNE DE SECTION : Afficher le sous-total
                    Dim nomSection As String = ligneRow("Designation").ToString()
                    Dim montantSection As Decimal = CDec(ligneRow("MontantLigne"))

                    AjouterCelluleSousTotal(mainTable, nomSection, montantSection)
                    Console.WriteLine($"PDF Section ajout√©e: {nomSection} = {montantSection:N0} FCFA")

                Else
                    ' LIGNE NORMALE : Afficher les 5 cellules standard
                    AjouterCelluleTableauPerfecte(mainTable, ligneRow("Designation").ToString(), False, False, Element.ALIGN_LEFT)
                    AjouterCelluleTableauPerfecte(mainTable, ligneRow("Unite").ToString(), False, False, Element.ALIGN_CENTER)
                    AjouterCelluleTableauPerfecte(mainTable, CDec(ligneRow("Quantite")).ToString("0.0"), False, False, Element.ALIGN_CENTER)
                    AjouterCelluleTableauPerfecte(mainTable, CDec(ligneRow("PrixUnitaire")).ToString("N0"), False, False, Element.ALIGN_RIGHT)
                    AjouterCelluleTableauPerfecte(mainTable, CDec(ligneRow("MontantLigne")).ToString("N0"), False, False, Element.ALIGN_RIGHT)

                    Console.WriteLine($"PDF Ligne ajout√©e: {ligneRow("Designation")}")
                End If
            Next

            Console.WriteLine("G√©n√©ration PDF termin√©e avec sections dans l'ordre correct")

        Catch ex As Exception
            Console.WriteLine($"Erreur g√©n√©ration PDF s√©quentiel : {ex.Message}")
            MessageBox.Show($"Erreur g√©n√©ration PDF : {ex.Message}", "Erreur PDF", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub ReorganiserLignesParSections()
        Try
            Console.WriteLine("üîÑ === R√âORGANISATION INTELLIGENTE (SANS D√âPLACER LES TITRES) ===")

            ' Cr√©er une table temporaire pour l'ordre correct
            Dim dtTemp As New DataTable()
            For Each column As DataColumn In TableLignesDevis.Columns
                dtTemp.Columns.Add(column.ColumnName, column.DataType)
            Next

            Dim ordre As Integer = 1

            ' ‚úÖ NOUVEAU : Parcourir dans l'ordre d'ajout et grouper SEULEMENT les sections
            Dim lignesTraitees As New HashSet(Of Integer) ' Pour √©viter les doublons

            For rowIndex As Integer = 0 To TableLignesDevis.Rows.Count - 1
                If lignesTraitees.Contains(rowIndex) Then Continue For

                Dim row As DataRow = TableLignesDevis.Rows(rowIndex)
                Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())
                Dim sectionNom As String = If(IsDBNull(row("SectionNom")), "", row("SectionNom").ToString())

                ' ‚úÖ CAS 1 : TITRE - Ajouter imm√©diatement dans l'ordre
                If typeLigne = "TITRE" Then
                    Dim newRow As DataRow = dtTemp.NewRow()
                    For Each column As DataColumn In TableLignesDevis.Columns
                        newRow(column.ColumnName) = row(column.ColumnName)
                    Next
                    newRow("OrdreAffichage") = ordre
                    dtTemp.Rows.Add(newRow)
                    lignesTraitees.Add(rowIndex)
                    ordre += 1
                    Console.WriteLine($"  üìã Titre pr√©serv√© : {row("Designation")}")

                    ' ‚úÖ CAS 2 : LIGNE AVEC SECTION - Traiter toute la section d'un coup
                ElseIf typeLigne = "LIGNE" AndAlso Not String.IsNullOrEmpty(sectionNom) Then
                    ' V√©rifier si cette section n'a pas d√©j√† √©t√© trait√©e
                    Dim sectionDejaTraitee As Boolean = False
                    For Each existingRow As DataRow In dtTemp.Rows
                        If existingRow("TypeLigne").ToString() = "SECTION" AndAlso
                       existingRow("SectionNom").ToString() = sectionNom Then
                            sectionDejaTraitee = True
                            Exit For
                        End If
                    Next

                    If Not sectionDejaTraitee Then
                        Console.WriteLine($"  üì¶ Traitement section : '{sectionNom}'")

                        ' Ajouter toutes les lignes de cette section
                        For i As Integer = 0 To TableLignesDevis.Rows.Count - 1
                            Dim ligneRow As DataRow = TableLignesDevis.Rows(i)
                            If ligneRow("SectionNom").ToString() = sectionNom AndAlso
                           ligneRow("TypeLigne").ToString() = "LIGNE" Then

                                Dim newRow As DataRow = dtTemp.NewRow()
                                For Each column As DataColumn In TableLignesDevis.Columns
                                    newRow(column.ColumnName) = ligneRow(column.ColumnName)
                                Next
                                newRow("OrdreAffichage") = ordre
                                dtTemp.Rows.Add(newRow)
                                lignesTraitees.Add(i)
                                ordre += 1
                                Console.WriteLine($"    ‚úÖ Ligne : {ligneRow("Designation")}")
                            End If
                        Next

                        ' Ajouter le sous-total de la section
                        For i As Integer = 0 To TableLignesDevis.Rows.Count - 1
                            Dim sectionRow As DataRow = TableLignesDevis.Rows(i)
                            If sectionRow("TypeLigne").ToString() = "SECTION" AndAlso
                           sectionRow("SectionNom").ToString() = sectionNom Then

                                Dim newRow As DataRow = dtTemp.NewRow()
                                For Each column As DataColumn In TableLignesDevis.Columns
                                    newRow(column.ColumnName) = sectionRow(column.ColumnName)
                                Next
                                newRow("OrdreAffichage") = ordre
                                dtTemp.Rows.Add(newRow)
                                lignesTraitees.Add(i)
                                ordre += 1
                                Console.WriteLine($"    üìä Sous-total : {sectionRow("MontantLigne"):N0} FCFA")
                                Exit For
                            End If
                        Next
                    End If

                    ' ‚úÖ CAS 3 : LIGNE LIBRE (sans section) - Ajouter dans l'ordre
                ElseIf typeLigne = "LIGNE" AndAlso String.IsNullOrEmpty(sectionNom) Then
                    Dim newRow As DataRow = dtTemp.NewRow()
                    For Each column As DataColumn In TableLignesDevis.Columns
                        newRow(column.ColumnName) = row(column.ColumnName)
                    Next
                    newRow("OrdreAffichage") = ordre
                    dtTemp.Rows.Add(newRow)
                    lignesTraitees.Add(rowIndex)
                    ordre += 1
                    Console.WriteLine($"  üÜì Ligne libre : {row("Designation")}")
                End If
            Next

            ' Remplacer la table originale
            TableLignesDevis = dtTemp

            Console.WriteLine($"‚úÖ R√©organisation termin√©e : {ordre - 1} lignes - ORDRE PR√âSERV√â")
            Console.WriteLine("üîÑ === FIN R√âORGANISATION ===")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©organisation : {ex.Message}")
        End Try
    End Sub
    ' ===============================================================================
    ' M√âTHODE COMPL√àTE OPTIMIS√âE - GenererDevisPDFAvecTemplate
    ' LOGIQUE UNIFI√âE : M√™me technique parfaite pour TOUTES les pages
    ' ‚úÖ CORRECTION : Utilisation de la hauteur R√âELLE du tableau (pas d'estimation)
    ' ===============================================================================

    Private Sub GenererDevisPDFAvecTemplate(cheminFichier As String)
        Dim templatePath As String = GetTemplatePath()
        If Not File.Exists(templatePath) Then
            MessageBox.Show($"Le fichier template n'existe pas √† l'emplacement : {templatePath}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Return
        End If

        Try
            Using templateReader As New PdfReader(templatePath)
                Using outputStream As New FileStream(cheminFichier, FileMode.Create)
                    Using stamper As New PdfStamper(templateReader, outputStream)
                        Dim cb As PdfContentByte = stamper.GetOverContent(1)

                        Dim fontNormal As BaseFont = BaseFont.CreateFont(BaseFont.HELVETICA, BaseFont.CP1252, BaseFont.NOT_EMBEDDED)
                        Dim fontBold As BaseFont = BaseFont.CreateFont(BaseFont.HELVETICA_BOLD, BaseFont.CP1252, BaseFont.NOT_EMBEDDED)
                        Dim fontItalic As BaseFont = BaseFont.CreateFont(BaseFont.HELVETICA_OBLIQUE, BaseFont.CP1252, BaseFont.NOT_EMBEDDED)
                        Dim fontBoldItalic As BaseFont = BaseFont.CreateFont(BaseFont.HELVETICA_BOLDOBLIQUE, BaseFont.CP1252, BaseFont.NOT_EMBEDDED)

                        ' Police Bahnschrift pour les infos client et date
                        Dim fontBahnschriftItalic As BaseFont
                        Dim fontBahnschriftBoldItalic As BaseFont
                        Try
                            fontBahnschriftItalic = BaseFont.CreateFont("bahnschrift", BaseFont.CP1252, BaseFont.NOT_EMBEDDED)
                            fontBahnschriftBoldItalic = BaseFont.CreateFont("bahnschrift", BaseFont.CP1252, BaseFont.NOT_EMBEDDED)
                        Catch
                            fontBahnschriftItalic = fontItalic
                            fontBahnschriftBoldItalic = fontBoldItalic
                        End Try

                        Dim nombreTotalLignes As Integer = TableLignesDevis.Rows.Count
                        Dim fontSizeNormal As Single = CalculerTaillePolice(nombreTotalLignes)
                        Dim fontSizeLarge As Single = fontSizeNormal + 1
                        Dim fontSizeClient As Single = fontSizeLarge
                        Dim fontSizeTableau As Single = 9

                        Console.WriteLine($"PDF Adaptatif - {nombreTotalLignes} lignes, Police {fontSizeNormal}pt")

                        Dim infosClient() As String = ObtenirInformationsClient(devisID)

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 1Ô∏è‚É£ DATE (Y = 700)
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        Dim dateY As Single = 700.0F
                        Dim yPosClientStart As Single = 665.0F
                        Dim xPosInfosClient As Single = PageSize.A4.Width - 50 - 226.78F

                        Dim dateTexte As String = "Abidjan le " & dtpDateDevis.Value.ToString("dd MMMM yyyy", New CultureInfo("fr-FR"))

                        cb.BeginText()
                        cb.SetFontAndSize(fontBahnschriftItalic, fontSizeClient)
                        cb.SetColorFill(BaseColor.BLACK)
                        cb.SetTextMatrix(xPosInfosClient, dateY)
                        cb.ShowText(dateTexte)
                        cb.EndText()

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 2Ô∏è‚É£ INFORMATIONS CLIENT (Y = 665)
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        If Not String.IsNullOrWhiteSpace(infosClient(0)) Then
                            cb.BeginText()
                            cb.SetFontAndSize(fontBahnschriftBoldItalic, fontSizeClient)
                            cb.SetColorFill(BaseColor.BLACK)
                            cb.SetTextMatrix(xPosInfosClient, yPosClientStart)
                            cb.ShowText(infosClient(0))
                            cb.EndText()
                        End If

                        Dim currentClientLineY As Single = yPosClientStart

                        If Not String.IsNullOrWhiteSpace(infosClient(1)) Then
                            currentClientLineY -= 15
                            cb.BeginText()
                            cb.SetFontAndSize(fontBahnschriftItalic, fontSizeClient)
                            cb.SetColorFill(BaseColor.BLACK)
                            cb.SetTextMatrix(xPosInfosClient, currentClientLineY)
                            cb.ShowText(infosClient(1))
                            cb.EndText()
                        End If

                        If Not String.IsNullOrWhiteSpace(infosClient(2)) Then
                            currentClientLineY -= 15
                            Dim telFormate As String = "T√©l. " & FormatTelephone(infosClient(2))
                            cb.BeginText()
                            cb.SetFontAndSize(fontBahnschriftItalic, fontSizeClient)
                            cb.SetColorFill(BaseColor.BLACK)
                            cb.SetTextMatrix(xPosInfosClient, currentClientLineY)
                            cb.ShowText(telFormate)
                            cb.EndText()
                        End If

                        If Not String.IsNullOrWhiteSpace(infosClient(4)) Then
                            currentClientLineY -= 15
                            Dim ccText As String = infosClient(4)
                            If Not ccText.StartsWith("CC N¬∞ ") Then ccText = "CC N¬∞ " & ccText
                            cb.BeginText()
                            cb.SetFontAndSize(fontBahnschriftItalic, fontSizeClient)
                            cb.SetColorFill(BaseColor.BLACK)
                            cb.SetTextMatrix(xPosInfosClient, currentClientLineY)
                            cb.ShowText(ccText)
                            cb.EndText()
                        End If

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 3Ô∏è‚É£ NUM√âRO DE DEVIS (Y = 580)
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        cb.BeginText()
                        cb.SetFontAndSize(fontBoldItalic, fontSizeLarge)
                        cb.SetColorFill(BaseColor.BLACK)
                        cb.SetTextMatrix(50, 580)
                        cb.ShowText("DEVIS: " & txtNumeroDevis.Text)
                        cb.EndText()

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 4Ô∏è‚É£ OBJET DU DEVIS (Y = 567 - ‚úÖ RAPPROCH√â)
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        If Not String.IsNullOrWhiteSpace(txtObjetDevis.Text) Then
                            Dim objetTexte As String = "OBJET: " & txtObjetDevis.Text
                            Dim largeurMaxObjet As Single = PageSize.A4.Width - 100
                            Dim largeurObjet As Single = fontItalic.GetWidthPoint(objetTexte, fontSizeNormal)

                            If largeurObjet <= largeurMaxObjet Then
                                cb.BeginText()
                                cb.SetFontAndSize(fontItalic, fontSizeNormal)
                                cb.SetColorFill(BaseColor.BLACK)
                                cb.SetTextMatrix(50, 567)  ' ‚úÖ CHANG√â de 560 ‚Üí 567
                                cb.ShowText(objetTexte)
                                cb.EndText()
                            Else
                                ' Gestion multiligne objet
                                Dim prefixe As String = "OBJET: "
                                Dim texteObjet As String = txtObjetDevis.Text
                                Dim largeurPrefix As Single = fontItalic.GetWidthPoint(prefixe, fontSizeNormal)
                                Dim largeurDisponible As Single = largeurMaxObjet - largeurPrefix

                                cb.BeginText()
                                cb.SetFontAndSize(fontItalic, fontSizeNormal)
                                cb.SetColorFill(BaseColor.BLACK)
                                cb.SetTextMatrix(50, 567)  ' ‚úÖ CHANG√â de 560 ‚Üí 567
                                cb.ShowText(prefixe)
                                cb.EndText()

                                Dim mots() As String = texteObjet.Split(" "c)
                                Dim ligneTexteActuelle As String = ""
                                Dim yPosition As Single = 567  ' ‚úÖ CHANG√â de 560 ‚Üí 567
                                Dim premiereLigne As Boolean = True

                                For Each mot As String In mots
                                    Dim testTexte As String = If(String.IsNullOrEmpty(ligneTexteActuelle), mot, ligneTexteActuelle & " " & mot)
                                    Dim largeurTest As Single = fontItalic.GetWidthPoint(testTexte, fontSizeNormal)
                                    Dim largeurMax As Single = If(premiereLigne, largeurDisponible, largeurMaxObjet - 50)

                                    If largeurTest <= largeurMax Then
                                        ligneTexteActuelle = testTexte
                                    Else
                                        cb.BeginText()
                                        cb.SetFontAndSize(fontItalic, fontSizeNormal)
                                        cb.SetColorFill(BaseColor.BLACK)
                                        If premiereLigne Then
                                            cb.SetTextMatrix(50 + largeurPrefix, yPosition)
                                            premiereLigne = False
                                        Else
                                            cb.SetTextMatrix(50, yPosition)
                                        End If
                                        cb.ShowText(ligneTexteActuelle)
                                        cb.EndText()

                                        yPosition -= 12
                                        ligneTexteActuelle = mot
                                    End If
                                Next

                                If Not String.IsNullOrEmpty(ligneTexteActuelle) Then
                                    cb.BeginText()
                                    cb.SetFontAndSize(fontItalic, fontSizeNormal)
                                    cb.SetColorFill(BaseColor.BLACK)
                                    If premiereLigne Then
                                        cb.SetTextMatrix(50 + largeurPrefix, yPosition)
                                    Else
                                        cb.SetTextMatrix(50, yPosition)
                                    End If
                                    cb.ShowText(ligneTexteActuelle)
                                    cb.EndText()
                                End If
                            End If
                        End If

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 5Ô∏è‚É£ TABLEAU DES LIGNES - ‚úÖ √âLARGI
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        Dim tableYPosition As Single = 535
                        Dim lignesParPage As Integer = 29
                        Dim ligneActuelle As Integer = 0
                        Dim pageActuelle As Integer = 1

                        ' Cr√©er le tableau initial - ‚úÖ √âLARGI
                        Dim mainTable As New PdfPTable(5)
                        mainTable.TotalWidth = 520  ' ‚úÖ CHANG√â de 500 ‚Üí 520
                        mainTable.LockedWidth = True
                        mainTable.SetWidths({300, 35, 50, 65, 70})  ' ‚úÖ NOUVELLES LARGEURS

                        Dim couleurGriseEntete As New BaseColor(240, 240, 240)

                        ' En-t√™te du tableau sur la premi√®re page
                        AjouterCelluleTableauPerfecte(mainTable, "DESIGNATION", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)
                        AjouterCelluleTableauPerfecte(mainTable, "U", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)
                        AjouterCelluleTableauPerfecte(mainTable, "QTE", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)
                        AjouterCelluleTableauPerfecte(mainTable, "PU", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)

                        Dim fontMontant As Font = FontFactory.GetFont(FontFactory.HELVETICA_BOLD, 9, BaseColor.BLACK)
                        Dim cellMontant As New PdfPCell(New Phrase("MONTANT" & vbLf & "TOTAL (FCFA)", fontMontant))

                        With cellMontant
                            .HorizontalAlignment = Element.ALIGN_CENTER
                            .VerticalAlignment = Element.ALIGN_MIDDLE
                            .BackgroundColor = couleurGriseEntete
                            .Border = Rectangle.BOX
                            .BorderWidth = 0.5F
                            .BorderColor = BaseColor.BLACK
                            .Padding = 2
                            .FixedHeight = 25.0F
                            .NoWrap = True
                        End With

                        mainTable.AddCell(cellMontant)

                        ' TRAITEMENT S√âQUENTIEL DES LIGNES AVEC SECTIONS
                        For Each ligneRow As DataRow In TableLignesDevis.Rows
                            If ligneActuelle >= lignesParPage Then
                                ' Dessiner le tableau de la page actuelle
                                mainTable.WriteSelectedRows(0, -1, 50, tableYPosition, If(pageActuelle = 1, cb, stamper.GetOverContent(pageActuelle)))

                                ' Nouvelle page
                                pageActuelle += 1
                                ligneActuelle = 0

                                If pageActuelle > stamper.Reader.NumberOfPages Then
                                    stamper.InsertPage(pageActuelle, templateReader.GetPageSize(1))
                                    Dim templatePage As PdfImportedPage = stamper.GetImportedPage(templateReader, 1)
                                    Dim cbTemplate As PdfContentByte = stamper.GetUnderContent(pageActuelle)
                                    cbTemplate.AddTemplate(templatePage, 0, 0)
                                End If

                                Dim cbNouvellePage As PdfContentByte = stamper.GetOverContent(pageActuelle)

                                ' DEVIS en gras italique sur nouvelle page
                                cbNouvellePage.BeginText()
                                cbNouvellePage.SetFontAndSize(fontBoldItalic, fontSizeLarge)
                                cbNouvellePage.SetColorFill(BaseColor.BLACK)
                                cbNouvellePage.SetTextMatrix(50, 580)
                                cbNouvellePage.ShowText("DEVIS: " & txtNumeroDevis.Text & " (Suite)")
                                cbNouvellePage.EndText()

                                ' OBJET en italique sur nouvelle page - ‚úÖ RAPPROCH√â
                                If Not String.IsNullOrWhiteSpace(txtObjetDevis.Text) Then
                                    Dim objetTexte As String = "OBJET: " & txtObjetDevis.Text
                                    Dim largeurMaxObjet As Single = PageSize.A4.Width - 100
                                    Dim largeurObjet As Single = fontItalic.GetWidthPoint(objetTexte, fontSizeNormal)

                                    If largeurObjet <= largeurMaxObjet Then
                                        cbNouvellePage.BeginText()
                                        cbNouvellePage.SetFontAndSize(fontItalic, fontSizeNormal)
                                        cbNouvellePage.SetColorFill(BaseColor.BLACK)
                                        cbNouvellePage.SetTextMatrix(50, 567)  ' ‚úÖ CHANG√â de 560 ‚Üí 567
                                        cbNouvellePage.ShowText(objetTexte)
                                        cbNouvellePage.EndText()
                                    Else
                                        ' Gestion multiligne objet page 2+
                                        Dim prefixe As String = "OBJET: "
                                        Dim texteObjet As String = txtObjetDevis.Text
                                        Dim largeurPrefix As Single = fontItalic.GetWidthPoint(prefixe, fontSizeNormal)
                                        Dim largeurDisponible As Single = largeurMaxObjet - largeurPrefix

                                        cbNouvellePage.BeginText()
                                        cbNouvellePage.SetFontAndSize(fontItalic, fontSizeNormal)
                                        cbNouvellePage.SetColorFill(BaseColor.BLACK)
                                        cbNouvellePage.SetTextMatrix(50, 567)  ' ‚úÖ CHANG√â de 560 ‚Üí 567
                                        cbNouvellePage.ShowText(prefixe)
                                        cbNouvellePage.EndText()

                                        Dim mots() As String = texteObjet.Split(" "c)
                                        Dim ligneTexteActuelle As String = ""
                                        Dim yPosition As Single = 567  ' ‚úÖ CHANG√â de 560 ‚Üí 567
                                        Dim premiereLigne As Boolean = True

                                        For Each mot As String In mots
                                            Dim testTexte As String = If(String.IsNullOrEmpty(ligneTexteActuelle), mot, ligneTexteActuelle & " " & mot)
                                            Dim largeurTest As Single = fontItalic.GetWidthPoint(testTexte, fontSizeNormal)
                                            Dim largeurMax As Single = If(premiereLigne, largeurDisponible, largeurMaxObjet - 50)

                                            If largeurTest <= largeurMax Then
                                                ligneTexteActuelle = testTexte
                                            Else
                                                cbNouvellePage.BeginText()
                                                cbNouvellePage.SetFontAndSize(fontItalic, fontSizeNormal)
                                                cbNouvellePage.SetColorFill(BaseColor.BLACK)
                                                If premiereLigne Then
                                                    cbNouvellePage.SetTextMatrix(50 + largeurPrefix, yPosition)
                                                    premiereLigne = False
                                                Else
                                                    cbNouvellePage.SetTextMatrix(50, yPosition)
                                                End If
                                                cbNouvellePage.ShowText(ligneTexteActuelle)
                                                cbNouvellePage.EndText()

                                                yPosition -= 12
                                                ligneTexteActuelle = mot
                                            End If
                                        Next

                                        If Not String.IsNullOrEmpty(ligneTexteActuelle) Then
                                            cbNouvellePage.BeginText()
                                            cbNouvellePage.SetFontAndSize(fontItalic, fontSizeNormal)
                                            cbNouvellePage.SetColorFill(BaseColor.BLACK)
                                            If premiereLigne Then
                                                cbNouvellePage.SetTextMatrix(50 + largeurPrefix, yPosition)
                                            Else
                                                cbNouvellePage.SetTextMatrix(50, yPosition)
                                            End If
                                            cbNouvellePage.ShowText(ligneTexteActuelle)
                                            cbNouvellePage.EndText()
                                        End If
                                    End If
                                End If

                                ' üî• Recr√©er le tableau √âLARGI sur nouvelle page
                                mainTable = New PdfPTable(5)
                                mainTable.TotalWidth = 520  ' ‚úÖ CHANG√â de 500 ‚Üí 520
                                mainTable.LockedWidth = True
                                mainTable.SetWidths({300, 35, 50, 65, 70})  ' ‚úÖ M√äMES LARGEURS

                                AjouterCelluleTableauPerfecte(mainTable, "DESIGNATION", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)
                                AjouterCelluleTableauPerfecte(mainTable, "U", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)
                                AjouterCelluleTableauPerfecte(mainTable, "QT√â", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)
                                AjouterCelluleTableauPerfecte(mainTable, "PU", True, True, Element.ALIGN_CENTER, False, couleurGriseEntete)

                                Dim fontMontant2 As Font = FontFactory.GetFont(FontFactory.HELVETICA_BOLD, 9, BaseColor.BLACK)
                                Dim cellMontant2 As New PdfPCell(New Phrase("MONTANT" & vbCrLf & "TOTAL (FCFA)", fontMontant2))

                                With cellMontant2
                                    .HorizontalAlignment = Element.ALIGN_CENTER
                                    .VerticalAlignment = Element.ALIGN_MIDDLE
                                    .BackgroundColor = couleurGriseEntete
                                    .Border = Rectangle.BOX
                                    .BorderWidth = 0.5F
                                    .BorderColor = BaseColor.BLACK
                                    .Padding = 2
                                    .FixedHeight = 25.0F
                                    .NoWrap = True
                                End With

                                mainTable.AddCell(cellMontant2)

                                ' üî• GARDER LA M√äME POSITION Y
                                tableYPosition = 535
                            End If

                            ' R√©cup√©ration du type de ligne
                            Dim typeLigne As String = If(IsDBNull(ligneRow("TypeLigne")), "LIGNE", ligneRow("TypeLigne").ToString())

                            ' Gestion TITRE
                            If typeLigne = "TITRE" Then
                                AjouterCelluleTitre(mainTable, ligneRow("Designation").ToString())
                                Console.WriteLine($"PDF Titre : {ligneRow("Designation")}")
                                ligneActuelle += 1

                                ' Gestion SECTION
                            ElseIf typeLigne = "SECTION" Then
                                Dim nomSection As String = ligneRow("Designation").ToString()
                                Dim montantSection As Decimal = CDec(ligneRow("MontantLigne"))

                                AjouterCelluleSousTotal(mainTable, nomSection, montantSection)
                                Console.WriteLine($"PDF Section ajout√©e: {nomSection} = {montantSection:N0} FCFA")
                                ligneActuelle += 1

                                ' Gestion LIGNE NORMALE
                            Else
                                AjouterCelluleTableauPerfecte(mainTable, ligneRow("Designation").ToString(), False, False, Element.ALIGN_LEFT)
                                AjouterCelluleTableauPerfecte(mainTable, ligneRow("Unite").ToString(), False, False, Element.ALIGN_CENTER)
                                AjouterCelluleTableauPerfecte(mainTable, CDec(ligneRow("Quantite")).ToString("0.0", New CultureInfo("fr-FR")), False, False, Element.ALIGN_CENTER)
                                AjouterCelluleTableauPerfecte(mainTable, CDec(ligneRow("PrixUnitaire")).ToString("N0", New CultureInfo("fr-FR")), False, False, Element.ALIGN_RIGHT)
                                AjouterCelluleTableauPerfecte(mainTable, CDec(ligneRow("MontantLigne")).ToString("N0", New CultureInfo("fr-FR")), False, False, Element.ALIGN_RIGHT)

                                Console.WriteLine($"PDF Ligne ajout√©e: {ligneRow("Designation")}")
                                ligneActuelle += 1
                            End If
                        Next

                        ' Ajouter la ligne de total
                        Dim cellMontantTotalHTLabel As New PdfPCell(New Phrase("MONTANT TOTAL HT", FontFactory.GetFont(FontFactory.HELVETICA_BOLD, 9, BaseColor.BLACK)))
                        cellMontantTotalHTLabel.Colspan = 4
                        cellMontantTotalHTLabel.HorizontalAlignment = Element.ALIGN_CENTER
                        cellMontantTotalHTLabel.BackgroundColor = BaseColor.WHITE
                        cellMontantTotalHTLabel.Border = Rectangle.BOX
                        cellMontantTotalHTLabel.BorderWidth = 0.5F
                        cellMontantTotalHTLabel.BorderColor = BaseColor.BLACK
                        cellMontantTotalHTLabel.Padding = 2
                        mainTable.AddCell(cellMontantTotalHTLabel)

                        Dim montantHTCorrect As Decimal = 0
                        For Each row As DataRow In TableLignesDevis.Rows
                            Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())
                            If typeLigne = "SECTION" Then Continue For
                            If typeLigne = "LIGNE" Then
                                montantHTCorrect += CDec(row("MontantLigne"))
                            End If
                        Next

                        Dim cellMontantTotalHTValue As New PdfPCell(New Phrase(montantHTCorrect.ToString("N0", New CultureInfo("fr-FR")), FontFactory.GetFont(FontFactory.HELVETICA_BOLD, 9, BaseColor.BLACK)))
                        cellMontantTotalHTValue.HorizontalAlignment = Element.ALIGN_RIGHT
                        cellMontantTotalHTValue.BackgroundColor = BaseColor.WHITE
                        cellMontantTotalHTValue.Border = Rectangle.BOX
                        cellMontantTotalHTValue.BorderWidth = 0.5F
                        cellMontantTotalHTValue.BorderColor = BaseColor.BLACK
                        cellMontantTotalHTValue.Padding = 2
                        mainTable.AddCell(cellMontantTotalHTValue)

                        ' Dessiner le tableau final
                        Dim cbDernierePage As PdfContentByte = If(pageActuelle = 1, cb, stamper.GetOverContent(pageActuelle))
                        mainTable.WriteSelectedRows(0, -1, 50, tableYPosition, cbDernierePage)

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 6Ô∏è‚É£ MONTANT EN LETTRES - ‚úÖ CALCUL AVEC HAUTEUR R√âELLE DU TABLEAU
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        ' üî• OBTENIR LA VRAIE HAUTEUR du tableau
                        Dim hauteurReelleTableau As Single = mainTable.TotalHeight

                        ' Espacement adaptatif selon le nombre de lignes
                        Dim espacementAdaptatif As Single
                        Select Case ligneActuelle
                            Case Is <= 15
                                espacementAdaptatif = 35
                            Case 16 To 25
                                espacementAdaptatif = 30
                            Case 26 To 35
                                espacementAdaptatif = 25
                            Case Else
                                espacementAdaptatif = 20
                        End Select

                        ' üî• CALCUL bas√© sur la hauteur R√âELLE
                        Dim yPosMontantLettres As Single = tableYPosition - hauteurReelleTableau - espacementAdaptatif
                        yPosMontantLettres = Math.Max(100, yPosMontantLettres)

                        Console.WriteLine($"üìÑ Page {pageActuelle}: Lignes={ligneActuelle}, HauteurR√©elle={hauteurReelleTableau:F1}, Y={yPosMontantLettres:F1}")

                        ' MONTANT EN LETTRES - ‚úÖ PR√âFIXE COMPLET CONSERV√â
                        Dim prefixeTexte As String = "Arr√™t√© le pr√©sent devis √† la Somme de: "
                        Dim montantEnLettresTexte As String = ConvertirMontantEnLettres(montantHTCorrect)

                        Dim largeurTextePrefix As Single = fontItalic.GetWidthPoint(prefixeTexte, fontSizeNormal)
                        Dim largeurMontantLettres As Single = fontBoldItalic.GetWidthPoint(montantEnLettresTexte, fontSizeNormal)
                        Dim largeurPageUtilisable As Single = PageSize.A4.Width - 100
                        Dim largeurRestante As Single = largeurPageUtilisable - largeurTextePrefix

                        cbDernierePage.BeginText()
                        cbDernierePage.SetFontAndSize(fontItalic, fontSizeNormal)
                        cbDernierePage.SetColorFill(BaseColor.BLACK)
                        cbDernierePage.SetTextMatrix(50, yPosMontantLettres)
                        cbDernierePage.ShowText(prefixeTexte)
                        cbDernierePage.EndText()

                        If largeurMontantLettres <= largeurRestante Then
                            cbDernierePage.BeginText()
                            cbDernierePage.SetFontAndSize(fontBoldItalic, fontSizeNormal)
                            cbDernierePage.SetColorFill(BaseColor.BLACK)
                            cbDernierePage.SetTextMatrix(50 + largeurTextePrefix, yPosMontantLettres)
                            cbDernierePage.ShowText(montantEnLettresTexte)
                            cbDernierePage.EndText()
                        Else
                            ' Gestion multiligne
                            Dim mots() As String = montantEnLettresTexte.Split(" "c)
                            Dim premierePartie As String = ""
                            Dim deuxiemePartie As String = montantEnLettresTexte

                            For i As Integer = 0 To mots.Length - 1
                                Dim testTexte As String = If(String.IsNullOrEmpty(premierePartie), mots(i), premierePartie & " " & mots(i))
                                Dim largeurTest As Single = fontBoldItalic.GetWidthPoint(testTexte, fontSizeNormal)

                                If largeurTest <= largeurRestante Then
                                    premierePartie = testTexte
                                Else
                                    deuxiemePartie = String.Join(" ", mots.Skip(If(String.IsNullOrEmpty(premierePartie), i, i)).ToArray())
                                    Exit For
                                End If

                                If i = mots.Length - 1 Then deuxiemePartie = ""
                            Next

                            If String.IsNullOrEmpty(premierePartie) AndAlso mots.Length > 0 Then
                                premierePartie = mots(0)
                                deuxiemePartie = String.Join(" ", mots.Skip(1).ToArray())
                            End If

                            If Not String.IsNullOrEmpty(premierePartie) Then
                                cbDernierePage.BeginText()
                                cbDernierePage.SetFontAndSize(fontBoldItalic, fontSizeNormal)
                                cbDernierePage.SetColorFill(BaseColor.BLACK)
                                cbDernierePage.SetTextMatrix(50 + largeurTextePrefix, yPosMontantLettres)
                                cbDernierePage.ShowText(premierePartie)
                                cbDernierePage.EndText()
                            End If

                            If Not String.IsNullOrEmpty(deuxiemePartie) Then
                                cbDernierePage.BeginText()
                                cbDernierePage.SetFontAndSize(fontBoldItalic, fontSizeNormal)
                                cbDernierePage.SetColorFill(BaseColor.BLACK)
                                cbDernierePage.SetTextMatrix(50, yPosMontantLettres - 15)
                                cbDernierePage.ShowText(deuxiemePartie)
                                cbDernierePage.EndText()
                            End If
                        End If

                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        ' 7Ô∏è‚É£ SIGNATURE - POSITION FIXE EN PIED DE PAGE (comme avec 29 lignes)
                        ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        ' Position absolue en pied de page (comme quand il y a 29 lignes compl√®tes)
                        Dim yPosSignature As Single = 65  ' Position fixe en pied de page au lieu de 80-70

                        cbDernierePage.BeginText()
                        Dim taillePoliceSignature As Single = Math.Max(9.0F, fontSizeNormal + 1)
                        cbDernierePage.SetFontAndSize(fontBold, taillePoliceSignature)
                        cbDernierePage.SetColorFill(BaseColor.BLACK)
                        cbDernierePage.SetTextMatrix(420, yPosSignature)
                        cbDernierePage.ShowText("V√©ronique KOUAME AKE")
                        cbDernierePage.EndText()

                        Console.WriteLine($"‚úÖ PDF optimis√© g√©n√©r√© - Position signature fixe:")
                        Console.WriteLine($"   - {pageActuelle} page(s)")
                        Console.WriteLine($"   - Derni√®re page: {ligneActuelle} lignes")
                        Console.WriteLine($"   - Hauteur tableau: {hauteurReelleTableau:F1} points")
                        Console.WriteLine($"   - Position montant: Y={yPosMontantLettres:F1}")
                        Console.WriteLine($"   - Position signature: Y={yPosSignature:F1} (FIXE)")
                    End Using
                End Using
            End Using

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la g√©n√©ration du PDF : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine("D√©tail de l'erreur PDF : " & ex.ToString())
        End Try
    End Sub
    Private Function CalculerHauteurLigneEstimee() As Single
        Return 14  ' üî• R√âDUIT : 18 ‚Üí 14
    End Function

    ' ‚≠ê M√âTHODE AM√âLIOR√âE pour les cellules du tableau avec gestion du NoWrap
    Private Sub AjouterCelluleTableauPerfecte(table As PdfPTable, texte As String, estGras As Boolean, estEntete As Boolean, alignement As Integer, Optional avecCouleur As Boolean = False, Optional couleurFond As BaseColor = Nothing)
        Dim fontSizeTableau As Single = 9  ' üî• Police r√©duite

        Dim police As Font = If(estGras,
        FontFactory.GetFont(FontFactory.HELVETICA_BOLD, fontSizeTableau, BaseColor.BLACK),
        FontFactory.GetFont(FontFactory.HELVETICA, fontSizeTableau, BaseColor.BLACK))

        Dim cell As New PdfPCell(New Phrase(texte, police))
        cell.HorizontalAlignment = alignement
        cell.Border = Rectangle.BOX
        cell.BorderWidth = 0.5F
        cell.BorderColor = BaseColor.BLACK
        cell.Padding = 2  ' üî• R√âDUIT : 4 ‚Üí 2

        ' üî• CHANGEMENT : Utiliser la couleur grise au lieu du bleu ciel
        Dim couleurGriseEntete As New BaseColor(240, 240, 240)

        If avecCouleur AndAlso couleurFond IsNot Nothing Then
            cell.BackgroundColor = couleurFond
        ElseIf estEntete Then
            cell.BackgroundColor = couleurGriseEntete  ' üî• GRIS au lieu de bleu ciel
        Else
            cell.BackgroundColor = BaseColor.WHITE
        End If

        table.AddCell(cell)
    End Sub
    ' üî• NOUVELLE M√âTHODE : D√©coupage intelligent du texte
    Private Function DecouperTexteIntelligent(texte As String, maxCaracteres As Integer) As String
        Try
            If String.IsNullOrWhiteSpace(texte) OrElse texte.Length <= maxCaracteres Then
                Return texte
            End If

            ' Chercher un point de coupure intelligent (espace, virgule, point)
            Dim pointsCoupure As Char() = {" "c, ","c, "."c, ";"c, "-"c}

            For i As Integer = maxCaracteres To Math.Max(1, maxCaracteres - 20) Step -1
                If pointsCoupure.Contains(texte(i - 1)) Then
                    ' D√©couper avec retour √† la ligne
                    Dim partie1 As String = texte.Substring(0, i).Trim()
                    Dim partie2 As String = texte.Substring(i).Trim()

                    ' Limiter la deuxi√®me partie si elle est encore trop longue
                    If partie2.Length > maxCaracteres Then
                        partie2 = partie2.Substring(0, maxCaracteres - 3) + "..."
                    End If

                    Return partie1 + vbLf + partie2
                End If
            Next

            ' Si pas de point de coupure trouv√©, couper brutalement
            Return texte.Substring(0, maxCaracteres - 3) + "..."

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur d√©coupage texte: {ex.Message}")
            Return texte
        End Try
    End Function

    Private Sub btnRetour_Click(sender As Object, e As EventArgs)
        Me.Close()
    End Sub

    Private Sub dgvListeDevis_CellDoubleClick(sender As Object, e As DataGridViewCellEventArgs) Handles dgvListeDevis.CellDoubleClick
        ' V√©rifier qu'on a cliqu√© sur une ligne valide (pas sur l'en-t√™te)
        If e.RowIndex >= 0 AndAlso e.RowIndex < dgvListeDevis.Rows.Count Then
            Try
                ' R√©cup√©rer l'ID du devis s√©lectionn√©
                Dim devisID As Integer = CInt(dgvListeDevis.Rows(e.RowIndex).Cells("DevisID").Value)
                Dim numeroDevis As String = dgvListeDevis.Rows(e.RowIndex).Cells("NumeroDevis").Value.ToString()

                Console.WriteLine($"Double-clic sur devis: {numeroDevis} (ID: {devisID})")

                ' Afficher les d√©tails du devis
                AfficherDetailsDevis(devisID, numeroDevis)

            Catch ex As Exception
                MessageBox.Show("Erreur lors de l'ouverture des d√©tails : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            End Try
        End If
    End Sub
    ' üî• M√âTHODE BONUS : Estimation intelligente du nombre de lignes n√©cessaires
    Private Function EstimerHauteurLigne(texte As String) As Integer
        Try
            If String.IsNullOrWhiteSpace(texte) Then Return 1

            ' Estimation bas√©e sur la longueur du texte
            Select Case texte.Length
                Case 0 To 50
                    Return 1
                Case 51 To 100
                    Return 2
                Case 101 To 150
                    Return 3
                Case Else
                    Return 4 ' Maximum 4 lignes
            End Select

        Catch ex As Exception
            Return 1
        End Try
    End Function

    Private Sub AfficherDetailsDevis(devisID As Integer, numeroDevis As String)
        Try
            Dim query As String = "SELECT D.*, P.NomProjet, P.NumeroProjet, C.NomClient, C.Adresse, C.Telephone, C.Email " &
                             "FROM Devis D " &
                             "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                             "JOIN Clients C ON P.ClientID = C.ClientID " &
                             "WHERE D.DevisID = @DevisID"

            Dim dtDevis As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dtDevis.Rows.Count = 0 Then
                MessageBox.Show("Devis introuvable.", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                Return
            End If

            Dim devisRow As DataRow = dtDevis.Rows(0)
            Dim details As New System.Text.StringBuilder()

            details.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
            details.AppendLine($"           D√âTAILS DU DEVIS")
            details.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê")
            details.AppendLine()

            details.AppendLine("üìã INFORMATIONS G√âN√âRALES")
            details.AppendLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
            details.AppendLine($"‚Ä¢ Num√©ro devis : {devisRow("NumeroDevis")}")
            details.AppendLine($"‚Ä¢ Date : {CDate(devisRow("DateDevis")):dd/MM/yyyy}")
            details.AppendLine($"‚Ä¢ Statut : {devisRow("StatutDevis")}")
            details.AppendLine($"‚Ä¢ Projet : {devisRow("NomProjet")}")

            If Not IsDBNull(devisRow("NumeroProjet")) AndAlso Not String.IsNullOrWhiteSpace(devisRow("NumeroProjet").ToString()) Then
                details.AppendLine($"‚Ä¢ N¬∞ Projet : {devisRow("NumeroProjet")}")
            End If

            details.AppendLine($"‚Ä¢ Client : {devisRow("NomClient")}")

            If Not IsDBNull(devisRow("ObjetDevis")) AndAlso Not String.IsNullOrWhiteSpace(devisRow("ObjetDevis").ToString()) Then
                details.AppendLine($"‚Ä¢ Objet : {devisRow("ObjetDevis")}")
            End If

            details.AppendLine()

            ' üî• MONTANTS HT SEULEMENT
            details.AppendLine("üí∞ MONTANTS")
            details.AppendLine("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
            details.AppendLine($"‚Ä¢ Montant HT : {CDec(devisRow("MontantHT")):N0} FCFA")
            details.AppendLine()

            Using frmDetails As New Form()
                frmDetails.Text = $"D√©tails du devis {numeroDevis}"
                frmDetails.Size = New Size(600, 500)
                frmDetails.StartPosition = FormStartPosition.CenterParent

                Dim txtDetails As New TextBox()
                txtDetails.Multiline = True
                txtDetails.ScrollBars = ScrollBars.Vertical
                txtDetails.ReadOnly = True
                txtDetails.Dock = DockStyle.Fill
                txtDetails.Font = New System.Drawing.Font("Consolas", 9, FontStyle.Regular)
                txtDetails.Text = details.ToString()

                frmDetails.Controls.Add(txtDetails)
                frmDetails.ShowDialog()
            End Using

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'affichage des d√©tails : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    Private Function ObtenirNomUtilisateurConnecte() As String
        Try
            ' UTILISER UNIQUEMENT LE COMPTE DE L'APPLICATION
            If GlobalVariables.CurrentUserID > 0 Then
                Dim queryUser As String = "SELECT NomUtilisateur FROM Utilisateurs WHERE UtilisateurID = @UserID"
                Dim dtUser As DataTable = DbHelper.GetData(queryUser, {New SqlParameter("@UserID", GlobalVariables.CurrentUserID)})

                If dtUser.Rows.Count > 0 AndAlso Not IsDBNull(dtUser.Rows(0)("NomUtilisateur")) Then
                    Return dtUser.Rows(0)("NomUtilisateur").ToString()
                End If
            End If

            ' Si GlobalVariables.CurrentUserName est disponible
            If Not String.IsNullOrWhiteSpace(GlobalVariables.CurrentUserName) Then
                Return GlobalVariables.CurrentUserName
            End If

            ' Si aucun utilisateur connect√© trouv√©
            Return "Utilisateur non identifi√©"

        Catch ex As Exception
            Return "Erreur identification utilisateur"
        End Try
    End Function

    Private Sub btnExporterExcel_Click(sender As Object, e As EventArgs)
        If dgvListeDevis.Rows.Count = 0 Then
            MessageBox.Show("Aucun devis √† exporter.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Return
        End If

        Try
            ' Afficher un message de progression
            Me.Cursor = Cursors.WaitCursor
            Console.WriteLine("D√©marrage de l'export Excel simple des devis...")

            ' Dialogue pour choisir l'emplacement de sauvegarde
            ' PAR CE NOUVEAU CODE :
            ' üî• UTILISATION DE PATHMANAGER POUR LE DOSSIER D'EXPORT
            Dim dossierExport As String = PathManager.GetExportPath()
            Dim nomFichier As String = "Liste_Devis_Simple_" & Date.Now.ToString("yyyyMMdd_HHmmss") & ".xlsx"

            ' Cr√©er le dossier s'il n'existe pas
            If Not Directory.Exists(dossierExport) Then
                Directory.CreateDirectory(dossierExport)
            End If

            ' Dialogue pour choisir l'emplacement de sauvegarde
            Dim saveDialog As New SaveFileDialog()
            saveDialog.Filter = "Fichiers Excel|*.xlsx"
            saveDialog.FileName = nomFichier
            saveDialog.InitialDirectory = dossierExport ' üî• DOSSIER PAR D√âFAUT VIA PATHMANAGER
            saveDialog.Title = "Exporter la liste des devis vers Excel (Simple)"

            If saveDialog.ShowDialog() = DialogResult.OK Then
                ExporterDevisVersExcelSimple(saveDialog.FileName)
                MessageBox.Show("Exportation Excel simple r√©ussie !" & vbCrLf & "Fichier sauvegard√© : " & saveDialog.FileName,
                      "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)

                ' Proposer d'ouvrir le fichier
                If MessageBox.Show("Voulez-vous ouvrir le fichier Excel ?", "Ouvrir Excel",
                         MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
                    Try
                        Process.Start(saveDialog.FileName)
                    Catch ex As Exception
                        MessageBox.Show("Impossible d'ouvrir le fichier automatiquement : " & ex.Message,
                              "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    End Try
                End If
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'exportation simple : " & ex.Message, "Erreur",
                  MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    Private Sub ExporterDevisVersExcelSimple(cheminFichier As String)
        Dim xlApp As Object = Nothing
        Dim xlWorkbook As Object = Nothing
        Dim xlWorksheet As Object = Nothing

        Try
            xlApp = CreateObject("Excel.Application")
            xlWorkbook = xlApp.Workbooks.Add()
            xlWorksheet = xlWorkbook.Worksheets(1)
            xlWorksheet.Name = "Liste des Devis"

            ' En-t√™te principal
            xlWorksheet.Cells(1, 1) = "VERNET - LISTE DES DEVIS"
            xlWorksheet.Range("A1:H1").Merge()
            xlWorksheet.Range("A1").Font.Bold = True
            xlWorksheet.Range("A1").Font.Size = 16
            xlWorksheet.Range("A1").HorizontalAlignment = -4108
            xlWorksheet.Range("A1").Interior.Color = RGB(135, 206, 235)

            ' Informations d'export
            xlWorksheet.Cells(3, 1) = "Date d'export : " & Date.Now.ToString("dd/MM/yyyy HH:mm")
            xlWorksheet.Cells(3, 4) = "Nombre de devis : " & dgvListeDevis.Rows.Count
            xlWorksheet.Cells(3, 6) = "Export√© par : " & ObtenirNomUtilisateurConnecte()

            ' üî• EN-T√äTES SEULEMENT AVEC MontantHT
            Dim headers() As String = {
                "Num√©ro Devis", "Projet", "N¬∞ Projet", "Date Devis", "Statut",
                "Objet", "Montant HT (FCFA)", "Nombre de Lignes"
            }

            For i As Integer = 0 To headers.Length - 1
                xlWorksheet.Cells(5, i + 1) = headers(i)
            Next

            ' Formater les en-t√™tes
            xlWorksheet.Range("A5:H5").Font.Bold = True
            xlWorksheet.Range("A5:H5").Interior.Color = RGB(200, 220, 255)
            xlWorksheet.Range("A5:H5").Borders.LineStyle = 1

            ' Donn√©es des devis
            Dim row As Integer = 6
            Dim totalMontantHT As Decimal = 0
            Dim totalDevis As Integer = 0

            For Each dgvRow As DataGridViewRow In dgvListeDevis.Rows
                If Not dgvRow.IsNewRow Then
                    Try
                        ' Donn√©es de base
                        xlWorksheet.Cells(row, 1) = If(dgvRow.Cells("NumeroDevis").Value Is DBNull.Value, "", dgvRow.Cells("NumeroDevis").Value.ToString())
                        xlWorksheet.Cells(row, 2) = If(dgvRow.Cells("NomProjet").Value Is DBNull.Value, "", dgvRow.Cells("NomProjet").Value.ToString())

                        If dgvListeDevis.Columns.Contains("NumeroProjet") Then
                            xlWorksheet.Cells(row, 3) = If(dgvRow.Cells("NumeroProjet").Value Is DBNull.Value, "", dgvRow.Cells("NumeroProjet").Value.ToString())
                        End If

                        If dgvRow.Cells("DateDevis").Value IsNot DBNull.Value Then
                            xlWorksheet.Cells(row, 4) = CDate(dgvRow.Cells("DateDevis").Value).ToString("dd/MM/yyyy")
                        End If

                        Dim statut As String = If(dgvRow.Cells("StatutDevis").Value Is DBNull.Value, "", dgvRow.Cells("StatutDevis").Value.ToString())
                        xlWorksheet.Cells(row, 5) = statut

                        xlWorksheet.Cells(row, 6) = If(dgvRow.Cells("ObjetDevis").Value Is DBNull.Value, "", dgvRow.Cells("ObjetDevis").Value.ToString())

                        ' üî• MONTANT HT SEULEMENT
                        Dim devisID As Integer = If(dgvRow.Cells("DevisID").Value Is DBNull.Value, 0, CInt(dgvRow.Cells("DevisID").Value))
                        Dim montantHT As Decimal = 0
                        Dim nombreLignes As Integer = 0

                        If devisID > 0 Then
                            Dim dtMontant As DataTable = DbHelper.GetData("SELECT MontantHT FROM Devis WHERE DevisID = @ID", {New SqlParameter("@ID", devisID)})
                            If dtMontant.Rows.Count > 0 AndAlso Not IsDBNull(dtMontant.Rows(0)("MontantHT")) Then
                                montantHT = CDec(dtMontant.Rows(0)("MontantHT"))
                            End If

                            Dim dtLignes As DataTable = DbHelper.GetData("SELECT COUNT(*) FROM LignesDevis WHERE DevisID = @ID", {New SqlParameter("@ID", devisID)})
                            If dtLignes.Rows.Count > 0 Then
                                nombreLignes = CInt(dtLignes.Rows(0)(0))
                            End If
                        End If

                        xlWorksheet.Cells(row, 7) = montantHT.ToString("N0")
                        xlWorksheet.Cells(row, 8) = nombreLignes

                        totalMontantHT += montantHT
                        totalDevis += 1
                        row += 1

                    Catch rowEx As Exception
                        Console.WriteLine($"Erreur ligne {row}: {rowEx.Message}")
                        row += 1
                        Continue For
                    End Try
                End If
            Next

            ' Ligne de totaux
            Dim totalRow As Integer = row + 1
            xlWorksheet.Cells(totalRow, 1) = "TOTAUX"
            xlWorksheet.Range($"A{totalRow}:F{totalRow}").Merge()
            xlWorksheet.Range($"A{totalRow}").Font.Bold = True
            xlWorksheet.Range($"A{totalRow}").HorizontalAlignment = -4108
            xlWorksheet.Range($"A{totalRow}").Interior.Color = RGB(255, 255, 0)

            xlWorksheet.Cells(totalRow, 7) = totalMontantHT.ToString("N0")
            xlWorksheet.Cells(totalRow, 7).Font.Bold = True
            xlWorksheet.Cells(totalRow, 7).Interior.Color = RGB(255, 255, 0)

            xlWorksheet.Cells(totalRow, 8) = totalDevis
            xlWorksheet.Cells(totalRow, 8).Font.Bold = True
            xlWorksheet.Cells(totalRow, 8).Interior.Color = RGB(255, 255, 0)

            ' Formatage final
            xlWorksheet.Columns.AutoFit()
            xlWorksheet.Range($"A5:H{totalRow}").Borders.LineStyle = 1
            xlWorksheet.Range("A6").Select()
            xlApp.ActiveWindow.FreezePanes = True

            xlWorkbook.SaveAs(cheminFichier)
            Console.WriteLine($"‚úÖ Export Excel termin√© - MontantHT seulement - {totalDevis} devis, {totalMontantHT:N0} FCFA")

        Finally
            If xlWorkbook IsNot Nothing Then
                xlWorkbook.Close(False)
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlWorkbook)
            End If
            If xlApp IsNot Nothing Then
                xlApp.Quit()
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlApp)
            End If
            GC.Collect()
            GC.WaitForPendingFinalizers()
        End Try
    End Sub

    Private Sub cmbProjetDevis_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbProjetDevis.SelectedIndexChanged
        ' Protection contre appels multiples
        Static processingChange As Boolean = False

        If IsLoadingData OrElse processingChange Then
            Console.WriteLine("‚ö†Ô∏è Changement projet ignor√© (loading ou processing)")
            Return
        End If

        If cmbProjetDevis.SelectedValue IsNot Nothing AndAlso Not TypeOf cmbProjetDevis.SelectedValue Is DataRowView Then
            Try
                processingChange = True

                Dim projetID As Integer
                If Integer.TryParse(cmbProjetDevis.SelectedValue.ToString(), projetID) AndAlso projetID > 0 Then
                    Console.WriteLine($"üîÑ Changement projet vers: {projetID}")

                    ' EN MODE MODIFICATION, NE PAS V√âRIFIER LES DOUBLONS
                    If devisID > 0 Then
                        Console.WriteLine($"üìù Mode modification - Projet {projetID} autoris√©")
                    Else
                        ' EN MODE CR√âATION, V√âRIFIER LES DOUBLONS
                        If VerifierProjetADejaUnDevis(projetID) Then
                            MessageBox.Show("üö´ Ce projet a d√©j√† un devis", "Projet Indisponible", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                            cmbProjetDevis.SelectedIndex = -1
                            Return
                        End If

                        If Not VerifierProjetTermine(projetID) Then
                            MessageBox.Show("üö´ Projet non termin√©", "Projet Non Autoris√©", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                            cmbProjetDevis.SelectedIndex = -1
                            Return
                        End If
                    End If

                    ' üî• CRUCIAL : PR√â-REMPLIR LES CHAMPS EN MODE CR√âATION
                    If devisID = 0 Then
                        Console.WriteLine("üîÑ Mode CR√âATION - Pr√©-remplissage automatique")
                        PreRemplirChampsNouveauDevis(projetID)
                    Else
                        Console.WriteLine("üîÑ Mode MODIFICATION - Chargement normal")
                        ViderChampsProjetSpecifiques()
                        RecupererEtMettreAJourInfosProjetForce(projetID)
                    End If

                    Console.WriteLine($"‚úÖ Projet {projetID} trait√© avec succ√®s")
                End If
            Catch ex As Exception
                Console.WriteLine($"‚ùå Erreur changement projet: {ex.Message}")
            Finally
                processingChange = False
            End Try
        End If
    End Sub
    Private Sub PreRemplirChampsNouveauDevis(projetID As Integer)
        Try
            Console.WriteLine($"üîÑ === PR√â-REMPLISSAGE NOUVEAU DEVIS PROJET {projetID} ===")
            
            ' Vider compl√®tement d'abord
            ViderChampsProjetSpecifiques()

            ' üî• REQU√äTE CORRIG√âE selon la vraie structure AppelClient
            Dim queryComplet As String = "
            SELECT P.ProjetID, P.NomProjet, P.NumeroProjet, P.Description as DescriptionProjet,
                   P.TypeProjet, P.ClientID, P.AppelClientID,
                   C.NomClient,
                   AC.NumeroAppel, AC.Sujet, AC.Description as DescriptionAppel,
                   AC.DateAppel, AC.StatutAppel
            FROM Projets P 
            INNER JOIN Clients C ON P.ClientID = C.ClientID
            LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID
            WHERE P.ProjetID = @ProjetID"

            Dim dtProjet As DataTable = DbHelper.GetData(queryComplet, {New SqlParameter("@ProjetID", projetID)})

            If dtProjet.Rows.Count = 0 Then
                Console.WriteLine($"‚ùå Projet {projetID} introuvable")
                Return
            End If

            Dim projetRow As DataRow = dtProjet.Rows(0)
            Console.WriteLine($"üìã Projet trouv√©: {projetRow("NomProjet")}")

            ' üî• DEBUG : Afficher ce qui est r√©cup√©r√©
            Console.WriteLine($"DEBUG - AppelClientID: {If(IsDBNull(projetRow("AppelClientID")), "NULL", projetRow("AppelClientID").ToString())}")
            Console.WriteLine($"DEBUG - NumeroAppel: {If(IsDBNull(projetRow("NumeroAppel")), "NULL", projetRow("NumeroAppel").ToString())}")
            Console.WriteLine($"DEBUG - Description: {If(IsDBNull(projetRow("DescriptionAppel")), "NULL", projetRow("DescriptionAppel").ToString())}")

            ' 1. NUM√âRO DE PROJET
            Dim numeroProjetValue As String = If(IsDBNull(projetRow("NumeroProjet")), "", projetRow("NumeroProjet").ToString().Trim())
            If txtNumeroProjet IsNot Nothing Then
                txtNumeroProjet.Text = numeroProjetValue
                Console.WriteLine($"üìã Num√©ro projet: '{numeroProjetValue}'")
            End If

            ' 2. NUM√âRO D'APPEL - üî• CORRECTION
            Dim numeroAppel As String = If(IsDBNull(projetRow("NumeroAppel")), "", projetRow("NumeroAppel").ToString().Trim())
            txtNumeroAppel.Text = numeroAppel
            txtNumeroAppel.Refresh()
            Application.DoEvents()
            Console.WriteLine($"üìû Num√©ro appel assign√©: '{numeroAppel}'")

            ' 3. OBJET DU DEVIS - üî• COPIE DIRECTE SANS PR√âFIXE
            Dim objetDevis As String = ""

            ' PRIORIT√â 1 : Description de l'appel (COPIE DIRECTE)
            If Not IsDBNull(projetRow("DescriptionAppel")) Then
                Dim descAppel As String = projetRow("DescriptionAppel").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descAppel) Then
                    objetDevis = descAppel  ' üî• COPIE DIRECTE SANS "Devis pour"
                    Console.WriteLine($"üìù Objet copi√© directement: '{objetDevis}'")
                End If
            End If

            ' PRIORIT√â 2 : Sujet de l'appel (si pas de description)
            If String.IsNullOrWhiteSpace(objetDevis) AndAlso Not IsDBNull(projetRow("Sujet")) Then
                Dim sujetAppel As String = projetRow("Sujet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(sujetAppel) Then
                    objetDevis = sujetAppel  ' üî• COPIE DIRECTE
                    Console.WriteLine($"üìù Objet depuis sujet: '{objetDevis}'")
                End If
            End If

            ' PRIORIT√â 3 : Description du projet (si pas d'appel)
            If String.IsNullOrWhiteSpace(objetDevis) AndAlso Not IsDBNull(projetRow("DescriptionProjet")) Then
                Dim descProjet As String = projetRow("DescriptionProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descProjet) Then
                    objetDevis = descProjet  ' üî• COPIE DIRECTE
                    Console.WriteLine($"üìù Objet depuis projet: '{objetDevis}'")
                End If
            End If

            ' PRIORIT√â 4 : Laisser vide plut√¥t que de g√©n√©rer automatiquement
            If String.IsNullOrWhiteSpace(objetDevis) Then
                objetDevis = ""  ' üî• LAISSER VIDE pour saisie manuelle
                Console.WriteLine("üìù Objet laiss√© vide pour saisie manuelle")
            End If

            ' Assigner l'objet du devis
            txtObjetDevis.Text = objetDevis
            txtObjetDevis.Refresh()
            Application.DoEvents()

            Console.WriteLine($"‚úÖ Pr√©-remplissage termin√©")
            Console.WriteLine($"   - Num√©ro appel: '{txtNumeroAppel.Text}'")
            Console.WriteLine($"   - Num√©ro projet: '{If(txtNumeroProjet?.Text, "N/A")}'")
            Console.WriteLine($"   - Objet: '{txtObjetDevis.Text}'")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur pr√©-remplissage: {ex.Message}")
        End Try
    End Sub
    ' 2. NOUVELLE M√âTHODE : Vider sp√©cifiquement les champs li√©s au projet
    ' ===============================================================================
    Private Sub ViderChampsProjetSpecifiques()
        Try
            Console.WriteLine("üßπ Vidage forc√© des champs projet...")

            ' ‚≠ê VIDER COMPL√àTEMENT CES CHAMPS
            txtNumeroAppel.Clear()
            txtNumeroAppel.Text = ""

            If txtNumeroProjet IsNot Nothing Then
                txtNumeroProjet.Clear()
                txtNumeroProjet.Text = ""
            End If

            ' ‚≠ê CRUCIAL: VIDER L'OBJET DU DEVIS POUR FORCER SA MISE √Ä JOUR
            txtObjetDevis.Clear()
            txtObjetDevis.Text = ""

            ' Forcer l'actualisation visuelle
            txtNumeroAppel.Refresh()
            txtObjetDevis.Refresh()
            If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Refresh()

            Application.DoEvents()

            Console.WriteLine("‚úÖ Champs projet vid√©s et pr√™ts pour nouvelle saisie")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur vidage champs: {ex.Message}")
        End Try
    End Sub
    ' 3. M√âTHODE CORRIG√âE : R√©cup√©ration forc√©e des infos projet
    ' ===============================================================================
    Private Sub RecupererEtMettreAJourInfosProjetForce(projetID As Integer)
        Try
            Console.WriteLine($"üîç === R√âCUP√âRATION COMPL√àTE PROJET {projetID} ===")

            ' üî• REQU√äTE CORRIG√âE pour r√©cup√©rer la description de l'appel
            Dim queryProjet As String = "
            SELECT P.ProjetID, P.NomProjet, P.NumeroProjet, P.Description as DescriptionProjet,
                   P.TypeProjet, P.ClientID, P.AppelClientID,
                   C.NomClient,
                   AC.NumeroAppel, AC.Sujet, AC.Description as DescriptionAppel
            FROM Projets P 
            INNER JOIN Clients C ON P.ClientID = C.ClientID
            LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID
            WHERE P.ProjetID = @ProjetID"

            Dim dtProjet As DataTable = DbHelper.GetData(queryProjet, {New SqlParameter("@ProjetID", projetID)})

            If dtProjet.Rows.Count = 0 Then
                Console.WriteLine($"‚ùå Projet {projetID} introuvable")
                Return
            End If

            Dim projetRow As DataRow = dtProjet.Rows(0)
            Console.WriteLine($"üìã Projet trouv√©: {projetRow("NomProjet")}")

            ' ‚≠ê VIDER COMPL√àTEMENT D'ABORD
            txtNumeroAppel.Clear()
            If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()
            txtObjetDevis.Clear()
            Application.DoEvents()

            ' ‚≠ê NUM√âRO DE PROJET
            Dim numeroProjetValue As String = If(IsDBNull(projetRow("NumeroProjet")), "", projetRow("NumeroProjet").ToString().Trim())
            If txtNumeroProjet IsNot Nothing Then
                txtNumeroProjet.Text = numeroProjetValue
                Console.WriteLine($"üìã Num√©ro projet: '{numeroProjetValue}'")
            End If

            ' ‚≠ê NUM√âRO D'APPEL
            Dim numeroAppel As String = If(IsDBNull(projetRow("NumeroAppel")), "", projetRow("NumeroAppel").ToString().Trim())
            txtNumeroAppel.Text = numeroAppel
            Console.WriteLine($"üìû Num√©ro appel: '{numeroAppel}'")

            ' üî• G√âN√âRATION OBJET AVEC DESCRIPTION APPEL
            Dim objetDevis As String = GenererObjetDevisAvecDescription(projetRow)
            txtObjetDevis.Text = objetDevis
            Console.WriteLine($"üìù Objet final: '{objetDevis}'")

            ' ‚≠ê FORCER L'AFFICHAGE
            txtNumeroAppel.Refresh()
            If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Refresh()
            txtObjetDevis.Refresh()
            Application.DoEvents()

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration: {ex.Message}")
        End Try
    End Sub

    Private Function GenererObjetDevisAvecDescription(projetRow As DataRow) As String
        Try
            Console.WriteLine("üéØ === G√âN√âRATION OBJET AVEC DESCRIPTION ===")

            ' üî• PRIORIT√â 1: Description de l'appel (champ Description d'AppelClient)
            If Not IsDBNull(projetRow("DescriptionAppel")) Then
                Dim descAppel As String = projetRow("DescriptionAppel").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descAppel) AndAlso Not EstTexteGenerique(descAppel) Then
                    ' Limiter la longueur si n√©cessaire
                    If descAppel.Length > 100 Then
                        descAppel = descAppel.Substring(0, 97) + "..."
                    End If
                    Console.WriteLine($"‚úÖ Objet depuis description appel: '{descAppel}'")
                    Return descAppel
                End If
            End If

            ' üî• PRIORIT√â 2: Sujet de l'appel
            If Not IsDBNull(projetRow("Sujet")) Then
                Dim sujetAppel As String = projetRow("Sujet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(sujetAppel) AndAlso Not EstTexteGenerique(sujetAppel) Then
                    Console.WriteLine($"‚úÖ Objet depuis sujet appel: '{sujetAppel}'")
                    Return sujetAppel
                End If
            End If

            ' üî• PRIORIT√â 3: Description du projet
            If Not IsDBNull(projetRow("DescriptionProjet")) Then
                Dim descProjet As String = projetRow("DescriptionProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descProjet) AndAlso Not EstTexteGenerique(descProjet) Then
                    Console.WriteLine($"‚úÖ Objet depuis description projet: '{descProjet}'")
                    Return descProjet
                End If
            End If

            ' üî• PRIORIT√â 4: Nom du projet (avec pr√©fixe)
            If Not IsDBNull(projetRow("NomProjet")) Then
                Dim nomProjet As String = projetRow("NomProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(nomProjet) AndAlso Not EstTexteGenerique(nomProjet) Then
                    Dim objetAvecPrefixe As String = $"Devis pour {nomProjet}"
                    Console.WriteLine($"‚úÖ Objet depuis nom projet: '{objetAvecPrefixe}'")
                    Return objetAvecPrefixe
                End If
            End If

            ' Aucun objet g√©n√©r√© automatiquement
            Console.WriteLine("Aucun objet g√©n√©r√© automatiquement")
            Return ""

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur g√©n√©ration objet: {ex.Message}")
            Return "Devis pour travaux"
        End Try
    End Function
    ' üî• NOUVELLE M√âTHODE : G√©n√©ration objet simplifi√©e SANS tables inexistantes
    Private Function GenererObjetDevisSimple(projetRow As DataRow) As String
        Try
            Console.WriteLine("üéØ === G√âN√âRATION OBJET SIMPLIFI√âE ===")

            ' üî• PRIORIT√â 1: Description du projet
            If Not IsDBNull(projetRow("DescriptionProjet")) Then
                Dim descProjet As String = projetRow("DescriptionProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descProjet) AndAlso Not EstTexteGenerique(descProjet) Then
                    Console.WriteLine($"‚úÖ Objet depuis description projet: '{descProjet}'")
                    Return descProjet
                End If
            End If

            ' üî• PRIORIT√â 2: Sujet appel (SEULEMENT si sp√©cifique)
            If Not IsDBNull(projetRow("Sujet")) Then
                Dim sujetAppel As String = projetRow("Sujet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(sujetAppel) AndAlso Not EstTexteGenerique(sujetAppel) Then
                    Console.WriteLine($"‚úÖ Objet depuis sujet appel: '{sujetAppel}'")
                    Return sujetAppel
                End If
            End If

            ' üî• PRIORIT√â 3: Description appel (SEULEMENT si sp√©cifique)
            If Not IsDBNull(projetRow("DescriptionAppel")) Then
                Dim descAppel As String = projetRow("DescriptionAppel").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descAppel) AndAlso Not EstTexteGenerique(descAppel) Then
                    ' Limiter la longueur
                    If descAppel.Length > 60 Then
                        descAppel = descAppel.Substring(0, 57) & "..."
                    End If
                    Console.WriteLine($"‚úÖ Objet depuis description appel: '{descAppel}'")
                    Return descAppel
                End If
            End If

            ' üî• PRIORIT√â 4: Nom du projet (avec pr√©fixe)
            If Not IsDBNull(projetRow("NomProjet")) Then
                Dim nomProjet As String = projetRow("NomProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(nomProjet) AndAlso Not EstTexteGenerique(nomProjet) Then
                    Dim objetAvecPrefixe As String = $"Devis pour {nomProjet}"
                    Console.WriteLine($"‚úÖ Objet depuis nom projet: '{objetAvecPrefixe}'")
                    Return objetAvecPrefixe
                End If
            End If

            ' Ne plus g√©n√©rer d'objet automatique, laisser vide pour saisie manuelle
            Console.WriteLine("Aucun objet g√©n√©r√© automatiquement")
            Return ""

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur g√©n√©ration objet simple: {ex.Message}")
            Return "Devis pour travaux"
        End Try
    End Function
    ' üî• NOUVELLE M√âTHODE : G√©n√©ration objet devis corrig√©e
    Private Function GenererObjetDevisCorrige(projetRow As DataRow) As String
        Try
            Console.WriteLine("üéØ === G√âN√âRATION OBJET CORRIG√âE ===")

            ' üî• R√âCUP√âRER LES VRAIES DESCRIPTIONS DES AUTRES FORMULAIRES
            Dim projetID As Integer = CInt(projetRow("ProjetID"))
            Dim vraieDescription As String = RecupererVraieDescriptionProjet(projetID)

            If Not String.IsNullOrWhiteSpace(vraieDescription) Then
                Console.WriteLine($"‚úÖ Description trouv√©e dans autres formulaires: '{vraieDescription}'")
                Return vraieDescription
            End If

            ' üî• PRIORIT√â 1: Description du projet (base de donn√©es)
            If Not IsDBNull(projetRow("DescriptionProjet")) Then
                Dim descProjet As String = projetRow("DescriptionProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descProjet) AndAlso Not EstTexteGenerique(descProjet) Then
                    Console.WriteLine($"‚úÖ Objet depuis description projet: '{descProjet}'")
                    Return descProjet
                End If
            End If

            ' üî• PRIORIT√â 2: Sujet appel (SEULEMENT si sp√©cifique)
            If Not IsDBNull(projetRow("SujetAppel")) Then
                Dim sujetAppel As String = projetRow("SujetAppel").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(sujetAppel) AndAlso Not EstTexteGenerique(sujetAppel) Then
                    Console.WriteLine($"‚úÖ Objet depuis sujet appel: '{sujetAppel}'")
                    Return sujetAppel
                Else
                    Console.WriteLine($"‚ö†Ô∏è Sujet appel g√©n√©rique ignor√©: '{sujetAppel}'")
                End If
            End If

            ' üî• PRIORIT√â 3: Description appel (SEULEMENT si sp√©cifique)
            If Not IsDBNull(projetRow("DescriptionAppel")) Then
                Dim descAppel As String = projetRow("DescriptionAppel").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(descAppel) AndAlso Not EstTexteGenerique(descAppel) Then
                    ' Limiter la longueur
                    If descAppel.Length > 60 Then
                        descAppel = descAppel.Substring(0, 57) & "..."
                    End If
                    Console.WriteLine($"‚úÖ Objet depuis description appel: '{descAppel}'")
                    Return descAppel
                Else
                    Console.WriteLine($"‚ö†Ô∏è Description appel g√©n√©rique ignor√©e: '{descAppel}'")
                End If
            End If

            ' üî• PRIORIT√â 4: Nom du projet (avec pr√©fixe)
            If Not IsDBNull(projetRow("NomProjet")) Then
                Dim nomProjet As String = projetRow("NomProjet").ToString().Trim()
                If Not String.IsNullOrWhiteSpace(nomProjet) AndAlso Not EstTexteGenerique(nomProjet) Then
                    Dim objetAvecPrefixe As String = $"Devis pour {nomProjet}"
                    Console.WriteLine($"‚úÖ Objet depuis nom projet: '{objetAvecPrefixe}'")
                    Return objetAvecPrefixe
                End If
            End If

            ' üî• FALLBACK: Selon le type de projet
            Dim typeProjet As String = If(IsDBNull(projetRow("TypeProjet")), "Projet", projetRow("TypeProjet").ToString())
            Dim objetFallback As String = GenererObjetSelonType(typeProjet)
            Console.WriteLine($"‚úÖ Objet fallback: '{objetFallback}'")
            Return objetFallback

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur g√©n√©ration objet: {ex.Message}")
            Return "Devis pour travaux"
        End Try
    End Function

    ' üî• NOUVELLE M√âTHODE : R√©cup√©rer la vraie description des autres formulaires
    Private Function RecupererVraieDescriptionProjet(projetID As Integer) As String
        Try
            Console.WriteLine($"üîç Recherche description alternative pour projet {projetID}")

            ' üî• SUPPRESSION DES REQU√äTES VERS DES TABLES INEXISTANTES
            ' Option 1: Chercher dans d'autres champs du projet lui-m√™me
            Dim queryAlternatif As String = "
                SELECT P.Description, P.NomProjet, P.TypeProjet,
                       AC.Sujet, AC.Description as DescriptionAppel
                FROM Projets P 
                LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID
                WHERE P.ProjetID = @ProjetID"

            Dim dtAlternatif As DataTable = DbHelper.GetData(queryAlternatif, {New SqlParameter("@ProjetID", projetID)})

            If dtAlternatif.Rows.Count > 0 Then
                Dim row As DataRow = dtAlternatif.Rows(0)

                ' Priorit√© 1 : Description du projet (d√©j√† v√©rifi√©e mais re-v√©rifier)
                If Not IsDBNull(row("Description")) Then
                    Dim desc As String = row("Description").ToString().Trim()
                    If Not String.IsNullOrWhiteSpace(desc) AndAlso Not EstTexteGenerique(desc) Then
                        Console.WriteLine($"‚úÖ Description projet alternative trouv√©e: '{desc}'")
                        Return desc
                    End If
                End If

                ' Priorit√© 2 : Sujet de l'appel (plus sp√©cifique)
                If Not IsDBNull(row("Sujet")) Then
                    Dim sujet As String = row("Sujet").ToString().Trim()
                    If Not String.IsNullOrWhiteSpace(sujet) AndAlso Not EstTexteGenerique(sujet) Then
                        Console.WriteLine($"‚úÖ Sujet appel trouv√©: '{sujet}'")
                        Return sujet
                    End If
                End If

                ' Priorit√© 3 : Description de l'appel
                If Not IsDBNull(row("DescriptionAppel")) Then
                    Dim descAppel As String = row("DescriptionAppel").ToString().Trim()
                    If Not String.IsNullOrWhiteSpace(descAppel) AndAlso Not EstTexteGenerique(descAppel) Then
                        Console.WriteLine($"‚úÖ Description appel trouv√©e: '{descAppel}'")
                        Return descAppel
                    End If
                End If
            End If

            Console.WriteLine("‚ö†Ô∏è Aucune description alternative trouv√©e")
            Return "" ' Rien trouv√©

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration description alternative: {ex.Message}")
            Return ""
        End Try
    End Function

    ' üî• FONCTION AM√âLIOR√âE : D√©tecter les textes g√©n√©riques/parasites
    Private Function EstTexteGenerique(texte As String) As Boolean
        If String.IsNullOrWhiteSpace(texte) Then Return True

        Dim texteClean As String = texte.ToLower().Trim()

        ' üî• LISTE √âTENDUE DES TEXTES PARASITES
        Dim textesGeneriques() As String = {
            "construction et reparation", "construction et r√©paration",
            "r√©paration", "reparation", "r√©par",
            "travaux", "travaux divers",
            "divers", "autre", "autres",
            "projet", "nouveau projet",
            "intervention", "d√©pannage",
            "maintenance", "entretien",
            "urgence", "urgent",
            "test", "essai", "temporaire",
            "√† d√©finir", "a definir", "tbd", "todo"
        }

        ' V√©rification exacte
        For Each generique In textesGeneriques
            If texteClean = generique OrElse texteClean.Contains(generique) AndAlso texteClean.Length < (generique.Length + 10) Then
                Return True
            End If
        Next

        ' Trop court = g√©n√©rique
        If texteClean.Length < 5 Then Return True

        Return False
    End Function

    ' üî• G√âN√âRATION D'OBJET SELON LE TYPE DE PROJET
    Private Function GenererObjetSelonType(typeProjet As String) As String
        Return "" ' Ne plus g√©n√©rer d'objet automatique
    End Function
    ' üî• NOUVELLE M√âTHODE : Diagnostic approfondi si √©chec
    Private Sub DiagnostiquerLiaisonAppelProjet(projetID As Integer)
        Try
            Console.WriteLine($"üîç === DIAGNOSTIC LIAISON APPEL-PROJET {projetID} ===")

            ' 1. V√©rifier les donn√©es du projet
            Dim queryProjet As String = "SELECT * FROM Projets WHERE ProjetID = @ProjetID"
            Dim dtProjet As DataTable = DbHelper.GetData(queryProjet, {New SqlParameter("@ProjetID", projetID)})

            If dtProjet.Rows.Count > 0 Then
                Dim pRow As DataRow = dtProjet.Rows(0)
                Console.WriteLine($"üìã PROJET:")
                Console.WriteLine($"   - ID: {pRow("ProjetID")}")
                Console.WriteLine($"   - Nom: {pRow("NomProjet")}")
                Console.WriteLine($"   - ClientID: {pRow("ClientID")}")
                Console.WriteLine($"   - AppelClientID: {If(IsDBNull(pRow("AppelClientID")), "NULL", pRow("AppelClientID").ToString())}")
                Console.WriteLine($"   - Statut: {pRow("StatutProjet")}")
                Console.WriteLine($"   - Type: {pRow("TypeProjet")}")

                Dim clientID As Integer = CInt(pRow("ClientID"))

                ' 2. V√©rifier TOUS les appels du client
                Dim queryAppelsClient As String = "
                SELECT AppelClientID, NumeroAppel, StatutAppel, Sujet, DateAppel 
                FROM AppelClient 
                WHERE ClientID = @ClientID 
                ORDER BY DateAppel DESC"
                Dim dtAppels As DataTable = DbHelper.GetData(queryAppelsClient, {New SqlParameter("@ClientID", clientID)})

                Console.WriteLine($"üìû TOUS LES APPELS DU CLIENT ({clientID}):")
                If dtAppels.Rows.Count = 0 Then
                    Console.WriteLine($"   ‚ùå AUCUN APPEL TROUV√â POUR CE CLIENT")
                Else
                    For Each appRow As DataRow In dtAppels.Rows
                        Console.WriteLine($"   - Appel {appRow("AppelClientID")}: {appRow("NumeroAppel")} | {appRow("StatutAppel")} | {appRow("Sujet")} | {CDate(appRow("DateAppel")):dd/MM/yyyy}")
                    Next
                End If

            Else
                Console.WriteLine($"‚ùå PROJET {projetID} INTROUVABLE")
            End If

            Console.WriteLine($"üîç === FIN DIAGNOSTIC ===")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur diagnostic: {ex.Message}")
        End Try
    End Sub

    ' 4. NOUVELLE M√âTHODE : G√©n√©ration intelligente de l'objet devis
    ' ===============================================================================
    Private Function GenererObjetDevisIntelligent(projetRow As DataRow, sujetAppel As String, descriptionAppel As String) As String
        Try
            Console.WriteLine("üéØ === G√âN√âRATION OBJET DEVIS S√âCURIS√â ===")

            Dim objetGenere As String = ""

            ' ‚≠ê FILTRER LES DONN√âES PARASITES IMM√âDIATEMENT
            If ContientDonneesParasites(sujetAppel) Then
                Console.WriteLine($"‚ö†Ô∏è Sujet parasite d√©tect√©: '{sujetAppel}' ‚Üí ignor√©")
                sujetAppel = ""
            End If

            If ContientDonneesParasites(descriptionAppel) Then
                Console.WriteLine($"‚ö†Ô∏è Description parasite d√©tect√©e: '{descriptionAppel}' ‚Üí ignor√©e")
                descriptionAppel = ""
            End If

            ' ‚≠ê PRIORIT√â 1: Sujet de l'appel (nettoy√© et valid√©)
            If Not String.IsNullOrWhiteSpace(sujetAppel) Then
                Dim sujetNettoye As String = sujetAppel.Trim()

                If sujetNettoye.Length > 3 AndAlso Not EstSujetGenerique(sujetNettoye) Then
                    objetGenere = sujetNettoye
                    Console.WriteLine($"üìù Objet depuis sujet appel valid√©: '{objetGenere}'")
                    Return objetGenere
                End If
            End If

            ' ‚≠ê PRIORIT√â 2: Description de l'appel (nettoy√©e)
            If Not String.IsNullOrWhiteSpace(descriptionAppel) Then
                Dim descriptionNettoyee As String = descriptionAppel.Trim()

                If descriptionNettoyee.Length > 5 AndAlso Not EstDescriptionGenerique(descriptionNettoyee) Then
                    ' Limiter la longueur
                    If descriptionNettoyee.Length > 60 Then
                        descriptionNettoyee = descriptionNettoyee.Substring(0, 57) & "..."
                    End If
                    objetGenere = descriptionNettoyee
                    Console.WriteLine($"üìù Objet depuis description appel: '{objetGenere}'")
                    Return objetGenere
                End If
            End If

            ' ‚≠ê PRIORIT√â 3: Description du projet
            If Not IsDBNull(projetRow("DescriptionProjet")) Then
                Dim descriptionProjet As String = projetRow("DescriptionProjet").ToString().Trim()

                If Not String.IsNullOrWhiteSpace(descriptionProjet) AndAlso Not EstDescriptionGenerique(descriptionProjet) Then
                    objetGenere = $"Devis pour {descriptionProjet}"
                    Console.WriteLine($"üìù Objet depuis description projet: '{objetGenere}'")
                    Return objetGenere
                End If
            End If

            ' ‚≠ê PRIORIT√â 4: Nom du projet (seulement si pas g√©n√©rique)
            If Not IsDBNull(projetRow("NomProjet")) Then
                Dim nomProjet As String = projetRow("NomProjet").ToString().Trim()

                If Not String.IsNullOrWhiteSpace(nomProjet) AndAlso Not EstDescriptionGenerique(nomProjet) Then
                    objetGenere = $"Devis pour {nomProjet}"
                    Console.WriteLine($"üìù Objet depuis nom projet: '{objetGenere}'")
                    Return objetGenere
                End If
            End If

            ' ‚≠ê PRIORIT√â 5: Selon le type de projet
            ' ‚≠ê FALLBACK: Ne pas g√©n√©rer d'objet automatique
            Console.WriteLine("üìù Aucun objet g√©n√©r√© - Laisser la saisie utilisateur")
            Return ""

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur g√©n√©ration objet: {ex.Message}")
            Return "Devis pour travaux"
        End Try
    End Function

    ' Fonctions utilitaires √† ajouter
    Private Function ContientDonneesParasites(texte As String) As Boolean
        If String.IsNullOrWhiteSpace(texte) Then Return False

        Dim parasites() As String = {
            "construction et reparation", "construction et r√©paration",
            "CONSTRUCTION ET REPARATION", "CONSTRUCTION ET R√âPARATION"
        }

        For Each parasite In parasites
            If texte.ToLower().Contains(parasite.ToLower()) Then
                Return True
            End If
        Next

        Return False
    End Function

    Private Function EstSujetGenerique(sujet As String) As Boolean
        Dim sujetsGeneriques() As String = {
            "r√©paration", "reparation", "travaux", "divers", "autre"
        }

        For Each generique In sujetsGeneriques
            If sujet.ToLower().Trim() = generique.ToLower() Then
                Return True
            End If
        Next

        Return False
    End Function

    Private Function EstDescriptionGenerique(description As String) As Boolean
        Dim descriptionsGeneriques() As String = {
            "projet", "travaux", "divers", "autre", "r√©paration", "reparation"
        }

        For Each desc In descriptionsGeneriques
            If description.ToLower().Trim() = desc.ToLower() Then
                Return True
            End If
        Next

        Return False
    End Function

    ' ‚≠ê NOUVELLE M√âTHODE POUR R√âCUP√âRER AUTOMATIQUEMENT LE NUM√âRO D'APPEL
    ' ‚≠ê CORRECTION POUR FORM7 - Nom de table correct: AppelClient
    Private Sub RecupererNumeroAppelPourProjet(projetID As Integer)
        Try
            Console.WriteLine($"üîç Recherche am√©lior√©e pour projet {projetID}")

            ' üî• V√âRIFICATION CRITIQUE : Projet a-t-il d√©j√† un devis ?
            If VerifierProjetADejaUnDevis(projetID) Then
                txtNumeroAppel.Clear()
                If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()
                txtObjetDevis.Clear()

                MessageBox.Show("üö´ PROJET D√âJ√Ä UTILIS√â" & vbCrLf & vbCrLf &
                      "Ce projet a d√©j√† un devis associ√©." & vbCrLf &
                      "Impossible de cr√©er un nouveau devis.",
                      "Projet Indisponible", MessageBoxButtons.OK, MessageBoxIcon.Warning)

                cmbProjetDevis.SelectedIndex = -1
                Return
            End If

            ' V√©rification que le projet est termin√©
            If Not VerifierProjetTermine(projetID) Then
                txtNumeroAppel.Clear()
                If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()
                txtObjetDevis.Clear()
                Return
            End If

            ' üî• REQU√äTE CORRIG√âE POUR R√âCUP√âRER LES BONNES INFORMATIONS
            Dim queryInfosProjet As String =
            "SELECT TOP 1 " &
            "P.NumeroProjet, " &
            "P.NomProjet, " &
            "P.Description as DescriptionProjet, " &
            "P.TypeProjet, " &
            "AC.NumeroAppel, " &
            "AC.Sujet, " &
            "AC.Description as DescriptionAppel " &
            "FROM Projets P " &
            "LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID " &
            "WHERE P.ProjetID = @ProjetID " &
            "AND (P.StatutProjet = 'Termine' OR P.StatutProjet = 'Termin√©')"

            Dim dtInfos As DataTable = DbHelper.GetData(queryInfosProjet, {New SqlParameter("@ProjetID", projetID)})

            If dtInfos.Rows.Count > 0 Then
                Dim row As DataRow = dtInfos.Rows(0)

                ' üî• REMPLIR LE NUM√âRO D'APPEL
                Dim numeroAppel As String = If(IsDBNull(row("NumeroAppel")), "", row("NumeroAppel").ToString())
                txtNumeroAppel.Text = numeroAppel

                ' üî• REMPLIR LE NUM√âRO DE PROJET
                If txtNumeroProjet IsNot Nothing Then
                    Dim numeroProjetValue As String = If(IsDBNull(row("NumeroProjet")), "", row("NumeroProjet").ToString())
                    txtNumeroProjet.Text = numeroProjetValue
                End If

                ' üî• REMPLIR L'OBJET DU DEVIS INTELLIGEMMENT
                Dim objetDevis As String = ""

                ' Priorit√© 1 : Sujet de l'appel client
                If Not IsDBNull(row("Sujet")) AndAlso Not String.IsNullOrWhiteSpace(row("Sujet").ToString()) Then
                    objetDevis = row("Sujet").ToString()
                    Console.WriteLine($"üìù Objet depuis sujet appel : {objetDevis}")

                    ' Priorit√© 2 : Description de l'appel client
                ElseIf Not IsDBNull(row("DescriptionAppel")) AndAlso Not String.IsNullOrWhiteSpace(row("DescriptionAppel").ToString()) Then
                    objetDevis = row("DescriptionAppel").ToString()
                    Console.WriteLine($"üìù Objet depuis description appel : {objetDevis}")

                    ' Priorit√© 3 : Description du projet
                ElseIf Not IsDBNull(row("DescriptionProjet")) AndAlso Not String.IsNullOrWhiteSpace(row("DescriptionProjet").ToString()) Then
                    objetDevis = row("DescriptionProjet").ToString()
                    Console.WriteLine($"üìù Objet depuis description projet : {objetDevis}")

                    ' Priorit√© 4 : Nom du projet
                ElseIf Not IsDBNull(row("NomProjet")) AndAlso Not String.IsNullOrWhiteSpace(row("NomProjet").ToString()) Then
                    objetDevis = $"Devis pour {row("NomProjet").ToString()}"
                    Console.WriteLine($"üìù Objet g√©n√©r√© depuis nom projet : {objetDevis}")

                    ' Priorit√© 5 : G√©n√©rique selon le type
                Else
                    Dim typeProjet As String = If(IsDBNull(row("TypeProjet")), "Projet", row("TypeProjet").ToString())
                    objetDevis = $"Devis {typeProjet}"
                    Console.WriteLine($"üìù Objet g√©n√©rique : {objetDevis}")
                End If

                ' Assigner l'objet du devis
                txtObjetDevis.Text = objetDevis

                Console.WriteLine($"‚úÖ Informations r√©cup√©r√©es - Appel: {numeroAppel}, Projet: {txtNumeroProjet?.Text}, Objet: {objetDevis}")

            Else
                txtNumeroAppel.Clear()
                If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()
                txtObjetDevis.Clear()
                Console.WriteLine($"‚ö†Ô∏è Aucune information trouv√©e pour le projet {projetID}")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration informations projet: {ex.Message}")
            txtNumeroAppel.Clear()
            If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()
            txtObjetDevis.Clear()
        End Try
    End Sub
    ' 3. NOUVELLE M√âTHODE : V√©rifier si un projet a d√©j√† un devis
    Private Function VerifierProjetADejaUnDevis(projetID As Integer) As Boolean
        Try
            Dim query As String = "SELECT COUNT(*) FROM Devis WHERE ProjetID = @ProjetID"
            Dim dtVerif As DataTable = DbHelper.GetData(query, {New SqlParameter("@ProjetID", projetID)})

            If dtVerif.Rows.Count > 0 AndAlso CInt(dtVerif.Rows(0)(0)) > 0 Then
                Console.WriteLine($"üö´ Projet {projetID} a d√©j√† un devis")
                Return True
            End If

            Return False

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification devis existant: {ex.Message}")
            Return True ' En cas d'erreur, bloquer par s√©curit√©
        End Try
    End Function
    ' 9. AJOUTER UN BOUTON POUR CONSULTER LES STATUTS DES PROJETS (OPTIONNEL)
    Private Sub btnConsulterStatutsProjets_Click(sender As Object, e As EventArgs)
        AfficherStatutsProjets()
    End Sub
    ' 4. NOUVELLE M√âTHODE : V√©rifier que le projet est termin√©
    Private Function VerifierProjetTermine(projetID As Integer) As Boolean
        Try
            Dim query As String = "SELECT StatutProjet FROM Projets WHERE ProjetID = @ProjetID"
            Dim dtStatut As DataTable = DbHelper.GetData(query, {New SqlParameter("@ProjetID", projetID)})

            If dtStatut.Rows.Count > 0 Then
                Dim statutProjet As String = dtStatut.Rows(0)("StatutProjet").ToString().ToUpper()

                ' Accepter "Termine" ou "Termin√©"
                Return statutProjet = "TERMINE" OrElse statutProjet = "TERMIN√â"
            End If

            Return False

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification statut projet {projetID}: {ex.Message}")
            Return False
        End Try
    End Function

    ' ‚≠ê M√âTHODE ALTERNATIVE : R√©cup√©rer TOUS les appels pour donner le choix
    Private Sub RecupererTousLesAppelsPourProjet(projetID As Integer)
        Try
            ' ‚≠ê REQU√äTE CORRIG√âE POUR R√âCUP√âRER TOUS LES APPELS DU CLIENT
            Dim queryAppels As String =
                "SELECT AC.AppelClientID, AC.NumeroAppel, AC.Sujet, AC.DateAppel, AC.StatutAppel " &
                "FROM AppelClient AC " &
                "JOIN Projets P ON AC.ClientID = P.ClientID " &
                "WHERE P.ProjetID = @ProjetID " &
                "ORDER BY AC.DateAppel DESC"

            Dim dtAppels As DataTable = DbHelper.GetData(queryAppels, New SqlParameter() {New SqlParameter("@ProjetID", projetID)})

            If dtAppels.Rows.Count > 0 Then
                If dtAppels.Rows.Count = 1 Then
                    ' Un seul appel : le s√©lectionner automatiquement
                    txtNumeroAppel.Text = dtAppels.Rows(0)("NumeroAppel").ToString()

                    ' Remplir l'objet avec le sujet
                    If String.IsNullOrWhiteSpace(txtObjetDevis.Text) Then
                        txtObjetDevis.Text = If(IsDBNull(dtAppels.Rows(0)("Sujet")), "", dtAppels.Rows(0)("Sujet").ToString())
                    End If

                    Console.WriteLine($"‚úÖ Appel unique s√©lectionn√©: {dtAppels.Rows(0)("NumeroAppel")}")

                Else
                    ' Plusieurs appels : proposer une s√©lection
                    Dim frmSelection As New Form()
                    frmSelection.Text = "S√©lectionner un appel"
                    frmSelection.Size = New Size(600, 400)
                    frmSelection.StartPosition = FormStartPosition.CenterParent

                    Dim dgvAppels As New DataGridView()
                    dgvAppels.Dock = DockStyle.Fill
                    dgvAppels.DataSource = dtAppels
                    dgvAppels.ReadOnly = True
                    dgvAppels.MultiSelect = False
                    dgvAppels.SelectionMode = DataGridViewSelectionMode.FullRowSelect

                    ' Masquer l'ID
                    dgvAppels.Columns("AppelClientID").Visible = False

                    ' Formater les colonnes
                    dgvAppels.Columns("NumeroAppel").HeaderText = "N¬∞ Appel"
                    dgvAppels.Columns("Sujet").HeaderText = "Sujet"
                    dgvAppels.Columns("DateAppel").HeaderText = "Date"
                    dgvAppels.Columns("StatutAppel").HeaderText = "Statut"

                    dgvAppels.AutoResizeColumns(DataGridViewAutoSizeColumnsMode.AllCells)

                    Dim btnOK As New Button()
                    btnOK.Text = "S√©lectionner"
                    btnOK.Size = New Size(100, 30)
                    btnOK.Location = New Point(250, 350)
                    btnOK.DialogResult = DialogResult.OK

                    Dim btnAnnuler As New Button()
                    btnAnnuler.Text = "Annuler"
                    btnAnnuler.Size = New Size(100, 30)
                    btnAnnuler.Location = New Point(360, 350)
                    btnAnnuler.DialogResult = DialogResult.Cancel

                    frmSelection.Controls.Add(dgvAppels)
                    frmSelection.Controls.Add(btnOK)
                    frmSelection.Controls.Add(btnAnnuler)

                    If frmSelection.ShowDialog() = DialogResult.OK AndAlso dgvAppels.CurrentRow IsNot Nothing Then
                        txtNumeroAppel.Text = dgvAppels.CurrentRow.Cells("NumeroAppel").Value.ToString()

                        ' Remplir l'objet avec le sujet s√©lectionn√©
                        If String.IsNullOrWhiteSpace(txtObjetDevis.Text) Then
                            Dim sujetSelectionne As String = If(IsDBNull(dgvAppels.CurrentRow.Cells("Sujet").Value), "", dgvAppels.CurrentRow.Cells("Sujet").Value.ToString())
                            txtObjetDevis.Text = sujetSelectionne
                        End If

                        Console.WriteLine($"‚úÖ Appel s√©lectionn√© manuellement: {txtNumeroAppel.Text}")
                    End If

                    frmSelection.Dispose()
                End If
            Else
                txtNumeroAppel.Clear()
                Console.WriteLine($"‚ö†Ô∏è Aucun appel trouv√© pour le projet {projetID}")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration appels multiples: {ex.Message}")
            txtNumeroAppel.Clear()
        End Try
    End Sub

    ' ‚≠ê VARIANTE SIMPLE : Juste r√©cup√©rer le dernier appel accept√©
    Private Sub RecupererDernierAppelAccepte(projetID As Integer)
        Try
            ' ‚≠ê REQU√äTE POUR R√âCUP√âRER LE DERNIER APPEL ACCEPT√â
            Dim queryAppel As String =
                "SELECT TOP 1 AC.NumeroAppel, AC.Sujet " &
                "FROM AppelClient AC " &
                "JOIN Projets P ON AC.ClientID = P.ClientID " &
                "WHERE P.ProjetID = @ProjetID AND AC.StatutAppel = 'Accept√©' " &
                "ORDER BY AC.DateAppel DESC"

            Dim dtAppel As DataTable = DbHelper.GetData(queryAppel, New SqlParameter() {New SqlParameter("@ProjetID", projetID)})

            If dtAppel.Rows.Count > 0 Then
                Dim row As DataRow = dtAppel.Rows(0)
                txtNumeroAppel.Text = row("NumeroAppel").ToString()

                ' Remplir l'objet si vide
                If String.IsNullOrWhiteSpace(txtObjetDevis.Text) Then
                    txtObjetDevis.Text = If(IsDBNull(row("Sujet")), "", row("Sujet").ToString())
                End If

                Console.WriteLine($"‚úÖ Dernier appel accept√© trouv√©: {row("NumeroAppel")}")
            Else
                ' Chercher n'importe quel appel si aucun accept√©
                RecupererNumeroAppelPourProjet(projetID)
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration dernier appel accept√©: {ex.Message}")
            RecupererNumeroAppelPourProjet(projetID) ' Fallback
        End Try
    End Sub

    ' ‚≠ê REQU√äTE DE TEST POUR V√âRIFIER LA STRUCTURE
    Private Sub TesterStructureTableAppelClient()
        Try
            ' Test pour voir les colonnes disponibles
            Dim queryTest As String = "SELECT TOP 1 * FROM AppelClient"
            Dim dtTest As DataTable = DbHelper.GetData(queryTest, New SqlParameter() {})

            Console.WriteLine("üìã Colonnes disponibles dans AppelClient:")
            For Each column As DataColumn In dtTest.Columns
                Console.WriteLine($"  - {column.ColumnName} ({column.DataType.Name})")
            Next

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur test structure: {ex.Message}")
        End Try
    End Sub

    Private Sub btnConvertirEnFacture_Click(sender As Object, e As EventArgs)

    End Sub


    ' 4. GESTION DES PLACEHOLDERS MANUELS (car PlaceholderText n'existe pas partout)
    Private Sub txtRechercheDevis_Enter(sender As Object, e As EventArgs)
        Try
            Dim txt As TextBox = CType(sender, TextBox)
            If txt.Text = "N¬∞ devis, client, projet..." Then
                txt.Text = ""
                txt.ForeColor = Color.Black
            End If
            ' ‚≠ê R√âINITIALISER LES STYLES AVANT DE RECONFIGURER
            ReinitialiserStylesDGV()

            ConfigurerColonnesListeDevis()
            ' ConfigurerColonnesListeDevis() est d√©j√† appel√© dans ConfigurerColonnesListeDevis()

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur recherche automatique: {ex.Message}")
        End Try
    End Sub

    Private Sub txtRechercheDevis_Leave(sender As Object, e As EventArgs)
        Dim txt As TextBox = CType(sender, TextBox)
        If String.IsNullOrWhiteSpace(txt.Text) Then
            txt.Text = "N¬∞ devis, client, projet..."
            txt.ForeColor = Color.Gray
        End If
    End Sub

    Private Sub txtRechercheAppelProjet_Enter(sender As Object, e As EventArgs)
        Dim txt As TextBox = CType(sender, TextBox)
        If txt.Text = "N¬∞ appel ou nom projet..." Then
            txt.Text = ""
            txt.ForeColor = Color.Black
        End If
    End Sub

    Private Sub txtRechercheAppelProjet_Leave(sender As Object, e As EventArgs)
        Dim txt As TextBox = CType(sender, TextBox)
        If String.IsNullOrWhiteSpace(txt.Text) Then
            txt.Text = "N¬∞ appel ou nom projet..."
            txt.ForeColor = Color.Gray
        End If
    End Sub
    ' 4. RECHERCHE DYNAMIQUE DANS LA LISTE DES DEVIS
    Private Sub txtRechercheDevis_TextChanged(sender As Object, e As EventArgs) Handles txtRechercheDevis.TextChanged
        Try
            If dtDevisComplet Is Nothing Then Return

            Dim textRecherche As String = txtRechercheDevis.Text.Trim()

            If String.IsNullOrWhiteSpace(textRecherche) Then
                ' Afficher tous les devis
                dgvListeDevis.DataSource = dtDevisComplet
                MettreAJourStatistiques(dtDevisComplet)
            Else
                ' ‚≠ê RECHERCHE AUTOMATIQUE EN TEMPS R√âEL
                Dim dv As DataView = dtDevisComplet.DefaultView
                Dim textLower As String = textRecherche.ToLower().Replace("'", "''") ' √âchapper les apostrophes

                Dim filtre As String = $"NumeroDevis LIKE '%{textLower}%' OR " &
                                      $"LOWER(NomProjet) LIKE '%{textLower}%' OR " &
                                      $"LOWER(StatutDevis) LIKE '%{textLower}%'"

                ' Ajouter ObjetDevis seulement s'il n'est pas null
                If dtDevisComplet.Columns.Contains("ObjetDevis") Then
                    filtre &= $" OR LOWER(ISNULL(ObjetDevis, '')) LIKE '%{textLower}%'"
                End If

                dv.RowFilter = filtre

                ' Cr√©er une table filtr√©e
                Dim dtFiltre As DataTable = dv.ToTable()
                dgvListeDevis.DataSource = dtFiltre
                MettreAJourStatistiques(dtFiltre)
            End If

            ConfigurerColonnesListeDevis()
            ConfigurerColonnesListeDevis()

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur recherche automatique: {ex.Message}")
        End Try
    End Sub

    ' 5. CALCUL AUTOMATIQUE DES STATISTIQUES
    Private Sub MettreAJourStatistiques(dt As DataTable)
        Try
            If dt Is Nothing OrElse dt.Rows.Count = 0 Then
                Dim lblStatsRecherche As Label = CType(Me.Controls("lblStatsRecherche"), Label)
                If lblStatsRecherche IsNot Nothing Then
                    lblStatsRecherche.Text = "Aucun r√©sultat"
                End If
                Return
            End If

            Dim totalDevis As Integer = dt.Rows.Count
            Dim totalMontant As Decimal = 0
            Dim statutCounts As New Dictionary(Of String, Integer)

            For Each row As DataRow In dt.Rows
                ' üî• CALCULER AVEC MontantHT (pas TTC)
                If dt.Columns.Contains("MontantHT") AndAlso Not IsDBNull(row("MontantHT")) Then
                    totalMontant += CDec(row("MontantHT"))
                End If

                ' Compter les statuts
                Dim statut As String = If(IsDBNull(row("StatutDevis")), "Inconnu", row("StatutDevis").ToString())
                If statutCounts.ContainsKey(statut) Then
                    statutCounts(statut) += 1
                Else
                    statutCounts(statut) = 1
                End If
            Next

            ' Construire le texte des statistiques
            Dim statsText As String = $"{totalDevis} devis ‚Ä¢ Total HT: {totalMontant:N0} FCFA"

            ' Ajouter les statuts principaux
            If statutCounts.ContainsKey("Accept√©") Then
                statsText &= $" ‚Ä¢ ‚úÖ {statutCounts("Accept√©")} accept√©s"
            End If
            If statutCounts.ContainsKey("D√©pos√©") Then
                statsText &= $" ‚Ä¢ üì§ {statutCounts("D√©pos√©")} d√©pos√©s"
            End If

            If lblCompteurTest IsNot Nothing Then
                lblCompteurTest.Text = statsText
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur calcul statistiques: {ex.Message}")
        End Try
    End Sub

    ' 6. CHARGER LES DONN√âES POUR LA RECHERCHE APPEL/PROJET
    ' üî• CORRECTION : Supprimer les requ√™tes vers des colonnes inexistantes
    Private Sub ChargerDonneesAppelProjetCorrect()
        Try
            ' üî• REQU√äTE CORRIG√âE : SEULEMENT LES COLONNES QUI EXISTENT
            Dim query As String =
                "SELECT " &
                "P.ProjetID, " &
                "P.NomProjet, " &
                "P.NumeroProjet, " &
                "P.TypeProjet, " &
                "P.StatutProjet, " &
                "P.Description as DescriptionProjet, " &
                "C.ClientID, " &
                "C.NomClient, " &
                "MAX(AC.NumeroAppel) as NumeroAppel, " &
                "MAX(AC.Sujet) as Sujet, " &
                "MAX(AC.Description) as DescriptionAppel, " &
                "MAX(AC.DateAppel) as DateAppel " &
                "FROM Projets P " &
                "INNER JOIN Clients C ON P.ClientID = C.ClientID " &
                "LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID " &
                "WHERE P.StatutProjet IN ('Termine', 'Termin√©') " &
                "AND P.TypeProjet IN ('Urgence', 'GreaGre', 'AppelOffres') " &
                "AND P.ProjetID NOT IN (SELECT DISTINCT ProjetID FROM Devis WHERE ProjetID IS NOT NULL) " &
                "GROUP BY P.ProjetID, P.NomProjet, P.NumeroProjet, P.TypeProjet, P.StatutProjet, P.Description, C.ClientID, C.NomClient " &
                "ORDER BY MAX(AC.DateAppel) DESC, P.NomProjet"

            dtAppelProjet = DbHelper.GetData(query, New SqlParameter() {})

            Console.WriteLine($"‚úÖ {dtAppelProjet.Rows.Count} projets charg√©s SANS erreurs BDD")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur chargement appels/projets: {ex.Message}")
            dtAppelProjet = New DataTable()
        End Try
    End Sub
    ' 7. RECHERCHE DANS LES APPELS/PROJETS
    Private Sub txtRechercheAppelProjet_TextChanged(sender As Object, e As EventArgs) Handles txtRechercheAppelProjet.TextChanged
        Try
            If dtAppelProjet Is Nothing OrElse IsLoadingData Then Return

            Dim textRecherche As String = txtRechercheAppelProjet.Text.Trim()

            If String.IsNullOrWhiteSpace(textRecherche) OrElse textRecherche.Length < 2 Then
                cmbAppelProjetSelection.Visible = False
                Return
            End If

            ' üî• FILTRAGE CORRIG√â : Pas de doublons avec DISTINCT sur ProjetID
            Dim dv As DataView = dtAppelProjet.DefaultView
            Dim filtre As String = $"NumeroAppel LIKE '%{textRecherche}%' OR " &
                          $"NumeroProjet LIKE '%{textRecherche}%' OR " &
                          $"NomProjet LIKE '%{textRecherche}%' OR " &
                          $"NomClient LIKE '%{textRecherche}%' OR " &
                          $"Sujet LIKE '%{textRecherche}%'"

            dv.RowFilter = filtre

            If dv.Count > 0 Then
                cmbAppelProjetSelection.Items.Clear()

                ' üî• UTILISER UN HASHSET POUR √âLIMINER LES DOUBLONS AU NIVEAU CODE
                Dim projetsTraites As New HashSet(Of Integer)

                For Each rowView As DataRowView In dv
                    Dim projetID As Integer = CInt(rowView("ProjetID"))

                    ' üî• V√âRIFIER SI D√âJ√Ä TRAIT√â
                    If projetsTraites.Contains(projetID) Then
                        Continue For
                    End If

                    ' üî• DOUBLE V√âRIFICATION : Projet vraiment disponible ?
                    If VerifierProjetTermine(projetID) AndAlso Not VerifierProjetADejaUnDevis(projetID) Then

                        Dim numeroProjet As String = If(IsDBNull(rowView("NumeroProjet")), "N/A", rowView("NumeroProjet").ToString())
                        Dim numeroAppel As String = If(IsDBNull(rowView("NumeroAppel")), "N/A", rowView("NumeroAppel").ToString())

                        ' üî• AFFICHAGE SIMPLIFI√â POUR √âVITER LA CONFUSION
                        Dim displayText As String = $"{numeroAppel} | {numeroProjet} - {rowView("NomProjet")} ({rowView("NomClient")})"

                        If Not IsDBNull(rowView("Sujet")) AndAlso Not String.IsNullOrWhiteSpace(rowView("Sujet").ToString()) Then
                            Dim sujetCourt As String = rowView("Sujet").ToString()
                            If sujetCourt.Length > 30 Then
                                sujetCourt = sujetCourt.Substring(0, 30) & "..."
                            End If
                            displayText &= $" - {sujetCourt}"
                        End If

                        cmbAppelProjetSelection.Items.Add(New AppelProjetItem() With {
                            .DisplayText = displayText,
                            .NumeroAppel = numeroAppel,
                            .NumeroProjet = numeroProjet,
                            .ProjetID = projetID,
                            .NomProjet = rowView("NomProjet").ToString(),
                            .ClientID = CInt(rowView("ClientID")),
                            .Sujet = If(IsDBNull(rowView("Sujet")), "", rowView("Sujet").ToString())
                        })

                        ' üî• MARQUER COMME TRAIT√â
                        projetsTraites.Add(projetID)
                    End If
                Next

                cmbAppelProjetSelection.Visible = (cmbAppelProjetSelection.Items.Count > 0)

                Console.WriteLine($"üîç Recherche '{textRecherche}' : {cmbAppelProjetSelection.Items.Count} r√©sultats uniques")
            Else
                cmbAppelProjetSelection.Visible = False
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur recherche: {ex.Message}")
            cmbAppelProjetSelection.Visible = False
        End Try
    End Sub

    ' ========== 8. AM√âLIORER LA RECHERCHE APPEL/PROJET ==========
    ' Modifier la classe AppelProjetItem pour inclure le num√©ro de projet
    Public Class AppelProjetItem
        Public Property DisplayText As String
        Public Property NumeroAppel As String
        Public Property NumeroProjet As String ' üî• NOUVEAU
        Public Property ProjetID As Integer
        Public Property NomProjet As String
        Public Property ClientID As Integer
        Public Property Sujet As String

        Public Overrides Function ToString() As String
            Return DisplayText
        End Function
    End Class

    ' 9. S√âLECTION D'UN APPEL/PROJET POUR PR√â-REMPLIR
    Private Sub cmbAppelProjetSelection_SelectedIndexChanged(sender As Object, e As EventArgs) Handles cmbAppelProjetSelection.SelectedIndexChanged
        Try
            If cmbAppelProjetSelection.SelectedItem Is Nothing OrElse IsLoadingData Then Return

            Dim item As AppelProjetItem = CType(cmbAppelProjetSelection.SelectedItem, AppelProjetItem)

            If devisID = 0 Then
                ViderChamps()
                devisID = 0
                txtNumeroDevis.Text = GenererNouveauNumeroDevis()
                ActiverDesactiverControles(True)

                ' Remplir automatiquement
                cmbProjetDevis.SelectedValue = item.ProjetID
                txtObjetDevis.Text = If(String.IsNullOrWhiteSpace(item.Sujet), $"Devis pour {item.NomProjet}", item.Sujet)

                ' üî• REMPLIR LES DEUX NUM√âROS
                txtNumeroAppel.Text = item.NumeroAppel
                If txtNumeroProjet IsNot Nothing Then
                    txtNumeroProjet.Text = item.NumeroProjet
                End If

                cmbDesignationLigneDevis.Focus()
                cmbAppelProjetSelection.Visible = False
                txtRechercheAppelProjet.Clear()

                ' üî• MESSAGE MODIFI√â : Inclure le num√©ro de projet
                MessageBox.Show($"‚úÖ Nouveau devis pr√©-rempli :" & vbCrLf &
                           $"‚Ä¢ Projet: {item.NomProjet}" & vbCrLf &
                           $"‚Ä¢ N¬∞ Projet: {item.NumeroProjet}" & vbCrLf &
                           $"‚Ä¢ N¬∞ Appel: {item.NumeroAppel}" & vbCrLf &
                           $"‚Ä¢ Objet: {txtObjetDevis.Text}" & vbCrLf & vbCrLf &
                           "Vous pouvez maintenant ajouter des lignes de devis.",
                           "Pr√©-remplissage r√©ussi", MessageBoxButtons.OK, MessageBoxIcon.Information)

                Console.WriteLine($"‚úÖ Devis pr√©-rempli: Projet {item.ProjetID}, N¬∞ Projet {item.NumeroProjet}, Appel {item.NumeroAppel}")
            Else
                MessageBox.Show("Impossible de pr√©-remplir car un devis est en cours d'√©dition.",
                           "√âdition en cours", MessageBoxButtons.OK, MessageBoxIcon.Warning)
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors du pr√©-remplissage : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub


    ' 4. AJOUTER CETTE M√âTHODE POUR LE MENU D'EXPORT
    ' ‚≠ê BOUTON EXPORT AVEC MENU D√âROULANT - VERSION CORRIG√âE
    Private Sub btnExportMenuDevis_Click(sender As Object, e As EventArgs)
        Try
            If dgvListeDevis.Rows.Count = 0 Then
                MessageBox.Show("Aucun devis √† exporter.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' Cr√©er le menu contextuel
            Dim menuExport As New ContextMenuStrip()
            menuExport.Font = New System.Drawing.Font("Segoe UI", 10)

            ' Option 1: Export simple
            Dim itemSimple As New ToolStripMenuItem("üìã Export Simple (Donn√©es visibles)")
            itemSimple.ToolTipText = "Exporte uniquement les donn√©es actuellement affich√©es"
            AddHandler itemSimple.Click, AddressOf btnExporterExcel_Click
            menuExport.Items.Add(itemSimple)

            ' Option 2: Export complet avec statistiques - CORRIG√â
            Dim itemComplet As New ToolStripMenuItem("üìä Export Complet (+ Statistiques)")
            itemComplet.ToolTipText = "Exporte toutes les donn√©es avec statistiques d√©taill√©es"
            AddHandler itemComplet.Click, Sub(s, ev) ExporterDevisAvecStatistiquesSimple()
            menuExport.Items.Add(itemComplet)

            ' S√©parateur
            menuExport.Items.Add(New ToolStripSeparator())

            ' Option 3: Export des donn√©es filtr√©es uniquement
            Dim itemFiltre As New ToolStripMenuItem("üîç Export Filtr√© (R√©sultats de recherche)")
            itemFiltre.ToolTipText = "Exporte uniquement les r√©sultats de la recherche actuelle"
            itemFiltre.Enabled = Not String.IsNullOrWhiteSpace(txtRechercheDevis.Text)
            AddHandler itemFiltre.Click, Sub(s, ev) ExporterDevisFiltres()
            menuExport.Items.Add(itemFiltre)

            ' Option 4: Export par p√©riode
            Dim itemPeriode As New ToolStripMenuItem("üìÖ Export par P√©riode")
            itemPeriode.ToolTipText = "Exporte les devis d'une p√©riode sp√©cifique"
            AddHandler itemPeriode.Click, Sub(s, ev) ExporterDevisParPeriode()
            menuExport.Items.Add(itemPeriode)

            ' Afficher le menu
            Dim btn As Button = CType(sender, Button)
            menuExport.Show(btn, New Point(0, btn.Height))

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'affichage du menu d'export : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' 5. AJOUTER CES M√âTHODES SUPPL√âMENTAIRES D'EXPORT

    ' Export des donn√©es filtr√©es
    Private Sub ExporterDevisFiltres()
        Try
            If dgvListeDevis.DataSource Is Nothing Then
                MessageBox.Show("Aucune donn√©e √† exporter.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' PAR CE NOUVEAU CODE :
            ' üî• UTILISATION DE PATHMANAGER
            Dim dossierExport As String = PathManager.GetExportPath()
            Dim nomFichier As String = "Devis_Filtres_" & Date.Now.ToString("yyyyMMdd_HHmmss") & ".xlsx"

            ' Cr√©er le dossier s'il n'existe pas
            If Not Directory.Exists(dossierExport) Then
                Directory.CreateDirectory(dossierExport)
            End If

            Dim saveDialog As New SaveFileDialog()
            saveDialog.Filter = "Fichiers Excel|*.xlsx"
            saveDialog.FileName = nomFichier
            saveDialog.InitialDirectory = dossierExport ' üî• DOSSIER PAR D√âFAUT
            saveDialog.Title = "Exporter les devis filtr√©s"

            If saveDialog.ShowDialog() = DialogResult.OK Then
                ExporterDevisVersExcelSimple(saveDialog.FileName)
                MessageBox.Show("Export des donn√©es filtr√©es r√©ussi !" & vbCrLf &
                              $"Nombre de lignes export√©es : {dgvListeDevis.Rows.Count}",
                              "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'export filtr√© : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' Export par p√©riode
    Private Sub ExporterDevisParPeriode()
        Try
            ' Cr√©er un formulaire de s√©lection de p√©riode
            Using frmPeriode As New Form()
                frmPeriode.Text = "S√©lectionner la p√©riode d'export"
                frmPeriode.Size = New Size(400, 200)
                frmPeriode.StartPosition = FormStartPosition.CenterParent
                frmPeriode.FormBorderStyle = FormBorderStyle.FixedDialog
                frmPeriode.MaximizeBox = False
                frmPeriode.MinimizeBox = False

                Dim lblDebut As New Label()
                lblDebut.Text = "Date de d√©but :"
                lblDebut.Location = New Point(20, 20)
                lblDebut.Size = New Size(100, 23)

                Dim dtpDebut As New DateTimePicker()
                dtpDebut.Location = New Point(130, 20)
                dtpDebut.Size = New Size(200, 23)
                dtpDebut.Value = Date.Today.AddMonths(-1)

                Dim lblFin As New Label()
                lblFin.Text = "Date de fin :"
                lblFin.Location = New Point(20, 60)
                lblFin.Size = New Size(100, 23)

                Dim dtpFin As New DateTimePicker()
                dtpFin.Location = New Point(130, 60)
                dtpFin.Size = New Size(200, 23)
                dtpFin.Value = Date.Today

                Dim btnOK As New Button()
                btnOK.Text = "Exporter"
                btnOK.Location = New Point(150, 110)
                btnOK.Size = New Size(80, 30)
                btnOK.DialogResult = DialogResult.OK

                Dim btnAnnuler As New Button()
                btnAnnuler.Text = "Annuler"
                btnAnnuler.Location = New Point(240, 110)
                btnAnnuler.Size = New Size(80, 30)
                btnAnnuler.DialogResult = DialogResult.Cancel

                frmPeriode.Controls.AddRange({lblDebut, dtpDebut, lblFin, dtpFin, btnOK, btnAnnuler})

                If frmPeriode.ShowDialog() = DialogResult.OK Then
                    ExporterDevisParPeriodeSpecifique(dtpDebut.Value, dtpFin.Value)
                End If
            End Using

        Catch ex As Exception
            MessageBox.Show("Erreur lors de la s√©lection de p√©riode : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' Export pour une p√©riode sp√©cifique
    Private Sub ExporterDevisParPeriodeSpecifique(dateDebut As Date, dateFin As Date)
        Try
            Me.Cursor = Cursors.WaitCursor

            ' üî• REQU√äTE AVEC MontantHT
            Dim query As String = "SELECT D.DevisID, D.NumeroDevis, P.NomProjet, D.DateDevis, D.StatutDevis, " &
                             "D.MontantHT, D.ObjetDevis " &
                             "FROM Devis D " &
                             "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                             "WHERE D.DateDevis BETWEEN @DateDebut AND @DateFin " &
                             "ORDER BY D.DateDevis DESC"

            Dim parameters() As SqlParameter = {
                New SqlParameter("@DateDebut", dateDebut.Date),
                New SqlParameter("@DateFin", dateFin.Date.AddDays(1).AddSeconds(-1))
            }

            Dim dtPeriode As DataTable = DbHelper.GetData(query, parameters)

            If dtPeriode.Rows.Count = 0 Then
                MessageBox.Show($"Aucun devis trouv√© pour la p√©riode du {dateDebut:dd/MM/yyyy} au {dateFin:dd/MM/yyyy}.",
                          "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' PAR CE NOUVEAU CODE :
            ' üî• UTILISATION DE PATHMANAGER POUR LE DOSSIER D'EXPORT
            Dim dossierExport As String = PathManager.GetExportPath()
            Dim nomFichier As String = $"Devis_Periode_{dateDebut:yyyyMMdd}_{dateFin:yyyyMMdd}.xlsx"

            ' Cr√©er le dossier s'il n'existe pas
            If Not Directory.Exists(dossierExport) Then
                Directory.CreateDirectory(dossierExport)
            End If

            Dim saveDialog As New SaveFileDialog()
            saveDialog.Filter = "Fichiers Excel|*.xlsx"
            saveDialog.FileName = nomFichier
            saveDialog.InitialDirectory = dossierExport ' üî• DOSSIER PAR D√âFAUT
            saveDialog.Title = "Exporter les devis par p√©riode"
            If saveDialog.ShowDialog() = DialogResult.OK Then
                ExporterDataTableVersExcel(dtPeriode, saveDialog.FileName, $"P√©riode du {dateDebut:dd/MM/yyyy} au {dateFin:dd/MM/yyyy}")
                MessageBox.Show($"Export r√©ussi !" & vbCrLf &
                          $"P√©riode : {dateDebut:dd/MM/yyyy} - {dateFin:dd/MM/yyyy}" & vbCrLf &
                          $"Nombre de devis : {dtPeriode.Rows.Count}",
                          "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'export par p√©riode : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    ' M√©thode utilitaire pour exporter un DataTable vers Excel
    Private Sub ExporterDataTableVersExcel(dt As DataTable, cheminFichier As String, titreSheet As String)
        Dim xlApp As Object = Nothing
        Dim xlWorkbook As Object = Nothing

        Try
            xlApp = CreateObject("Excel.Application")
            xlWorkbook = xlApp.Workbooks.Add()
            Dim xlWorksheet As Object = xlWorkbook.Worksheets(1)
            xlWorksheet.Name = "Devis Export"

            ' Titre
            xlWorksheet.Cells(1, 1) = $"VERNET - EXPORT DEVIS - {titreSheet}"
            xlWorksheet.Range("A1:G1").Merge()
            xlWorksheet.Range("A1").Font.Bold = True
            xlWorksheet.Range("A1").Font.Size = 14
            xlWorksheet.Range("A1").HorizontalAlignment = -4108
            xlWorksheet.Range("A1").Interior.Color = RGB(52, 152, 219)
            xlWorksheet.Range("A1").Font.Color = RGB(255, 255, 255)

            ' üî• EN-T√äTES AVEC MontantHT
            Dim headers() As String = {"Num√©ro Devis", "Projet", "Date", "Statut", "Objet", "Montant HT", "Montant HT (Total)"}
            For i As Integer = 0 To headers.Length - 1
                xlWorksheet.Cells(3, i + 1) = headers(i)
            Next

            xlWorksheet.Range("A3:G3").Font.Bold = True
            xlWorksheet.Range("A3:G3").Interior.Color = RGB(230, 230, 230)

            ' Donn√©es
            Dim row As Integer = 4
            For Each dataRow As DataRow In dt.Rows
                xlWorksheet.Cells(row, 1) = If(IsDBNull(dataRow("NumeroDevis")), "", dataRow("NumeroDevis").ToString())
                xlWorksheet.Cells(row, 2) = If(IsDBNull(dataRow("NomProjet")), "", dataRow("NomProjet").ToString())
                xlWorksheet.Cells(row, 3) = If(IsDBNull(dataRow("DateDevis")), "", CDate(dataRow("DateDevis")).ToString("dd/MM/yyyy"))
                xlWorksheet.Cells(row, 4) = If(IsDBNull(dataRow("StatutDevis")), "", dataRow("StatutDevis").ToString())
                xlWorksheet.Cells(row, 5) = If(IsDBNull(dataRow("ObjetDevis")), "", dataRow("ObjetDevis").ToString())
                xlWorksheet.Cells(row, 6) = If(IsDBNull(dataRow("MontantHT")), 0, CDec(dataRow("MontantHT"))).ToString("N0")
                row += 1
            Next

            xlWorksheet.Columns.AutoFit()
            xlWorkbook.SaveAs(cheminFichier)

        Finally
            If xlWorkbook IsNot Nothing Then
                xlWorkbook.Close(False)
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlWorkbook)
            End If
            If xlApp IsNot Nothing Then
                xlApp.Quit()
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlApp)
            End If
            GC.Collect()
            GC.WaitForPendingFinalizers()
        End Try
    End Sub

    ' 4. NOUVELLE M√âTHODE : Cr√©er le compteur de devis avanc√©
    Private Sub CreerCompteurDevisAvance()
        Try
            ' V√©rifier si le label existe d√©j√†
            Dim lblExistant As Label = TryCast(Me.Controls("lblCompteurDevisAvance"), Label)
            If lblExistant IsNot Nothing Then
                MettreAJourCompteurDevis()
                Return
            End If

            ' Cr√©er le nouveau label avec un design moderne
            Dim lblCompteur As New Label()
            With lblCompteur
                .Name = "lblCompteurDevisAvance"
                .Text = "üìã Devis : 0 total | Montant : 0 FCFA"
                .Font = New System.Drawing.Font("Segoe UI", 10, System.Drawing.FontStyle.Bold)
                .ForeColor = Color.FromArgb(52, 73, 94)
                .AutoSize = True

                ' Positionner au-dessus du DataGridView
                If dgvListeDevis IsNot Nothing Then
                    .Location = New Point(dgvListeDevis.Location.X, dgvListeDevis.Location.Y - 60)
                Else
                    .Location = New Point(20, 150)
                End If

                .Anchor = AnchorStyles.Top Or AnchorStyles.Left
            End With

            Me.Controls.Add(lblCompteur)
            lblCompteur.BringToFront()

            Console.WriteLine("‚úÖ Compteur devis avanc√© cr√©√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur cr√©ation compteur devis : {ex.Message}")
        End Try
    End Sub

    ' 5. NOUVELLE M√âTHODE : Obtenir les statistiques compl√®tes des devis
    Private Function ObtenirStatistiquesDevis() As StatistiquesDevis
        Try
            Dim stats As New StatistiquesDevis()

            ' üî• REQU√äTE MODIFI√âE : MontantHT au lieu de MontantTTC
            Dim query As String = "SELECT " &
                         "COUNT(*) AS NombreTotal, " &
                         "SUM(CASE WHEN StatutDevis = 'Brouillon' THEN 1 ELSE 0 END) AS NombreBrouillons, " &
                         "SUM(CASE WHEN StatutDevis = 'Envoy√©' THEN 1 ELSE 0 END) AS NombreEnvoyes, " &
                         "SUM(CASE WHEN StatutDevis = 'D√©pos√©' THEN 1 ELSE 0 END) AS NombreDeposes, " &
                         "SUM(CASE WHEN StatutDevis = 'Retourn√©' THEN 1 ELSE 0 END) AS NombreRetournes, " &
                         "SUM(CASE WHEN StatutDevis = 'Accept√©' THEN 1 ELSE 0 END) AS NombreAcceptes, " &
                         "SUM(CASE WHEN StatutDevis = 'Command√©' THEN 1 ELSE 0 END) AS NombreCommandes, " &
                         "SUM(CASE WHEN StatutDevis = 'Factur√©' THEN 1 ELSE 0 END) AS NombreFactures, " &
                         "SUM(CASE WHEN StatutDevis = 'Refus√©' THEN 1 ELSE 0 END) AS NombreRefuses, " &
                         "SUM(CASE WHEN StatutDevis = 'Annul√©' THEN 1 ELSE 0 END) AS NombreAnnules, " &
                         "ISNULL(SUM(MontantHT), 0) AS MontantTotalHT, " &
                         "ISNULL(AVG(MontantHT), 0) AS MontantMoyenHT, " &
                         "MIN(DateDevis) AS DatePremier, " &
                         "MAX(DateDevis) AS DateDernier " &
                         "FROM Devis"

            Dim dtStats As DataTable = DbHelper.GetData(query, New SqlParameter() {})

            If dtStats.Rows.Count > 0 Then
                Dim row As DataRow = dtStats.Rows(0)
                stats.NombreTotal = If(IsDBNull(row("NombreTotal")), 0, CInt(row("NombreTotal")))
                stats.NombreBrouillons = If(IsDBNull(row("NombreBrouillons")), 0, CInt(row("NombreBrouillons")))
                stats.NombreEnvoyes = If(IsDBNull(row("NombreEnvoyes")), 0, CInt(row("NombreEnvoyes")))
                stats.NombreDeposes = If(IsDBNull(row("NombreDeposes")), 0, CInt(row("NombreDeposes")))
                stats.NombreRetournes = If(IsDBNull(row("NombreRetournes")), 0, CInt(row("NombreRetournes")))
                stats.NombreAcceptes = If(IsDBNull(row("NombreAcceptes")), 0, CInt(row("NombreAcceptes")))
                stats.NombreRefuses = If(IsDBNull(row("NombreRefuses")), 0, CInt(row("NombreRefuses")))
                stats.NombreAnnules = If(IsDBNull(row("NombreAnnules")), 0, CInt(row("NombreAnnules")))
                stats.MontantTotalHT = If(IsDBNull(row("MontantTotalHT")), 0D, CDec(row("MontantTotalHT")))
                stats.MontantMoyenHT = If(IsDBNull(row("MontantMoyenHT")), 0D, CDec(row("MontantMoyenHT")))
                stats.DatePremier = If(IsDBNull(row("DatePremier")), Date.Today, CDate(row("DatePremier")))
                stats.DateDernier = If(IsDBNull(row("DateDernier")), Date.Today, CDate(row("DateDernier")))
            End If

            ' Obtenir le projet le plus actif
            Try
                Dim queryProjetTop As String = "SELECT TOP 1 P.NomProjet, COUNT(*) as NombreDevis " &
                                         "FROM Devis D " &
                                         "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                                         "GROUP BY P.NomProjet " &
                                         "ORDER BY COUNT(*) DESC"

                Dim dtProjet As DataTable = DbHelper.GetData(queryProjetTop, New SqlParameter() {})
                If dtProjet.Rows.Count > 0 Then
                    stats.ProjetLePlusActif = dtProjet.Rows(0)("NomProjet").ToString()
                Else
                    stats.ProjetLePlusActif = "N/A"
                End If
            Catch
                stats.ProjetLePlusActif = "N/A"
            End Try

            StatistiquesDevisActuelles = stats
            Return stats

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur ObtenirStatistiquesDevis : {ex.Message}")
            Return New StatistiquesDevis()
        End Try
    End Function

    ' 6. NOUVELLE M√âTHODE : Mettre √† jour le compteur de devis
    Private Sub MettreAJourCompteurDevis()
        Try
            Dim lblCompteur As Label = TryCast(Me.Controls("lblCompteurDevisAvance"), Label)
            If lblCompteur IsNot Nothing Then
                Dim stats As StatistiquesDevis = ObtenirStatistiquesDevis()

                ' Mettre √† jour le texte avec statistiques compl√®tes
                If stats.NombreTotal = 0 Then
                    lblCompteur.Text = "üìã Devis : Aucun devis"
                    lblCompteur.ForeColor = Color.FromArgb(149, 165, 166)
                Else
                    lblCompteur.Text = $"üìã Devis : {stats.NombreTotal} total | üí∞ Montant : {stats.MontantTotalHT:N0} FCFA | ‚úÖ Accept√©s : {stats.NombreAcceptes} | üì§ D√©pos√©s : {stats.NombreDeposes}"
                    lblCompteur.ForeColor = Color.FromArgb(46, 204, 113)
                End If

                Console.WriteLine($"‚úÖ Compteur devis mis √† jour : {stats.NombreTotal} devis")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur mise √† jour compteur devis : {ex.Message}")
        End Try
    End Sub

    ' AJOUTER CETTE M√âTHODE DANS VOTRE FORM7.VB
    Private Sub ExporterDevisAvecStatistiquesSimple()
        Try
            Me.Cursor = Cursors.WaitCursor
            Console.WriteLine("D√©marrage de l'export Excel simple avec statistiques...")

            ' PAR CE NOUVEAU CODE :
            ' üî• UTILISATION DE PATHMANAGER
            Dim dossierExport As String = PathManager.GetExportPath()
            Dim nomFichier As String = "Devis_Statistiques_" & Date.Now.ToString("yyyyMMdd_HHmmss") & ".xlsx"

            ' Cr√©er le dossier s'il n'existe pas  
            If Not Directory.Exists(dossierExport) Then
                Directory.CreateDirectory(dossierExport)
            End If

            Dim saveDialog As New SaveFileDialog()
            saveDialog.Filter = "Fichiers Excel|*.xlsx"
            saveDialog.FileName = nomFichier
            saveDialog.InitialDirectory = dossierExport ' üî• DOSSIER PAR D√âFAUT
            saveDialog.Title = "Exporter les devis avec statistiques"

            If saveDialog.ShowDialog() = DialogResult.OK Then
                ' üî• UTILISER LA M√âTHODE SIMPLE QUI FONCTIONNE
                ExporterDevisVersExcelSimple(saveDialog.FileName)

                MessageBox.Show("Export r√©ussi !" & vbCrLf &
                              "Fichier sauvegard√© : " & saveDialog.FileName,
                              "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)

                If MessageBox.Show("Voulez-vous ouvrir le fichier Excel ?", "Ouvrir Excel",
                                 MessageBoxButtons.YesNo, MessageBoxIcon.Question) = DialogResult.Yes Then
                    Try
                        Process.Start(saveDialog.FileName)
                    Catch ex As Exception
                        MessageBox.Show("Impossible d'ouvrir le fichier automatiquement : " & ex.Message,
                                      "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    End Try
                End If
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'export : " & ex.Message, "Erreur",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    ' AJOUTER CETTE M√âTHODE DANS VOTRE FORM7.VB
    Private Sub ExporterDevisVersExcelAvance(cheminFichier As String)
        Dim xlApp As Object = Nothing
        Dim xlWorkbook As Object = Nothing

        Try
            ' Cr√©er l'application Excel
            xlApp = CreateObject("Excel.Application")
            xlWorkbook = xlApp.Workbooks.Add()

            ' Obtenir les statistiques
            Dim stats As StatistiquesDevis = ObtenirStatistiquesDevis()

            ' ===== FEUILLE 1: DONN√âES DES DEVIS =====
            Dim xlWorksheet1 As Object = xlWorkbook.Worksheets(1)
            xlWorksheet1.Name = "Donn√©es Devis"

            ' En-t√™te principal
            xlWorksheet1.Cells(1, 1) = "VERNET - RAPPORT COMPLET DES DEVIS"
            xlWorksheet1.Range("A1:H1").Merge()
            xlWorksheet1.Range("A1").Font.Bold = True
            xlWorksheet1.Range("A1").Font.Size = 16
            xlWorksheet1.Range("A1").HorizontalAlignment = -4108 ' Center
            xlWorksheet1.Range("A1").Interior.Color = RGB(52, 152, 219)
            xlWorksheet1.Range("A1").Font.Color = RGB(255, 255, 255)

            ' Informations de g√©n√©ration
            xlWorksheet1.Cells(3, 1) = "Date d'export : " & Date.Now.ToString("dd/MM/yyyy HH:mm")
            xlWorksheet1.Cells(3, 4) = "Nombre de devis : " & stats.NombreTotal
            xlWorksheet1.Cells(3, 6) = "Montant total : " & stats.MontantTotalHT.ToString("N0") & " FCFA"

            ' En-t√™tes des colonnes (ligne 5)
            Dim headers() As String = {
                "Num√©ro Devis", "Projet", "Date Devis", "Statut",
                "Objet", "Montant HT (FCFA)", "M√©thode D√©p√¥t", "D√©cision Client"
            }

            For i As Integer = 0 To headers.Length - 1
                xlWorksheet1.Cells(5, i + 1) = headers(i)
            Next

            ' Formater les en-t√™tes
            xlWorksheet1.Range("A5:H5").Font.Bold = True
            xlWorksheet1.Range("A5:H5").Interior.Color = RGB(46, 204, 113)
            xlWorksheet1.Range("A5:H5").Font.Color = RGB(255, 255, 255)

            ' Donn√©es des devis
            Dim row As Integer = 6
            Dim totalMontantExport As Decimal = 0

            For Each dgvRow As DataGridViewRow In dgvListeDevis.Rows
                If Not dgvRow.IsNewRow Then
                    Try
                        xlWorksheet1.Cells(row, 1) = If(dgvRow.Cells("NumeroDevis").Value Is DBNull.Value, "", dgvRow.Cells("NumeroDevis").Value.ToString())
                        xlWorksheet1.Cells(row, 2) = If(dgvRow.Cells("NomProjet").Value Is DBNull.Value, "", dgvRow.Cells("NomProjet").Value.ToString())

                        If dgvRow.Cells("DateDevis").Value IsNot DBNull.Value Then
                            xlWorksheet1.Cells(row, 3) = CDate(dgvRow.Cells("DateDevis").Value).ToString("dd/MM/yyyy")
                        End If

                        ' Statut avec couleurs
                        Dim statut As String = If(dgvRow.Cells("StatutDevis").Value Is DBNull.Value, "", dgvRow.Cells("StatutDevis").Value.ToString())
                        xlWorksheet1.Cells(row, 4) = statut

                        ' Colorier selon le statut
                        Select Case statut.ToUpper()
                            Case "ACCEPT√â"
                                xlWorksheet1.Cells(row, 4).Interior.Color = RGB(144, 238, 144)
                                xlWorksheet1.Cells(row, 4).Font.Bold = True
                            Case "D√âPOS√â"
                                xlWorksheet1.Cells(row, 4).Interior.Color = RGB(255, 165, 0)
                                xlWorksheet1.Cells(row, 4).Font.Bold = True
                            Case "REFUS√â"
                                xlWorksheet1.Cells(row, 4).Interior.Color = RGB(255, 182, 193)
                                xlWorksheet1.Cells(row, 4).Font.Bold = True
                            Case "BROUILLON"
                                xlWorksheet1.Cells(row, 4).Interior.Color = RGB(220, 220, 220)
                            Case "ENVOY√â"
                                xlWorksheet1.Cells(row, 4).Interior.Color = RGB(173, 216, 230)
                        End Select

                        xlWorksheet1.Cells(row, 5) = If(dgvRow.Cells("ObjetDevis").Value Is DBNull.Value, "", dgvRow.Cells("ObjetDevis").Value.ToString())

                        ' R√©cup√©rer le montant HT depuis la base de donn√©es
                        Dim devisID As Integer = If(dgvRow.Cells("DevisID").Value Is DBNull.Value, 0, CInt(dgvRow.Cells("DevisID").Value))
                        Dim montantHT As Decimal = 0

                        If devisID > 0 Then
                            Try
                                Dim dtMontant As DataTable = DbHelper.GetData("SELECT MontantHT FROM Devis WHERE DevisID = @ID",
                                                                             {New SqlParameter("@ID", devisID)})
                                If dtMontant.Rows.Count > 0 AndAlso Not IsDBNull(dtMontant.Rows(0)("MontantHT")) Then
                                    montantHT = CDec(dtMontant.Rows(0)("MontantHT"))
                                End If
                            Catch ex As Exception
                                Console.WriteLine($"Erreur r√©cup√©ration montant devis {devisID}: {ex.Message}")
                            End Try
                        End If

                        xlWorksheet1.Cells(row, 6) = montantHT.ToString("N0")
                        totalMontantExport += montantHT

                        ' Colonnes optionnelles (d√©p√¥t et retour)
                        If dgvListeDevis.Columns.Contains("CommentaireDepot") Then
                            xlWorksheet1.Cells(row, 7) = If(dgvRow.Cells("CommentaireDepot").Value Is DBNull.Value, "", dgvRow.Cells("CommentaireDepot").Value.ToString())
                        Else
                            xlWorksheet1.Cells(row, 7) = ""
                        End If

                        If dgvListeDevis.Columns.Contains("DecisionClient") Then
                            xlWorksheet1.Cells(row, 8) = If(dgvRow.Cells("DecisionClient").Value Is DBNull.Value, "", dgvRow.Cells("DecisionClient").Value.ToString())
                        Else
                            xlWorksheet1.Cells(row, 8) = ""
                        End If

                        row += 1
                    Catch rowEx As Exception
                        Console.WriteLine($"Erreur ligne {row}: {rowEx.Message}")
                        row += 1
                        Continue For
                    End Try
                End If
            Next

            ' Auto-ajuster les colonnes
            xlWorksheet1.Columns.AutoFit()

            ' ===== FEUILLE 2: STATISTIQUES D√âTAILL√âES =====
            Dim xlWorksheet2 As Object = xlWorkbook.Worksheets.Add()
            xlWorksheet2.Name = "Statistiques"

            ' Titre
            xlWorksheet2.Cells(1, 1) = "STATISTIQUES D√âTAILL√âES DES DEVIS"
            xlWorksheet2.Range("A1:E1").Merge()
            xlWorksheet2.Range("A1").Font.Bold = True
            xlWorksheet2.Range("A1").Font.Size = 14
            xlWorksheet2.Range("A1").HorizontalAlignment = -4108
            xlWorksheet2.Range("A1").Interior.Color = RGB(155, 89, 182)
            xlWorksheet2.Range("A1").Font.Color = RGB(255, 255, 255)

            Dim statsRow As Integer = 3

            ' Statistiques g√©n√©rales
            xlWorksheet2.Cells(statsRow, 1) = "STATISTIQUES G√âN√âRALES"
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(52, 73, 94)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            statsRow += 2

            xlWorksheet2.Cells(statsRow, 1) = "Nombre total de devis"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreTotal
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Montant total HT"
            xlWorksheet2.Cells(statsRow, 2) = stats.MontantTotalHT.ToString("N0") & " FCFA"
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Montant moyen HT"
            xlWorksheet2.Cells(statsRow, 2) = stats.MontantMoyenHT.ToString("N0") & " FCFA"
            statsRow += 2

            ' R√©partition par statut
            xlWorksheet2.Cells(statsRow, 1) = "R√âPARTITION PAR STATUT"
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(46, 204, 113)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            statsRow += 2

            ' Donn√©es par statut avec couleurs
            xlWorksheet2.Cells(statsRow, 1) = "Brouillons"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreBrouillons
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(149, 165, 166)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Envoy√©s"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreEnvoyes
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(52, 152, 219)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "D√©pos√©s"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreDeposes
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(255, 165, 0)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Retourn√©s"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreRetournes
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(155, 89, 182)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Accept√©s"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreAcceptes
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(46, 204, 113)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Refus√©s"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreRefuses
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(231, 76, 60)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 1

            xlWorksheet2.Cells(statsRow, 1) = "Annul√©s"
            xlWorksheet2.Cells(statsRow, 2) = stats.NombreAnnules
            xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(149, 165, 166)
            xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
            xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
            statsRow += 2

            ' Taux de performance
            If stats.NombreTotal > 0 Then
                xlWorksheet2.Cells(statsRow, 1) = "TAUX DE PERFORMANCE"
                xlWorksheet2.Cells(statsRow, 1).Font.Bold = True
                xlWorksheet2.Cells(statsRow, 1).Interior.Color = RGB(243, 156, 18)
                xlWorksheet2.Cells(statsRow, 1).Font.Color = RGB(255, 255, 255)
                statsRow += 2

                xlWorksheet2.Cells(statsRow, 1) = "Taux d'acceptation"
                xlWorksheet2.Cells(statsRow, 2) = $"{(stats.NombreAcceptes / stats.NombreTotal * 100):F1}%"
                statsRow += 1

                xlWorksheet2.Cells(statsRow, 1) = "Taux de refus"
                xlWorksheet2.Cells(statsRow, 2) = $"{(stats.NombreRefuses / stats.NombreTotal * 100):F1}%"
                statsRow += 1
            End If

            ' Auto-ajuster les colonnes
            xlWorksheet2.Columns.AutoFit()

            ' Sauvegarder le fichier
            xlWorkbook.SaveAs(cheminFichier)

            Console.WriteLine($"‚úÖ Export Excel avanc√© termin√© - {stats.NombreTotal} devis export√©s avec statistiques compl√®tes")

        Finally
            ' Nettoyer les objets COM
            If xlWorkbook IsNot Nothing Then
                xlWorkbook.Close(False)
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlWorkbook)
            End If
            If xlApp IsNot Nothing Then
                xlApp.Quit()
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlApp)
            End If
            GC.Collect()
            GC.WaitForPendingFinalizers()
        End Try
    End Sub

    ' 4. V√âRIFICATION SI DEVIS D√âJ√Ä FACTUR√â
    ' ===============================================================================
    Private Function DevisDejaFacture(devisID As Integer) As Boolean
        Try
            Dim query As String = "SELECT COUNT(*) FROM Factures WHERE DevisID = @DevisID"
            Dim parameters() As SqlParameter = {New SqlParameter("@DevisID", devisID)}
            Dim dtCount As DataTable = DbHelper.GetData(query, parameters)

            If dtCount IsNot Nothing AndAlso dtCount.Rows.Count > 0 Then
                Dim nombreFactures As Integer = CInt(dtCount.Rows(0)(0))
                Return nombreFactures > 0
            End If

            Return False

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification facture existante: {ex.Message}")
            Return True ' En cas d'erreur, on bloque par s√©curit√©
        End Try
    End Function

    ' 5. R√âCUP√âRER INFOS DE LA FACTURE EXISTANTE
    ' ===============================================================================
    Private Function RecupererInfoFactureExistante(devisID As Integer) As String
        Try
            Dim query As String = "SELECT NumeroFacture, DateFacture, StatutFacture FROM Factures WHERE DevisID = @DevisID"
            Dim parameters() As SqlParameter = {New SqlParameter("@DevisID", devisID)}
            Dim dtFacture As DataTable = DbHelper.GetData(query, parameters)

            If dtFacture IsNot Nothing AndAlso dtFacture.Rows.Count > 0 Then
                Dim row As DataRow = dtFacture.Rows(0)
                Dim numeroFacture As String = row("NumeroFacture").ToString()
                Dim dateFacture As Date = CDate(row("DateFacture"))
                Dim statutFacture As String = row("StatutFacture").ToString()

                Return $"{numeroFacture} ({dateFacture:dd/MM/yyyy}) - {statutFacture}"
            End If

            Return "Facture existante"

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration info facture: {ex.Message}")
            Return "Facture existante (erreur d√©tails)"
        End Try
    End Function
    ' ===============================================================================
    ' DANS FORM7 - REMPLACER COMPL√àTEMENT OuvrirFormulaireFacture :
    Private Sub OuvrirFormulaireFacture()
        Try
            Console.WriteLine($"üîÑ === OUVERTURE FORMFACTURE DEPUIS FORM7 ===")

            If dgvListeDevis.CurrentRow Is Nothing Then
                MessageBox.Show("Veuillez s√©lectionner un devis dans la liste.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            ' ‚≠ê R√âCUP√âRATION DES VRAIES DONN√âES
            Dim devisIDLocal As Integer = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)
            Dim numeroDevisLocal As String = dgvListeDevis.CurrentRow.Cells("NumeroDevis").Value.ToString()

            Console.WriteLine($"üìã Donn√©es √† transmettre - DevisID: {devisIDLocal}, Num√©ro: {numeroDevisLocal}")

            ' ‚≠ê V√âRIFICATION ANTI-DOUBLONS
            If VerifierFactureExistanteDevis(devisIDLocal) Then
                Return
            End If

            ' ‚≠ê CR√âER FORMFACTURE AVEC TRANSMISSION CORRECTE
            Using frmFacture As New FormFacture()
                ' ‚≠ê CONFIGURATION AVANT AFFICHAGE
                frmFacture.DevisIDSource = devisIDLocal
                frmFacture.NumeroDevisSource = numeroDevisLocal
                frmFacture.ForceRechargement = True

                Console.WriteLine($"‚úÖ FormFacture configur√© - DevisID: {frmFacture.DevisIDSource}")

                ' ‚≠ê OUVERTURE ET TRAITEMENT
                Dim resultat As DialogResult = frmFacture.ShowDialog()

                If resultat = DialogResult.OK Then
                    MessageBox.Show("‚úÖ Facture trait√©e avec succ√®s !", "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    ' ‚≠ê RAFRA√éCHIR FORM7
                    ChargerDevis()

                End If
            End Using

        Catch ex As Exception
            MessageBox.Show($"Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"‚ùå Erreur OuvrirFormulaireFacture: {ex.Message}")
        End Try
    End Sub
    ' DANS FORM7 - AJOUTER cette m√©thode de v√©rification :
    Private Function VerifierFactureExistanteDevis(devisID As Integer) As Boolean
        Try
            Dim query As String = "SELECT COUNT(*) FROM Factures WHERE DevisID = @DevisID"
            Dim dtVerif As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dtVerif.Rows.Count > 0 AndAlso CInt(dtVerif.Rows(0)(0)) > 0 Then
                ' R√©cup√©rer les d√©tails de la facture existante
                Dim queryDetails As String = "SELECT NumeroFacture, DateFacture, StatutFacture FROM Factures WHERE DevisID = @DevisID"
                Dim dtDetails As DataTable = DbHelper.GetData(queryDetails, {New SqlParameter("@DevisID", devisID)})

                If dtDetails.Rows.Count > 0 Then
                    Dim numeroFacture As String = dtDetails.Rows(0)("NumeroFacture").ToString()
                    Dim dateFacture As Date = CDate(dtDetails.Rows(0)("DateFacture"))
                    Dim statutFacture As String = dtDetails.Rows(0)("StatutFacture").ToString()

                    Dim reponse As DialogResult = MessageBox.Show(
                        $"üìÑ Une facture existe d√©j√† pour ce devis !" & vbCrLf & vbCrLf &
                        $"Devis : {dgvListeDevis.CurrentRow.Cells("NumeroDevis").Value}" & vbCrLf &
                        $"Facture : {numeroFacture}" & vbCrLf &
                        $"Date : {dateFacture:dd/MM/yyyy}" & vbCrLf &
                        $"Statut : {statutFacture}" & vbCrLf & vbCrLf &
                        "Voulez-vous consulter la facture existante ?",
                        "Facture Existante", MessageBoxButtons.YesNo, MessageBoxIcon.Information)

                    If reponse = DialogResult.Yes Then
                        ' Ouvrir FormFacture en mode consultation
                        ' Dans Form7, apr√®s cr√©ation de FormFacture :
                        Using frmFacture As New FormFacture()
                            frmFacture.DevisIDSource = devisID
                        End Using
                    End If
                End If
                Return True
            End If

            Return False

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification facture: {ex.Message}")
            Return False
        End Try
    End Function
    ' 8. AM√âLIORATION DU DATAGRIDVIEW AVEC INDICATEUR DE FACTURATION
    ' ===============================================================================
    Private Sub ChargerDevisAvecStatutFacturation()
        Try
            ' ‚≠ê REQU√äTE AVEC STATUT DE FACTURATION
            Dim query As String = "SELECT D.DevisID, D.NumeroDevis, P.NomProjet, D.DateDevis, D.StatutDevis, D.MontantTTC, D.ObjetDevis, " &
                                 "DD.MethodeDepot, DD.Commentaires as CommentaireDepot, " &
                                 "RD.DecisionClient, RD.Commentaires as CommentaireRetour, " &
                                 "CASE WHEN EXISTS(SELECT 1 FROM Factures WHERE DevisID = D.DevisID) " &
                                 "     THEN 'Factur√©' " &
                                 "     ELSE 'Non factur√©' " &
                                 "END as StatutFacturation " &
                                 "FROM Devis D " &
                                 "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                                 "LEFT JOIN DepotDevis DD ON D.DevisID = DD.DevisID " &
                                 "LEFT JOIN RetourDevis RD ON D.DevisID = RD.DevisID " &
                                 "ORDER BY D.DateDevis DESC"

            Dim dtDevis As DataTable = DbHelper.GetData(query, New SqlParameter() {})

            If dtDevis IsNot Nothing Then
                dtDevisComplet = dtDevis.Copy()
                dtDevisCompletAvecStats = dtDevis.Copy()
                dgvListeDevis.DataSource = dtDevis
                ConfigurerColonnesAvecStatutFacturation()
                MettreAJourCompteurDevis()
                MettreAJourStatistiques(dtDevis)
                Console.WriteLine($"‚úÖ {dtDevis.Rows.Count} devis charg√©s avec statut facturation")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur chargement devis avec facturation: {ex.Message}")
            ' Fallback sur le chargement normal
            ChargerDevis()
        End Try
    End Sub

    ' 9. CONFIGURATION DES COLONNES AVEC STATUT FACTURATION
    ' ===============================================================================
    Private Sub ConfigurerColonnesAvecStatutFacturation()
        Try
            ' Configuration normale des colonnes
            ConfigurerColonnesListeDevis()

            ' ‚≠ê AJOUTER LA COLONNE STATUT FACTURATION
            If dgvListeDevis.Columns.Contains("StatutFacturation") Then
                dgvListeDevis.Columns("StatutFacturation").HeaderText = "Facturation"
                dgvListeDevis.Columns("StatutFacturation").Width = 100
                dgvListeDevis.Columns("StatutFacturation").DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                dgvListeDevis.Columns("StatutFacturation").DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                ' Coloriser selon le statut
                ColoriserStatutFacturation()
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur configuration colonnes avec facturation: {ex.Message}")
        End Try
    End Sub

    ' 8. M√âTHODE UTILITAIRE : Obtenir la liste des statuts manuels autoris√©s
    Private Function ObtenirStatutsManuelsAutorises() As String()
        Return {"Brouillon", "Envoy√©", "Annul√©"}
    End Function
    Private Function EstStatutManuel(statut As String) As Boolean
        Return {"D√©pos√©", "Retourn√©", "Accept√©", "R√©vision"}.Contains(statut)
    End Function

    Private Function EstStatutAutomatique(statut As String) As Boolean
        Return {"D√©pos√©", "Retourn√©", "Accept√©", "R√©vision"}.Contains(statut)
    End Function
    ' 5. AJOUTER UN INDICATEUR VISUEL POUR EXPLIQUER LE SYST√àME :
    Private Sub AjouterIndicateurStatutsWorkflow()
        Try
            ' Cr√©er un label d'explication
            Dim lblExplication As New Label()
            lblExplication.Name = "lblExplicationWorkflow"
            lblExplication.Text = "‚ÑπÔ∏è Workflow: Brouillon ‚Üí Envoy√© ‚Üí [D√©poser Devis] ‚Üí [Retour Devis] ‚Üí Accept√©/R√©vision"
            lblExplication.Font = New System.Drawing.Font("Segoe UI", 8, FontStyle.Italic)
            lblExplication.ForeColor = Color.FromArgb(100, 100, 100)
            lblExplication.AutoSize = True

            ' Positionner sous la ComboBox des statuts
            If cmbStatutDevis IsNot Nothing Then
                lblExplication.Location = New Point(cmbStatutDevis.Location.X, cmbStatutDevis.Location.Y + cmbStatutDevis.Height + 25)
            Else
                lblExplication.Location = New Point(20, 220)
            End If

            ' Tooltip d√©taill√©
            toolTipForm7.SetToolTip(lblExplication,
            "WORKFLOW DES STATUTS :" & vbCrLf &
            "‚îå‚îÄ MANUELS (dans liste d√©roulante) :" & vbCrLf &
            "‚îÇ  ‚Ä¢ Brouillon : Devis en cours de cr√©ation" & vbCrLf &
            "‚îÇ  ‚Ä¢ Envoy√© : Devis finalis√© et envoy√© au client" & vbCrLf &
            "‚îÇ  ‚Ä¢ Annul√© : Devis abandonn√©" & vbCrLf &
            "‚îî‚îÄ AUTOMATIQUES (par boutons uniquement) :" & vbCrLf &
            "   ‚Ä¢ D√©pos√© : Via bouton 'D√©poser Devis'" & vbCrLf &
            "   ‚Ä¢ Retourn√© : Via bouton 'Retour Devis'" & vbCrLf &
            "   ‚Ä¢ Accept√© : Client accepte dans Form18" & vbCrLf &
            "   ‚Ä¢ R√©vision : Client demande r√©vision dans Form18")

            Me.Controls.Add(lblExplication)
            lblExplication.BringToFront()

            Console.WriteLine("‚úÖ Indicateur workflow ajout√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur ajout indicateur: {ex.Message}")
        End Try
    End Sub
    ' 11. D√âSACTIVATION GLOBALE DES BOUTONS
    ' 10. COLORISATION DU STATUT FACTURATION
    ' ===============================================================================
    Private Sub ColoriserStatutFacturation()
        Try
            For Each row As DataGridViewRow In dgvListeDevis.Rows
                If Not row.IsNewRow AndAlso row.Cells("StatutFacturation") IsNot Nothing AndAlso row.Cells("StatutFacturation").Value IsNot Nothing Then
                    Dim statutFacturation As String = row.Cells("StatutFacturation").Value.ToString()

                    If statutFacturation = "Factur√©" Then
                        ' Devis factur√© - Vert avec emoji
                        row.Cells("StatutFacturation").Value = "üí∞ Factur√©"
                        row.Cells("StatutFacturation").Style.BackColor = Color.FromArgb(204, 255, 204)
                        row.Cells("StatutFacturation").Style.ForeColor = Color.DarkGreen
                    Else
                        ' Devis non factur√© - Orange avec emoji
                        row.Cells("StatutFacturation").Value = "üìã Non factur√©"
                        row.Cells("StatutFacturation").Style.BackColor = Color.FromArgb(255, 240, 204)
                        row.Cells("StatutFacturation").Style.ForeColor = Color.DarkOrange
                    End If
                End If
            Next

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur colorisation statut facturation: {ex.Message}")
        End Try
    End Sub

    ' ===============================================================================
    ' M√âTHODE POUR V√âRIFIER SI UNE FACTURE EXISTE D√âJ√Ä
    ' ===============================================================================
    Private Function VerifierFactureExistante(devisID As Integer) As Boolean
        Try
            Dim query As String = "SELECT COUNT(*), MAX(NumeroFacture) FROM Factures WHERE DevisID = @DevisID"
            Dim dt As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dt.Rows.Count > 0 Then
                Dim count As Integer = CInt(dt.Rows(0)(0))
                If count > 0 Then
                    Dim numeroFactureExistant As String = If(IsDBNull(dt.Rows(0)(1)), "Inconnue", dt.Rows(0)(1).ToString())

                    Dim result As DialogResult = MessageBox.Show(
                        $"‚ö†Ô∏è Une facture existe d√©j√† pour ce devis !" & vbCrLf & vbCrLf &
                        $"Facture existante : {numeroFactureExistant}" & vbCrLf & vbCrLf &
                        "Voulez-vous cr√©er une nouvelle facture quand m√™me ?",
                        "Facture Existante",
                        MessageBoxButtons.YesNo, MessageBoxIcon.Warning)

                    Return result = DialogResult.No
                End If
            End If

            Return False

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification facture existante: {ex.Message}")
            Return False
        End Try
    End Function

    ' ===============================================================================
    ' ALTERNATIVE : M√âTHODE AVEC D√âLAI SI PROBL√àME PERSISTE
    ' ===============================================================================
    Private Sub CreerFactureAvecDelai(devisID As Integer, numeroDevis As String)
        Try
            Console.WriteLine("‚è∞ Cr√©ation facture avec d√©lai...")

            Dim formFacture As New FormFacture()

            ' Configurer les propri√©t√©s
            formFacture.DevisIDSource = devisID
            formFacture.NumeroDevisSource = numeroDevis

            ' Afficher le formulaire
            formFacture.Show()

            ' Attendre que le formulaire soit visible
            Application.DoEvents()
            System.Threading.Thread.Sleep(200)

            ' Forcer le rechargement
            formFacture.ForceReloadFromDevis(devisID, numeroDevis)

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur cr√©ation avec d√©lai: {ex.Message}")
        End Try
    End Sub
    ' DANS FORM7 - NOUVELLE M√âTHODE pour cr√©er FormFacture avec processus propre :
    Private Sub CreerNouvelleInstanceFormFacture(devisID As Integer, numeroDevis As String)
        Try
            Console.WriteLine($"üîÑ === CR√âATION NOUVELLE INSTANCE FORMFACTURE ===")
            Console.WriteLine($"   Param√®tres: DevisID={devisID}, NumeroDevis={numeroDevis}")

            ' ‚≠ê FORCER LA LIB√âRATION DE M√âMOIRE AVANT CR√âATION
            GC.Collect()
            GC.WaitForPendingFinalizers()

            ' ‚≠ê CR√âER UNE NOUVELLE INSTANCE COMPL√àTEMENT ISOL√âE
            Using frmFacture As New FormFacture()

                Console.WriteLine($"‚úÖ Nouvelle instance FormFacture cr√©√©e")

                ' ‚≠ê CONFIGURATION INITIALE STRICTE
                frmFacture.DevisIDSource = 0 ' R√©initialiser d'abord
                frmFacture.NumeroDevisSource = "" ' R√©initialiser d'abord
                frmFacture.ModeModification = False
                frmFacture.ForceRechargement = True

                ' ‚≠ê PAUSE POUR √âVITER LES CONFLITS DE TIMING
                Application.DoEvents()
                System.Threading.Thread.Sleep(200)

                ' ‚≠ê ASSIGNER LES NOUVELLES DONN√âES
                frmFacture.DevisIDSource = devisID
                frmFacture.NumeroDevisSource = numeroDevis

                Console.WriteLine($"‚úÖ Donn√©es assign√©es: DevisID={frmFacture.DevisIDSource}, NumeroDevis={frmFacture.NumeroDevisSource}")

                ' ‚≠ê DIAGNOSTIC AVANT OUVERTURE
                Console.WriteLine($"üîç Diagnostic: DevisID={frmFacture.DevisIDSource}, Num√©ro={frmFacture.NumeroDevisSource}")

                ' ‚≠ê OUVRIR LE FORMULAIRE
                Dim resultat As DialogResult = frmFacture.ShowDialog()

                If resultat = DialogResult.OK Then
                    MessageBox.Show("‚úÖ Facture trait√©e avec succ√®s !", "Succ√®s", MessageBoxButtons.OK, MessageBoxIcon.Information)
                    ChargerDevis()

                End If

                Console.WriteLine($"üèÅ FormFacture ferm√© avec r√©sultat: {resultat}")

            End Using

            ' ‚≠ê NETTOYAGE FINAL
            GC.Collect()
            GC.WaitForPendingFinalizers()

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur CreerNouvelleInstanceFormFacture: {ex.Message}")
            MessageBox.Show($"Erreur lors de la cr√©ation du formulaire facture : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' DANS FORM7 - CORRIGER la m√©thode VerifierFactureExistante :
    ' DANS FORM7 - CORRIGER la m√©thode VerifierFactureExistante :
    Private Function VerifierFactureExistante() As Boolean
        Try
            ' ‚≠ê R√âCUP√âRER L'ID DU DEVIS DEPUIS LA LIGNE S√âLECTIONN√âE
            If dgvListeDevis.CurrentRow Is Nothing OrElse dgvListeDevis.CurrentRow.Cells("DevisID").Value Is DBNull.Value Then
                Return False
            End If

            Dim devisIDPourVerification As Integer = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)

            ' ‚≠ê REQU√äTE BAS√âE SUR VOS VRAIES TABLES
            Dim query As String = "
            SELECT COUNT(*) as NombreFactures,
                   (SELECT TOP 1 NumeroFacture 
                    FROM Factures 
                    WHERE DevisID = @DevisID 
                    AND (StatutFacture IS NULL OR StatutFacture NOT LIKE 'RESERVE%') 
                    ORDER BY DateCreation DESC) as NumeroExistant
            FROM Factures 
            WHERE DevisID = @DevisID 
            AND (StatutFacture IS NULL OR StatutFacture NOT LIKE 'RESERVE%')"

            Dim dtVerif As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisIDPourVerification)})

            If dtVerif.Rows.Count > 0 AndAlso CInt(dtVerif.Rows(0)("NombreFactures")) > 0 Then
                Dim numeroExistant As String = If(IsDBNull(dtVerif.Rows(0)("NumeroExistant")), "Num√©ro inconnu", dtVerif.Rows(0)("NumeroExistant").ToString())

                Dim reponse As DialogResult = MessageBox.Show(
                $"üìÑ Une facture existe d√©j√† pour ce devis !" & vbCrLf & vbCrLf &
                $"Devis : {dgvListeDevis.CurrentRow.Cells("NumeroDevis").Value}" & vbCrLf &
                $"Facture existante : {numeroExistant}" & vbCrLf & vbCrLf &
                "Voulez-vous consulter la facture existante au lieu d'en cr√©er une nouvelle ?",
                "Facture Existante", MessageBoxButtons.YesNo, MessageBoxIcon.Information)

                If reponse = DialogResult.Yes Then
                    ' ‚≠ê OUVRIR LE FORMULAIRE FACTURE POUR CONSULTATION
                    Try
                        Using frmFacture As New FormFacture()
                            frmFacture.ShowDialog()
                        End Using
                    Catch ex As Exception
                        Console.WriteLine($"‚ùå Erreur ouverture facture existante: {ex.Message}")
                    End Try
                End If

                Return True ' Bloquer la cr√©ation d'une nouvelle facture
            End If

            Return False ' Autoriser la cr√©ation

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification facture: {ex.Message}")
            Return False
        End Try
    End Function
    ' DANS FORM7 - AM√âLIORER LA GESTION DES BOUTONS
    ' ===============================================================================

    ' DANS FORM7 - AM√âLIORER GererBoutonsSelonStatut pour inclure les factures :

    Private Sub GererAutresBoutons(statut As String)
        Try
            Console.WriteLine($"üîß Configuration boutons pour statut: {statut}")

            ' ‚≠ê BOUTON D√âPOSER
            If btnDeposerDevis IsNot Nothing Then
                Dim depotAutorise As Boolean = (statut.ToUpper() = "BROUILLON")
                ConfigurerBouton(btnDeposerDevis, depotAutorise,
                   If(depotAutorise, Color.FromArgb(52, 152, 219), Color.LightGray),
                   If(depotAutorise, Color.White, Color.DarkGray))
            End If

            ' ‚≠ê BOUTON RETOUR
            If btnRetourDevis IsNot Nothing Then
                Dim retourAutorise As Boolean = (statut.ToUpper() = "D√âPOS√â" OrElse statut.ToUpper() = "DEPOSE")
                ConfigurerBouton(btnRetourDevis, retourAutorise,
                   If(retourAutorise, Color.FromArgb(155, 89, 182), Color.LightGray),
                   If(retourAutorise, Color.White, Color.DarkGray))
            End If

            ' ‚≠ê BOUTON MODIFIER : Autoris√© pour "Brouillon" ET "R√©vision" MAIS PAS "Factur√©"
            If btnModifierDevis IsNot Nothing Then
                Dim modificationAutorisee As Boolean = (
                    {"BROUILLON", "R√âVISION", "REVISIONS"}.Contains(statut.ToUpper()) AndAlso
                    statut.ToUpper() <> "FACTUR√â" AndAlso statut.ToUpper() <> "FACTURE"
                )
                ConfigurerBouton(btnModifierDevis, modificationAutorisee,
                   If(modificationAutorisee, Color.FromArgb(243, 156, 18), Color.LightGray),
                   If(modificationAutorisee, Color.White, Color.DarkGray))

                ' Tooltip sp√©cial pour les devis factur√©s
                If statut.ToUpper() = "FACTUR√â" OrElse statut.ToUpper() = "FACTURE" Then
                    toolTipForm7.SetToolTip(btnModifierDevis, "Modification interdite - Devis d√©j√† factur√©")
                End If
            End If

            ' ‚≠ê BOUTON SUPPRIMER : JAMAIS autoris√© pour les devis factur√©s
            If btnSupprimerDevis IsNot Nothing Then
                Dim suppressionAutorisee As Boolean = (
                    {"BROUILLON", "ANNUL√â", "ANNULE"}.Contains(statut.ToUpper()) AndAlso
                    statut.ToUpper() <> "FACTUR√â" AndAlso statut.ToUpper() <> "FACTURE"
                )
                ConfigurerBouton(btnSupprimerDevis, suppressionAutorisee,
                   If(suppressionAutorisee, Color.FromArgb(231, 76, 60), Color.LightGray),
                   If(suppressionAutorisee, Color.White, Color.DarkGray))

                ' Tooltip sp√©cial pour les devis factur√©s
                If statut.ToUpper() = "FACTUR√â" OrElse statut.ToUpper() = "FACTURE" Then
                    toolTipForm7.SetToolTip(btnSupprimerDevis, "Suppression interdite - Devis d√©j√† factur√©")
                End If
            End If

            Console.WriteLine($"‚úÖ Boutons configur√©s pour statut: {statut}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur GererAutresBoutons: {ex.Message}")
        End Try
    End Sub

    Private Function RGB(red As Integer, green As Integer, blue As Integer) As Integer
        Return red + (green * 256) + (blue * 65536)
    End Function
    ' 2. NOUVELLE STRUCTURE : Statistiques des devis
    Public Structure StatistiquesDevis
        Public NombreTotal As Integer
        Public NombreBrouillons As Integer
        Public NombreEnvoyes As Integer
        Public NombreDeposes As Integer
        Public NombreRetournes As Integer
        Public NombreAcceptes As Integer
        Public NombreRefuses As Integer
        Public NombreAnnules As Integer
        Public MontantTotalHT As Decimal
        Public MontantMoyenHT As Decimal
        Public DatePremier As Date
        Public DateDernier As Date
        Public ProjetLePlusActif As String
    End Structure

    Private Sub btnCreerFactureManuel_Click(sender As Object, e As EventArgs) Handles btnCreerFactureManuel.Click
        If actionEnCours Then Return
        actionEnCours = True

        Try
            If dgvListeDevis.CurrentRow Is Nothing Then
                MessageBox.Show("Veuillez s√©lectionner un devis.", "Attention", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim devisID As Integer = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)
            Dim numeroDevis As String = dgvListeDevis.CurrentRow.Cells("NumeroDevis").Value.ToString() ' D√âCLARATION ICI
            Dim statutActuel As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString()

            ' V√©rification statut...
            If Not (statutActuel.ToUpper() = "COMMAND√â" OrElse statutActuel.ToUpper() = "COMMANDE") Then
                MessageBox.Show($"Seuls les devis avec le statut 'Command√©' peuvent √™tre factur√©s.",
                           "Bon de Commande Requis", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            ' V√©rifier si d√©j√† factur√©...
            If VerifierDevisDejaFacture(devisID) Then
                MessageBox.Show("Ce devis a d√©j√† √©t√© factur√©.", "D√©j√† factur√©", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' Cr√©er la facture
            Using frmFacture As New FormFacture()
                frmFacture.DevisIDSource = devisID
                frmFacture.NumeroDevisSource = numeroDevis

                If frmFacture.ShowDialog() = DialogResult.OK Then
                    ' NE PLUS CHANGER LE STATUT ICI - FormFacture s'en charge

                    ' Seulement recharger les donn√©es pour voir les changements
                    ChargerDevis()

                    ' Repositionner sur le devis concern√©
                    RepositionnerSurDevis(devisID)

                    ' Reconfigurer les boutons selon le nouveau statut
                    If dgvListeDevis.CurrentRow IsNot Nothing Then
                        Dim nouveauStatut As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString()
                        GererAutresBoutons(nouveauStatut)
                        GererBoutonCreerFacture()
                    End If

                    MessageBox.Show($"Processus de facturation termin√© pour le devis {numeroDevis}",
                          "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                End If
            End Using

        Catch ex As Exception
            MessageBox.Show($"Erreur lors de l'ouverture du formulaire facture : {ex.Message}",
                   "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            actionEnCours = False
        End Try
    End Sub

    ' 4. M√âTHODES UTILITAIRES SUPPL√âMENTAIRES :

    ' M√©thode pour bloquer apr√®s facturation SANS changer les textes
    Private Function VerifierAutorisationFacturation(devisID As Integer, statutDevis As String, ByRef messageErreur As String) As Boolean
        Try
            ' 1. V√©rifier si d√©j√† factur√©
            If VerifierDevisDejaFacture(devisID) Then
                ' R√©cup√©rer les d√©tails de la facture existante
                Dim queryFacture As String = "SELECT NumeroFacture, DateFacture, StatutFacture FROM Factures WHERE DevisID = @DevisID"
                Dim dtFacture As DataTable = DbHelper.GetData(queryFacture, {New SqlParameter("@DevisID", devisID)})

                If dtFacture.Rows.Count > 0 Then
                    Dim numeroFacture As String = dtFacture.Rows(0)("NumeroFacture").ToString()
                    Dim dateFacture As Date = CDate(dtFacture.Rows(0)("DateFacture"))

                    messageErreur = $"üö´ DEVIS D√âJ√Ä FACTUR√â" & vbCrLf & vbCrLf &
                              $"Facture existante : {numeroFacture}" & vbCrLf &
                              $"Date de cr√©ation : {dateFacture:dd/MM/yyyy}" & vbCrLf & vbCrLf &
                              "Impossible de cr√©er une nouvelle facture."
                Else
                    messageErreur = "üö´ Ce devis a d√©j√† √©t√© factur√©."
                End If
                Return False
            End If

            ' 2. V√©rifier le statut du devis - NOUVELLE LOGIQUE
            Select Case statutDevis.ToUpper()
                Case "BROUILLON"
                    messageErreur = $"üö´ FACTURATION BLOQU√âE" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Un devis en brouillon ne peut pas √™tre factur√©." & vbCrLf &
                              "Veuillez d'abord finaliser et envoyer le devis."
                    Return False

                Case "ENVOY√â"
                    messageErreur = $"üö´ FACTURATION BLOQU√âE" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Un devis envoy√© ne peut pas encore √™tre factur√©." & vbCrLf &
                              "Attendez le retour et l'acceptation du client."
                    Return False

                Case "D√âPOS√â"
                    messageErreur = $"üö´ FACTURATION BLOQU√âE" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Un devis d√©pos√© ne peut pas encore √™tre factur√©." & vbCrLf &
                              "Attendez le retour du client."
                    Return False

                Case "ACCEPT√â" ' ‚≠ê NOUVELLE R√àGLE : ACCEPT√â N'EST PLUS SUFFISANT
                    messageErreur = $"‚ö†Ô∏è BON DE COMMANDE REQUIS" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Un devis accept√© doit d'abord √™tre command√©." & vbCrLf & vbCrLf &
                              "Veuillez cr√©er un bon de commande pour passer " & vbCrLf &
                              "au statut 'Command√©' avant facturation."
                    Return False

                Case "REFUS√â"
                    messageErreur = $"üö´ FACTURATION IMPOSSIBLE" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Un devis refus√© ne peut pas √™tre factur√©."
                    Return False

                Case "ANNUL√â"
                    messageErreur = $"üö´ FACTURATION IMPOSSIBLE" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Un devis annul√© ne peut pas √™tre factur√©."
                    Return False

                Case "COMMAND√â", "COMMANDE" ' ‚≠ê SEUL STATUT AUTORIS√â MAINTENANT
                    ' ‚úÖ AUTORIS√â
                    Return True

                Case "RETOURN√â"
                    messageErreur = $"‚ö†Ô∏è D√âCISION CLIENT REQUISE" & vbCrLf & vbCrLf &
                              $"Statut actuel : {statutDevis}" & vbCrLf & vbCrLf &
                              "Attendez que le client accepte le devis, " & vbCrLf &
                              "puis cr√©ez un bon de commande."
                    Return False

                Case Else
                    messageErreur = $"‚ùì STATUT INCONNU" & vbCrLf & vbCrLf &
                              $"Statut : {statutDevis}" & vbCrLf & vbCrLf &
                              "Statut non reconnu pour la facturation."
                    Return False
            End Select

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification autorisation: {ex.Message}")
            messageErreur = $"Erreur technique lors de la v√©rification : {ex.Message}"
            Return False
        End Try
    End Function
    Private Sub ReinitialiserStylesDGV()
        Try
            Console.WriteLine("üßπ R√©initialisation des styles DGV")

            ' R√©initialiser tous les styles des lignes
            For Each row As DataGridViewRow In dgvListeDevis.Rows
                If Not row.IsNewRow Then
                    ' Style par d√©faut pour la ligne
                    row.DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Regular)
                    row.DefaultCellStyle.ForeColor = Color.Black
                    row.DefaultCellStyle.BackColor = Color.White

                    ' R√©initialiser chaque cellule
                    For Each cell As DataGridViewCell In row.Cells
                        cell.Style.Font = Nothing ' Utiliser la police par d√©faut
                        cell.Style.ForeColor = Color.Empty
                        cell.Style.BackColor = Color.Empty
                    Next
                End If
            Next

            Console.WriteLine("‚úÖ Styles DGV r√©initialis√©s")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©initialisation styles: {ex.Message}")
        End Try
    End Sub
    Private Sub GererBoutonCreerFacture()
        Try
            If dgvListeDevis.CurrentRow Is Nothing Then
                ConfigurerBouton(btnCreerFactureManuel, False, Color.LightGray, Color.DarkGray)
                toolTipForm7.SetToolTip(btnCreerFactureManuel, "S√©lectionnez un devis")
                Return
            End If

            Dim devisID As Integer = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)
            Dim statutDevis As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString().Trim().ToUpper()

            Console.WriteLine($"üîß Gestion bouton facture - Statut: '{statutDevis}', DevisID: {devisID}")

            ' V√âRIFIER SI DEVIS D√âJ√Ä FACTUR√â
            If VerifierDevisDejaFacture(devisID) Then
                ConfigurerBouton(btnCreerFactureManuel, False, Color.LightGray, Color.DarkGray)
                toolTipForm7.SetToolTip(btnCreerFactureManuel, "Ce devis a d√©j√† √©t√© factur√©")
                Console.WriteLine($"üö´ Devis {devisID} d√©j√† factur√©")
                Return
            End If

            ' ‚≠ê LOGIQUE CORRIG√âE : Accepter COMMAND√â et COMMANDE (nettoy√©s)
            Dim facturationAutorisee As Boolean = (
                statutDevis = "COMMAND√â" OrElse
                statutDevis = "COMMANDE" OrElse
                statutDevis = "COMMAND√â" OrElse  ' Avec accent
                statutDevis = "COMMANDE"         ' Sans accent
            )

            Console.WriteLine($"üîß Facturation autoris√©e: {facturationAutorisee}")

            ConfigurerBouton(btnCreerFactureManuel, facturationAutorisee,
                If(facturationAutorisee, Color.FromArgb(46, 204, 113), Color.LightGray),
                If(facturationAutorisee, Color.White, Color.DarkGray))

            ' ‚≠ê TOOLTIPS ADAPT√âS
            If facturationAutorisee Then
                toolTipForm7.SetToolTip(btnCreerFactureManuel, "‚úÖ Cr√©er une facture - Devis command√©")
            Else
                Select Case statutDevis
                    Case "BROUILLON"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Finalisez d'abord le devis")
                    Case "ENVOY√â", "ENVOYE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Attendez l'acceptation du client")
                    Case "D√âPOS√â", "DEPOSE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Attendez le retour du client")
                    Case "RETOURN√â", "RETOURNE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "En attente de d√©cision client")
                    Case "ACCEPT√â", "ACCEPTE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "‚ö†Ô∏è Cr√©ez d'abord un bon de commande")
                    Case "R√âVISION", "REVISIONS"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Le client demande des r√©visions")
                    Case "REFUS√â", "REFUSE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Devis refus√© - Facturation impossible")
                    Case "ANNUL√â", "ANNULE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Devis annul√© - Facturation impossible")
                    Case "FACTUR√â", "FACTURE"
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, "Devis d√©j√† factur√©")
                    Case Else
                        toolTipForm7.SetToolTip(btnCreerFactureManuel, $"Statut '{statutDevis}' - Bon de commande requis")
                End Select
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur GererBoutonCreerFacture: {ex.Message}")
            ConfigurerBouton(btnCreerFactureManuel, False, Color.LightGray, Color.DarkGray)
        End Try
    End Sub

    ' üîí 2. V√âRIFIER SI DEVIS D√âJ√Ä FACTUR√â
    ' ===============================================================================
    Private Function VerifierDevisDejaFacture(devisID As Integer) As Boolean
        Try
            Dim query As String = "SELECT COUNT(*) FROM Factures WHERE DevisID = @DevisID"
            Dim dtVerif As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dtVerif.Rows.Count > 0 AndAlso CInt(dtVerif.Rows(0)(0)) > 0 Then
                Console.WriteLine($"üö´ Devis {devisID} d√©j√† factur√©")
                Return True
            End If

            Return False

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification facture: {ex.Message}")
            Return True ' En cas d'erreur, bloquer par s√©curit√©
        End Try
    End Function
    ' üîí 3. BLOQUER MODIFICATIONS SI DEVIS FACTUR√â
    ' ===============================================================================
    Private Sub VerifierEtBloquerModifications()
        Try
            If dgvListeDevis.CurrentRow Is Nothing Then
                Return
            End If

            Dim devisID As Integer = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)
            Dim numeroDevis As String = dgvListeDevis.CurrentRow.Cells("NumeroDevis").Value.ToString()

            If VerifierDevisDejaFacture(devisID) Then
                ' BLOQUER TOUS LES BOUTONS DE MODIFICATION
                BloquerBoutonsModification(numeroDevis)
            Else
                ' R√âACTIVER LES BOUTONS NORMALEMENT
                ReactiversBoutonsModification()
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification modifications: {ex.Message}")
        End Try
    End Sub
    Private Sub BloquerBoutonsModification(numeroDevis As String)
        Try
            ' ‚≠ê GARDER LES APPARENCES ORIGINALES, SEULEMENT D√âSACTIVER

            ' Modifier Devis - Apparence originale conserv√©e
            If btnModifierDevis IsNot Nothing Then
                btnModifierDevis.Enabled = False
                btnModifierDevis.Text = "‚úèÔ∏è Modifier" ' GARDER le texte original
                btnModifierDevis.BackColor = Color.FromArgb(243, 156, 18) ' GARDER la couleur originale
                btnModifierDevis.ForeColor = Color.White
                toolTipForm7.SetToolTip(btnModifierDevis, $"Modification interdite - Devis {numeroDevis} d√©j√† factur√©")
            End If

            ' Supprimer Devis - Apparence originale conserv√©e
            If btnSupprimerDevis IsNot Nothing Then
                btnSupprimerDevis.Enabled = False
                btnSupprimerDevis.Text = "üóëÔ∏è Supprimer" ' GARDER le texte original
                btnSupprimerDevis.BackColor = Color.FromArgb(231, 76, 60) ' GARDER la couleur originale
                btnSupprimerDevis.ForeColor = Color.White
                toolTipForm7.SetToolTip(btnSupprimerDevis, $"Suppression interdite - Devis {numeroDevis} d√©j√† factur√©")
            End If

            ' D√©p√¥t Devis - Apparence originale conserv√©e
            If btnDeposerDevis IsNot Nothing Then
                btnDeposerDevis.Enabled = False
                btnDeposerDevis.Text = "üì¶ D√©poser Devis" ' GARDER le texte original
                btnDeposerDevis.BackColor = Color.FromArgb(52, 152, 219) ' GARDER la couleur originale
                btnDeposerDevis.ForeColor = Color.White
                toolTipForm7.SetToolTip(btnDeposerDevis, "D√©p√¥t non autoris√© - Devis factur√©")
            End If

            ' Retour Devis - Apparence originale conserv√©e  
            If btnRetourDevis IsNot Nothing Then
                btnRetourDevis.Enabled = False
                btnRetourDevis.Text = "üîÑ D√©cision Client"  ' ‚≠ê MODIFICATION ICI
                btnRetourDevis.BackColor = Color.FromArgb(155, 89, 182) ' GARDER la couleur originale
                btnRetourDevis.ForeColor = Color.White
                toolTipForm7.SetToolTip(btnRetourDevis, "Retour non autoris√© - Devis factur√©")
            End If

            Console.WriteLine($"üîí Boutons d√©sactiv√©s avec apparence originale conserv√©e: {numeroDevis}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur blocage boutons: {ex.Message}")
        End Try
    End Sub

    Private Sub ReactiversBoutonsModification()
        Try
            ' R√©activer selon les r√®gles normales (votre logique existante)
            If dgvListeDevis.CurrentRow IsNot Nothing Then
                Dim statut As String = dgvListeDevis.CurrentRow.Cells("StatutDevis").Value.ToString()
                GererAutresBoutons(statut)
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©activation boutons: {ex.Message}")
        End Try
    End Sub
    ' üî• AJOUT : M√©thode utilitaire pour initialiser correctement les boutons au chargement
    Private Sub InitialiserApparenceBoutons()
        Try
            ' ‚≠ê D√âFINIR LES APPARENCES STANDARD UNE FOIS POUR TOUTES

            If btnDeposerDevis IsNot Nothing Then
                btnDeposerDevis.Text = "üì¶ D√©poser Devis"
                btnDeposerDevis.BackColor = Color.FromArgb(52, 152, 219)
                btnDeposerDevis.ForeColor = Color.White
                btnDeposerDevis.FlatStyle = FlatStyle.Flat
            End If

            If btnRetourDevis IsNot Nothing Then
                btnRetourDevis.Text = "üîÑ Retour Devis"
                btnRetourDevis.BackColor = Color.FromArgb(155, 89, 182)
                btnRetourDevis.ForeColor = Color.White
                btnRetourDevis.FlatStyle = FlatStyle.Flat
            End If

            If btnCreerFactureManuel IsNot Nothing Then
                btnCreerFactureManuel.Text = "üí∞ Cr√©er Facture"
                btnCreerFactureManuel.BackColor = Color.FromArgb(46, 204, 113)
                btnCreerFactureManuel.ForeColor = Color.White
                btnCreerFactureManuel.FlatStyle = FlatStyle.Flat
            End If

            If btnModifierDevis IsNot Nothing Then
                btnModifierDevis.Text = "‚úèÔ∏è Modifier"
                btnModifierDevis.BackColor = Color.FromArgb(243, 156, 18)
                btnModifierDevis.ForeColor = Color.White
                btnModifierDevis.FlatStyle = FlatStyle.Flat
            End If

            If btnSupprimerDevis IsNot Nothing Then
                btnSupprimerDevis.Text = "üóëÔ∏è Supprimer"
                btnSupprimerDevis.BackColor = Color.FromArgb(231, 76, 60)
                btnSupprimerDevis.ForeColor = Color.White
                btnSupprimerDevis.FlatStyle = FlatStyle.Flat
            End If

            Console.WriteLine("‚úÖ Apparences standard des boutons initialis√©es")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur initialisation boutons: {ex.Message}")
        End Try
    End Sub
    ' ===============================================================================
    ' M√âTHODES MANQUANTES √Ä AJOUTER DANS FORM7.VB
    ' Ajoutez ces m√©thodes n'importe o√π dans votre classe Form7
    ' ===============================================================================

    ' 1. M√âTHODE CENTRALE : Configure un bouton SANS changer son texte
    Private Sub ConfigurerBouton(bouton As Button, actif As Boolean, couleurFond As Color, couleurTexte As Color)
        If bouton IsNot Nothing Then
            ' ‚≠ê NE JAMAIS TOUCHER AU TEXTE - Il reste tel que d√©fini dans le designer
            bouton.Enabled = actif
            bouton.BackColor = couleurFond
            bouton.ForeColor = couleurTexte

            ' Assurer une apparence coh√©rente
            If bouton.FlatStyle <> FlatStyle.Flat Then
                bouton.FlatStyle = FlatStyle.Flat
            End If
        End If
    End Sub

    ' 2. M√âTHODE : D√©sactiver tous les boutons workflow
    Private Sub DesactiverTousBoutons()
        ConfigurerBouton(btnModifierDevis, False, Color.LightGray, Color.DarkGray)
        ConfigurerBouton(btnSupprimerDevis, False, Color.LightGray, Color.DarkGray)
        ConfigurerBouton(btnDeposerDevis, False, Color.LightGray, Color.DarkGray)

        ' ‚≠ê FORCER LE TEXTE ICI AUSSI
        If btnRetourDevis IsNot Nothing Then
            btnRetourDevis.Text = "üîÑ D√©cision Client"
        End If
        ConfigurerBouton(btnRetourDevis, False, Color.LightGray, Color.DarkGray)

        ConfigurerBouton(btnCreerFactureManuel, False, Color.LightGray, Color.DarkGray)
    End Sub

    ' 3. M√âTHODE : Pr√©server les textes originaux (appel dans Form7_Load)
    Private Sub PreserverTextesOriginauxBoutons()
        ' Cette m√©thode assure que les textes des boutons ne changent jamais
        Console.WriteLine("‚úÖ Textes originaux des boutons pr√©serv√©s:")
        If btnDeposerDevis IsNot Nothing Then Console.WriteLine($"   D√©p√¥t: '{btnDeposerDevis.Text}'")
        If btnRetourDevis IsNot Nothing Then Console.WriteLine($"   Retour: '{btnRetourDevis.Text}'")
        If btnCreerFactureManuel IsNot Nothing Then Console.WriteLine($"   Facture: '{btnCreerFactureManuel.Text}'")
        If btnModifierDevis IsNot Nothing Then Console.WriteLine($"   Modifier: '{btnModifierDevis.Text}'")
        If btnSupprimerDevis IsNot Nothing Then Console.WriteLine($"   Supprimer: '{btnSupprimerDevis.Text}'")
    End Sub

    ' 4. M√âTHODE : Bloquer apr√®s facturation SANS changer les textes
    Private Sub BloquerToutesModificationsApresFacturation(numeroDevis As String)
        Try
            ' Tous les boutons deviennent gris et d√©sactiv√©s MAIS gardent leur texte original
            ConfigurerBouton(btnModifierDevis, False, Color.LightGray, Color.DarkGray)
            ConfigurerBouton(btnSupprimerDevis, False, Color.LightGray, Color.DarkGray)
            ConfigurerBouton(btnDeposerDevis, False, Color.LightGray, Color.DarkGray)
            ConfigurerBouton(btnRetourDevis, False, Color.LightGray, Color.DarkGray)
            ConfigurerBouton(btnCreerFactureManuel, False, Color.LightGray, Color.DarkGray)

            ' Messages explicatifs dans les tooltips seulement
            toolTipForm7.SetToolTip(btnModifierDevis, $"Devis {numeroDevis} factur√© - Modifications interdites")
            toolTipForm7.SetToolTip(btnSupprimerDevis, $"Devis {numeroDevis} factur√© - Suppression interdite")
            toolTipForm7.SetToolTip(btnDeposerDevis, $"Devis {numeroDevis} factur√© - D√©p√¥t non applicable")
            toolTipForm7.SetToolTip(btnRetourDevis, $"Devis {numeroDevis} factur√© - Retour non applicable")
            toolTipForm7.SetToolTip(btnCreerFactureManuel, $"Devis {numeroDevis} d√©j√† factur√©")

            Console.WriteLine($"üîí Toutes modifications bloqu√©es pour devis factur√©: {numeroDevis} (textes pr√©serv√©s)")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur blocage modifications: {ex.Message}")
        End Try
    End Sub

    ' 5. M√âTHODE : Mise √† jour dynamique du statut
    Private Sub MettreAJourStatutDynamique(devisID As Integer, nouveauStatut As String)
        Try
            ' Mettre √† jour en base de donn√©es
            MettreAJourStatutDevis(devisID, nouveauStatut)

            ' Mettre √† jour imm√©diatement dans le DataGridView SANS recharger
            If dgvListeDevis.CurrentRow IsNot Nothing Then
                dgvListeDevis.CurrentRow.Cells("StatutDevis").Value = nouveauStatut

                ' Forcer le rafra√Æchissement visuel
                dgvListeDevis.Refresh()
                ConfigurerColonnesListeDevis()

                ' Reconfigurer les boutons pour le nouveau statut (SANS changer les textes)
                GererAutresBoutons(nouveauStatut)
                GererBoutonCreerFacture()

                Console.WriteLine($"‚úÖ Statut mis √† jour dynamiquement: {nouveauStatut} (textes boutons pr√©serv√©s)")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur mise √† jour statut dynamique: {ex.Message}")
            ' En cas d'erreur, recharger compl√®tement
            ChargerDevis()
        End Try
    End Sub
    ' 5. M√âTHODE POUR METTRE √Ä JOUR LES COLONNES DU DGV AUTOMATIQUEMENT
    Private Sub MettreAJourColonnesForm7ApresAction(action As String, nouveauStatut As String)
        Try
            For Each row As DataGridViewRow In dgvListeDevis.Rows
                If Not row.IsNewRow AndAlso CInt(row.Cells("DevisID").Value) = devisID Then

                    ' R√©cup√©ration des donn√©es Form6 et Form18
                    Dim donneesForm6 As Object = RecupererDonneesForm6(devisID)
                    Dim donneesForm18 As Object = RecupererDonneesForm18(devisID)

                    ' Remplissage automatique des colonnes correspondantes
                    If donneesForm6 IsNot Nothing Then
                        RemplirColonnesDepuisForm6(row, donneesForm6)
                    End If

                    If donneesForm18 IsNot Nothing Then
                        RemplirColonnesDepuisForm18(row, donneesForm18)
                    End If

                    ' Mise √† jour du statut
                    row.Cells("StatutDevis").Value = nouveauStatut

                    ' Ajouter timestamp selon l'action
                    Select Case action.ToUpper()
                        Case "DEPOT"
                            If dgvListeDevis.Columns.Contains("DateDepot") Then
                                row.Cells("DateDepot").Value = DateTime.Now
                            End If
                        Case "RETOUR"
                            If dgvListeDevis.Columns.Contains("DateRetour") Then
                                row.Cells("DateRetour").Value = DateTime.Now
                            End If
                    End Select

                    Exit For
                End If
            Next

            dgvListeDevis.Refresh()
            ConfigurerColonnesListeDevis()

            Console.WriteLine($"‚úÖ Colonnes DGV mises √† jour automatiquement - Action: {action}, Statut: {nouveauStatut}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur mise √† jour colonnes DGV: {ex.Message}")
        End Try
    End Sub
    ' 6. M√âTHODES UTILITAIRES POUR R√âCUP√âRER LES DONN√âES
    Private Function RecupererDonneesForm6(devisID As Integer) As Object
        Try
            Dim query As String = "SELECT * FROM DepotDevis WHERE DevisID = @DevisID ORDER BY DateDepot DESC"
            Dim dt As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dt.Rows.Count > 0 Then
                Return dt.Rows(0)
            End If

            Return Nothing
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration donn√©es Form6: {ex.Message}")
            Return Nothing
        End Try
    End Function

    Private Function RecupererDonneesForm18(devisID As Integer) As Object
        Try
            Dim query As String = "SELECT * FROM RetourDevis WHERE DevisID = @DevisID ORDER BY DateRetour DESC"
            Dim dt As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dt.Rows.Count > 0 Then
                Return dt.Rows(0)
            End If

            Return Nothing
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration donn√©es Form18: {ex.Message}")
            Return Nothing
        End Try
    End Function

    Private Sub RemplirColonnesDepuisForm6(row As DataGridViewRow, donneesForm6 As DataRow)
        Try
            If dgvListeDevis.Columns.Contains("MethodeDepot") Then
                row.Cells("MethodeDepot").Value = If(IsDBNull(donneesForm6("MethodeDepot")), "", donneesForm6("MethodeDepot").ToString())
            End If

            If dgvListeDevis.Columns.Contains("CommentaireDepot") Then
                row.Cells("CommentaireDepot").Value = If(IsDBNull(donneesForm6("Commentaires")), "", donneesForm6("Commentaires").ToString())
            End If

            If dgvListeDevis.Columns.Contains("DateDepot") Then
                row.Cells("DateDepot").Value = If(IsDBNull(donneesForm6("DateDepot")), Nothing, donneesForm6("DateDepot"))
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur remplissage colonnes Form6: {ex.Message}")
        End Try
    End Sub

    Private Sub RemplirColonnesDepuisForm18(row As DataGridViewRow, donneesForm18 As DataRow)
        Try
            If dgvListeDevis.Columns.Contains("DecisionClient") Then
                row.Cells("DecisionClient").Value = If(IsDBNull(donneesForm18("DecisionClient")), "", donneesForm18("DecisionClient").ToString())
            End If

            If dgvListeDevis.Columns.Contains("CommentaireRetour") Then
                row.Cells("CommentaireRetour").Value = If(IsDBNull(donneesForm18("Commentaire")), "", donneesForm18("Commentaire").ToString())
            End If

            If dgvListeDevis.Columns.Contains("DateRetour") Then
                row.Cells("DateRetour").Value = If(IsDBNull(donneesForm18("DateRetour")), Nothing, donneesForm18("DateRetour"))
            End If

            If dgvListeDevis.Columns.Contains("MotifRefus") Then
                row.Cells("MotifRefus").Value = If(IsDBNull(donneesForm18("MotifRefus")), "", donneesForm18("MotifRefus").ToString())
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur remplissage colonnes Form18: {ex.Message}")
        End Try
    End Sub
    ' 7. AJOUTER UNE M√âTHODE POUR AFFICHER LES STATISTIQUES DES PROJETS
    Private Sub AfficherStatutsProjets()
        Try
            Dim query As String = "SELECT StatutProjet, COUNT(*) as Nombre FROM Projets GROUP BY StatutProjet ORDER BY StatutProjet"
            Dim dtStatuts As DataTable = DbHelper.GetData(query, New SqlParameter() {})

            Dim message As New StringBuilder()
            message.AppendLine("üìä √âTAT DES PROJETS")
            message.AppendLine("=" & New String("=", 30))
            message.AppendLine()

            Dim totalProjets As Integer = 0
            Dim projetsTermines As Integer = 0

            For Each row As DataRow In dtStatuts.Rows
                Dim statut As String = row("StatutProjet").ToString()
                Dim nombre As Integer = CInt(row("Nombre"))
                totalProjets += nombre

                If statut.ToUpper() = "TERMINE" OrElse statut.ToUpper() = "TERMIN√â" Then
                    projetsTermines += nombre
                    message.AppendLine($"‚úÖ {statut} : {nombre} projet(s)")
                Else
                    message.AppendLine($"‚è≥ {statut} : {nombre} projet(s)")
                End If
            Next

            message.AppendLine()
            message.AppendLine($"üìã Total projets : {totalProjets}")
            message.AppendLine($"‚úÖ Projets termin√©s : {projetsTermines}")
            message.AppendLine($"üìù Projets disponibles pour devis : {projetsTermines}")

            If projetsTermines = 0 Then
                message.AppendLine()
                message.AppendLine("‚ö†Ô∏è Aucun projet termin√© disponible")
                message.AppendLine("Terminez d'abord un projet pour cr√©er des devis.")
            End If

            MessageBox.Show(message.ToString(), "Statuts Projets", MessageBoxButtons.OK, MessageBoxIcon.Information)

        Catch ex As Exception
            MessageBox.Show("Erreur lors de l'affichage des statuts : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' ========== 5. MODIFIER LA M√âTHODE ChargerDetailsProjet POUR DEVIS ==========
    ' Si vous avez une m√©thode pour charger les d√©tails d'un devis en modification
    Private Sub ChargerDetailsDevisPourModification(devisID As Integer)
        Try
            ' üî• REQU√äTE MODIFI√âE : Inclure le num√©ro de projet
            Dim query As String = "SELECT D.*, P.NomProjet, P.NumeroProjet, " &
                                 "AC.NumeroAppel " &
                                 "FROM Devis D " &
                                 "JOIN Projets P ON D.ProjetID = P.ProjetID " &
                                 "LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID " &
                                 "WHERE D.DevisID = @DevisID"

            Dim dtDevis As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dtDevis.Rows.Count > 0 Then
                Dim row As DataRow = dtDevis.Rows(0)

                ' Remplir les champs existants
                txtNumeroDevis.Text = GetStringValue(row, "NumeroDevis")
                cmbProjetDevis.SelectedValue = GetIntValue(row, "ProjetID")
                dtpDateDevis.Value = CDate(row("DateDevis"))
                cmbStatutDevis.SelectedItem = GetStringValue(row, "StatutDevis")
                txtObjetDevis.Text = GetStringValue(row, "ObjetDevis")

                ' üî• REMPLIR LES NUM√âROS
                txtNumeroAppel.Text = GetStringValue(row, "NumeroAppel")
                If txtNumeroProjet IsNot Nothing Then
                    txtNumeroProjet.Text = GetStringValue(row, "NumeroProjet")
                End If

                ' Montants
                txtMontantHT.Text = CDec(row("MontantHT")).ToString("N2") & " FCFA"

                ChargerLignesDevisPourModification(devisID)
            End If

        Catch ex As Exception
            MessageBox.Show("Erreur lors du chargement des d√©tails : " & ex.Message, "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' ========== 6. M√âTHODE UTILITAIRE ==========
    Private Function GetStringValue(row As DataRow, columnName As String) As String
        Return If(IsDBNull(row(columnName)), "", row(columnName).ToString())
    End Function

    Private Function GetIntValue(row As DataRow, columnName As String) As Integer
        Return If(IsDBNull(row(columnName)), 0, CInt(row(columnName)))
    End Function
    ' 3. ALTERNATIVE : REQU√äTE ENCORE PLUS STRICTE (si les doublons persistent)
    Private Sub ChargerDonneesAppelProjetAlternatif()
        Try
            ' üî• APPROCHE ALTERNATIVE : Requ√™te en deux √©tapes pour garantir l'unicit√©

            ' √âtape 1 : R√©cup√©rer les projets √©ligibles
            Dim queryProjets As String =
                "SELECT DISTINCT P.ProjetID, P.NomProjet, P.NumeroProjet, P.TypeProjet, P.StatutProjet, " &
                "P.Description as DescriptionProjet, P.ClientID, P.AppelClientID " &
                "FROM Projets P " &
                "WHERE P.StatutProjet IN ('Termine', 'Termin√©') " &
                "AND P.TypeProjet IN ('Urgence', 'GreaGre', 'AppelOffres') " &
                "AND P.ProjetID NOT IN (SELECT DISTINCT ProjetID FROM Devis WHERE ProjetID IS NOT NULL)"

            Dim dtProjetsBase As DataTable = DbHelper.GetData(queryProjets, New SqlParameter() {})

            ' √âtape 2 : Cr√©er le DataTable final sans doublons
            dtAppelProjet = New DataTable()
            dtAppelProjet.Columns.Add("ProjetID", GetType(Integer))
            dtAppelProjet.Columns.Add("NomProjet", GetType(String))
            dtAppelProjet.Columns.Add("NumeroProjet", GetType(String))
            dtAppelProjet.Columns.Add("TypeProjet", GetType(String))
            dtAppelProjet.Columns.Add("StatutProjet", GetType(String))
            dtAppelProjet.Columns.Add("DescriptionProjet", GetType(String))
            dtAppelProjet.Columns.Add("ClientID", GetType(Integer))
            dtAppelProjet.Columns.Add("NomClient", GetType(String))
            dtAppelProjet.Columns.Add("NumeroAppel", GetType(String))
            dtAppelProjet.Columns.Add("Sujet", GetType(String))
            dtAppelProjet.Columns.Add("DescriptionAppel", GetType(String))
            dtAppelProjet.Columns.Add("DateAppel", GetType(Date))

            ' √âtape 3 : Remplir avec les donn√©es compl√®tes (un projet = une ligne)
            For Each projetRow As DataRow In dtProjetsBase.Rows
                Try
                    Dim projetID As Integer = CInt(projetRow("ProjetID"))
                    Dim clientID As Integer = CInt(projetRow("ClientID"))
                    Dim appelClientID As Object = projetRow("AppelClientID")

                    ' R√©cup√©rer les infos client
                    Dim queryClient As String = "SELECT NomClient FROM Clients WHERE ClientID = @ClientID"
                    Dim dtClient As DataTable = DbHelper.GetData(queryClient, {New SqlParameter("@ClientID", clientID)})
                    Dim nomClient As String = If(dtClient.Rows.Count > 0, dtClient.Rows(0)("NomClient").ToString(), "Client inconnu")

                    ' R√©cup√©rer les infos appel (si existe)
                    Dim numeroAppel As String = ""
                    Dim sujet As String = ""
                    Dim descriptionAppel As String = ""
                    Dim dateAppel As Date = Date.MinValue

                    If appelClientID IsNot DBNull.Value Then
                        Dim queryAppel As String = "SELECT NumeroAppel, Sujet, Description, DateAppel FROM AppelClient WHERE AppelClientID = @AppelClientID"
                        Dim dtAppel As DataTable = DbHelper.GetData(queryAppel, {New SqlParameter("@AppelClientID", appelClientID)})

                        If dtAppel.Rows.Count > 0 Then
                            numeroAppel = If(IsDBNull(dtAppel.Rows(0)("NumeroAppel")), "", dtAppel.Rows(0)("NumeroAppel").ToString())
                            sujet = If(IsDBNull(dtAppel.Rows(0)("Sujet")), "", dtAppel.Rows(0)("Sujet").ToString())
                            descriptionAppel = If(IsDBNull(dtAppel.Rows(0)("Description")), "", dtAppel.Rows(0)("Description").ToString())
                            If Not IsDBNull(dtAppel.Rows(0)("DateAppel")) Then
                                dateAppel = CDate(dtAppel.Rows(0)("DateAppel"))
                            End If
                        End If
                    End If

                    ' Ajouter la ligne unique
                    Dim newRow As DataRow = dtAppelProjet.NewRow()
                    newRow("ProjetID") = projetID
                    newRow("NomProjet") = projetRow("NomProjet").ToString()
                    newRow("NumeroProjet") = If(IsDBNull(projetRow("NumeroProjet")), "", projetRow("NumeroProjet").ToString())
                    newRow("TypeProjet") = projetRow("TypeProjet").ToString()
                    newRow("StatutProjet") = projetRow("StatutProjet").ToString()
                    newRow("DescriptionProjet") = If(IsDBNull(projetRow("DescriptionProjet")), "", projetRow("DescriptionProjet").ToString())
                    newRow("ClientID") = clientID
                    newRow("NomClient") = nomClient
                    newRow("NumeroAppel") = numeroAppel
                    newRow("Sujet") = sujet
                    newRow("DescriptionAppel") = descriptionAppel
                    newRow("DateAppel") = If(dateAppel = Date.MinValue, DBNull.Value, dateAppel)

                    dtAppelProjet.Rows.Add(newRow)

                Catch rowEx As Exception
                    Console.WriteLine($"‚ùå Erreur traitement projet {projetRow("ProjetID")}: {rowEx.Message}")
                    Continue For
                End Try
            Next

            ' Trier par date d'appel puis nom de projet
            Dim dv As DataView = dtAppelProjet.DefaultView
            dv.Sort = "DateAppel DESC, NomProjet ASC"
            dtAppelProjet = dv.ToTable()

            Console.WriteLine($"‚úÖ {dtAppelProjet.Rows.Count} projets uniques charg√©s (m√©thode alternative)")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur chargement alternatif: {ex.Message}")
            dtAppelProjet = New DataTable()
        End Try
    End Sub

    ' 4. M√âTHODE DE DEBUG POUR IDENTIFIER LES DOUBLONS
    Private Sub DebugDoublonsAppelProjet()
        Try
            If dtAppelProjet Is Nothing Then Return

            Console.WriteLine("=== DEBUG DOUBLONS APPEL/PROJET ===")

            Dim groupesProjetID As New Dictionary(Of Integer, Integer)

            For Each row As DataRow In dtAppelProjet.Rows
                Dim projetID As Integer = CInt(row("ProjetID"))

                If groupesProjetID.ContainsKey(projetID) Then
                    groupesProjetID(projetID) += 1
                Else
                    groupesProjetID(projetID) = 1
                End If
            Next

            Console.WriteLine($"Total lignes dans dtAppelProjet: {dtAppelProjet.Rows.Count}")
            Console.WriteLine($"Projets uniques: {groupesProjetID.Count}")

            ' Afficher les doublons
            For Each kvp In groupesProjetID
                If kvp.Value > 1 Then
                    Console.WriteLine($"üî¥ DOUBLON D√âTECT√â - ProjetID {kvp.Key}: {kvp.Value} occurrences")

                    ' Afficher les d√©tails des doublons
                    For Each row As DataRow In dtAppelProjet.Rows
                        If CInt(row("ProjetID")) = kvp.Key Then
                            Console.WriteLine($"   - {row("NomProjet")} | {row("NumeroAppel")} | {row("NomClient")}")
                        End If
                    Next
                End If
            Next

            Console.WriteLine("===================================")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur debug doublons: {ex.Message}")
        End Try
    End Sub

    ' 5. V√âRIFICATION SUPPL√âMENTAIRE AVANT AJOUT √Ä LA COMBOBOX
    Private Function ProjetDejaPresent(items As ComboBox.ObjectCollection, projetID As Integer) As Boolean
        Try
            For Each item As AppelProjetItem In items
                If item.ProjetID = projetID Then
                    Return True
                End If
            Next
            Return False
        Catch
            Return False
        End Try
    End Function

    ' 6. M√âTHODE POUR NETTOYER LA COMBOBOX DES DOUBLONS
    Private Sub NettoyerComboBoxDoublons()
        Try
            If cmbAppelProjetSelection.Items.Count <= 1 Then Return

            Dim itemsUniques As New List(Of AppelProjetItem)
            Dim projetsVus As New HashSet(Of Integer)

            For Each item As AppelProjetItem In cmbAppelProjetSelection.Items
                If Not projetsVus.Contains(item.ProjetID) Then
                    itemsUniques.Add(item)
                    projetsVus.Add(item.ProjetID)
                End If
            Next

            If itemsUniques.Count < cmbAppelProjetSelection.Items.Count Then
                Console.WriteLine($"üßπ Nettoyage doublons ComboBox: {cmbAppelProjetSelection.Items.Count} ‚Üí {itemsUniques.Count}")

                cmbAppelProjetSelection.Items.Clear()
                For Each item In itemsUniques
                    cmbAppelProjetSelection.Items.Add(item)
                Next
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur nettoyage ComboBox: {ex.Message}")
        End Try
    End Sub
    ' 5. M√âTHODES DE NETTOYAGE POUR √âVITER LES MOTS PARASITES
    ' ===============================================================================
    Private Function NettoyerSujetAppel(sujet As String) As String
        Try
            If String.IsNullOrWhiteSpace(sujet) Then Return ""

            Dim sujetNettoye As String = sujet.Trim()

            ' ‚≠ê LISTE DES MOTS PARASITES √Ä √âVITER
            Dim motsParasites() As String = {
                    "r√©paration", "reparation", "r√©par", "reparation",
                    "divers", "autre", "g√©n√©rique", "generique",
                    "test", "essai", "temporaire", "temp"
                }

            ' V√©rifier si le sujet contient uniquement des mots parasites
            For Each motParasite In motsParasites
                If sujetNettoye.ToLower().Trim() = motParasite.ToLower() Then
                    Console.WriteLine($"‚ö†Ô∏è Sujet parasite d√©tect√©: '{sujet}' ‚Üí rejet√©")
                    Return ""
                End If
            Next

            ' Nettoyer les caract√®res ind√©sirables
            sujetNettoye = sujetNettoye.Replace("  ", " ").Trim()

            ' Si trop court, rejeter
            If sujetNettoye.Length < 3 Then
                Console.WriteLine($"‚ö†Ô∏è Sujet trop court: '{sujet}' ‚Üí rejet√©")
                Return ""
            End If

            Console.WriteLine($"‚úÖ Sujet nettoy√©: '{sujet}' ‚Üí '{sujetNettoye}'")
            Return sujetNettoye

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur nettoyage sujet: {ex.Message}")
            Return ""
        End Try
    End Function

    Private Function NettoyerDescription(description As String) As String
        Try
            If String.IsNullOrWhiteSpace(description) Then Return ""

            Dim descriptionNettoyee As String = description.Trim()

            ' Limiter la longueur pour l'objet du devis
            If descriptionNettoyee.Length > 100 Then
                descriptionNettoyee = descriptionNettoyee.Substring(0, 97) & "..."
            End If

            ' Supprimer les retours √† la ligne
            descriptionNettoyee = descriptionNettoyee.Replace(vbCrLf, " ").Replace(vbLf, " ").Replace(vbCr, " ")
            descriptionNettoyee = descriptionNettoyee.Replace("  ", " ").Trim()

            ' V√©rifier les mots parasites
            If descriptionNettoyee.ToLower().Contains("r√©paration") AndAlso descriptionNettoyee.Length < 20 Then
                Console.WriteLine($"‚ö†Ô∏è Description contient mot parasite: '{description}' ‚Üí rejet√©")
                Return ""
            End If

            Console.WriteLine($"‚úÖ Description nettoy√©e: '{descriptionNettoyee}'")
            Return descriptionNettoyee

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur nettoyage description: {ex.Message}")
            Return ""
        End Try
    End Function

    ' 6. M√âTHODE DE DEBUG POUR INVESTIGUER LE PROBL√àME
    ' ===============================================================================
    Public Sub DiagnostiquerObjetDevis(projetID As Integer)
        Try
            Console.WriteLine($"üîç === DIAGNOSTIC OBJET DEVIS PROJET {projetID} ===")

            ' Diagnostic projet
            Dim queryProjet As String = "
                SELECT P.*, C.NomClient, 
                       AC.NumeroAppel, AC.Sujet, AC.Description as DescAppel
                FROM Projets P 
                LEFT JOIN Clients C ON P.ClientID = C.ClientID
                LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID
                WHERE P.ProjetID = @ProjetID"

            Dim dtDiag As DataTable = DbHelper.GetData(queryProjet, {New SqlParameter("@ProjetID", projetID)})

            If dtDiag.Rows.Count > 0 Then
                Dim row As DataRow = dtDiag.Rows(0)

                Console.WriteLine($"üìã Projet: {row("NomProjet")}")
                Console.WriteLine($"üìã Num√©ro: {If(IsDBNull(row("NumeroProjet")), "NULL", row("NumeroProjet"))}")
                Console.WriteLine($"üìã Description: {If(IsDBNull(row("Description")), "NULL", row("Description"))}")
                Console.WriteLine($"üìû Appel: {If(IsDBNull(row("NumeroAppel")), "NULL", row("NumeroAppel"))}")
                Console.WriteLine($"üìû Sujet: {If(IsDBNull(row("Sujet")), "NULL", row("Sujet"))}")
                Console.WriteLine($"üìû Desc Appel: {If(IsDBNull(row("DescAppel")), "NULL", row("DescAppel"))}")
                Console.WriteLine($"üë§ Client: {If(IsDBNull(row("NomClient")), "NULL", row("NomClient"))}")

                ' Test de g√©n√©ration d'objet
                Dim objetTest As String = GenererObjetDevisIntelligent(
                        row,
                        If(IsDBNull(row("Sujet")), "", row("Sujet").ToString()),
                        If(IsDBNull(row("DescAppel")), "", row("DescAppel").ToString())
                    )

                Console.WriteLine($"üéØ Objet g√©n√©r√©: '{objetTest}'")

            Else
                Console.WriteLine("‚ùå Projet introuvable")
            End If

            Console.WriteLine($"üîç === FIN DIAGNOSTIC ===")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur diagnostic: {ex.Message}")
        End Try
    End Sub

    ' 7. M√âTHODE POUR FORCER LA MISE √Ä JOUR DE L'OBJET MANUELLEMENT
    ' ===============================================================================
    Private Sub ForcerMiseAJourObjetDevis()
        Try
            If cmbProjetDevis.SelectedValue IsNot Nothing Then
                Dim projetID As Integer
                If Integer.TryParse(cmbProjetDevis.SelectedValue.ToString(), projetID) Then
                    Console.WriteLine($"üîÑ For√ßage mise √† jour objet pour projet {projetID}")

                    ' Vider d'abord
                    txtObjetDevis.Clear()
                    Application.DoEvents()

                    ' R√©cup√©rer √† nouveau
                    RecupererEtMettreAJourInfosProjetForce(projetID)
                End If
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur for√ßage mise √† jour: {ex.Message}")
        End Try
    End Sub

    ' 8. BOUTON DE TEST √Ä AJOUTER TEMPORAIREMENT (pour d√©boguer)
    ' ===============================================================================
    Private Sub btnTestObjetDevis_Click(sender As Object, e As EventArgs)
        Try
            If cmbProjetDevis.SelectedValue IsNot Nothing Then
                Dim projetID As Integer = CInt(cmbProjetDevis.SelectedValue)

                ' Diagnostic complet
                DiagnostiquerObjetDevis(projetID)

                ' Forcer la mise √† jour
                ForcerMiseAJourObjetDevis()

                MessageBox.Show($"‚úÖ Test termin√© pour projet {projetID}" & vbCrLf &
                                   $"Objet actuel: '{txtObjetDevis.Text}'" & vbCrLf &
                                   "Consultez la console pour les d√©tails.",
                                   "Test Objet Devis", MessageBoxButtons.OK, MessageBoxIcon.Information)
            Else
                MessageBox.Show("Veuillez d'abord s√©lectionner un projet.", "Test", MessageBoxButtons.OK, MessageBoxIcon.Information)
            End If
        Catch ex As Exception
            MessageBox.Show($"Erreur test: {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' ========== CORRECTION 4 : M√âTHODE ALTERNATIVE SI LE PROBL√àME PERSISTE ==========
    ' Si le probl√®me persiste, essayer cette m√©thode pour forcer l'affichage

    Private Sub ForcerAffichageNumeroAppel(devisID As Integer)
        Try
            Console.WriteLine($"üîß === FOR√áAGE AFFICHAGE NUM√âRO APPEL POUR DEVIS {devisID} ===")

            ' Requ√™te sp√©cifique pour r√©cup√©rer le num√©ro d'appel
            Dim queryForce As String = "
            SELECT AC.NumeroAppel, P.NumeroProjet
            FROM Devis D 
            INNER JOIN Projets P ON D.ProjetID = P.ProjetID 
            LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID 
            WHERE D.DevisID = @DevisID"

            Dim dtForce As DataTable = DbHelper.GetData(queryForce, {New SqlParameter("@DevisID", devisID)})

            If dtForce.Rows.Count > 0 Then
                Dim row As DataRow = dtForce.Rows(0)

                ' Forcer l'affichage du num√©ro d'appel
                If Not IsDBNull(row("NumeroAppel")) Then
                    Dim numeroAppelForce As String = row("NumeroAppel").ToString()

                    ' Vider d'abord
                    txtNumeroAppel.Clear()
                    Application.DoEvents()

                    ' Puis remplir
                    txtNumeroAppel.Text = numeroAppelForce
                    txtNumeroAppel.Refresh()
                    Application.DoEvents()

                    Console.WriteLine($"üîß Num√©ro appel FORC√â: '{txtNumeroAppel.Text}'")
                Else
                    Console.WriteLine($"‚ùå Pas de num√©ro d'appel dans la base pour ce devis")
                End If

                ' Forcer l'affichage du num√©ro de projet
                If txtNumeroProjet IsNot Nothing AndAlso Not IsDBNull(row("NumeroProjet")) Then
                    txtNumeroProjet.Text = row("NumeroProjet").ToString()
                    Console.WriteLine($"üîß Num√©ro projet FORC√â: '{txtNumeroProjet.Text}'")
                End If
            Else
                Console.WriteLine($"‚ùå Aucune donn√©e trouv√©e pour le devis {devisID}")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur for√ßage affichage: {ex.Message}")
        End Try
    End Sub

    ' ========== CORRECTION 6 : DIAGNOSTIC COMPLET ==========
    Private Sub DiagnostiquerProblemeNumeroAppel()
        Try
            Console.WriteLine("=== DIAGNOSTIC PROBL√àME NUM√âRO APPEL ===")

            ' 1. V√©rifier l'existence du contr√¥le
            If txtNumeroAppel Is Nothing Then
                Console.WriteLine("‚ùå CRITIQUE: txtNumeroAppel est NULL")
                Return
            End If

            Console.WriteLine($"‚úÖ txtNumeroAppel existe")
            Console.WriteLine($"   - Name: {txtNumeroAppel.Name}")
            Console.WriteLine($"   - Text: '{txtNumeroAppel.Text}'")
            Console.WriteLine($"   - Visible: {txtNumeroAppel.Visible}")
            Console.WriteLine($"   - Enabled: {txtNumeroAppel.Enabled}")
            Console.WriteLine($"   - Location: {txtNumeroAppel.Location}")
            Console.WriteLine($"   - Size: {txtNumeroAppel.Size}")

            ' 2. V√©rifier les donn√©es en base
            If devisID > 0 Then
                Console.WriteLine($"   - DevisID s√©lectionn√©: {devisID}")

                Dim queryDiag As String = "
                SELECT D.NumeroDevis, P.NomProjet, AC.NumeroAppel, P.AppelClientID
                FROM Devis D 
                INNER JOIN Projets P ON D.ProjetID = P.ProjetID 
                LEFT JOIN AppelClient AC ON P.AppelClientID = AC.AppelClientID 
                WHERE D.DevisID = @DevisID"

                Dim dtDiag As DataTable = DbHelper.GetData(queryDiag, {New SqlParameter("@DevisID", devisID)})

                If dtDiag.Rows.Count > 0 Then
                    Dim row As DataRow = dtDiag.Rows(0)
                    Console.WriteLine($"   - Donn√©es base:")
                    Console.WriteLine($"     - NumeroDevis: {row("NumeroDevis")}")
                    Console.WriteLine($"     - NomProjet: {row("NomProjet")}")
                    Console.WriteLine($"     - AppelClientID: {If(IsDBNull(row("AppelClientID")), "NULL", row("AppelClientID").ToString())}")
                    Console.WriteLine($"     - NumeroAppel: {If(IsDBNull(row("NumeroAppel")), "NULL", row("NumeroAppel").ToString())}")
                End If
            End If

            Console.WriteLine("=====================================")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur diagnostic: {ex.Message}")
        End Try
    End Sub
    Private Sub VerifierStructureBDD()
        Try
            ' Test des tables et colonnes essentielles
            Dim queryTest As String = "SELECT TOP 1 ProjetID, NomProjet, Description FROM Projets"
            DbHelper.GetData(queryTest, New SqlParameter() {})
            Console.WriteLine("‚úÖ Structure BDD v√©rifi√©e")
        Catch ex As Exception
            Console.WriteLine($"‚ùå Probl√®me structure BDD: {ex.Message}")
        End Try
    End Sub
    ' Structure pour les informations du bon de commande
    Public Structure InfoBonCommande
        Public Existe As Boolean
        Public BonCommandeID As Integer
        Public NumeroBon As String
        Public ARefacturer As String
        Public NumeroBonCommande As String
        Public DateBonCommande As Date
    End Structure
    ' R√©cup√©rer les informations du bon de commande associ√© au devis
    Private Function RecupererInfoBonCommande(devisID As Integer) As InfoBonCommande
        Dim info As New InfoBonCommande()
        info.Existe = False

        Try
            Console.WriteLine($"üîç Recherche bon de commande pour devis {devisID}")

            ' ‚≠ê REQU√äTE POUR R√âCUP√âRER LE BON DE COMMANDE ASSOCI√â AU DEVIS
            Dim query As String = "
            SELECT BC.BonCommandeID, BC.NumeroBon, BC.ARefacturer, 
                   BC.NumeroBonCommande, BC.DateBonCommande
            FROM BonsDeCommande BC 
            WHERE BC.DevisID = @DevisID"

            Dim dtBonCommande As DataTable = DbHelper.GetData(query, {New SqlParameter("@DevisID", devisID)})

            If dtBonCommande.Rows.Count > 0 Then
                Dim row As DataRow = dtBonCommande.Rows(0)

                info.Existe = True
                info.BonCommandeID = CInt(row("BonCommandeID"))
                info.NumeroBon = If(IsDBNull(row("NumeroBon")), "", row("NumeroBon").ToString().Trim())
                info.ARefacturer = If(IsDBNull(row("ARefacturer")), "", row("ARefacturer").ToString().Trim())
                info.NumeroBonCommande = If(IsDBNull(row("NumeroBonCommande")), "", row("NumeroBonCommande").ToString().Trim())

                If Not IsDBNull(row("DateBonCommande")) Then
                    info.DateBonCommande = CDate(row("DateBonCommande"))
                End If

                Console.WriteLine($"‚úÖ Bon de commande trouv√©:")
                Console.WriteLine($"   - ID: {info.BonCommandeID}")
                Console.WriteLine($"   - N¬∞ Bon: '{info.NumeroBon}'")
                Console.WriteLine($"   - A refacturer: '{info.ARefacturer}'")
                Console.WriteLine($"   - N¬∞ BC: '{info.NumeroBonCommande}'")
            Else
                Console.WriteLine("‚ÑπÔ∏è Aucun bon de commande trouv√© pour ce devis")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration bon de commande: {ex.Message}")
            info.Existe = False
        End Try

        Return info
    End Function
    ' ================================================================================
    ' VERSION CORRIG√âE - PLACEMENT AU-DESSUS DU DataGridView
    ' ================================================================================

    ' üî• M√âTHODE 1 : CR√âER TOUS LES CONTR√îLES
    Private Sub AjouterRechercheComplete()
        Try
            ' Supprimer les anciens contr√¥les s'ils existent
            SupprimerAnciensControles()

            ' Cr√©er les nouveaux contr√¥les avec layout optimis√©
            AjouterEnTeteDataGridView()      ' Titre + Compteur (m√™me ligne, plus proche)
            AjouterControlesRecherche()      ' Recherche + Boutons (ligne au-dessus, plus compact)

            ' üî• CR√âER ET POSITIONNER LE LABEL DU TOTAL FILTR√â (DANS LE TRY)
            lblTotalFiltre.Text = ""
            lblTotalFiltre.AutoSize = True
            lblTotalFiltre.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)
            lblTotalFiltre.ForeColor = Color.Blue
            lblTotalFiltre.Location = New Point(20, dgvLignesDevis.Bottom + 10)
            Me.Controls.Add(lblTotalFiltre)

            ' üî• CALCULER LE TOTAL INITIAL
            CalculerTotalFiltre()

            Console.WriteLine("‚úÖ Layout complet optimis√© cr√©√©")
            Console.WriteLine("‚úÖ Label total filtr√© ajout√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur cr√©ation layout: {ex.Message}")
        End Try
    End Sub
    ' üî• 7. NOUVELLE M√âTHODE : Supprimer anciens contr√¥les pour √©viter doublons
    Private Sub SupprimerAnciensControles()
        Try
            ' Liste des noms de contr√¥les √† supprimer
            Dim nomsASupprimer() As String = {
                "lblRecherche", "txtRechercheTest", "btnEffacer", "btnFiltrer",
                "btnStats", "btnExport", "lblTitre", "lblCompteurTest"
            }

            ' Supprimer les contr√¥les existants
            For Each nomControle In nomsASupprimer
                Dim controle As Control = Me.Controls(nomControle)
                If controle IsNot Nothing Then
                    Me.Controls.Remove(controle)
                    controle.Dispose()
                End If
            Next

            Console.WriteLine("‚úÖ Anciens contr√¥les supprim√©s")

        Catch ex As Exception
            ' Ignorer les erreurs (contr√¥les inexistants)
            Console.WriteLine($"‚ÑπÔ∏è Nettoyage contr√¥les: {ex.Message}")
        End Try
    End Sub

    ' üî• M√âTHODE 2 : EN-T√äTE DU DATAGRIDVIEW
    Private Sub AjouterEnTeteDataGridView()
        Try
            Dim dgvX As Integer = dgvListeDevis.Location.X
            Dim dgvY As Integer = dgvListeDevis.Location.Y

            ' üìã TITRE "LISTE DES DEVIS" (c√¥t√© gauche)
            Dim lblTitre As New Label()
            lblTitre.Text = "üìã LISTE DES DEVIS"
            lblTitre.Font = New System.Drawing.Font("Segoe UI", 12, FontStyle.Bold)
            lblTitre.ForeColor = Color.FromArgb(52, 73, 94)
            lblTitre.Location = New Point(dgvX, dgvY - 25) ' üî• REMONT√â : -30 ‚Üí -25
            lblTitre.AutoSize = True
            Me.Controls.Add(lblTitre)
            lblTitre.BringToFront()

            ' üìä COMPTEUR DEVIS ET MONTANT (plus proche, m√™me ligne)
            lblCompteurTest = New Label()
            lblCompteurTest.Text = "üìã Devis : 0 total | üí∞ Montant HT : 0 FCFA"
            lblCompteurTest.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)
            lblCompteurTest.ForeColor = Color.FromArgb(46, 204, 113)
            lblCompteurTest.AutoSize = True

            ' üî• POSITIONNER JUSTE √Ä DROITE DU TITRE (m√™me ligne, plus proche)
            lblCompteurTest.Location = New Point(dgvX + 200, dgvY - 25) ' M√™me Y que le titre

            Me.Controls.Add(lblCompteurTest)
            lblCompteurTest.BringToFront()

            ' Mettre √† jour le compteur initial
            MettreAJourCompteur()

            Console.WriteLine("‚úÖ En-t√™te avec compteur rapproch√© cr√©√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur en-t√™te: {ex.Message}")
        End Try
    End Sub

    ' üî• M√âTHODE 3 : RECHERCHE EN TEMPS R√âEL
    Private Sub RechercheTest_TextChanged(sender As Object, e As EventArgs)
        Try
            Dim terme As String = txtRechercheTest.Text.Trim()

            If String.IsNullOrWhiteSpace(terme) Then
                ' üî• VIDE : Restaurer TOUS les devis depuis la base
                RestaurerTousLesDevis()
            Else
                ' üî• RECHERCHE : Utiliser les donn√©es compl√®tes
                RechercherDansDevis(terme)
                D√©s√©lectionnerCompl√®tementDGV()
                DesactiverTousBoutons()
                ViderChampsDetail()
            End If
            ' üî• AJOUTER √Ä LA FIN :
            CalculerTotalFiltre()
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur recherche: {ex.Message}")
        End Try
    End Sub

    ' üî• M√âTHODE 4 : LOGIQUE DE RECHERCHE
    ' M√âTHODE BONUS : Pour la recherche en temps r√©el avec somme
    Private Sub RechercherDansDevis(terme As String)
        Try
            If dtDevisCompletAvecStats Is Nothing Then Return

            ' Cr√©er le filtre de recherche (multiple colonnes)
            Dim filtre As String = $"ClientNom LIKE '%{terme}%' OR " &
                              $"NumeroDevis LIKE '%{terme}%' OR " &
                              $"StatutDevis LIKE '%{terme}%' OR " &
                              $"Convert(MontantHT, 'System.String') LIKE '%{terme}%'"

            Dim dv As DataView = dtDevisCompletAvecStats.DefaultView
            dv.RowFilter = filtre

            Dim dtFiltre As DataTable = dv.ToTable()
            dgvListeDevis.DataSource = dtFiltre

            ' Calculer et afficher le r√©sultat avec somme
            Dim sommeTotal As Decimal = 0
            For Each row As DataRow In dtFiltre.Rows
                If Not IsDBNull(row("MontantHT")) Then
                    sommeTotal += Convert.ToDecimal(row("MontantHT"))
                End If
            Next

            Dim sommeFormatee As String = sommeTotal.ToString("N0").Replace(",", " ") & " FCFA"

            ' Mettre √† jour l'affichage
            If lblCompteurTest IsNot Nothing Then
                If dtFiltre.Rows.Count = 0 Then
                    lblCompteurTest.Text = $"üîç Recherche '{terme}' : Aucun r√©sultat"
                    lblCompteurTest.ForeColor = Color.FromArgb(231, 76, 60)
                Else
                    lblCompteurTest.Text = $"üîç Recherche '{terme}' : {dtFiltre.Rows.Count} devis | üí∞ Montant HT : {sommeFormatee}"
                    lblCompteurTest.ForeColor = Color.FromArgb(46, 204, 113)
                End If
            End If

            Console.WriteLine($"‚úÖ Recherche '{terme}' : {dtFiltre.Rows.Count} r√©sultats, Montant : {sommeFormatee}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur recherche avec somme: {ex.Message}")
        End Try
    End Sub

    ' üî• M√âTHODE 5 : EFFACER LA RECHERCHE
    Private Sub EffacerRecherche_Click(sender As Object, e As EventArgs)
        Try
            Console.WriteLine("üßπ Effacement complet de la recherche...")

            ' 1. VIDER LA TEXTBOX DE RECHERCHE
            txtRechercheTest.Text = ""
            txtRechercheTest.ForeColor = Color.Black

            ' 2. üî• FORCER LE RECHARGEMENT COMPLET DEPUIS LA BASE
            RestaurerTousLesDevis()
            ' üî• AJOUTER √Ä LA FIN :
            CalculerTotalFiltre()
            Console.WriteLine("‚úÖ Recherche effac√©e et TOUS les devis restaur√©s")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur effacement recherche: {ex.Message}")
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : D√©s√©lectionner compl√®tement le DataGridView
    Private Sub D√©s√©lectionnerCompl√®tementDGV()
        Try
            ' D√©s√©lectionner toutes les lignes
            dgvListeDevis.ClearSelection()

            ' Retirer le focus du DataGridView
            dgvListeDevis.CurrentCell = Nothing

            ' S'assurer qu'aucune ligne n'est s√©lectionn√©e
            For Each row As DataGridViewRow In dgvListeDevis.Rows
                row.Selected = False
            Next

            ' R√©initialiser la variable globale
            devisID = 0

            Console.WriteLine("‚úÖ DataGridView compl√®tement d√©s√©lectionn√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur d√©s√©lection DGV: {ex.Message}")
        End Try
    End Sub

    ' üî• NOUVELLE M√âTHODE : Vider les champs de d√©tail
    Private Sub ViderChampsDetail()
        Try
            ' Vider tous les champs de d√©tail du devis
            txtNumeroDevis.Clear()
            txtNumeroAppel.Clear()
            If txtNumeroProjet IsNot Nothing Then txtNumeroProjet.Clear()
            txtObjetDevis.Clear()
            txtMontantHT.Clear()

            txtMontantEnLettres.Clear()

            ' R√©initialiser les ComboBox
            If cmbProjetDevis IsNot Nothing Then cmbProjetDevis.SelectedIndex = -1
            If cmbStatutDevis IsNot Nothing Then cmbStatutDevis.SelectedIndex = -1

            ' R√©initialiser la date
            If dtpDateDevis IsNot Nothing Then dtpDateDevis.Value = Date.Today

            Console.WriteLine("‚úÖ Champs de d√©tail vid√©s")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur vidage champs: {ex.Message}")
        End Try
    End Sub
    ' üî• M√âTHODE 6 : MENU DE FILTRAGE
    Private Sub AfficherMenuFiltrer_Click(sender As Object, e As EventArgs)
        Try
            If dtDevisComplet Is Nothing OrElse dtDevisComplet.Rows.Count = 0 Then
                MessageBox.Show("Aucune donn√©e disponible pour le filtrage.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' R√©cup√©rer tous les statuts uniques
            Dim statuts As New HashSet(Of String)
            For Each row As DataRow In dtDevisComplet.Rows
                If dtDevisComplet.Columns.Contains("StatutDevis") AndAlso Not IsDBNull(row("StatutDevis")) Then
                    statuts.Add(row("StatutDevis").ToString())
                End If
            Next

            If statuts.Count = 0 Then
                MessageBox.Show("Aucun statut disponible pour le filtrage.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            Using formFiltre As New Form()
                formFiltre.Text = "Filtrer par Statut"
                formFiltre.Size = New Size(320, Math.Min(500, (statuts.Count + 3) * 40 + 120))
                formFiltre.StartPosition = FormStartPosition.CenterParent
                formFiltre.FormBorderStyle = FormBorderStyle.FixedDialog
                formFiltre.MaximizeBox = False
                formFiltre.MinimizeBox = False

                Dim yPos As Integer = 20

                ' üî• BOUTON "TOUS" CORRIG√â - Appeler RestaurerTousLesDevis()
                Dim btnTous As New Button()
                btnTous.Text = "üìã Tous les devis"
                btnTous.Size = New Size(260, 35)
                btnTous.Location = New Point(30, yPos)
                btnTous.BackColor = Color.FromArgb(52, 73, 94)
                btnTous.ForeColor = Color.White
                btnTous.FlatStyle = FlatStyle.Flat
                btnTous.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)
                AddHandler btnTous.Click, Sub()
                                              formFiltre.Close()
                                              RestaurerTousLesDevis() ' üî• CORRECTION ICI
                                          End Sub
                formFiltre.Controls.Add(btnTous)
                yPos += 45

                ' S√©parateur visuel
                Dim separateur As New Label()
                separateur.Text = "‚îÄ‚îÄ Filtrer par statut ‚îÄ‚îÄ"
                separateur.Size = New Size(260, 20)
                separateur.Location = New Point(30, yPos)
                separateur.ForeColor = Color.Gray
                separateur.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Italic)
                separateur.TextAlign = ContentAlignment.MiddleCenter
                formFiltre.Controls.Add(separateur)
                yPos += 30

                ' Boutons pour chaque statut
                For Each statut In statuts.OrderBy(Function(s) s)
                    Dim btnStatut As New Button()
                    btnStatut.Text = $"{ObtenirEmojiStatut(statut)} {statut}"
                    btnStatut.Size = New Size(260, 32)
                    btnStatut.Location = New Point(30, yPos)
                    btnStatut.BackColor = ObtenirCouleurStatut(statut)
                    btnStatut.ForeColor = Color.White
                    btnStatut.FlatStyle = FlatStyle.Flat
                    btnStatut.Font = New System.Drawing.Font("Segoe UI", 9)

                    Dim statutCapture As String = statut
                    AddHandler btnStatut.Click, Sub()
                                                    formFiltre.Close()
                                                    FiltrerParStatut(statutCapture)
                                                End Sub
                    formFiltre.Controls.Add(btnStatut)
                    yPos += 37
                Next

                formFiltre.ShowDialog()
            End Using
            ' üî• AJOUTER √Ä LA FIN (apr√®s application du filtre) :
            CalculerTotalFiltre()
        Catch ex As Exception
            MessageBox.Show($"Erreur filtrage : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' üî• M√âTHODE 7 : FILTRER PAR STATUT
    Private Sub FiltrerParStatut(statut As String)
        Try
            Console.WriteLine($"üîΩ Filtrage par statut: {statut}")

            If dtDevisComplet Is Nothing Then
                ChargerDevis()
                Return
            End If

            Dim dv As DataView = dtDevisComplet.DefaultView
            dv.RowFilter = $"StatutDevis = '{statut.Replace("'", "''")}'"
            Dim dtFiltre As DataTable = dv.ToTable()

            dgvListeDevis.DataSource = dtFiltre
            ConfigurerColonnesListeDevis()

            ' D√©s√©lectionner apr√®s filtrage
            D√©s√©lectionnerCompl√®tementDGV()
            DesactiverTousBoutons()
            ViderChampsDetail()

            ' üî• CALCULER LE MONTANT TOTAL DES DEVIS FILTR√âS (comme RechercherDansDevis)
            Dim montantTotal As Decimal = 0
            For Each row As DataRow In dtFiltre.Rows
                If Not IsDBNull(row("MontantHT")) Then
                    montantTotal += Convert.ToDecimal(row("MontantHT"))
                End If
            Next

            Dim montantFormate As String = montantTotal.ToString("N0").Replace(",", " ") & " FCFA"

            ' üî• AFFICHER AVEC LE MONTANT TOTAL
            lblCompteurTest.Text = $"üîΩ Filtre '{statut}' : {dtFiltre.Rows.Count} sur {dtDevisComplet.Rows.Count} | üí∞ {montantFormate}"
            lblCompteurTest.ForeColor = Color.FromArgb(155, 89, 182)

            Console.WriteLine($"‚úÖ Filtrage termin√©: {dtFiltre.Rows.Count} r√©sultats - Montant: {montantFormate}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur filtrage: {ex.Message}")
            RestaurerTousLesDevis()
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : Obtenir emoji pour chaque statut
    Private Function ObtenirEmojiStatut(statut As String) As String
        Select Case statut.ToUpper()
            Case "BROUILLON"
                Return "üìù"
            Case "ENVOY√â", "ENVOYE"
                Return "üì§"
            Case "D√âPOS√â", "DEPOSE"
                Return "üì¶"
            Case "RETOURN√â", "RETOURNE"
                Return "üîÑ"
            Case "ACCEPT√â", "ACCEPTE"
                Return "‚úÖ"
            Case "COMMAND√â", "COMMANDE"
                Return "üõí"
            Case "FACTUR√â", "FACTURE" ' ‚≠ê NOUVEAU
                Return "üí∞"
            Case "REFUS√â", "REFUSE"
                Return "‚ùå"
            Case "ANNUL√â", "ANNULE"
                Return "üö´"
            Case "R√âVISION", "REVISIONS"
                Return "üìù"
            Case Else
                Return "üìã"
        End Select
    End Function

    ' üî• M√âTHODE 8 : STATISTIQUES D√âTAILL√âES
    Private Sub AfficherStats_Click(sender As Object, e As EventArgs)
        Try
            Dim dt As DataTable = CType(dgvListeDevis.DataSource, DataTable)
            Dim total As Integer = dt.Rows.Count
            Dim montantTotal As Decimal = 0
            Dim statuts As New Dictionary(Of String, Integer)

            For Each row As DataRow In dt.Rows
                ' üî• Calculer montants HT
                If dt.Columns.Contains("MontantHT") AndAlso Not IsDBNull(row("MontantHT")) Then
                    montantTotal += CDec(row("MontantHT"))
                End If

                ' Compter statuts
                If dt.Columns.Contains("StatutDevis") AndAlso Not IsDBNull(row("StatutDevis")) Then
                    Dim statut As String = row("StatutDevis").ToString()
                    If statuts.ContainsKey(statut) Then
                        statuts(statut) += 1
                    Else
                        statuts(statut) = 1
                    End If
                End If
            Next

            Dim message As String = $"üìä STATISTIQUES D√âTAILL√âES - DEVIS" & vbCrLf &
                                  "=" & New String("=", 40) & vbCrLf & vbCrLf &
                                  $"üìã Nombre total : {total}" & vbCrLf &
                                  $"üí∞ Montant total HT : {montantTotal:N0} FCFA" & vbCrLf &
                                  $"üí∞ Montant moyen HT : {If(total > 0, (montantTotal / total).ToString("N0"), "0")} FCFA" & vbCrLf & vbCrLf &
                                  "üìà R√âPARTITION PAR STATUT :" & vbCrLf

            For Each kvp In statuts.OrderByDescending(Function(x) x.Value)
                Dim pourcentage As Double = If(total > 0, (kvp.Value / total) * 100, 0)
                message += $"‚Ä¢ {kvp.Key} : {kvp.Value} ({pourcentage:F1}%)" & vbCrLf
            Next

            MessageBox.Show(message, "Statistiques Devis", MessageBoxButtons.OK, MessageBoxIcon.Information)

        Catch ex As Exception
            MessageBox.Show($"Erreur statistiques : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' üî• M√âTHODE 9 : EXPORT EXCEL
    Private Sub ExporterDevis_Click(sender As Object, e As EventArgs)
        Try
            Dim dtSource As DataTable = CType(dgvListeDevis.DataSource, DataTable)

            If dtSource Is Nothing OrElse dtSource.Rows.Count = 0 Then
                MessageBox.Show("Aucune donn√©e √† exporter.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' PAR CE NOUVEAU CODE :
            ' üî• UTILISATION DE PATHMANAGER POUR LE DOSSIER D'EXPORT
            Dim dossierExport As String = PathManager.GetExportPath()
            Dim nomFichier As String = $"Devis_Export_{Date.Now:yyyyMMdd_HHmmss}.xlsx"

            ' Cr√©er le dossier s'il n'existe pas
            If Not Directory.Exists(dossierExport) Then
                Directory.CreateDirectory(dossierExport)
            End If

            Dim saveDialog As New SaveFileDialog()
            saveDialog.Filter = "Fichiers Excel (*.xlsx)|*.xlsx"
            saveDialog.FileName = nomFichier
            saveDialog.InitialDirectory = dossierExport ' üî• DOSSIER PAR D√âFAUT
            saveDialog.Title = "Exporter les devis vers Excel"

            If saveDialog.ShowDialog() = DialogResult.OK Then
                Me.Cursor = Cursors.WaitCursor

                Try
                    ExporterVersExcelComplet(dtSource, saveDialog.FileName)

                    MessageBox.Show($"‚úÖ Export r√©ussi !" & vbCrLf & vbCrLf &
                              $"Fichier : {saveDialog.FileName}" & vbCrLf &
                              $"Nombre de devis : {dtSource.Rows.Count}" & vbCrLf & vbCrLf &
                              "Voulez-vous ouvrir le fichier ?",
                              "Export termin√©", MessageBoxButtons.YesNo, MessageBoxIcon.Information)

                    If MessageBox.Show("", "", MessageBoxButtons.YesNo) = DialogResult.Yes Then
                        Process.Start(saveDialog.FileName)
                    End If

                Catch ex As Exception
                    MessageBox.Show($"Erreur lors de l'export : {ex.Message}", "Erreur Export", MessageBoxButtons.OK, MessageBoxIcon.Error)
                End Try
            End If

        Catch ex As Exception
            MessageBox.Show($"Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        Finally
            Me.Cursor = Cursors.Default
        End Try
    End Sub

    ' üî• M√âTHODE 10 : COULEURS PAR STATUT
    Private Function ObtenirCouleurStatut(statut As String) As Color
        Select Case statut.ToUpper()
            Case "BROUILLON"
                Return Color.FromArgb(149, 165, 166)
            Case "ENVOY√â", "ENVOYE"
                Return Color.FromArgb(52, 152, 219)
            Case "D√âPOS√â", "DEPOSE"
                Return Color.Orange
            Case "RETOURN√â", "RETOURNE"
                Return Color.FromArgb(155, 89, 182)
            Case "ACCEPT√â", "ACCEPTE"
                Return Color.FromArgb(46, 204, 113)
            Case "COMMAND√â", "COMMANDE"
                Return Color.FromArgb(34, 153, 84)
            Case "FACTUR√â", "FACTURE" ' ‚≠ê NOUVEAU
                Return Color.FromArgb(46, 204, 113)
            Case "REFUS√â", "REFUSE"
                Return Color.FromArgb(231, 76, 60)
            Case "ANNUL√â", "ANNULE"
                Return Color.FromArgb(149, 165, 166)
            Case "R√âVISION", "REVISIONS"
                Return Color.Orange
            Case Else
                Return Color.FromArgb(52, 73, 94)
        End Select
    End Function

    ' üî• M√âTHODE 11 : METTRE √Ä JOUR LE COMPTEUR
    Private Sub MettreAJourCompteur()
        Try
            If lblCompteurTest IsNot Nothing AndAlso dgvListeDevis.DataSource IsNot Nothing Then
                Dim dt As DataTable = CType(dgvListeDevis.DataSource, DataTable)
                Dim total As Integer = dt.Rows.Count
                Dim montantTotal As Decimal = 0

                ' Calculer avec MontantHT depuis la base (pas depuis TableLignesDevis)
                If dt.Columns.Contains("MontantHT") Then
                    For Each row As DataRow In dt.Rows
                        If Not IsDBNull(row("MontantHT")) Then
                            montantTotal += CDec(row("MontantHT"))
                        End If
                    Next

                    ' üî• FORMAT AM√âLIOR√â : Plus compact
                    If total = 0 Then
                        lblCompteurTest.Text = "üìã Aucun devis"
                        lblCompteurTest.ForeColor = Color.FromArgb(149, 165, 166)
                    ElseIf total = 1 Then
                        lblCompteurTest.Text = $"üìã 1 devis | üí∞ {montantTotal:N0} FCFA"
                        lblCompteurTest.ForeColor = Color.FromArgb(46, 204, 113)
                    Else
                        lblCompteurTest.Text = $"üìã {total} devis | üí∞ {montantTotal:N0} FCFA"
                        lblCompteurTest.ForeColor = Color.FromArgb(46, 204, 113)
                    End If
                Else
                    lblCompteurTest.Text = $"üìã {total} devis"
                    lblCompteurTest.ForeColor = If(total > 0, Color.FromArgb(46, 204, 113), Color.FromArgb(149, 165, 166))
                End If
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur compteur: {ex.Message}")
        End Try
    End Sub

    ' üî• M√âTHODE 12 : ACTUALISER APR√àS MODIFICATIONS
    Private Sub ActualiserRecherche()
        Try
            If Not String.IsNullOrWhiteSpace(txtRechercheTest?.Text) Then
                RechercherDansDevis(txtRechercheTest.Text)
            Else
                dgvListeDevis.DataSource = dtDevisComplet
                MettreAJourCompteur()
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur actualisation: {ex.Message}")
        End Try
    End Sub

    ' üî• NOUVELLE M√âTHODE : Actualiser automatiquement les donn√©es apr√®s actions
    Private Sub ActualiserDonneesApresAction(typeAction As String, devisID As Integer, nouveauStatut As String)
        Try
            Console.WriteLine($"üîÑ Actualisation automatique - Action: {typeAction}, DevisID: {devisID}, Statut: {nouveauStatut}")

            ' 1. METTRE √Ä JOUR LE STATUT DANS LA BASE
            MettreAJourStatutDevis(devisID, nouveauStatut)

            ' 2. ATTENDRE UN PETIT D√âLAI POUR QUE LES DONN√âES SOIENT BIEN √âCRITES
            System.Threading.Thread.Sleep(500)

            ' 3. RECHARGER LES DONN√âES COMPL√àTES DEPUIS LA BASE
            ChargerDevis()

            ' 4. DIAGNOSTIC DES COMMENTAIRES SI C'EST UN RETOUR
            If typeAction.ToUpper() = "RETOUR" Then
                DiagnostiquerCommentairesRetour()
            End If

            ' 5. RESTAURER LA RECHERCHE ACTIVE SI N√âCESSAIRE
            If txtRechercheTest IsNot Nothing AndAlso Not String.IsNullOrWhiteSpace(txtRechercheTest.Text) Then
                RechercherDansDevis(txtRechercheTest.Text)
            End If

            ' 6. RECONFIGURER LES COLONNES
            ConfigurerColonnesListeDevis()

            ' 7. METTRE √Ä JOUR LE COMPTEUR
            MettreAJourCompteur()

            ' 8. REPOSITION SUR LE DEVIS CONCERN√â
            RepositionnerSurDevis(devisID)

            ' 9. RECONFIGURER LES BOUTONS
            GererAutresBoutons(nouveauStatut)
            GererBoutonCreerFacture()

            Console.WriteLine($"‚úÖ Actualisation automatique termin√©e")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur actualisation automatique: {ex.Message}")
        End Try
    End Sub

    ' üî• NOUVELLE M√âTHODE : Repositionner sur un devis sp√©cifique
    Private Sub RepositionnerSurDevis(devisID As Integer)
        Try
            For Each row As DataGridViewRow In dgvListeDevis.Rows
                If Not row.IsNewRow AndAlso row.Cells("DevisID").Value IsNot Nothing Then
                    If CInt(row.Cells("DevisID").Value) = devisID Then
                        dgvListeDevis.CurrentCell = row.Cells(0)
                        dgvListeDevis.FirstDisplayedScrollingRowIndex = row.Index
                        Console.WriteLine($"‚úÖ Repositionn√© sur devis {devisID}")
                        Return
                    End If
                End If
            Next
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur repositionnement: {ex.Message}")
        End Try
    End Sub

    ' üî• NOUVELLE M√âTHODE : Forcer le rafra√Æchissement complet
    Public Sub ForceRefreshDevis()
        Try
            Console.WriteLine("üîÑ Rafra√Æchissement forc√© des devis...")

            ' Sauvegarder la position actuelle
            Dim devisIDActuel As Integer = 0
            If dgvListeDevis.CurrentRow IsNot Nothing AndAlso dgvListeDevis.CurrentRow.Cells("DevisID").Value IsNot Nothing Then
                devisIDActuel = CInt(dgvListeDevis.CurrentRow.Cells("DevisID").Value)
            End If

            ' Recharger compl√®tement
            ChargerDevis()

            ' Restaurer la position
            If devisIDActuel > 0 Then
                RepositionnerSurDevis(devisIDActuel)
            End If

            ' Restaurer la recherche si active
            If txtRechercheTest IsNot Nothing AndAlso Not String.IsNullOrWhiteSpace(txtRechercheTest.Text) Then
                RechercherDansDevis(txtRechercheTest.Text)
            End If

            Console.WriteLine("‚úÖ Rafra√Æchissement forc√© termin√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur rafra√Æchissement forc√©: {ex.Message}")
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : Diagnostic des commentaires de retour
    Private Sub DiagnostiquerCommentairesRetour()
        Try
            Console.WriteLine("üîç === DIAGNOSTIC COMMENTAIRES RETOUR ===")

            ' V√©rifier la structure de la table RetourDevis
            Dim queryStructure As String = "SELECT TOP 1 * FROM RetourDevis WHERE Commentaires IS NOT NULL OR Commentaire IS NOT NULL"
            Dim dtStructure As DataTable = DbHelper.GetData(queryStructure, New SqlParameter() {})

            If dtStructure.Rows.Count > 0 Then
                Console.WriteLine("üìã Colonnes disponibles dans RetourDevis :")
                For Each column As DataColumn In dtStructure.Columns
                    Console.WriteLine($"   - {column.ColumnName} ({column.DataType.Name})")
                Next

                ' V√©rifier les donn√©es
                Dim row As DataRow = dtStructure.Rows(0)
                If dtStructure.Columns.Contains("Commentaires") Then
                    Console.WriteLine($"   Exemple Commentaires: '{If(IsDBNull(row("Commentaires")), "NULL", row("Commentaires").ToString())}'")
                End If
                If dtStructure.Columns.Contains("Commentaire") Then
                    Console.WriteLine($"   Exemple Commentaire: '{If(IsDBNull(row("Commentaire")), "NULL", row("Commentaire").ToString())}'")
                End If
            End If

            ' V√©rifier le DataGridView
            Console.WriteLine("üìä Colonnes dans le DataGridView :")
            For Each column As DataGridViewColumn In dgvListeDevis.Columns
                Console.WriteLine($"   - {column.Name}: Visible={column.Visible}, Width={column.Width}")
            Next

            Console.WriteLine("=======================================")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur diagnostic: {ex.Message}")
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : Forcer l'affichage des commentaires de retour
    Private Sub ForcerAffichageCommentairesRetour()
        Try
            ' V√©rifier si la colonne existe et la rendre visible
            If dgvListeDevis.Columns.Contains("CommentaireRetour") Then
                dgvListeDevis.Columns("CommentaireRetour").Visible = True
                dgvListeDevis.Columns("CommentaireRetour").Width = 200
                dgvListeDevis.Columns("CommentaireRetour").HeaderText = "Commentaire Retour"

                ' Parcourir les lignes pour v√©rifier les donn√©es
                Dim compteurCommentaires As Integer = 0
                For Each row As DataGridViewRow In dgvListeDevis.Rows
                    If Not row.IsNewRow AndAlso row.Cells("CommentaireRetour").Value IsNot Nothing Then
                        Dim commentaire As String = row.Cells("CommentaireRetour").Value.ToString()
                        If Not String.IsNullOrEmpty(commentaire) Then
                            compteurCommentaires += 1
                            Console.WriteLine($"   Commentaire trouv√©: '{commentaire}'")
                        End If
                    End If
                Next

                Console.WriteLine($"‚úÖ {compteurCommentaires} commentaires de retour trouv√©s dans le DGV")
            Else
                Console.WriteLine("‚ùå Colonne CommentaireRetour introuvable dans le DGV")
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur for√ßage commentaires: {ex.Message}")
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : Restaurer tous les devis sans filtre
    Private Sub RestaurerTousLesDevis()
        Try
            Console.WriteLine("üîÑ Restauration FORC√âE de tous les devis...")

            ' üî• SOLUTION : Recharger depuis la base au lieu d'utiliser dtDevisComplet
            ChargerDevis() ' Recharge compl√®tement depuis la base de donn√©es

            ' R√©initialiser les filtres de recherche
            If txtRechercheTest IsNot Nothing Then
                txtRechercheTest.Text = ""
            End If

            ' D√©s√©lectionner tout
            D√©s√©lectionnerCompl√®tementDGV()

            ' üî• NOUVEAU : Mettre √† jour le compteur avec la somme totale
            MettreAJourCompteurComplet()

            ' D√©sactiver les boutons
            DesactiverTousBoutons()

            ' Vider les champs
            ViderChampsDetail()

            Console.WriteLine($"‚úÖ TOUS les devis restaur√©s depuis la base de donn√©es")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur restauration tous devis: {ex.Message}")
            ' En cas d'erreur, forcer le rechargement
            ChargerDevis()
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : Compteur complet avec somme pour restauration
    Private Sub MettreAJourCompteurComplet()
        Try
            If dtDevisCompletAvecStats Is Nothing OrElse dtDevisCompletAvecStats.Rows.Count = 0 Then
                If lblCompteurTest IsNot Nothing Then
                    lblCompteurTest.Text = "üìã Devis : 0 total | üí∞ Montant HT : 0 FCFA"
                    lblCompteurTest.ForeColor = Color.FromArgb(231, 76, 60)
                End If
                Return
            End If

            Dim nombreTotal As Integer = dtDevisCompletAvecStats.Rows.Count
            Dim sommeTotal As Decimal = 0

            ' Calculer la somme totale de tous les devis
            For Each row As DataRow In dtDevisCompletAvecStats.Rows
                If Not IsDBNull(row("MontantHT")) Then
                    sommeTotal += Convert.ToDecimal(row("MontantHT"))
                End If
            Next

            ' Formater la somme avec des espaces pour les milliers
            Dim sommeFormatee As String = sommeTotal.ToString("N0").Replace(",", " ") & " FCFA"

            ' Mettre √† jour l'affichage
            If lblCompteurTest IsNot Nothing Then
                lblCompteurTest.Text = $"üìã Devis : {nombreTotal} total | üí∞ Montant HT : {sommeFormatee}"
                lblCompteurTest.ForeColor = Color.FromArgb(46, 204, 113)
            End If

            Console.WriteLine($"‚úÖ Compteur mis √† jour : {nombreTotal} devis, Montant total : {sommeFormatee}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur mise √† jour compteur complet: {ex.Message}")
            ' Fallback sur la m√©thode originale
            MettreAJourCompteur()
        End Try
    End Sub
    ' üî• NOUVELLE M√âTHODE : Export Excel complet et optimis√©
    Private Sub ExporterVersExcelComplet(dtSource As DataTable, cheminFichier As String)
        Dim xlApp As Object = Nothing
        Dim xlWorkbook As Object = Nothing

        Try
            xlApp = CreateObject("Excel.Application")
            xlApp.Visible = False
            xlWorkbook = xlApp.Workbooks.Add()
            Dim xlWorksheet As Object = xlWorkbook.Worksheets(1)
            xlWorksheet.Name = "Export Devis"

            ' En-t√™te principal
            xlWorksheet.Cells(1, 1) = "VERNET - EXPORT DEVIS"
            xlWorksheet.Range("A1:J1").Merge()
            xlWorksheet.Range("A1").Font.Bold = True
            xlWorksheet.Range("A1").Font.Size = 16
            xlWorksheet.Range("A1").HorizontalAlignment = -4108
            xlWorksheet.Range("A1").Interior.Color = RGB(52, 152, 219)
            xlWorksheet.Range("A1").Font.Color = RGB(255, 255, 255)

            ' Informations d'export
            xlWorksheet.Cells(3, 1) = "Date d'export :"
            xlWorksheet.Cells(3, 2) = Date.Now.ToString("dd/MM/yyyy HH:mm:ss")
            xlWorksheet.Cells(3, 4) = "Nombre de devis :"
            xlWorksheet.Cells(3, 5) = dtSource.Rows.Count
            xlWorksheet.Cells(3, 7) = "Export√© par :"
            xlWorksheet.Cells(3, 8) = Environment.UserName

            ' üî• EN-T√äTES AVEC MontantHT
            Dim headers() As String = {
                "N¬∞ Devis", "Projet", "Date", "Statut", "Objet",
                "Montant HT", "N¬∞ Projet", "D√©cision Client", "Commentaire Retour", "Commentaire D√©p√¥t"
            }

            For i As Integer = 0 To headers.Length - 1
                xlWorksheet.Cells(5, i + 1) = headers(i)
            Next

            xlWorksheet.Range("A5:J5").Font.Bold = True
            xlWorksheet.Range("A5:J5").Interior.Color = RGB(46, 204, 113)
            xlWorksheet.Range("A5:J5").Font.Color = RGB(255, 255, 255)
            xlWorksheet.Range("A5:J5").Borders.LineStyle = 1

            ' Donn√©es
            Dim row As Integer = 6
            Dim totalMontant As Decimal = 0

            For Each dataRow As DataRow In dtSource.Rows
                Try
                    xlWorksheet.Cells(row, 1) = ObtenirValeurSecure(dataRow, "NumeroDevis")
                    xlWorksheet.Cells(row, 2) = ObtenirValeurSecure(dataRow, "NomProjet")

                    If dtSource.Columns.Contains("DateDevis") AndAlso Not IsDBNull(dataRow("DateDevis")) Then
                        xlWorksheet.Cells(row, 3) = CDate(dataRow("DateDevis")).ToString("dd/MM/yyyy")
                    End If

                    Dim statut As String = ObtenirValeurSecure(dataRow, "StatutDevis")
                    xlWorksheet.Cells(row, 4) = statut
                    ColorierCelluleStatut(xlWorksheet.Cells(row, 4), statut)

                    xlWorksheet.Cells(row, 5) = ObtenirValeurSecure(dataRow, "ObjetDevis")

                    ' üî• MONTANT HT au lieu de TTC
                    If dtSource.Columns.Contains("MontantHT") AndAlso Not IsDBNull(dataRow("MontantHT")) Then
                        Dim montant As Decimal = CDec(dataRow("MontantHT"))
                        xlWorksheet.Cells(row, 6) = montant.ToString("N0") & " FCFA"
                        totalMontant += montant
                    End If

                    xlWorksheet.Cells(row, 7) = ObtenirValeurSecure(dataRow, "NumeroProjet")
                    xlWorksheet.Cells(row, 8) = ObtenirValeurSecure(dataRow, "DecisionClient")
                    xlWorksheet.Cells(row, 9) = ObtenirValeurSecure(dataRow, "CommentaireRetour")
                    xlWorksheet.Cells(row, 10) = ObtenirValeurSecure(dataRow, "CommentaireDepot")

                    row += 1

                Catch rowEx As Exception
                    Console.WriteLine($"Erreur ligne {row}: {rowEx.Message}")
                    row += 1
                    Continue For
                End Try
            Next

            ' Totaux
            Dim totalRow As Integer = row + 1
            xlWorksheet.Cells(totalRow, 1) = "TOTAUX"
            xlWorksheet.Range($"A{totalRow}:E{totalRow}").Merge()
            xlWorksheet.Range($"A{totalRow}").Font.Bold = True
            xlWorksheet.Range($"A{totalRow}").HorizontalAlignment = -4108
            xlWorksheet.Range($"A{totalRow}").Interior.Color = RGB(255, 255, 0)

            xlWorksheet.Cells(totalRow, 6) = totalMontant.ToString("N0") & " FCFA"
            xlWorksheet.Cells(totalRow, 6).Font.Bold = True
            xlWorksheet.Cells(totalRow, 6).Interior.Color = RGB(255, 255, 0)

            xlWorksheet.Columns.AutoFit()
            xlWorksheet.Range($"A5:J{row - 1}").Borders.LineStyle = 1
            xlWorksheet.Range("A6").Select()
            xlApp.ActiveWindow.FreezePanes = True

            xlWorkbook.SaveAs(cheminFichier)
            Console.WriteLine($"‚úÖ Export Excel complet termin√© avec MontantHT")

        Finally
            If xlWorkbook IsNot Nothing Then
                xlWorkbook.Close(False)
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlWorkbook)
            End If
            If xlApp IsNot Nothing Then
                xlApp.Quit()
                System.Runtime.InteropServices.Marshal.ReleaseComObject(xlApp)
            End If
            GC.Collect()
            GC.WaitForPendingFinalizers()
        End Try
    End Sub
    ' üî• M√âTHODES UTILITAIRES POUR L'EXPORT EXCEL
    Private Function ObtenirValeurSecure(row As DataRow, columnName As String) As String
        Try
            If row.Table.Columns.Contains(columnName) AndAlso Not IsDBNull(row(columnName)) Then
                Return row(columnName).ToString()
            End If
            Return ""
        Catch
            Return ""
        End Try
    End Function

    Private Sub ColorierCelluleStatut(cellule As Object, statut As String)
        Try
            Select Case statut.ToUpper()
                Case "BROUILLON"
                    cellule.Interior.Color = RGB(149, 165, 166)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "ENVOY√â", "ENVOYE"
                    cellule.Interior.Color = RGB(52, 152, 219)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "D√âPOS√â", "DEPOSE"
                    cellule.Interior.Color = RGB(255, 165, 0)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "ACCEPT√â", "ACCEPTE"
                    cellule.Interior.Color = RGB(46, 204, 113)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "REFUS√â", "REFUSE"
                    cellule.Interior.Color = RGB(231, 76, 60)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "RETOURN√â", "RETOURNE"
                    cellule.Interior.Color = RGB(155, 89, 182)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "R√âVISION", "REVISIONS"
                    cellule.Interior.Color = RGB(243, 156, 18)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case "FACTUR√â", "FACTURE"
                    cellule.Interior.Color = RGB(46, 204, 113)
                    cellule.Font.Color = RGB(255, 255, 255)
                Case Else
                    cellule.Interior.Color = RGB(220, 220, 220)
                    cellule.Font.Color = RGB(0, 0, 0)
            End Select
            cellule.Font.Bold = True
        Catch ex As Exception
            Console.WriteLine($"Erreur colorisation: {ex.Message}")
        End Try
    End Sub
    ' üî• 5. NOUVEAU LAYOUT : Contr√¥les de recherche remont√©s
    Private Sub AjouterControlesRecherche()
        Try
            Dim dgvX As Integer = dgvListeDevis.Location.X
            Dim dgvY As Integer = dgvListeDevis.Location.Y

            ' üîç LABEL RECHERCHE (plus haut, ligne unique)
            Dim lblRecherche As New Label()
            lblRecherche.Text = "üîç Rechercher :"
            lblRecherche.Location = New Point(dgvX, dgvY - 50) ' üî• REMONT√â : -55 ‚Üí -50
            lblRecherche.Size = New Size(100, 22)
            lblRecherche.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)
            lblRecherche.ForeColor = Color.DarkBlue
            Me.Controls.Add(lblRecherche)

            ' üìù TEXTBOX RECHERCHE
            txtRechercheTest = New TextBox()
            txtRechercheTest.Location = New Point(dgvX + 105, dgvY - 50) ' üî• REMONT√â
            txtRechercheTest.Size = New Size(180, 22) ' üî• R√âDUIT : 200 ‚Üí 180
            txtRechercheTest.Font = New System.Drawing.Font("Segoe UI", 9)
            AddHandler txtRechercheTest.TextChanged, AddressOf RechercheTest_TextChanged
            Me.Controls.Add(txtRechercheTest)

            ' ‚ùå BOUTON EFFACER (plus compact)
            Dim btnEffacer As New Button()
            btnEffacer.Text = "‚ùå"
            btnEffacer.Location = New Point(dgvX + 290, dgvY - 50) ' üî• AJUST√â
            btnEffacer.Size = New Size(25, 22) ' üî• PLUS COMPACT
            btnEffacer.BackColor = Color.FromArgb(231, 76, 60)
            btnEffacer.ForeColor = Color.White
            btnEffacer.FlatStyle = FlatStyle.Flat
            btnEffacer.Font = New System.Drawing.Font("Segoe UI", 8)
            AddHandler btnEffacer.Click, AddressOf EffacerRecherche_Click
            Me.Controls.Add(btnEffacer)

            ' üîΩ BOUTON FILTRER (plus compact)
            Dim btnFiltrer As New Button()
            btnFiltrer.Text = "üîΩ Filtrer"
            btnFiltrer.Location = New Point(dgvX + 320, dgvY - 50) ' üî• AJUST√â
            btnFiltrer.Size = New Size(65, 22) ' üî• PLUS COMPACT
            btnFiltrer.BackColor = Color.FromArgb(155, 89, 182)
            btnFiltrer.ForeColor = Color.White
            btnFiltrer.FlatStyle = FlatStyle.Flat
            btnFiltrer.Font = New System.Drawing.Font("Segoe UI", 8, FontStyle.Bold)
            AddHandler btnFiltrer.Click, AddressOf AfficherMenuFiltrer_Click
            Me.Controls.Add(btnFiltrer)

            ' üìä BOUTON STATS (plus compact)
            Dim btnStats As New Button()
            btnStats.Text = "üìä Stats"
            btnStats.Location = New Point(dgvX + 390, dgvY - 50) ' üî• AJUST√â
            btnStats.Size = New Size(65, 22) ' üî• PLUS COMPACT
            btnStats.BackColor = Color.FromArgb(46, 204, 113)
            btnStats.ForeColor = Color.White
            btnStats.FlatStyle = FlatStyle.Flat
            btnStats.Font = New System.Drawing.Font("Segoe UI", 8, FontStyle.Bold)
            AddHandler btnStats.Click, AddressOf AfficherStats_Click
            Me.Controls.Add(btnStats)

            ' üì§ BOUTON EXPORT (plus compact)
            Dim btnExport As New Button()
            btnExport.Text = "üì§ Export"
            btnExport.Location = New Point(dgvX + 460, dgvY - 50) ' üî• AJUST√â
            btnExport.Size = New Size(65, 22) ' üî• PLUS COMPACT
            btnExport.BackColor = Color.FromArgb(52, 152, 219)
            btnExport.ForeColor = Color.White
            btnExport.FlatStyle = FlatStyle.Flat
            btnExport.Font = New System.Drawing.Font("Segoe UI", 8, FontStyle.Bold)
            AddHandler btnExport.Click, AddressOf ExporterDevis_Click
            Me.Controls.Add(btnExport)

            ' Mettre au premier plan
            lblRecherche.BringToFront()
            txtRechercheTest.BringToFront()
            btnEffacer.BringToFront()
            btnFiltrer.BringToFront()
            btnStats.BringToFront()
            btnExport.BringToFront()

            Console.WriteLine("‚úÖ Contr√¥les de recherche REMONT√âS et COMPACTS cr√©√©s")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur cr√©ation contr√¥les: {ex.Message}")
        End Try
    End Sub
    Private Sub InitialiserLayoutOptimise()
        Try
            Console.WriteLine("üé® Initialisation layout optimis√©...")

            ' Supprimer tout ancien layout
            SupprimerAnciensControles()

            ' Attendre que le form soit compl√®tement charg√©
            Application.DoEvents()

            ' Cr√©er le nouveau layout optimis√©
            AjouterRechercheComplete()

            Console.WriteLine("‚úÖ Layout optimis√© initialis√©")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur initialisation layout: {ex.Message}")
        End Try
    End Sub
    ' NOUVEAU CODE √Ä AJOUTER :
    Private Function GetTemplatePath() As String
        Try
            Return PathManager.GetTemplatePath("template_entreprise.pdf")
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur r√©cup√©ration chemin template: {ex.Message}")
            ' Fallback vers l'ancien chemin si PathManager √©choue
            Return "C:\Users\HP\source\repos\Nouveau dossier\VERNETTE\VERNETTE\bin\Debug\Templates\template_entreprise.pdf"
        End Try
    End Function
    ' Cette m√©thode peut √™tre ajout√©e pour v√©rifier les dossiers au chargement
    Private Sub VerifierDossiersNecessaires()
        Try
            ' V√©rifier le dossier d'export
            Dim dossierExport As String = PathManager.GetExportPath()
            If Not Directory.Exists(dossierExport) Then
                Try
                    Directory.CreateDirectory(dossierExport)
                    Console.WriteLine($"‚úÖ Dossier d'export cr√©√©: {dossierExport}")
                Catch ex As Exception
                    Console.WriteLine($"‚ùå Impossible de cr√©er le dossier d'export: {ex.Message}")
                End Try
            End If
        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur v√©rification dossiers: {ex.Message}")
        End Try
    End Sub

    Private Sub btnCommande_Click(sender As Object, e As EventArgs)
        Using frm As New Form4()
            frm.ShowDialog()
        End Using
    End Sub

    ' ===============================================================================
    ' NOUVELLE M√âTHODE : CR√âER SECTION AVEC S√âLECTION MANUELLE DES LIGNES
    ' ===============================================================================
    Private Sub btnCreerSection_Click(sender As Object, e As EventArgs) Handles btnCreerSection.Click
        Try
            Dim nomSection As String = txtNomSection.Text.Trim()
            If String.IsNullOrWhiteSpace(nomSection) Then
                MessageBox.Show("‚ö†Ô∏è NOM DE SECTION REQUIS", "Nom Manquant", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                txtNomSection.Focus()
                Return
            End If

            ' üî• NOUVELLE LOGIQUE : Identifier les lignes disponibles (sans section ET pas de type SECTION/TITRE)
            Dim lignesDisponibles As New List(Of LigneInfo)

            For i As Integer = 0 To TableLignesDevis.Rows.Count - 1
                Dim row As DataRow = TableLignesDevis.Rows(i)
                Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())

                ' Inclure seulement les lignes normales sans section
                If typeLigne = "LIGNE" AndAlso String.IsNullOrEmpty(row("SectionNom").ToString()) Then
                    lignesDisponibles.Add(New LigneInfo With {
                    .Index = i,
                    .Designation = row("Designation").ToString(),
                    .Montant = CDec(row("MontantLigne"))
                })
                End If
            Next

            If lignesDisponibles.Count = 0 Then
                MessageBox.Show("‚ö†Ô∏è AUCUNE LIGNE DISPONIBLE" & vbCrLf & vbCrLf &
                          "Toutes les lignes sont d√©j√† dans des sections ou sont des titres/sections.",
                          "Impossible", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' üî• OUVRIR FORMULAIRE DE S√âLECTION
            Dim lignesSelectionnees As List(Of Integer) = OuvrirFormulaireSelectionLignes(lignesDisponibles, nomSection)

            If lignesSelectionnees Is Nothing OrElse lignesSelectionnees.Count = 0 Then
                Return ' Annulation
            End If

            ' Cr√©er la section avec les lignes s√©lectionn√©es
            CreerSectionAvecLignesSelectionnees(nomSection, lignesSelectionnees)

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    ' ===============================================================================
    ' CLASSE POUR STOCKER LES INFOS DE LIGNE
    ' ===============================================================================
    Public Class LigneInfo
        Public Property Index As Integer
        Public Property Designation As String
        Public Property Montant As Decimal
        Public Property Selectionne As Boolean = False
    End Class
    ' ===============================================================================
    ' CORRECTION : FORMULAIRE DE S√âLECTION AM√âLIOR√â
    ' ===============================================================================
    Private Function OuvrirFormulaireSelectionLignes(lignes As List(Of LigneInfo), nomSection As String) As List(Of Integer)
        Try
            Using frmSelection As New Form()
                frmSelection.Text = $"S√©lectionner les lignes pour '{nomSection}'"
                frmSelection.Size = New Size(750, 550)
                frmSelection.StartPosition = FormStartPosition.CenterParent
                frmSelection.FormBorderStyle = FormBorderStyle.FixedDialog
                frmSelection.MaximizeBox = False

                ' Instructions
                Dim lblInstructions As New Label()
                lblInstructions.Text = "üìã Cochez les lignes √† inclure dans cette section :" & vbCrLf &
                                  "‚úÖ Les lignes coch√©es seront dans la section" & vbCrLf &
                                  "‚ùå Les lignes non coch√©es resteront libres (hors section)" & vbCrLf &
                                  "üí° Conseil : Les lignes ajout√©es juste avant ne sont PAS coch√©es par d√©faut"
                lblInstructions.Location = New Point(20, 10)
                lblInstructions.Size = New Size(700, 75)
                lblInstructions.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Regular)
                lblInstructions.ForeColor = Color.FromArgb(52, 73, 94)

                ' CheckedListBox
                Dim clbLignes As New CheckedListBox()
                clbLignes.Location = New Point(20, 95)
                clbLignes.Size = New Size(700, 300)
                clbLignes.CheckOnClick = True
                clbLignes.Font = New System.Drawing.Font("Segoe UI", 9)

                ' üî• REMPLIR AVEC LOGIQUE DE COCHAGE INTELLIGENT
                ' ‚úÖ CORRECTION : Ne rien cocher automatiquement
                Dim totalDisponible As Decimal = 0

                For Each ligne In lignes
                    clbLignes.Items.Add($"{ligne.Designation} ({ligne.Montant:N0} FCFA)")
                    totalDisponible += ligne.Montant

                    ' ‚úÖ NE RIEN COCHER PAR D√âFAUT
                    ' L'utilisateur coche MANUELLEMENT les lignes qu'il veut dans cette section
                    clbLignes.SetItemChecked(clbLignes.Items.Count - 1, False)
                Next

                ' Label total s√©lectionn√©
                ' Label total s√©lectionn√© - CORRECTION : Commencer √† 0
                Dim lblTotalSelectionne As New Label()
                lblTotalSelectionne.Location = New Point(20, 405)
                lblTotalSelectionne.Size = New Size(700, 25)
                lblTotalSelectionne.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)
                lblTotalSelectionne.ForeColor = Color.FromArgb(46, 204, 113)
                ' ‚úÖ CORRECTION : Afficher 0 au d√©part
                lblTotalSelectionne.Text = $"üí∞ Total s√©lectionn√© : 0 FCFA sur {totalDisponible:N0} FCFA disponibles"
                ' Mise √† jour dynamique
                AddHandler clbLignes.ItemCheck, Sub(s, e)
                                                    Dim totalSelectionne As Decimal = 0
                                                    For i As Integer = 0 To clbLignes.Items.Count - 1
                                                        Dim estCoche As Boolean = If(i = e.Index, e.NewValue = CheckState.Checked, clbLignes.GetItemChecked(i))
                                                        If estCoche Then
                                                            totalSelectionne += lignes(i).Montant
                                                        End If
                                                    Next
                                                    lblTotalSelectionne.Text = $"üí∞ Total s√©lectionn√© : {totalSelectionne:N0} FCFA sur {totalDisponible:N0} FCFA disponibles"
                                                End Sub

                ' Boutons
                Dim btnToutCocher As New Button()
                btnToutCocher.Text = "‚úÖ Tout cocher"
                btnToutCocher.Location = New Point(20, 440)
                btnToutCocher.Size = New Size(110, 30)
                btnToutCocher.BackColor = Color.FromArgb(52, 152, 219)
                btnToutCocher.ForeColor = Color.White
                btnToutCocher.FlatStyle = FlatStyle.Flat
                AddHandler btnToutCocher.Click, Sub()
                                                    For i As Integer = 0 To clbLignes.Items.Count - 1
                                                        clbLignes.SetItemChecked(i, True)
                                                    Next
                                                End Sub

                Dim btnToutDecocher As New Button()
                btnToutDecocher.Text = "‚ùå Tout d√©cocher"
                btnToutDecocher.Location = New Point(140, 440)
                btnToutDecocher.Size = New Size(120, 30)
                btnToutDecocher.BackColor = Color.FromArgb(231, 76, 60)
                btnToutDecocher.ForeColor = Color.White
                btnToutDecocher.FlatStyle = FlatStyle.Flat
                AddHandler btnToutDecocher.Click, Sub()
                                                      For i As Integer = 0 To clbLignes.Items.Count - 1
                                                          clbLignes.SetItemChecked(i, False)
                                                      Next
                                                  End Sub

                ' üî• NOUVEAU BOUTON : Marquer comme libres d√©finitives
                Dim btnMarquerLibres As New Button()
                btnMarquerLibres.Text = "üîì Laisser libres"
                btnMarquerLibres.Location = New Point(270, 440)
                btnMarquerLibres.Size = New Size(130, 30)
                btnMarquerLibres.BackColor = Color.FromArgb(243, 156, 18)
                btnMarquerLibres.ForeColor = Color.White
                btnMarquerLibres.FlatStyle = FlatStyle.Flat
                btnMarquerLibres.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                AddHandler btnMarquerLibres.Click, Sub()
                                                       ' Marquer les lignes non coch√©es comme "libres d√©finitives"
                                                       Dim compteur As Integer = 0
                                                       For i As Integer = 0 To clbLignes.Items.Count - 1
                                                           If Not clbLignes.GetItemChecked(i) Then
                                                               Dim ligneIndex As Integer = lignes(i).Index
                                                               If ligneIndex < TableLignesDevis.Rows.Count Then
                                                                   TableLignesDevis.Rows(ligneIndex)("EstLibreDefinitif") = True
                                                                   compteur += 1
                                                               End If
                                                           End If
                                                       Next

                                                       MessageBox.Show($"‚úÖ {compteur} ligne(s) marqu√©e(s) comme LIBRES" & vbCrLf & vbCrLf &
                              "Ces lignes ne seront PLUS propos√©es dans les futures sections.",
                              "Lignes Libres", MessageBoxButtons.OK, MessageBoxIcon.Information)

                                                       frmSelection.DialogResult = DialogResult.Cancel
                                                       frmSelection.Close()
                                                   End Sub

                Dim btnValider As New Button()
                btnValider.Text = "üíæ Cr√©er Section"
                btnValider.Location = New Point(520, 440)
                btnValider.Size = New Size(130, 30)
                btnValider.BackColor = Color.FromArgb(46, 204, 113)
                btnValider.ForeColor = Color.White
                btnValider.FlatStyle = FlatStyle.Flat
                btnValider.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim btnAnnuler As New Button()
                btnAnnuler.Text = "Annuler"
                btnAnnuler.Location = New Point(660, 440)
                btnAnnuler.Size = New Size(70, 30)
                btnAnnuler.BackColor = Color.Gray
                btnAnnuler.ForeColor = Color.White
                btnAnnuler.FlatStyle = FlatStyle.Flat

                Dim lignesChoisies As List(Of Integer) = Nothing

                AddHandler btnValider.Click, Sub(s, e)
                                                 lignesChoisies = New List(Of Integer)
                                                 For i As Integer = 0 To clbLignes.Items.Count - 1
                                                     If clbLignes.GetItemChecked(i) Then
                                                         lignesChoisies.Add(lignes(i).Index)
                                                     End If
                                                 Next

                                                 If lignesChoisies.Count = 0 Then
                                                     MessageBox.Show("‚ö†Ô∏è Veuillez s√©lectionner au moins une ligne.",
                                  "S√©lection vide", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                     Return
                                                 End If

                                                 frmSelection.DialogResult = DialogResult.OK
                                                 frmSelection.Close()
                                             End Sub

                AddHandler btnAnnuler.Click, Sub(s, e)
                                                 lignesChoisies = Nothing
                                                 frmSelection.DialogResult = DialogResult.Cancel
                                                 frmSelection.Close()
                                             End Sub

                ' Ajouter contr√¥les
                frmSelection.Controls.AddRange({
                lblInstructions, clbLignes, lblTotalSelectionne,
                btnToutCocher, btnToutDecocher, btnMarquerLibres, btnValider, btnAnnuler
            })

                If frmSelection.ShowDialog() = DialogResult.OK Then
                    Return lignesChoisies
                Else
                    Return Nothing
                End If

            End Using

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur formulaire : {ex.Message}")
            Return Nothing
        End Try
    End Function


    ' ===============================================================================
    ' CR√âER LA SECTION AVEC LES LIGNES S√âLECTIONN√âES
    ' ===============================================================================
    Private Sub CreerSectionAvecLignesSelectionnees(nomSection As String, lignesIndices As List(Of Integer))
        Try
            Console.WriteLine($"üîÑ === CR√âATION SECTION '{nomSection}' ===")
            Console.WriteLine($"   Lignes s√©lectionn√©es: {lignesIndices.Count}")

            Dim sousTotal As Decimal = 0

            ' 1Ô∏è‚É£ Assigner SEULEMENT les lignes s√©lectionn√©es √† la section
            For Each index In lignesIndices
                If index < TableLignesDevis.Rows.Count Then
                    Dim row As DataRow = TableLignesDevis.Rows(index)

                    ' üî• V√âRIFIER que c'est bien une LIGNE normale
                    If row("TypeLigne").ToString() = "LIGNE" Then
                        row("SectionNom") = nomSection
                        sousTotal += CDec(row("MontantLigne"))
                        Console.WriteLine($"  ‚úÖ Ligne assign√©e: {row("Designation")} = {CDec(row("MontantLigne")):N0}")
                    End If
                End If
            Next

            ' 2Ô∏è‚É£ Cr√©er la ligne de sous-total
            Dim sectionRow As DataRow = TableLignesDevis.NewRow()
            sectionRow("Designation") = $"SOUS-TOTAL - {nomSection.ToUpper()}"
            sectionRow("Unite") = ""
            sectionRow("Quantite") = 0
            sectionRow("PrixUnitaire") = 0
            sectionRow("MontantLigne") = sousTotal
            sectionRow("TacheID") = 0
            sectionRow("LigneDevisID") = 0
            sectionRow("SectionNom") = nomSection
            sectionRow("TypeLigne") = "SECTION"
            sectionRow("OrdreAffichage") = TableLignesDevis.Rows.Count + 1
            sectionRow("EstLibreDefinitif") = False ' üî• NOUVEAU

            TableLignesDevis.Rows.Add(sectionRow)

            ' 3Ô∏è‚É£ R√©organiser CORRECTEMENT (lignes section + sous-total + lignes libres)
            ReorganiserLignesParSections()

            ' 4Ô∏è‚É£ Compteurs et rafra√Æchissement
            nombreSections += 1
            txtNomSection.Clear()

            RefreshDataGridViewLignes()
            GererEtatBoutonsSections()
            CalculerTotauxDevis()
            ' üî• AJOUTER √Ä LA FIN :
            CalculerTotalFiltre()
            ' 5Ô∏è‚É£ Compter les lignes rest√©es VRAIMENT libres
            Dim lignesLibres As Integer = 0
            For Each row As DataRow In TableLignesDevis.Rows
                If row("TypeLigne").ToString() = "LIGNE" AndAlso String.IsNullOrEmpty(row("SectionNom").ToString()) Then
                    lignesLibres += 1
                    Console.WriteLine($"  üÜì Ligne libre: {row("Designation")}")
                End If
            Next

            MessageBox.Show($"‚úÖ SECTION CR√â√âE" & vbCrLf & vbCrLf &
           $"üìã Section : {nomSection}" & vbCrLf &
           $"üìä Lignes incluses : {lignesIndices.Count}" & vbCrLf &
           $"üìä Sous-total : {sousTotal:N0} FCFA" & vbCrLf & vbCrLf &
           $"üÜì Lignes rest√©es LIBRES : {lignesLibres}" & vbCrLf &
           If(lignesLibres > 0, "Ces lignes apparaissent APR√àS la section cr√©√©e.", "Toutes les lignes sont maintenant sectionn√©es."),
           "Section Cr√©√©e", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"‚úÖ Section '{nomSection}' cr√©√©e - {lignesLibres} lignes libres APR√àS la section")
            Console.WriteLine("üîÑ === FIN CR√âATION SECTION ===")

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub CreerSectionAvecLignes(nomSection As String, lignesIndices As List(Of Integer))
        Try
            Console.WriteLine($"üîÑ Cr√©ation section '{nomSection}' avec {lignesIndices.Count} lignes")

            Dim sousTotal As Decimal = 0

            ' Assigner toutes les lignes √† la section
            For Each index In lignesIndices
                If index < TableLignesDevis.Rows.Count Then
                    Dim row As DataRow = TableLignesDevis.Rows(index)
                    row("SectionNom") = nomSection
                    sousTotal += CDec(row("MontantLigne"))
                    Console.WriteLine($"  Ligne assign√©e : {row("Designation")} = {CDec(row("MontantLigne")):N0}")
                End If
            Next

            ' Cr√©er la ligne de sous-total
            Dim sectionRow As DataRow = TableLignesDevis.NewRow()
            sectionRow("Designation") = $"SOUS-TOTAL - {nomSection.ToUpper()}"
            sectionRow("Unite") = ""
            sectionRow("Quantite") = 0
            sectionRow("PrixUnitaire") = 0
            sectionRow("MontantLigne") = sousTotal
            sectionRow("TacheID") = 0
            sectionRow("LigneDevisID") = 0
            sectionRow("SectionNom") = nomSection
            sectionRow("TypeLigne") = "SECTION"
            sectionRow("OrdreAffichage") = TableLignesDevis.Rows.Count + 1

            TableLignesDevis.Rows.Add(sectionRow)

            ' Mise √† jour des compteurs
            nombreSections += 1
            lignesEnCours.Clear() ' Vider car toutes les lignes sont maintenant sectionn√©es
            txtNomSection.Clear()

            ReorganiserLignesParSections()
            RefreshDataGridViewLignes()
            GererEtatBoutonsSections()
            CalculerTotauxDevis()

            MessageBox.Show($"‚úÖ SECTION CR√â√âE" & vbCrLf & vbCrLf &
                   $"üìã Section : {nomSection}" & vbCrLf &
                   $"üìä Lignes incluses : {lignesIndices.Count}" & vbCrLf &
                   $"üìä Sous-total : {sousTotal:N0} FCFA",
                   "Section Cr√©√©e", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"‚úÖ Section '{nomSection}' cr√©√©e avec sous-total {sousTotal:N0}")

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur cr√©ation section : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub CreerNouvelleSection(nomSection As String)
        Try
            Console.WriteLine($"üîÑ Cr√©ation section '{nomSection}' avec {lignesEnCours.Count} lignes")

            If lignesEnCours.Count = 0 Then Return

            ' üî• CALCULER LE SOUS-TOTAL
            Dim sousTotal As Decimal = 0
            For Each ligneIndex In lignesEnCours
                If ligneIndex < TableLignesDevis.Rows.Count Then
                    Dim row As DataRow = TableLignesDevis.Rows(ligneIndex)
                    sousTotal += CDec(row("MontantLigne"))
                    row("SectionNom") = nomSection ' Assigner √† la section
                End If
            Next

            ' üî• CR√âER LA LIGNE DE SOUS-TOTAL
            Dim sectionRow As DataRow = TableLignesDevis.NewRow()
            sectionRow("Designation") = $"SOUS-TOTAL - {nomSection.ToUpper()}"
            sectionRow("Unite") = ""
            sectionRow("Quantite") = 0
            sectionRow("PrixUnitaire") = 0
            sectionRow("MontantLigne") = sousTotal
            sectionRow("TacheID") = 0
            sectionRow("LigneDevisID") = 0
            sectionRow("SectionNom") = nomSection
            sectionRow("TypeLigne") = "SECTION"
            sectionRow("OrdreAffichage") = TableLignesDevis.Rows.Count + 1

            ' üî• POINT CL√â : AJOUTER IMM√âDIATEMENT APR√àS LA DERNI√àRE LIGNE DE LA SECTION
            ' Pas √† la fin du tableau, mais juste apr√®s les lignes concern√©es
            TableLignesDevis.Rows.Add(sectionRow)

            ' Mise √† jour des compteurs
            nombreSections += 1
            sectionActuelle = nombreSections

            ' IMPORTANT : VIDER lignesEnCours pour la prochaine section
            lignesEnCours.Clear()
            txtNomSection.Clear()

            ' Rafra√Æchir l'affichage
            RefreshDataGridViewLignes()
            GererEtatBoutonsSections()
            CalculerTotauxDevis()

            MessageBox.Show($"‚úÖ SECTION CR√â√âE" & vbCrLf & vbCrLf &
                       $"üìã Section : {nomSection}" & vbCrLf &
                       $"üìä Sous-total : {sousTotal:N0} FCFA" & vbCrLf & vbCrLf &
                       "Vous pouvez maintenant ajouter des t√¢ches pour une nouvelle section.",
                       "Section Cr√©√©e", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"‚úÖ Section '{nomSection}' cr√©√©e IMM√âDIATEMENT apr√®s ses t√¢ches")

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur cr√©ation section : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub RefreshDataGridViewLignesAvecSections()
        Try
            dgvLignesDevis.Rows.Clear()

            For Each row As DataRow In TableLignesDevis.Rows
                Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())

                If typeLigne = "TITRE" Then
                    ' üî∑ TITRE
                    Dim dgvRow As Integer = dgvLignesDevis.Rows.Add(
                    "üî∑ " & row("Designation").ToString(),
                    "", "", "", "", row("TacheID")
                )
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.BackColor = Color.FromArgb(173, 216, 230)
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.ForeColor = Color.FromArgb(25, 25, 112)

                ElseIf typeLigne = "SECTION" Then
                    ' üìä SECTION
                    Dim dgvRow As Integer = dgvLignesDevis.Rows.Add(
                    row("Designation").ToString(),
                    "", "", "", CDec(row("MontantLigne")).ToString("N0"), row("TacheID")
                )
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.BackColor = Color.LightBlue
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.ForeColor = Color.DarkBlue

                Else
                    ' üìù LIGNE NORMALE
                    Dim dgvRow As Integer = dgvLignesDevis.Rows.Add(
                    row("Designation").ToString(),
                    row("Unite").ToString(),
                    CDec(row("Quantite")).ToString("N2"),
                    CDec(row("PrixUnitaire")).ToString("N0"),
                    CDec(row("MontantLigne")).ToString("N0"),
                    row("TacheID")
                )
                End If
            Next

            Console.WriteLine($"‚úÖ DGV rafra√Æchi - {TableLignesDevis.Rows.Count} lignes")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur refresh : {ex.Message}")
        End Try
    End Sub
    Private Function CalculerTaillePolice(nombreLignes As Integer) As Single
        Select Case nombreLignes
            Case 1 To 15 : Return 11.0F  ' Au lieu de 10.0F
            Case 16 To 25 : Return 10.0F ' Au lieu de 9.0F
            Case 26 To 35 : Return 9.0F  ' Au lieu de 8.0F
            Case Else : Return 8.5F      ' Au lieu de 7.5F
        End Select
    End Function

    Private Sub lblNumeroDevis_Click(sender As Object, e As EventArgs) Handles lblNumeroDevis.Click

    End Sub
    Private Sub GererControlesSection()
        Try
            ' Activer si on est en mode √©dition ET qu'il y a des lignes
            Dim actif As Boolean = (btnEnregistrerDevis.Enabled AndAlso TableLignesDevis.Rows.Count > 0)

            ' TextBox nom de section
            txtNomSection.Enabled = actif
            txtNomSection.BackColor = If(actif, Color.White, Color.LightGray)

            ' Bouton cr√©er section - actif seulement s'il y a des lignes en attente
            Dim peutCreer As Boolean = actif AndAlso lignesEnCours.Count > 0
            btnCreerSection.Enabled = peutCreer
            btnCreerSection.BackColor = If(peutCreer, Color.FromArgb(52, 152, 219), Color.LightGray)
            btnCreerSection.ForeColor = If(peutCreer, Color.White, Color.DarkGray)

            Console.WriteLine($"GererControlesSection: actif={actif}, lignesEnCours={lignesEnCours.Count}")

        Catch ex As Exception
            Console.WriteLine($"Erreur GererControlesSection: {ex.Message}")
        End Try
    End Sub

    ' 4. CORRIGER AjouterCelluleSousTotal pour √™tre compatible avec le tableau √† 5 colonnes
    Private Sub AjouterCelluleSousTotal(table As PdfPTable, texteSousTotal As String, montant As Decimal)
        Try
            Dim fontSizeTableau As Single = 9  ' üî• Police r√©duite fixe
            Dim font As Font = FontFactory.GetFont(FontFactory.HELVETICA_BOLD, fontSizeTableau, BaseColor.BLACK)

            ' CELLULE 1 : Texte sous-total (COLSPAN = 4 pour occuper les 4 premi√®res colonnes)
            Dim cellTexte As New PdfPCell(New Phrase(texteSousTotal, font))
            cellTexte.Colspan = 4 ' Fusion des colonnes D√©signation + Unit√© + Quantit√© + Prix unitaire
            cellTexte.HorizontalAlignment = Element.ALIGN_LEFT
            cellTexte.VerticalAlignment = Element.ALIGN_MIDDLE
            cellTexte.BackgroundColor = New BaseColor(230, 230, 230) ' Gris clair
            cellTexte.Border = Rectangle.BOX
            cellTexte.BorderWidth = 0.5F
            cellTexte.BorderColor = BaseColor.BLACK
            cellTexte.Padding = 2  ' üî• R√âDUIT : padding fixe √† 2
            cellTexte.MinimumHeight = 0  ' üî• SUPPRIM√â : laisse la hauteur s'adapter
            table.AddCell(cellTexte)

            ' CELLULE 2 : Montant sous-total (colonne Montant)
            Dim cellMontant As New PdfPCell(New Phrase(montant.ToString("N0", New CultureInfo("fr-FR")), font))
            cellMontant.HorizontalAlignment = Element.ALIGN_RIGHT
            cellMontant.VerticalAlignment = Element.ALIGN_MIDDLE
            cellMontant.BackgroundColor = New BaseColor(230, 230, 230) ' M√™me gris que le texte
            cellMontant.Border = Rectangle.BOX
            cellMontant.BorderWidth = 0.5F
            cellMontant.BorderColor = BaseColor.BLACK
            cellMontant.Padding = 2  ' üî• R√âDUIT : padding fixe √† 2
            cellMontant.MinimumHeight = 0  ' üî• SUPPRIM√â : laisse la hauteur s'adapter
            table.AddCell(cellMontant)

            Console.WriteLine($"Sous-total PDF ajout√© : {texteSousTotal} = {montant:N0} FCFA")
        Catch ex As Exception
            Console.WriteLine($"Erreur ajout sous-total PDF : {ex.Message}")
        End Try
    End Sub

    Private Sub txtNomSection_TextChanged(sender As Object, e As EventArgs) Handles txtNomSection.TextChanged

    End Sub
    ' ‚≠ê M√âTHODE PUBLIQUE pour notification externe
    Public Sub NotifierCreationBonCommande(devisID As Integer)
        Try
            Console.WriteLine($"üîî Notification cr√©ation bon de commande pour devis {devisID}")

            ' Recharger les donn√©es
            ChargerDevis()

            ' Repositionner sur le devis concern√©
            RepositionnerSurDevis(devisID)

            ' Mettre √† jour les boutons selon le nouveau statut
            If dgvListeDevis.CurrentRow IsNot Nothing Then
                GererAutresBoutons("Command√©")
                GererBoutonCreerFacture()
            End If

            Console.WriteLine("‚úÖ Form7 mis √† jour apr√®s cr√©ation bon de commande")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur notification bon de commande: {ex.Message}")
        End Try
    End Sub
    Private Sub VerifierEtSynchroniserStatutsCommandes()
        Try
            Console.WriteLine("üîç V√©rification synchronisation statuts command√©s...")

            ' Mettre √† jour automatiquement les devis qui ont un bon de commande mais pas le bon statut
            Dim query As String = "
                UPDATE Devis 
                SET StatutDevis = 'Command√©' 
                WHERE DevisID IN (
                    SELECT DISTINCT BC.DevisID 
                    FROM BonsDeCommande BC
                    INNER JOIN Devis D ON BC.DevisID = D.DevisID
                    WHERE D.StatutDevis != 'Command√©' 
                    AND D.StatutDevis != 'Factur√©'
                    AND BC.DevisID IS NOT NULL
                )"

            Dim nbMisAJour As Integer = DbHelper.ExecuteNonQuery(query)

            If nbMisAJour > 0 Then
                Console.WriteLine($"‚úÖ {nbMisAJour} statuts synchronis√©s vers 'Command√©'")
                ChargerDevis() ' Recharger si des corrections ont √©t√© faites
            End If

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur synchronisation statuts: {ex.Message}")
        End Try
    End Sub
    ' 1. BOUTON MODIFIER SECTION - Event Handler
    Private Sub btnModifierSection_Click(sender As Object, e As EventArgs) Handles btnModifierSection.Click
        Try
            If dgvLignesDevis.CurrentRow Is Nothing Then
                MessageBox.Show("Veuillez s√©lectionner une ligne de section √† modifier.",
                                  "S√©lection requise", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim rowIndex As Integer = dgvLignesDevis.CurrentRow.Index
            If rowIndex >= TableLignesDevis.Rows.Count Then
                MessageBox.Show("Index de ligne invalide.", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                Return
            End If

            Dim row As DataRow = TableLignesDevis.Rows(rowIndex)

            ' V√©rifier que c'est bien une section
            If row("TypeLigne").ToString() <> "SECTION" Then
                MessageBox.Show("La ligne s√©lectionn√©e n'est pas une section." & vbCrLf & vbCrLf &
                                  "Veuillez s√©lectionner une ligne 'SOUS-TOTAL' pour modifier une section.",
                                  "S√©lection incorrecte", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim ancienNom As String = row("SectionNom").ToString()
            Dim nouveauNom As String = InputBox($"Modifier le nom de la section :" & vbCrLf & vbCrLf &
                                                   $"Nom actuel : {ancienNom}",
                                                   "Modification Section", ancienNom)

            If String.IsNullOrWhiteSpace(nouveauNom) Then
                Return ' Annulation
            End If

            If nouveauNom.Trim() = ancienNom Then
                MessageBox.Show("Le nom n'a pas chang√©.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            nouveauNom = nouveauNom.Trim()

            ' Mettre √† jour toutes les lignes de cette section
            Dim nombreLignesModifiees As Integer = 0
            For Each ligneRow As DataRow In TableLignesDevis.Rows
                If ligneRow("SectionNom").ToString() = ancienNom Then
                    ligneRow("SectionNom") = nouveauNom
                    If ligneRow("TypeLigne").ToString() = "SECTION" Then
                        ligneRow("Designation") = $"SOUS-TOTAL - {nouveauNom.ToUpper()}"
                    End If
                    nombreLignesModifiees += 1
                End If
            Next

            RefreshDataGridViewLignes()

            MessageBox.Show($"Section renomm√©e avec succ√®s !" & vbCrLf & vbCrLf &
                               $"Ancien nom : {ancienNom}" & vbCrLf &
                               $"Nouveau nom : {nouveauNom}" & vbCrLf &
                               $"Lignes modifi√©es : {nombreLignesModifiees}",
                               "Modification r√©ussie", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"Section renomm√©e : '{ancienNom}' -> '{nouveauNom}' ({nombreLignesModifiees} lignes)")

        Catch ex As Exception
            MessageBox.Show($"Erreur lors de la modification : {ex.Message}",
                               "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"Erreur btnModifierSection_Click : {ex.Message}")
        End Try
    End Sub

    ' 2. BOUTON SUPPRIMER SECTION - Event Handler
    Private Sub btnSupprimerSection_Click(sender As Object, e As EventArgs) Handles btnSupprimerSection.Click
        Try
            If dgvLignesDevis.CurrentRow Is Nothing Then
                MessageBox.Show("Veuillez s√©lectionner une ligne de section √† supprimer.",
                                  "S√©lection requise", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim rowIndex As Integer = dgvLignesDevis.CurrentRow.Index
            If rowIndex >= TableLignesDevis.Rows.Count Then
                MessageBox.Show("Index de ligne invalide.", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                Return
            End If

            Dim row As DataRow = TableLignesDevis.Rows(rowIndex)

            If row("TypeLigne").ToString() <> "SECTION" Then
                MessageBox.Show("La ligne s√©lectionn√©e n'est pas une section." & vbCrLf & vbCrLf &
                                  "Veuillez s√©lectionner une ligne 'SOUS-TOTAL' pour supprimer une section.",
                                  "S√©lection incorrecte", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim nomSection As String = row("SectionNom").ToString()
            Dim montantSection As Decimal = CDec(row("MontantLigne"))

            ' Compter les lignes de cette section
            Dim nombreTaches As Integer = 0
            For Each ligneRow As DataRow In TableLignesDevis.Rows
                If ligneRow("SectionNom").ToString() = nomSection AndAlso ligneRow("TypeLigne").ToString() <> "SECTION" Then
                    nombreTaches += 1
                End If
            Next

            Dim reponse As DialogResult = MessageBox.Show(
                    $"√ätes-vous s√ªr de vouloir supprimer la section '{nomSection}' ?" & vbCrLf & vbCrLf &
                    $"Section contient : {nombreTaches} t√¢che(s)" & vbCrLf &
                    $"Montant section : {montantSection:N0} FCFA" & vbCrLf & vbCrLf &
                    "Cette action :" & vbCrLf &
                    "‚Ä¢ Supprimera la ligne de sous-total" & vbCrLf &
                    "‚Ä¢ Remettra les t√¢ches sans section" & vbCrLf &
                    "‚Ä¢ Ne supprimera PAS les t√¢ches elles-m√™mes" & vbCrLf &
                    "‚Ä¢ Ne peut pas √™tre annul√©e" & vbCrLf & vbCrLf &
                    "Continuer ?",
                    "Confirmer suppression", MessageBoxButtons.YesNo, MessageBoxIcon.Question)

            If reponse = DialogResult.Yes Then
                ' Supprimer la ligne de section (sous-total)
                TableLignesDevis.Rows.Remove(row)

                ' Remettre les autres lignes de cette section sans section
                Dim nombreLignesLiberees As Integer = 0
                For Each ligneRow As DataRow In TableLignesDevis.Rows
                    If ligneRow("SectionNom").ToString() = nomSection AndAlso ligneRow("TypeLigne").ToString() <> "SECTION" Then
                        ligneRow("SectionNom") = ""
                        nombreLignesLiberees += 1
                    End If
                Next

                RefreshDataGridViewLignes()
                CalculerTotauxDevis()

                ' D√©cr√©menter le compteur de sections
                If nombreSections > 0 Then
                    nombreSections -= 1
                End If

                MessageBox.Show($"Section supprim√©e avec succ√®s !" & vbCrLf & vbCrLf &
                                   $"Section : {nomSection}" & vbCrLf &
                                   $"T√¢ches lib√©r√©es : {nombreLignesLiberees}" & vbCrLf &
                                   $"Montant lib√©r√© : {montantSection:N0} FCFA",
                                   "Suppression r√©ussie", MessageBoxButtons.OK, MessageBoxIcon.Information)

                Console.WriteLine($"Section '{nomSection}' supprim√©e ({nombreLignesLiberees} t√¢ches lib√©r√©es)")
            End If
            GererEtatBoutonsSections()
        Catch ex As Exception
            MessageBox.Show($"Erreur lors de la suppression : {ex.Message}",
                               "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"Erreur btnSupprimerSection_Click : {ex.Message}")
        End Try
    End Sub

    ' 3. M√âTHODE POUR G√âRER L'√âTAT DES BOUTONS SECTIONS
    Private Sub GererEtatBoutonsSections()
        Try
            Console.WriteLine("üîß === DIAGNOSTIC BOUTONS SECTIONS ===")

            Dim activerBoutons As Boolean = False

            ' ‚úÖ V√©rifier si on est en mode √©dition
            If btnEnregistrerDevis IsNot Nothing AndAlso btnEnregistrerDevis.Enabled Then
                Dim nombreLignes As Integer = TableLignesDevis.Rows.Count
                activerBoutons = (nombreLignes > 0)
                Console.WriteLine($"   Mode √©dition: Oui, Nombre lignes: {nombreLignes}")
            Else
                Console.WriteLine($"   Mode √©dition: Non")
            End If

            ' üìä Compter les lignes sans section (SANS TITRE ni SECTION)
            Dim lignesSansSection As Integer = 0
            For Each row As DataRow In TableLignesDevis.Rows
                Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())
                Dim sectionNom As String = If(IsDBNull(row("SectionNom")), "", row("SectionNom").ToString())

                ' Compter SEULEMENT les lignes normales sans section
                If typeLigne = "LIGNE" AndAlso String.IsNullOrEmpty(sectionNom) Then
                    lignesSansSection += 1
                    Console.WriteLine($"   Ligne libre trouv√©e: {row("Designation")}")
                End If
            Next

            Console.WriteLine($"   Total lignes sans section: {lignesSansSection}")

            ' üî• BOUTON CR√âER SECTION
            If btnCreerSection IsNot Nothing Then
                Dim peutCreer As Boolean = activerBoutons AndAlso lignesSansSection > 0

                btnCreerSection.Enabled = peutCreer
                btnCreerSection.BackColor = If(peutCreer, Color.FromArgb(52, 152, 219), Color.LightGray)
                btnCreerSection.ForeColor = If(peutCreer, Color.White, Color.DarkGray)

                Console.WriteLine($"   Bouton Cr√©er Section: {If(peutCreer, "ACTIV√â ‚úÖ", "D√âSACTIV√â ‚ùå")}")

                If Not peutCreer Then
                    If Not activerBoutons Then
                        Console.WriteLine($"   Raison: Pas en mode √©dition")
                    ElseIf lignesSansSection = 0 Then
                        Console.WriteLine($"   Raison: Aucune ligne libre disponible")
                    End If
                End If
            End If

            ' üìù BOUTON MODIFIER SECTION
            If btnModifierSection IsNot Nothing Then
                Dim nombreSections As Integer = 0
                For Each row As DataRow In TableLignesDevis.Rows
                    If row("TypeLigne").ToString() = "SECTION" Then
                        nombreSections += 1
                    End If
                Next

                Dim peutModifier As Boolean = activerBoutons AndAlso nombreSections > 0
                btnModifierSection.Enabled = peutModifier
                btnModifierSection.BackColor = If(peutModifier, Color.FromArgb(243, 156, 18), Color.LightGray)
                btnModifierSection.ForeColor = If(peutModifier, Color.White, Color.DarkGray)

                Console.WriteLine($"   Bouton Modifier Section: {If(peutModifier, "ACTIV√â ‚úÖ", "D√âSACTIV√â ‚ùå")} (Sections: {nombreSections})")
            End If

            ' üóëÔ∏è BOUTON SUPPRIMER SECTION
            If btnSupprimerSection IsNot Nothing Then
                Dim nombreSections As Integer = 0
                For Each row As DataRow In TableLignesDevis.Rows
                    If row("TypeLigne").ToString() = "SECTION" Then
                        nombreSections += 1
                    End If
                Next

                Dim peutSupprimer As Boolean = activerBoutons AndAlso nombreSections > 0
                btnSupprimerSection.Enabled = peutSupprimer
                btnSupprimerSection.BackColor = If(peutSupprimer, Color.FromArgb(231, 76, 60), Color.LightGray)
                btnSupprimerSection.ForeColor = If(peutSupprimer, Color.White, Color.DarkGray)

                Console.WriteLine($"   Bouton Supprimer Section: {If(peutSupprimer, "ACTIV√â ‚úÖ", "D√âSACTIV√â ‚ùå")}")
            End If

            Console.WriteLine("üîß === FIN DIAGNOSTIC ===")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur GererEtatBoutonsSections : {ex.Message}")
        End Try
    End Sub
    ' 5. AM√âLIORATION DU RefreshDataGridViewLignes pour highlighting des sections
    Private Sub RefreshDataGridViewLignesAvecHighlight()
        Try
            dgvLignesDevis.Rows.Clear()

            For Each row As DataRow In TableLignesDevis.Rows
                Dim dgvRow As Integer = dgvLignesDevis.Rows.Add(
                    row("Designation"),
                    row("Unite"),
                    row("Quantite"),
                    row("PrixUnitaire"),
                    row("MontantLigne"),
                    row("TacheID")
                )

                ' Styliser les lignes de section avec couleur distinctive
                If row("TypeLigne").ToString() = "SECTION" Then
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.BackColor = Color.FromArgb(173, 216, 230) ' Bleu clair
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.ForeColor = Color.FromArgb(25, 25, 112) ' Bleu fonc√©
                ElseIf Not String.IsNullOrEmpty(row("SectionNom").ToString()) Then
                    ' Lignes appartenant √† une section - couleur tr√®s l√©g√®re
                    dgvLignesDevis.Rows(dgvRow).DefaultCellStyle.BackColor = Color.FromArgb(248, 252, 255) ' Bleu tr√®s p√¢le
                End If
            Next

            Console.WriteLine($"DataGridView rafra√Æchi avec highlighting ({TableLignesDevis.Rows.Count} lignes)")

        Catch ex As Exception
            Console.WriteLine($"Erreur RefreshDataGridViewLignesAvecHighlight : {ex.Message}")
        End Try
    End Sub

    Private Sub btnFermer_Click(sender As Object, e As EventArgs) Handles btnFermer.Click
        Me.Close()
    End Sub

    Private Sub btnAjouterTitre_Click(sender As Object, e As EventArgs) Handles btnAjouterTitre.Click
        Try
            ' Demander le texte du titre
            Dim texteTitre As String = InputBox("Saisissez le texte du titre :" & vbCrLf & vbCrLf &
                                               "Exemples :" & vbCrLf &
                                               "‚Ä¢ PHASE 1 : FONDATIONS" & vbCrLf &
                                               "‚Ä¢ TRAVAUX PR√âPARATOIRES" & vbCrLf &
                                               "‚Ä¢ FINITIONS INT√âRIEURES",
                                               "Ajouter un Titre", "")

            If String.IsNullOrWhiteSpace(texteTitre) Then
                Return ' Annulation
            End If

            ' Cr√©er la ligne de titre
            AjouterLigneTitre(texteTitre.Trim())

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"‚ùå Erreur btnAjouterTitre : {ex.Message}")
        End Try
    End Sub

    Private Sub AjouterLigneTitre(texteTitre As String)
        Try
            Console.WriteLine($"üè∑Ô∏è Ajout titre : '{texteTitre}'")

            Dim titreRow As DataRow = TableLignesDevis.NewRow()
            titreRow("Designation") = texteTitre.ToUpper()
            titreRow("Unite") = ""
            titreRow("Quantite") = 0
            titreRow("PrixUnitaire") = 0
            titreRow("MontantLigne") = 0
            titreRow("TacheID") = 0
            titreRow("LigneDevisID") = 0
            titreRow("SectionNom") = ""
            titreRow("TypeLigne") = "TITRE"
            titreRow("OrdreAffichage") = TableLignesDevis.Rows.Count + 1

            TableLignesDevis.Rows.Add(titreRow)

            RefreshDataGridViewLignes()
            CalculerTotauxDevis()

            ' üî• CORRECTION : Mettre √† jour les boutons
            GererEtatBoutonsSections()

            MessageBox.Show($"‚úÖ TITRE AJOUT√â" & vbCrLf & vbCrLf &
                       $"üìã {texteTitre}",
                       "Titre cr√©√©", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"‚úÖ Titre ajout√© : '{texteTitre}'")

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    Private Sub btnModifierTache_Click(sender As Object, e As EventArgs) Handles btnModifierTache.Click
        Try
            ' V√©rifier s√©lection
            If dgvLignesDevis.CurrentRow Is Nothing OrElse dgvLignesDevis.CurrentRow.IsNewRow Then
                MessageBox.Show("‚ö†Ô∏è Veuillez s√©lectionner une ligne de t√¢che √† modifier.",
                              "Aucune s√©lection", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim rowIndex As Integer = dgvLignesDevis.CurrentRow.Index

            If rowIndex >= TableLignesDevis.Rows.Count Then
                MessageBox.Show("‚ùå Index invalide.", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                Return
            End If

            Dim row As DataRow = TableLignesDevis.Rows(rowIndex)
            Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())

            ' Interdire modification des titres et sections
            If typeLigne = "TITRE" Then
                MessageBox.Show("üî∑ Les titres ne peuvent pas √™tre modifi√©s via ce bouton." & vbCrLf &
                              "Supprimez-le et recr√©ez-le.",
                              "Non autoris√©", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            If typeLigne = "SECTION" Then
                MessageBox.Show("üìä Utilisez 'Modifier Section' pour renommer." & vbCrLf &
                              "Modifiez les lignes pour changer le montant.",
                              "Non autoris√©", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' Ouvrir formulaire modification
            OuvrirFormulaireModificationTache(row, rowIndex)

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    ' ===============================================================================
    ' BOUTON MODIFIER TITRE
    ' ===============================================================================
    Private Sub btnModifierTitre_Click(sender As Object, e As EventArgs) Handles btnModifierTitre.Click
        Try
            ' V√©rifier s√©lection
            If dgvLignesDevis.CurrentRow Is Nothing OrElse dgvLignesDevis.CurrentRow.IsNewRow Then
                MessageBox.Show("‚ö†Ô∏è Veuillez s√©lectionner une ligne de TITRE √† modifier.",
                          "Aucune s√©lection", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim rowIndex As Integer = dgvLignesDevis.CurrentRow.Index

            If rowIndex >= TableLignesDevis.Rows.Count Then
                MessageBox.Show("‚ùå Index invalide.", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                Return
            End If

            Dim row As DataRow = TableLignesDevis.Rows(rowIndex)
            Dim typeLigne As String = If(IsDBNull(row("TypeLigne")), "LIGNE", row("TypeLigne").ToString())

            ' V√©rifier que c'est bien un TITRE
            If typeLigne <> "TITRE" Then
                MessageBox.Show("‚ö†Ô∏è La ligne s√©lectionn√©e n'est pas un TITRE." & vbCrLf & vbCrLf &
                          "Veuillez s√©lectionner une ligne bleue (üî∑ TITRE) pour la modifier.",
                          "S√©lection incorrecte", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            ' R√©cup√©rer le texte actuel
            Dim ancienTexte As String = row("Designation").ToString()

            ' Demander le nouveau texte
            Dim nouveauTexte As String = InputBox("Modifier le texte du titre :" & vbCrLf & vbCrLf &
                                             $"Texte actuel :" & vbCrLf &
                                             $"{ancienTexte}",
                                             "Modification Titre", ancienTexte)

            If String.IsNullOrWhiteSpace(nouveauTexte) Then
                Return ' Annulation
            End If

            nouveauTexte = nouveauTexte.Trim()

            If nouveauTexte = ancienTexte Then
                MessageBox.Show("‚ÑπÔ∏è Le texte n'a pas chang√©.", "Information", MessageBoxButtons.OK, MessageBoxIcon.Information)
                Return
            End If

            ' Mettre √† jour le titre
            row("Designation") = nouveauTexte.ToUpper() ' En majuscules

            ' Rafra√Æchir l'affichage
            RefreshDataGridViewLignes()

            MessageBox.Show($"‚úÖ TITRE MODIFI√â" & vbCrLf & vbCrLf &
                       $"Ancien texte :" & vbCrLf &
                       $"{ancienTexte}" & vbCrLf & vbCrLf &
                       $"Nouveau texte :" & vbCrLf &
                       $"{nouveauTexte.ToUpper()}",
                       "Modification r√©ussie", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"Titre modifi√© : '{ancienTexte}' ‚Üí '{nouveauTexte}'")

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"‚ùå Erreur btnModifierTitre_Click : {ex.Message}")
        End Try
    End Sub
    Private Sub OuvrirFormulaireModificationTache(row As DataRow, rowIndex As Integer)
        Try
            Using frmModif As New Form()
                frmModif.Text = "Modifier la T√¢che"
                frmModif.Size = New Size(500, 380)
                frmModif.StartPosition = FormStartPosition.CenterParent
                frmModif.FormBorderStyle = FormBorderStyle.FixedDialog
                frmModif.MaximizeBox = False
                frmModif.MinimizeBox = False

                Dim yPos As Integer = 20

                ' D√âSIGNATION
                Dim lblDesignation As New Label()
                lblDesignation.Text = "D√©signation :"
                lblDesignation.Location = New Point(20, yPos)
                lblDesignation.Size = New Size(100, 20)
                lblDesignation.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim txtDesignation As New TextBox()
                txtDesignation.Text = row("Designation").ToString()
                txtDesignation.Location = New Point(130, yPos)
                txtDesignation.Size = New Size(330, 25)
                txtDesignation.MaxLength = 255
                yPos += 35

                ' UNIT√â
                Dim lblUnite As New Label()
                lblUnite.Text = "Unit√© :"
                lblUnite.Location = New Point(20, yPos)
                lblUnite.Size = New Size(100, 20)
                lblUnite.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim txtUnite As New TextBox()
                txtUnite.Text = If(IsDBNull(row("Unite")), "", row("Unite").ToString())
                txtUnite.Location = New Point(130, yPos)
                txtUnite.Size = New Size(100, 25)
                txtUnite.MaxLength = 50
                yPos += 35

                ' QUANTIT√â
                Dim lblQuantite As New Label()
                lblQuantite.Text = "Quantit√© :"
                lblQuantite.Location = New Point(20, yPos)
                lblQuantite.Size = New Size(100, 20)
                lblQuantite.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim txtQuantite As New TextBox()
                txtQuantite.Text = CDec(row("Quantite")).ToString("N2")
                txtQuantite.Location = New Point(130, yPos)
                txtQuantite.Size = New Size(100, 25)
                yPos += 35

                ' PRIX UNITAIRE
                Dim lblPrixUnitaire As New Label()
                lblPrixUnitaire.Text = "Prix Unitaire :"
                lblPrixUnitaire.Location = New Point(20, yPos)
                lblPrixUnitaire.Size = New Size(100, 20)
                lblPrixUnitaire.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim txtPrixUnitaire As New TextBox()
                txtPrixUnitaire.Text = CDec(row("PrixUnitaire")).ToString("N0")
                txtPrixUnitaire.Location = New Point(130, yPos)
                txtPrixUnitaire.Size = New Size(150, 25)

                Dim lblFCFA As New Label()
                lblFCFA.Text = "FCFA"
                lblFCFA.Location = New Point(290, yPos + 3)
                lblFCFA.Size = New Size(50, 20)
                yPos += 35

                ' MONTANT CALCUL√â
                Dim lblMontantCalcule As New Label()
                lblMontantCalcule.Text = "Montant calcul√© :"
                lblMontantCalcule.Location = New Point(20, yPos)
                lblMontantCalcule.Size = New Size(110, 20)
                lblMontantCalcule.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim txtMontantCalcule As New TextBox()
                txtMontantCalcule.Location = New Point(130, yPos)
                txtMontantCalcule.Size = New Size(150, 25)
                txtMontantCalcule.ReadOnly = True
                txtMontantCalcule.BackColor = Color.LightGray
                txtMontantCalcule.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim lblFCFA2 As New Label()
                lblFCFA2.Text = "FCFA"
                lblFCFA2.Location = New Point(290, yPos + 3)
                lblFCFA2.Size = New Size(50, 20)
                yPos += 45

                ' Calcul automatique du montant
                Dim CalculerMontant As Action = Sub()
                                                    Try
                                                        Dim qte As Decimal = 0
                                                        Dim pu As Decimal = 0

                                                        ' üî• CORRECTION : Utiliser CultureInfo fran√ßais pour accepter la virgule
                                                        Dim quantiteTexte As String = txtQuantite.Text.Trim().Replace(".", ",")
                                                        Dim puTexte As String = txtPrixUnitaire.Text.Trim().Replace(" ", "").Replace(".", ",")

                                                        If Decimal.TryParse(quantiteTexte, NumberStyles.Number, New CultureInfo("fr-FR"), qte) AndAlso
           Decimal.TryParse(puTexte, NumberStyles.Number, New CultureInfo("fr-FR"), pu) Then
                                                            txtMontantCalcule.Text = (qte * pu).ToString("N0")
                                                        Else
                                                            txtMontantCalcule.Text = "0"
                                                        End If
                                                    Catch
                                                        txtMontantCalcule.Text = "0"
                                                    End Try
                                                End Sub

                ' Events pour calcul temps r√©el
                AddHandler txtQuantite.TextChanged, Sub() CalculerMontant()
                AddHandler txtPrixUnitaire.TextChanged, Sub() CalculerMontant()

                ' Calcul initial
                CalculerMontant()

                ' BOUTONS
                Dim btnEnregistrer As New Button()
                btnEnregistrer.Text = "üíæ Enregistrer"
                btnEnregistrer.Location = New Point(180, yPos)
                btnEnregistrer.Size = New Size(120, 35)
                btnEnregistrer.BackColor = Color.FromArgb(46, 204, 113)
                btnEnregistrer.ForeColor = Color.White
                btnEnregistrer.FlatStyle = FlatStyle.Flat
                btnEnregistrer.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                Dim btnAnnuler As New Button()
                btnAnnuler.Text = "‚ùå Annuler"
                btnAnnuler.Location = New Point(310, yPos)
                btnAnnuler.Size = New Size(100, 35)
                btnAnnuler.BackColor = Color.FromArgb(231, 76, 60)
                btnAnnuler.ForeColor = Color.White
                btnAnnuler.FlatStyle = FlatStyle.Flat
                btnAnnuler.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                ' Event Enregistrer
                AddHandler btnEnregistrer.Click, Sub(s, ev)
                                                     Try
                                                         ' Validation
                                                         If String.IsNullOrWhiteSpace(txtDesignation.Text) Then
                                                             MessageBox.Show("‚ö†Ô∏è La d√©signation est obligatoire.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                             txtDesignation.Focus()
                                                             Return
                                                         End If

                                                         ' üî• CORRECTION : Gestion correcte des d√©cimaux avec virgule
                                                         Dim nouvelleQuantite As Decimal = 0
                                                         Dim quantiteTexte As String = txtQuantite.Text.Trim().Replace(".", ",") ' Normaliser avec virgule

                                                         If Not Decimal.TryParse(quantiteTexte, NumberStyles.Number, New CultureInfo("fr-FR"), nouvelleQuantite) OrElse nouvelleQuantite <= 0 Then
                                                             MessageBox.Show("‚ö†Ô∏è Quantit√© invalide." & vbCrLf & vbCrLf &
                          "Formats accept√©s :" & vbCrLf &
                          "‚Ä¢ 5" & vbCrLf &
                          "‚Ä¢ 5,00" & vbCrLf &
                          "‚Ä¢ 51,2" & vbCrLf &
                          "‚Ä¢ 0,5",
                          "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                             txtQuantite.Focus()
                                                             txtQuantite.SelectAll()
                                                             Return
                                                         End If

                                                         ' üî• CORRECTION : Gestion correcte du prix unitaire avec virgule
                                                         Dim nouveauPU As Decimal = 0
                                                         Dim puTexte As String = txtPrixUnitaire.Text.Trim().Replace(" ", "").Replace(".", ",") ' Normaliser avec virgule

                                                         If Not Decimal.TryParse(puTexte, NumberStyles.Number, New CultureInfo("fr-FR"), nouveauPU) OrElse nouveauPU <= 0 Then
                                                             MessageBox.Show("‚ö†Ô∏è Prix unitaire invalide." & vbCrLf & vbCrLf &
                          "Formats accept√©s :" & vbCrLf &
                          "‚Ä¢ 1000" & vbCrLf &
                          "‚Ä¢ 1000,50" & vbCrLf &
                          "‚Ä¢ 25 000" & vbCrLf &
                          "‚Ä¢ 25000,75",
                          "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                             txtPrixUnitaire.Focus()
                                                             txtPrixUnitaire.SelectAll()
                                                             Return
                                                         End If

                                                         ' Mise √† jour de la ligne
                                                         Dim ancienneDesignation As String = row("Designation").ToString()
                                                         Dim ancienMontant As Decimal = CDec(row("MontantLigne"))

                                                         row("Designation") = txtDesignation.Text.Trim()
                                                         row("Unite") = txtUnite.Text.Trim()
                                                         row("Quantite") = nouvelleQuantite
                                                         row("PrixUnitaire") = nouveauPU
                                                         row("MontantLigne") = nouvelleQuantite * nouveauPU

                                                         Dim nouveauMontant As Decimal = CDec(row("MontantLigne"))

                                                         ' Recalculer section si n√©cessaire
                                                         Dim sectionNom As String = If(IsDBNull(row("SectionNom")), "", row("SectionNom").ToString())
                                                         If Not String.IsNullOrEmpty(sectionNom) Then
                                                             RecalculerSousTotal(sectionNom)
                                                         End If

                                                         ' Rafra√Æchir
                                                         RefreshDataGridViewLignes()
                                                         CalculerTotauxDevis()

                                                         MessageBox.Show($"‚úÖ T√ÇCHE MODIFI√âE" & vbCrLf & vbCrLf &
                      $"‚Ä¢ T√¢che : {txtDesignation.Text}" & vbCrLf &
                      $"‚Ä¢ Quantit√© : {nouvelleQuantite:N2}" & vbCrLf &
                      $"‚Ä¢ Prix unitaire : {nouveauPU:N0} FCFA" & vbCrLf &
                      $"‚Ä¢ Ancien montant : {ancienMontant:N0} FCFA" & vbCrLf &
                      $"‚Ä¢ Nouveau montant : {nouveauMontant:N0} FCFA",
                      "Modification r√©ussie", MessageBoxButtons.OK, MessageBoxIcon.Information)

                                                         frmModif.DialogResult = DialogResult.OK
                                                         frmModif.Close()

                                                     Catch ex As Exception
                                                         MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                                                     End Try
                                                 End Sub

                ' Event Annuler
                AddHandler btnAnnuler.Click, Sub(s, ev)
                                                 frmModif.DialogResult = DialogResult.Cancel
                                                 frmModif.Close()
                                             End Sub

                ' Ajouter contr√¥les
                frmModif.Controls.AddRange({
                    lblDesignation, txtDesignation,
                    lblUnite, txtUnite,
                    lblQuantite, txtQuantite,
                    lblPrixUnitaire, txtPrixUnitaire, lblFCFA,
                    lblMontantCalcule, txtMontantCalcule, lblFCFA2,
                    btnEnregistrer, btnAnnuler
                })

                frmModif.AcceptButton = btnEnregistrer
                frmModif.CancelButton = btnAnnuler
                txtDesignation.Select()

                frmModif.ShowDialog()

            End Using

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub
    Private Sub RecalculerSousTotal(sectionNom As String)
        Try
            Console.WriteLine($"üîÑ Recalcul sous-total section : '{sectionNom}'")

            ' Calculer le nouveau sous-total
            Dim sousTotal As Decimal = 0
            For Each row As DataRow In TableLignesDevis.Rows
                If row("TypeLigne").ToString() <> "SECTION" AndAlso
                   row("SectionNom").ToString() = sectionNom Then
                    sousTotal += CDec(row("MontantLigne"))
                End If
            Next

            ' Mettre √† jour la ligne de section
            For Each row As DataRow In TableLignesDevis.Rows
                If row("TypeLigne").ToString() = "SECTION" AndAlso
                   row("SectionNom").ToString() = sectionNom Then
                    row("MontantLigne") = sousTotal
                    Console.WriteLine($"‚úÖ Sous-total section '{sectionNom}' = {sousTotal:N0} FCFA")
                    Exit For
                End If
            Next

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur recalcul section : {ex.Message}")
        End Try
    End Sub

    Private Sub AjouterCelluleTitre(table As PdfPTable, texteTitre As String)
        Try
            ' üî• CORRECTION : M√™me taille que les sections (9pt au lieu de 10pt)
            Dim fontSizeTableau As Single = 9
            Dim font As Font = FontFactory.GetFont(FontFactory.HELVETICA_BOLD, fontSizeTableau, BaseColor.BLACK)

            Dim cellTitre As New PdfPCell(New Phrase(texteTitre, font))
            cellTitre.Colspan = 5
            cellTitre.HorizontalAlignment = Element.ALIGN_LEFT
            cellTitre.VerticalAlignment = Element.ALIGN_MIDDLE

            ' üî• CORRECTION : M√™me couleur grise que les sections (230, 230, 230) au lieu de bleu
            cellTitre.BackgroundColor = New BaseColor(230, 230, 230)

            cellTitre.Border = Rectangle.BOX
            cellTitre.BorderWidth = 0.5F ' üî• M√™me bordure fine que les sections
            cellTitre.BorderColor = BaseColor.BLACK
            cellTitre.Padding = 2 ' üî• M√™me padding r√©duit que les sections
            cellTitre.MinimumHeight = 0 ' üî• Hauteur adaptative

            table.AddCell(cellTitre)

            Console.WriteLine($"PDF Titre ajout√© : {texteTitre}")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur titre PDF : {ex.Message}")
        End Try
    End Sub
    ' ===============================================================================
    ' STRUCTURE POUR STOCKER UNE T√ÇCHE MODIFI√âE
    ' ===============================================================================
    Public Class TacheMultiple
        Public Property TacheID As Integer
        Public Property Designation As String
        Public Property Unite As String
        Public Property Quantite As Decimal
        Public Property PrixUnitaire As Decimal
        Public Property MontantLigne As Decimal
        Public Property Ordre As Integer
    End Class

    ' ===============================================================================
    ' BOUTON AJOUTER MULTIPLE - EVENT HANDLER
    ' ===============================================================================
    Private Sub btnAjouterMultiple_Click(sender As Object, e As EventArgs) Handles btnAjouterMultiple.Click
        Try
            Console.WriteLine("üìã === AJOUT MULTIPLE T√ÇCHES ===")

            ' Ouvrir le formulaire de s√©lection multiple
            Dim tachesSelectionnees As List(Of TacheMultiple) = OuvrirFormulaireAjoutMultiple()

            If tachesSelectionnees Is Nothing OrElse tachesSelectionnees.Count = 0 Then
                Console.WriteLine("‚ö†Ô∏è Aucune t√¢che s√©lectionn√©e")
                Return
            End If

            ' Ajouter toutes les t√¢ches dans l'ordre
            AjouterTachesMultiples(tachesSelectionnees)

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"‚ùå Erreur btnAjouterMultiple : {ex.Message}")
        End Try
    End Sub

    ' ===============================================================================
    ' FORMULAIRE AVEC ORDRE DE S√âLECTION NUM√âROT√â
    ' ===============================================================================
    Private Function OuvrirFormulaireAjoutMultiple() As List(Of TacheMultiple)
        Try
            Using frmMultiple As New Form()
                frmMultiple.Text = "Ajouter Plusieurs T√¢ches"
                frmMultiple.Size = New Size(1100, 650)
                frmMultiple.StartPosition = FormStartPosition.CenterParent
                frmMultiple.FormBorderStyle = FormBorderStyle.Sizable
                frmMultiple.MinimumSize = New Size(1000, 600)

                ' üî• COMPTEUR D'ORDRE DE S√âLECTION (variable partag√©e)
                Dim ordreSelectionActuel As Integer = 0

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' INSTRUCTIONS
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                Dim lblInstructions As New Label()
                lblInstructions.Text = "üìã S√âLECTION AVEC ORDRE NUM√âROT√â" & vbCrLf & vbCrLf &
                                  "1Ô∏è‚É£ Cochez les t√¢ches DANS L'ORDRE que vous voulez les ajouter" & vbCrLf &
                                  "2Ô∏è‚É£ Un NUM√âRO appara√Æt √† c√¥t√© de chaque coche (1, 2, 3...)" & vbCrLf &
                                  "3Ô∏è‚É£ Cliquez sur une ligne pour modifier quantit√©/prix/d√©signation" & vbCrLf &
                                  "4Ô∏è‚É£ Les t√¢ches seront ajout√©es DANS L'ORDRE DE COCHE"
                lblInstructions.Location = New Point(20, 10)
                lblInstructions.Size = New Size(1050, 80)
                lblInstructions.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Regular)
                lblInstructions.ForeColor = Color.FromArgb(52, 73, 94)

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' DATAGRIDVIEW AVEC COLONNE ORDRE VISIBLE
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                Dim dgvTaches As New DataGridView()
                dgvTaches.Location = New Point(20, 100)
                dgvTaches.Size = New Size(1050, 400)
                dgvTaches.AllowUserToAddRows = False
                dgvTaches.AllowUserToDeleteRows = False
                dgvTaches.SelectionMode = DataGridViewSelectionMode.FullRowSelect
                dgvTaches.MultiSelect = False
                dgvTaches.AutoGenerateColumns = False
                dgvTaches.RowHeadersWidth = 30

                ' üî• COLONNES AVEC ORDRE DE S√âLECTION VISIBLE
                Dim colSelect As New DataGridViewCheckBoxColumn()
                colSelect.Name = "Selectionner"
                colSelect.HeaderText = "‚úì"
                colSelect.Width = 40
                colSelect.ReadOnly = False

                ' üî• NOUVELLE COLONNE : Ordre de s√©lection
                Dim colOrdreSelection As New DataGridViewTextBoxColumn()
                colOrdreSelection.Name = "OrdreSelection"
                colOrdreSelection.HeaderText = "N¬∞"
                colOrdreSelection.Width = 45
                colOrdreSelection.ReadOnly = True
                colOrdreSelection.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter
                colOrdreSelection.DefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)
                colOrdreSelection.DefaultCellStyle.ForeColor = Color.FromArgb(46, 204, 113)
                colOrdreSelection.DefaultCellStyle.BackColor = Color.FromArgb(240, 255, 240)

                Dim colDesignation As New DataGridViewTextBoxColumn()
                colDesignation.Name = "Designation"
                colDesignation.HeaderText = "D√âSIGNATION"
                colDesignation.Width = 340
                colDesignation.ReadOnly = False

                Dim colUnite As New DataGridViewTextBoxColumn()
                colUnite.Name = "Unite"
                colUnite.HeaderText = "UNIT√â"
                colUnite.Width = 80
                colUnite.ReadOnly = False

                Dim colQuantite As New DataGridViewTextBoxColumn()
                colQuantite.Name = "Quantite"
                colQuantite.HeaderText = "QUANTIT√â"
                colQuantite.Width = 100
                colQuantite.ReadOnly = False
                colQuantite.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight

                Dim colPrixUnitaire As New DataGridViewTextBoxColumn()
                colPrixUnitaire.Name = "PrixUnitaire"
                colPrixUnitaire.HeaderText = "PRIX UNITAIRE"
                colPrixUnitaire.Width = 140
                colPrixUnitaire.ReadOnly = False
                colPrixUnitaire.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight

                Dim colMontant As New DataGridViewTextBoxColumn()
                colMontant.Name = "Montant"
                colMontant.HeaderText = "MONTANT (FCFA)"
                colMontant.Width = 140
                colMontant.ReadOnly = True
                colMontant.DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleRight
                colMontant.DefaultCellStyle.BackColor = Color.LightGray

                Dim colTacheID As New DataGridViewTextBoxColumn()
                colTacheID.Name = "TacheID"
                colTacheID.HeaderText = "ID"
                colTacheID.Visible = False

                ' üî• AJOUTER TOUTES LES COLONNES (avec OrdreSelection)
                dgvTaches.Columns.AddRange({colSelect, colOrdreSelection, colDesignation, colUnite, colQuantite, colPrixUnitaire, colMontant, colTacheID})

                ' Style
                dgvTaches.ColumnHeadersDefaultCellStyle.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)
                dgvTaches.ColumnHeadersDefaultCellStyle.BackColor = Color.FromArgb(52, 152, 219)
                dgvTaches.ColumnHeadersDefaultCellStyle.ForeColor = Color.White
                dgvTaches.EnableHeadersVisualStyles = False

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' REMPLIR AVEC LES T√ÇCHES
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                Dim dtTaches As DataTable = DbHelper.GetData(
                "SELECT TacheID, Designation, Unite, PrixUnitaire FROM TachesPredefinies ORDER BY Designation",
                New SqlParameter() {})

                For Each row As DataRow In dtTaches.Rows
                    dgvTaches.Rows.Add(
                    False,                                                      ' S√©lectionner
                    "",                                                         ' üî• OrdreSelection (vide par d√©faut)
                    row("Designation").ToString(),                              ' D√©signation
                    If(IsDBNull(row("Unite")), "", row("Unite").ToString()),   ' Unit√©
                    1D,                                                        ' Quantit√©
                    If(IsDBNull(row("PrixUnitaire")), 0, CDec(row("PrixUnitaire"))), ' Prix
                    If(IsDBNull(row("PrixUnitaire")), 0, CDec(row("PrixUnitaire"))), ' Montant
                    CInt(row("TacheID"))                                       ' TacheID
                )
                Next

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' üî• GESTION DE L'ORDRE DE S√âLECTION
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                AddHandler dgvTaches.CellValueChanged, Sub(s, ev)
                                                           Try
                                                               If ev.ColumnIndex = dgvTaches.Columns("Selectionner").Index Then
                                                                   Dim row As DataGridViewRow = dgvTaches.Rows(ev.RowIndex)
                                                                   Dim estCoche As Boolean = CBool(row.Cells("Selectionner").Value)

                                                                   If estCoche Then
                                                                       ' ‚úÖ COCH√â : Attribuer le prochain num√©ro
                                                                       ordreSelectionActuel += 1
                                                                       row.Cells("OrdreSelection").Value = ordreSelectionActuel.ToString()
                                                                       row.Cells("OrdreSelection").Style.BackColor = Color.FromArgb(240, 255, 240)
                                                                       Console.WriteLine($"‚úÖ T√¢che coch√©e en position {ordreSelectionActuel}: {row.Cells("Designation").Value}")
                                                                   Else
                                                                       ' ‚ùå D√âCOCH√â : Retirer le num√©ro et r√©organiser
                                                                       Dim ancienOrdre As Integer = 0
                                                                       If Integer.TryParse(row.Cells("OrdreSelection").Value?.ToString(), ancienOrdre) Then
                                                                           row.Cells("OrdreSelection").Value = ""
                                                                           row.Cells("OrdreSelection").Style.BackColor = Color.White

                                                                           ' R√©organiser les num√©ros suivants
                                                                           For Each autreRow As DataGridViewRow In dgvTaches.Rows
                                                                               Dim autreOrdre As Integer = 0
                                                                               If Integer.TryParse(autreRow.Cells("OrdreSelection").Value?.ToString(), autreOrdre) Then
                                                                                   If autreOrdre > ancienOrdre Then
                                                                                       ' D√©caler vers le bas
                                                                                       autreRow.Cells("OrdreSelection").Value = (autreOrdre - 1).ToString()
                                                                                   End If
                                                                               End If
                                                                           Next

                                                                           ' D√©cr√©menter le compteur
                                                                           ordreSelectionActuel -= 1
                                                                           Console.WriteLine($"‚ùå T√¢che d√©coch√©e - R√©organisation effectu√©e")
                                                                       End If
                                                                   End If
                                                               End If
                                                           Catch ex As Exception
                                                               Console.WriteLine($"‚ùå Erreur gestion ordre: {ex.Message}")
                                                           End Try
                                                       End Sub

                AddHandler dgvTaches.CurrentCellDirtyStateChanged, Sub(s, ev)
                                                                       If dgvTaches.IsCurrentCellDirty Then
                                                                           dgvTaches.CommitEdit(DataGridViewDataErrorContexts.Commit)
                                                                       End If
                                                                   End Sub

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' CALCUL AUTOMATIQUE DU MONTANT
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                AddHandler dgvTaches.CellEndEdit, Sub(s, ev)
                                                      Try
                                                          If ev.ColumnIndex = dgvTaches.Columns("Quantite").Index OrElse
                                                         ev.ColumnIndex = dgvTaches.Columns("PrixUnitaire").Index Then

                                                              Dim rowEdit As DataGridViewRow = dgvTaches.Rows(ev.RowIndex)
                                                              Dim quantite As Decimal = 0
                                                              Dim prixUnitaire As Decimal = 0

                                                              If Decimal.TryParse(rowEdit.Cells("Quantite").Value?.ToString(), quantite) AndAlso
                                                             Decimal.TryParse(rowEdit.Cells("PrixUnitaire").Value?.ToString(), prixUnitaire) Then
                                                                  rowEdit.Cells("Montant").Value = (quantite * prixUnitaire).ToString("N0")
                                                              End If
                                                          End If
                                                      Catch ex As Exception
                                                          Console.WriteLine($"Erreur calcul : {ex.Message}")
                                                      End Try
                                                  End Sub

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' LABEL TOTAL
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                Dim lblTotalSelectionne As New Label()
                lblTotalSelectionne.Location = New Point(20, 510)
                lblTotalSelectionne.Size = New Size(800, 25)
                lblTotalSelectionne.Font = New System.Drawing.Font("Segoe UI", 11, FontStyle.Bold)
                lblTotalSelectionne.ForeColor = Color.FromArgb(46, 204, 113)
                lblTotalSelectionne.Text = "üí∞ Total s√©lectionn√© : 0 FCFA | 0 t√¢che(s)"

                ' Mise √† jour du total
                Dim MettreAJourTotal As Action = Sub()
                                                     Try
                                                         Dim total As Decimal = 0
                                                         Dim nombreTaches As Integer = 0

                                                         For Each row As DataGridViewRow In dgvTaches.Rows
                                                             If CBool(row.Cells("Selectionner").Value) = True Then
                                                                 nombreTaches += 1
                                                                 Dim montant As Decimal = 0
                                                                 If Decimal.TryParse(row.Cells("Montant").Value?.ToString()?.Replace(" ", ""), montant) Then
                                                                     total += montant
                                                                 End If
                                                             End If
                                                         Next

                                                         lblTotalSelectionne.Text = $"üí∞ Total s√©lectionn√© : {total:N0} FCFA | {nombreTaches} t√¢che(s)"
                                                     Catch ex As Exception
                                                         Console.WriteLine($"Erreur MAJ total : {ex.Message}")
                                                     End Try
                                                 End Sub

                ' D√©clencher la MAJ du total apr√®s changement de s√©lection
                AddHandler dgvTaches.CellValueChanged, Sub(s, ev)
                                                           If ev.ColumnIndex = dgvTaches.Columns("Selectionner").Index OrElse
                                                          ev.ColumnIndex = dgvTaches.Columns("Montant").Index Then
                                                               MettreAJourTotal()
                                                           End If
                                                       End Sub

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' BOUTONS
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                Dim btnToutCocher As New Button()
                btnToutCocher.Text = "‚úÖ Tout cocher"
                btnToutCocher.Location = New Point(20, 545)
                btnToutCocher.Size = New Size(120, 35)
                btnToutCocher.BackColor = Color.FromArgb(52, 152, 219)
                btnToutCocher.ForeColor = Color.White
                btnToutCocher.FlatStyle = FlatStyle.Flat
                btnToutCocher.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                AddHandler btnToutCocher.Click, Sub()
                                                    ' R√©initialiser le compteur
                                                    ordreSelectionActuel = 0
                                                    For Each row As DataGridViewRow In dgvTaches.Rows
                                                        row.Cells("Selectionner").Value = True
                                                    Next
                                                    MettreAJourTotal()
                                                End Sub

                Dim btnToutDecocher As New Button()
                btnToutDecocher.Text = "‚ùå Tout d√©cocher"
                btnToutDecocher.Location = New Point(150, 545)
                btnToutDecocher.Size = New Size(130, 35)
                btnToutDecocher.BackColor = Color.FromArgb(231, 76, 60)
                btnToutDecocher.ForeColor = Color.White
                btnToutDecocher.FlatStyle = FlatStyle.Flat
                btnToutDecocher.Font = New System.Drawing.Font("Segoe UI", 9, FontStyle.Bold)

                AddHandler btnToutDecocher.Click, Sub()
                                                      ordreSelectionActuel = 0
                                                      For Each row As DataGridViewRow In dgvTaches.Rows
                                                          row.Cells("Selectionner").Value = False
                                                          row.Cells("OrdreSelection").Value = ""
                                                          row.Cells("OrdreSelection").Style.BackColor = Color.White
                                                      Next
                                                      MettreAJourTotal()
                                                  End Sub

                Dim btnAjouterTout As New Button()
                btnAjouterTout.Text = "üíæ Ajouter Toutes"
                btnAjouterTout.Location = New Point(850, 545)
                btnAjouterTout.Size = New Size(140, 35)
                btnAjouterTout.BackColor = Color.FromArgb(46, 204, 113)
                btnAjouterTout.ForeColor = Color.White
                btnAjouterTout.FlatStyle = FlatStyle.Flat
                btnAjouterTout.Font = New System.Drawing.Font("Segoe UI", 10, FontStyle.Bold)

                Dim btnAnnuler As New Button()
                btnAnnuler.Text = "Annuler"
                btnAnnuler.Location = New Point(1000, 545)
                btnAnnuler.Size = New Size(70, 35)
                btnAnnuler.BackColor = Color.Gray
                btnAnnuler.ForeColor = Color.White
                btnAnnuler.FlatStyle = FlatStyle.Flat

                Dim tachesChoisies As List(Of TacheMultiple) = Nothing

                AddHandler btnAjouterTout.Click, Sub(s, ev)
                                                     Try
                                                         tachesChoisies = New List(Of TacheMultiple)

                                                         For Each row As DataGridViewRow In dgvTaches.Rows
                                                             If CBool(row.Cells("Selectionner").Value) = True Then
                                                                 ' Validation
                                                                 Dim quantite As Decimal = 0
                                                                 Dim prixUnitaire As Decimal = 0

                                                                 If Not Decimal.TryParse(row.Cells("Quantite").Value?.ToString(), quantite) OrElse quantite <= 0 Then
                                                                     MessageBox.Show($"‚ö†Ô∏è Quantit√© invalide" & vbCrLf &
                                                                               $"T√¢che N¬∞{row.Cells("OrdreSelection").Value}: {row.Cells("Designation").Value}",
                                                                               "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                                     Return
                                                                 End If

                                                                 If Not Decimal.TryParse(row.Cells("PrixUnitaire").Value?.ToString(), prixUnitaire) OrElse prixUnitaire <= 0 Then
                                                                     MessageBox.Show($"‚ö†Ô∏è Prix unitaire invalide" & vbCrLf &
                                                                               $"T√¢che N¬∞{row.Cells("OrdreSelection").Value}: {row.Cells("Designation").Value}",
                                                                               "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                                     Return
                                                                 End If

                                                                 ' üî• R√©cup√©rer l'ordre de s√©lection
                                                                 Dim ordreSelection As Integer = 0
                                                                 Integer.TryParse(row.Cells("OrdreSelection").Value?.ToString(), ordreSelection)

                                                                 ' Ajouter √† la liste avec l'ordre de s√©lection
                                                                 tachesChoisies.Add(New TacheMultiple With {
                                                                 .TacheID = CInt(row.Cells("TacheID").Value),
                                                                 .Designation = row.Cells("Designation").Value.ToString(),
                                                                 .Unite = row.Cells("Unite").Value?.ToString(),
                                                                 .Quantite = quantite,
                                                                 .PrixUnitaire = prixUnitaire,
                                                                 .MontantLigne = quantite * prixUnitaire,
                                                                 .Ordre = ordreSelection ' üî• ORDRE DE S√âLECTION !
                                                             })
                                                             End If
                                                         Next

                                                         If tachesChoisies.Count = 0 Then
                                                             MessageBox.Show("‚ö†Ô∏è Veuillez s√©lectionner au moins une t√¢che.",
                                                                       "Aucune s√©lection", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                                                             Return
                                                         End If

                                                         frmMultiple.DialogResult = DialogResult.OK
                                                         frmMultiple.Close()

                                                     Catch ex As Exception
                                                         MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
                                                     End Try
                                                 End Sub

                AddHandler btnAnnuler.Click, Sub(s, ev)
                                                 tachesChoisies = Nothing
                                                 frmMultiple.DialogResult = DialogResult.Cancel
                                                 frmMultiple.Close()
                                             End Sub

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' AJOUTER TOUS LES CONTR√îLES
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                frmMultiple.Controls.AddRange({
                lblInstructions, dgvTaches, lblTotalSelectionne,
                btnToutCocher, btnToutDecocher, btnAjouterTout, btnAnnuler
            })

                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                ' AFFICHER
                ' ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                If frmMultiple.ShowDialog() = DialogResult.OK Then
                    Return tachesChoisies
                Else
                    Return Nothing
                End If

            End Using

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur formulaire : {ex.Message}")
            MessageBox.Show($"‚ùå Erreur : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Return Nothing
        End Try
    End Function

    ' ===============================================================================
    ' AJOUTER LES T√ÇCHES DANS L'ORDRE DE S√âLECTION
    ' ===============================================================================
    Private Sub AjouterTachesMultiples(taches As List(Of TacheMultiple))
        Try
            Console.WriteLine($"üì• Ajout de {taches.Count} t√¢ches multiples...")

            Dim tachesAjoutees As Integer = 0
            Dim montantTotal As Decimal = 0

            ' üî• TRIER PAR ORDRE DE S√âLECTION (pas ordre visuel !)
            Dim tachesTriees = taches.OrderBy(Function(t) t.Ordre).ToList()

            For Each tache In tachesTriees
                Try
                    Dim newRow As DataRow = TableLignesDevis.NewRow()
                    newRow("Designation") = tache.Designation
                    newRow("Unite") = If(String.IsNullOrWhiteSpace(tache.Unite), "", tache.Unite)
                    newRow("Quantite") = tache.Quantite
                    newRow("PrixUnitaire") = tache.PrixUnitaire
                    newRow("MontantLigne") = tache.MontantLigne
                    newRow("TacheID") = tache.TacheID
                    newRow("LigneDevisID") = 0
                    newRow("SectionNom") = ""
                    newRow("TypeLigne") = "LIGNE"
                    newRow("OrdreAffichage") = TableLignesDevis.Rows.Count + 1
                    newRow("EstLibreDefinitif") = False

                    TableLignesDevis.Rows.Add(newRow)

                    tachesAjoutees += 1
                    montantTotal += tache.MontantLigne

                    Console.WriteLine($"  ‚úÖ N¬∞{tache.Ordre}: {tache.Designation} : {tache.Quantite:N2} √ó {tache.PrixUnitaire:N0} = {tache.MontantLigne:N0}")

                Catch rowEx As Exception
                    Console.WriteLine($"  ‚ùå Erreur t√¢che '{tache.Designation}' : {rowEx.Message}")
                    Continue For
                End Try
            Next

            ' Rafra√Æchir l'affichage
            RefreshDataGridViewLignes()
            CalculerTotauxDevis()
            GererEtatBoutonsSections()

            ' Message de confirmation simplifi√©
            MessageBox.Show($"üìä Nombre de t√¢ches : {tachesAjoutees}" & vbCrLf &
                $"üí∞ Montant total : {montantTotal:N0} FCFA",
                "Confirmation", MessageBoxButtons.OK, MessageBoxIcon.Information)

            Console.WriteLine($"‚úÖ {tachesAjoutees} t√¢ches ajout√©es - Total : {montantTotal:N0} FCFA")

        Catch ex As Exception
            MessageBox.Show($"‚ùå Erreur ajout : {ex.Message}", "Erreur", MessageBoxButtons.OK, MessageBoxIcon.Error)
            Console.WriteLine($"‚ùå Erreur AjouterTachesMultiples : {ex.Message}")
        End Try
    End Sub
    ' ===============================================================================
    ' CALCUL DU TOTAL POUR LES LIGNES FILTR√âES - VERSION CORRIG√âE
    ' ===============================================================================
    Private Sub CalculerTotalFiltre()
        Try
            Dim totalFiltre As Decimal = 0
            Dim nombreLignesVisibles As Integer = 0

            ' üî• R√âCUP√âRER LA DATATABLE SOURCE (comme FormFacture)
            Dim dt As DataTable = TryCast(dgvLignesDevis.DataSource, DataTable)

            If dt IsNot Nothing Then
                ' Parcourir la DataTable source
                For Each row As DataRow In dt.Rows
                    If Not IsDBNull(row("MontantLigne")) Then
                        totalFiltre += CDec(row("MontantLigne"))
                        nombreLignesVisibles += 1
                    End If
                Next
            Else
                ' Fallback : parcourir TableLignesDevis
                For Each row As DataRow In TableLignesDevis.Rows
                    If Not IsDBNull(row("MontantLigne")) Then
                        totalFiltre += CDec(row("MontantLigne"))
                        nombreLignesVisibles += 1
                    End If
                Next
            End If

            ' Afficher le r√©sultat
            If lblTotalFiltre IsNot Nothing Then
                If nombreLignesVisibles > 0 Then
                    lblTotalFiltre.Text = $"üí∞ Total lignes : {totalFiltre:N0} FCFA ({nombreLignesVisibles} lignes)"
                    lblTotalFiltre.ForeColor = Color.FromArgb(39, 174, 96)
                    lblTotalFiltre.Font = New System.Drawing.Font(lblTotalFiltre.Font, FontStyle.Bold)
                Else
                    lblTotalFiltre.Text = ""
                End If
            End If

            Console.WriteLine($"‚úÖ Total calcul√©: {totalFiltre:N0} FCFA ({nombreLignesVisibles} lignes)")

        Catch ex As Exception
            Console.WriteLine($"‚ùå Erreur calcul total: {ex.Message}")
        End Try
    End Sub
End Class